param (
    [switch]$Manual, # Required for Manual trigger
    [switch]$Testing, # Required for Testing trigger
    [switch]$Tautulli, # Required for Tautulli trigger
    [switch]$Backup, # Required for Backup trigger
    [switch]$dev, # Required for trigger dev branch
    [switch]$SyncJelly, # Required for Jellyfin Sync trigger
    [switch]$SyncEmby, # Required for Emby Sync trigger
    [switch]$PosterReset, # Required for Poster Reset trigger
    [switch]$SeasonPoster, # Required for Manual Trigger
    [switch]$TitleCard, # Required for Manual Trigger
    [switch]$CollectionCard, # Required for Manual Trigger
    [switch]$MoviePosterCard, # Required for Manual Trigger
    [switch]$ShowPosterCard, # Required for Manual Trigger
    [switch]$BackgroundCard, # Required for Manual Trigger
    [switch]$UISchedule, # Required for UI Schedule trigger
    [switch]$ContainerSchedule, # Required for Container Schedule trigger
    [string]$PicturePath, # Required for Manual Trigger
    [string]$Titletext, # Required for Manual Trigger
    [string]$FolderName, # Required for Manual Trigger
    [string]$LibraryName, # Required for Manual Trigger
    [string]$SeasonPosterName, # Required for Manual Trigger
    [string]$EPTitleName, # Required for Manual Trigger
    [string]$EpisodeNumber, # Required for Manual Trigger
    [string]$RatingKey, # Required for Tautulli Trigger
    [string]$parentratingkey, # Required for Tautulli Trigger
    [string]$grandparentratingkey, # Required for Tautulli Trigger
    [string]$mediatype, # Required for Tautulli Trigger
    [string]$LibraryToReset, # Required for Poster Reset Trigger
    [Parameter(ValueFromRemainingArguments = $true)]
    [string[]]$ExtraArgs # Required for Arrtrigger
)
# Disable command history saving
Set-PSReadLineOption -HistorySaveStyle SaveNothing

# Parse ExtraArgs into a hashtable
$arrTriggers = @{}
for ($i = 0; $i -lt $ExtraArgs.Count; $i++) {
    $current = $ExtraArgs[$i]

    if ($current -like '-*') {
        $key = $current.TrimStart('-')

        # If next item is missing OR also starts with "-", treat as a switch
        if ($i + 1 -ge $ExtraArgs.Count -or $ExtraArgs[$i + 1] -like '-*') {
            $arrTriggers[$key] = $true
        }
        else {
            $arrTriggers[$key] = $ExtraArgs[$i + 1]
            $i++ # skip value since it was consumed
        }
    }
}

$CurrentScriptVersion = "2.1.13"
$global:HeaderWritten = $false
$ProgressPreference = 'SilentlyContinue'
$env:PSMODULE_ANALYSIS_CACHE_PATH = $null
$env:PSMODULE_ANALYSIS_CACHE_ENABLED = $false

#################
# What you need #
#####################################################################################################################
# TMDB API Read Access Token      -> https://www.themoviedb.org/settings/api
# FANART API                      -> https://fanart.tv/get-an-api-key
# TVDB API                        -> https://thetvdb.com/api-information/signup
# ImageMagick                     -> https://imagemagick.org/archive/binaries/ImageMagick-7.1.1-27-Q16-HDRI-x64-dll.exe
# FanartTv API Powershell Wrapper -> https://github.com/Celerium/FanartTV-PowerShellWrapper
#####################################################################################################################

#### FUNCTION START ####
#region Functions

function New-TextSizeCacheKey {
    param([Parameter(Mandatory)][string]$Text, [Parameter(Mandatory)][hashtable]$Params)
    $list = [System.Collections.Generic.List[string]]::new()
    $list.Add("text=`"$Text`"")
    foreach ($k in ((($Params.Keys | ForEach-Object { $_.ToString().ToLowerInvariant() }) | Sort-Object))) {
        $v = $Params[$k]; if ($null -eq $v) { $v = '' }
        $list.Add(("{0}={1}" -f ($k.ToString().ToLowerInvariant()), ($v.ToString())))
    }
    $payload = [string]::Join('|', $list)
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($payload)
    $sha = [System.Security.Cryptography.SHA256]::Create()
    $hash = ($sha.ComputeHash($bytes) | ForEach-Object { $_.ToString('x2') }) -join ''
    return $hash
}

function Get-TextSizeFromCache {
    param([Parameter(Mandatory)][string]$Key, [string]$Path = $Global:TextSizeCachePath)
    if (-not (Test-Path -LiteralPath $Path)) { return $null }
    $raw = Get-Content -LiteralPath $Path -Raw -Encoding UTF8
    if (-not $raw) { return $null }
    try { $db = $raw | ConvertFrom-Json -ErrorAction Stop } catch { return $null }
    if ($db.PSObject.Properties.Name -contains $Key) { return $db.$Key }
    return $null
}

function Set-TextSizeCacheEntry {
    param([Parameter(Mandatory)][string]$Key, [Parameter(Mandatory)]$Result, [string]$Path = $Global:TextSizeCachePath)
    if (-not (Test-Path -LiteralPath $Path)) {
        try { '{}' | Set-Content -LiteralPath $Path -Encoding UTF8 } catch {}
    }
    $lockPath = "$Path.lock"
    $sw = [Diagnostics.Stopwatch]::StartNew()
    while (Test-Path -LiteralPath $lockPath) {
        Start-Sleep -Milliseconds 50
        if ($sw.ElapsedMilliseconds -gt 5000) { break }
    }
    New-Item -ItemType File -Path $lockPath -Force | Out-Null
    try {
        $raw = if (Test-Path -LiteralPath $Path) { Get-Content -LiteralPath $Path -Raw -Encoding UTF8 } else { '{}' }
        if (-not $raw) { $raw = '{}' }
        $db = $raw | ConvertFrom-Json
        if ($null -eq $db) { $db = @{ } }
        $db | Add-Member -NotePropertyName $Key -NotePropertyValue $Result -Force
        ($db | ConvertTo-Json -Depth 6) | Set-Content -LiteralPath $Path -Encoding UTF8
    } finally {
        Remove-Item -LiteralPath $lockPath -Force -ErrorAction SilentlyContinue
    }
}
function InvokeIMChecks {
    # Check for latest Imagemagick Version
    if ($global:OSarch -eq "Arm64") {
        try {
            $global:CurrentImagemagickversion = & $magick -version
        }
        catch {
            Write-Entry -Message "Could not query installed Imagemagick" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Imagemagick missing"
            }
            Exit
        }
        $global:CurrentImagemagickversion = [regex]::Match($global:CurrentImagemagickversion, 'Version: ImageMagick (\d+(\.\d+){1,2}-\d+)')
        $global:CurrentImagemagickversion = $global:CurrentImagemagickversion.Groups[1].Value.replace('-', '.')
        Write-Entry -Message "Current Imagemagick Version: $global:CurrentImagemagickversion" -Path $configLogging -Color White -log Info
    }
    Else {
        # Check ImageMagick now:
        CheckImageMagick -magick $magick -magickinstalllocation $magickinstalllocation

        $global:CurrentImagemagickversion = & $magick -version
        $global:CurrentImagemagickversion = [regex]::Match($global:CurrentImagemagickversion, 'Version: ImageMagick (\d+(\.\d+){1,2}-\d+)')
        $global:CurrentImagemagickversion = $global:CurrentImagemagickversion.Groups[1].Value.replace('-', '.')
        Write-Entry -Message "Current Imagemagick Version: $global:CurrentImagemagickversion" -Path $configLogging -Color White -log Info
    }

    if ($global:OSType -eq "Docker") {
        #$OSVersionTag = (Get-Content /etc/os-release | Select-String -Pattern "^PRETTY_NAME=").ToString().Split('=')[1].Trim('"').replace('Alpine Linux ', '')
        $Url = "https://pkgs.alpinelinux.org/package/edge/community/x86_64/imagemagick"
        $response = Invoke-WebRequest -Uri $url
        $htmlContent = $response.Content
        $regexPattern = '<th class="header">Version<\/th>\s*<td>\s*<strong[^>]*>([\d\.]+-r\d+)<\/strong>'
        $Versionmatching = [regex]::Matches($htmlContent, $regexPattern)

        if ($Versionmatching.Count -gt 0) {
            $global:LatestImagemagickversion = $Versionmatching[0].Groups[1].Value.split('-')[0]
        }
        <#
        $Url = "https://raw.githubusercontent.com/SoftCreatR/imei/main/versions/imagemagick.version"
        $response = Invoke-WebRequest -Uri $url
        $htmlContent = $response.Content
        $regexPattern = '(\d+\.\d+\.\d+-\d+)'
        $Versionmatching = [regex]::Matches($htmlContent, $regexPattern)

        if ($Versionmatching.Count -gt 0) {
            $global:LatestImagemagickversion = $Versionmatching[0].Value
        }
    #>
    }
    Elseif ($global:OSType -eq "Win32NT") {
        try {
            $Url = "https://imagemagick.org/archive/binaries/?C=M;O=D"
            $result = Invoke-WebRequest -Uri $Url -ErrorAction Stop

            $global:LatestImagemagickversion = ($result.links.href |
                Where-Object { $_ -like '*portable-Q16-HDRI-x64.zip' } |
                Sort-Object -Descending)[0] -replace '-portable-Q16-HDRI-x64.zip', '' -replace 'ImageMagick-', ''
        }
        catch {
            # Fallback to GitHub API if direct access is forbidden or fails
            Write-Entry -Subtext "Primary method failed. Falling back to GitHub API..." -Path $configLogging -Color Yellow -log Debug
            $global:LatestImagemagickversion = (Invoke-RestMethod -Uri "https://api.github.com/repos/ImageMagick/ImageMagick/releases/latest" -Method Get).tag_name
        }
    }
    Else {
        $global:LatestImagemagickversion = (Invoke-RestMethod -Uri "https://api.github.com/repos/ImageMagick/ImageMagick/releases/latest" -Method Get).tag_name
    }
    if ($global:LatestImagemagickversion) {
        $global:LatestImagemagickversiontemp = $global:LatestImagemagickversion
        $global:LatestImagemagickversion = $global:LatestImagemagickversion.replace('-', '.')
        Write-Entry -Subtext "Latest Imagemagick Version: $global:LatestImagemagickversion" -Path $configLogging -Color Yellow -log Info
    }

    # Auto Update Magick
    if ($AutoUpdateIM -eq 'true' -and $global:OSType -ne "Docker" -and $global:OSType -eq "Win32NT" -and $global:LatestImagemagickversion -gt $global:CurrentImagemagickversion -and $global:OSarch -ne "Arm64") {
        Remove-Item -LiteralPath "$global:ScriptRoot/magick" -Force

        if ($global:OSType -ne "Win32NT") {
            if ($global:OSType -ne "Docker") {
                Write-Entry -Subtext "Downloading the latest Imagemagick portable version for you..." -Path $configLogging -Color Cyan -log Info
                $magickUrl = "https://imagemagick.org/archive/binaries/magick"
                Invoke-WebRequest -Uri $magickUrl -OutFile "$global:ScriptRoot/magick"
                chmod +x "$global:ScriptRoot/magick"
                Write-Entry -Subtext "Made the portable Magick executable..." -Path $configLogging -Color Green -log Info
            }
        }
    }
}
function Output-ConfigJson {
    param (
        $obj,
        [int]$indentLevel = 0
    )
    function RedactUrl($value) {
        if ($null -eq $value) { return $null }
        if ($value.Length -le 10) { return $value }
        return ($value[0..9] -join '') + '****'
    }
    function RedactKey($value) {
        if ($null -eq $value) { return $null }
        # If the string is 1 character or less, return it as-is.
        if ($value.Length -le 1) {
            return $value
        }
        # For any string longer than 1 char, show the first char and then redact.
        return $value.Substring(0, 1) + '****'
    }
    $redactKeys = @("tvdbapi", "tmdbtoken", "fanarttvapikey", "plextoken", "jellyfinapikey", "embyapikey", "embyurl", "jellyfinurl", "discord", "plexurl", "UptimeKumaUrl", "AppriseUrl", "basicAuthPassword","basicAuthUsername")
    $indent = '  ' * $indentLevel

    if ($indentLevel -eq 0) {
        foreach ($section in $obj.PSObject.Properties) {
            Write-Entry "===== $($section.Name) =====" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Output-ConfigJson -obj $section.Value -indentLevel 1
        }
        return
    }

    if ($obj -is [System.Management.Automation.PSCustomObject] -or $obj -is [Hashtable]) {
        foreach ($prop in $obj.PSObject.Properties) {
            $keyLower = $prop.Name.ToLower()
            $val = $prop.Value

            if ($redactKeys -contains $keyLower) {
                if ($keyLower.EndsWith("url")) {
                    $redacted = RedactUrl $val
                }
                else {
                    $redacted = RedactKey $val
                }
                Write-Entry -Subtext "$indent$($prop.Name): $redacted" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            }
            elseif ($val -is [System.Management.Automation.PSCustomObject] -or $val -is [Hashtable]) {
                # For nested objects, print key with colon and then recurse with increased indent
                Write-Entry -Subtext "$indent$($prop.Name):" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                Output-ConfigJson -obj $val -indentLevel ($indentLevel + 1)
            }
            elseif ($val -is [System.Collections.IEnumerable] -and -not ($val -is [string])) {
                # For arrays/lists, join with comma and print on the same line
                $joined = ($val | ForEach-Object { $_ }) -join ", "
                Write-Entry -Subtext "$indent$($prop.Name): $joined" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            }
            else {
                Write-Entry -Subtext "$indent$($prop.Name): $val" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            }
        }
    }
    else {
        Write-Entry -Subtext ("{0}{1}" -f ('  ' * $indentLevel), $obj) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
}
function Initialize-LanguageSettings {
    param (
        [string]$SettingName, # e.g. "PreferredLanguageOrder"
        [string]$Label,       # e.g. "Poster"
        [string[]]$Default = @("xx", "en", "de")
    )

    # Get the starting value (global if exists, else default)
    if (Get-Variable -Name $SettingName -Scope Global -ErrorAction SilentlyContinue) {
        $valueToValidate = (Get-Variable -Name $SettingName -Scope Global).Value
    }
    else {
        $valueToValidate = $Default
        Write-Entry -Message "$Label search Order not set in Config, setting it to '$($Default -join ",")'" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
    }

    # Log and remove invalid entries (> 2 chars and not "xx")
    $invalids = $valueToValidate | Where-Object { $_ -ne 'xx' -and $_.Length -ne 2 }
    foreach ($inv in $invalids) {
        Write-Entry -Message "$Label search Order contains invalid language code '$inv' (must be exactly 2 chars), removing it." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
    }

    $validLangs = $valueToValidate | Where-Object { $_ -eq 'xx' -or ($_ -match '^[a-z]{2}$') }

    # Fallback to default if empty after filtering
    if (-not $validLangs -or $validLangs.Count -eq 0) {
        $validLangs = $Default
        Write-Entry -Message "$Label order invalid after filtering, using default '$($Default -join ",")'" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
    }

    # Always overwrite the global variable
    Set-Variable -Name $SettingName -Scope Global -Value $validLangs -Force

    # Derived variants
    Set-Variable -Name "${SettingName}TMDB"   -Scope Global -Value $validLangs
    Set-Variable -Name "${SettingName}Fanart" -Scope Global -Value ($validLangs -replace '^xx$', '00')
    Set-Variable -Name "${SettingName}TVDB"   -Scope Global -Value ($validLangs -replace '^xx$', 'null')

    # Flags
    if ($validLangs -contains 'xx' -and $validLangs.Count -eq 1) {
        Set-Variable -Name "${Label}PreferTextless" -Scope Global -Value $true
        Set-Variable -Name "${Label}OnlyTextless"   -Scope Global -Value $true
    }
    elseif ($validLangs[0] -eq 'xx') {
        Set-Variable -Name "${Label}PreferTextless" -Scope Global -Value $true
        Set-Variable -Name "${Label}OnlyTextless"   -Scope Global -Value $false
    }
    else {
        Set-Variable -Name "${Label}PreferTextless" -Scope Global -Value $false
        Set-Variable -Name "${Label}OnlyTextless"   -Scope Global -Value $false
    }

    # Debug logs

    $preferTextless = (Get-Variable -Name "${Label}PreferTextless" -Scope Global).Value
    $onlyTextless = (Get-Variable -Name "${Label}OnlyTextless" -Scope Global).Value

    Write-Entry -Subtext "$Label PreferTextless Value: $preferTextless" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug
    Write-Entry -Subtext "$Label OnlyTextless Value: $onlyTextless" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

}
function Test-PathPermissions {
    param (
        [string]$PathToTest
    )

    # Extract drive (if any) from the path (Windows paths like P:\assetsbackup)
    $driveLetter = ($PathToTest -split ':')[0]

    # If path starts with a drive letter but that drive doesn't exist, log and skip
    if ($PathToTest -match '^[A-Za-z]:\\' -and -not (Get-PSDrive -Name $driveLetter -ErrorAction SilentlyContinue)) {
        Write-Entry -Message "Drive '$($driveLetter):' not found. The path '$PathToTest' appears to use a Windows-style default." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        Write-Entry -Subtext "Please update this path to a valid mount (e.g., /assetsbackup)." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Info
        Write-Entry -Message "Refer to the official docker-compose.yml template for correct volume mappings:" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Info
        Write-Entry -Subtext "https://raw.githubusercontent.com/fscorrupt/posterizarr/refs/heads/main/docker-compose.yml" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Info
        return
    }

    # Check if directory exists
    $canRead = Test-Path $PathToTest -PathType Container -ErrorAction SilentlyContinue

    # Check write access
    $testFile = Join-Path $PathToTest ".perm_check"

    try {
        New-Item -ItemType File -Path $testFile -Force -ErrorAction Stop | Out-Null
        Remove-Item $testFile -Force
        $canWrite = $true
    }
    catch {
        $canWrite = $false
    }

    if ($canRead -and $canWrite) {
        Write-Entry -Message "You have read and write permissions to $PathToTest" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
    }
    else {
        Write-Entry -Message "You do NOT have read and/or write permissions to $PathToTest" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        if ($PathToTest -eq $AssetPath) {
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Perm issues on /assets"
            }
            Exit  # Abort the script
        }
    }
}


function Reset-PlexLibraryPictures {
    param (
        [string]$LibraryName
    )

    # Fetch the sections of the Plex library
    try {
        if ($PlexToken) {
            $sections = Invoke-RestMethod -Uri "$PlexUrl/library/sections?X-Plex-Token=$PlexToken"
        }
        Else {
            $sections = Invoke-RestMethod -Uri "$PlexUrl/library/sections"
        }
    }
    catch {
        Write-Entry -Subtext "Error fetching sections: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        return
    }

    $section = $sections.MediaContainer.Directory | Where-Object { $_.title -eq $LibraryName }

    if (-not $section) {
        Write-Entry -Subtext "Library not found: $LibraryName" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        return
    }

    # Determine if the library is a show or not
    $IsShow = $null
    if ($section.type -eq "show") {
        $ContainerUrl = "directory"
        $IsShow = 'True'
    }
    Else {
        $ContainerUrl = "video"
        $IsShow = 'False'
    }

    $PlexHeaders = @{}
    # Default headers for Plex API requests
    $PlexHeaders['X-Plex-Container-Size'] = '1000'

    if ($PlexToken) {
        $PlexHeaders['X-Plex-Token'] = $PlexToken
    }

    # Fetch all items in the library
    try {
        $url = "$PlexUrl/library/sections/$($section.key)/all"
        $items = Invoke-RestMethod -Uri $url -Headers $PlexHeaders
    }
    catch {
        Write-Entry -Subtext "Error fetching library items: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
        return
    }

    foreach ($item in $items.MediaContainer.$ContainerUrl) {
        $title = $item.title
        $ratingKey = $item.ratingKey
        Write-Entry -Message "Current Show/Movie: $title [$ratingKey]" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

        # If the item is a show, handle seasons and episodes
        if ($IsShow -eq 'True') {
            try {
                $SeasondataUrl = "$PlexUrl/library/metadata/$ratingKey/children?"
                $Seasondata = Invoke-RestMethod -Uri $SeasondataUrl -Headers $PlexHeaders
            }
            catch {
                Write-Entry -Subtext "Error fetching season data for show [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                continue
            }

            foreach ($season in $Seasondata.MediaContainer.Directory) {
                $SeasonratingKey = $season.ratingKey
                Write-Entry -Subtext "Season $($season.index): $($season.title) [$SeasonratingKey]" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

                # Get posters for the season
                try {
                    $seasonposterUrls = "$PlexUrl/library/metadata/$SeasonratingKey/posters?"
                    $seasonposters = Invoke-RestMethod -Uri $seasonposterUrls -Headers $PlexHeaders
                }
                catch {
                    Write-Entry -Subtext "Error fetching season posters for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                    continue
                }

                if ($seasonposters.MediaContainer.Photo.Count -gt 0) {
                    $firstPosterKey = $seasonposters.MediaContainer.Photo[0].ratingKey -replace "^metadata://posters/", ""
                    $setPosterUrl = "$PlexUrl/library/metadata/$SeasonratingKey/poster?url=$firstPosterKey"

                    try {
                        $response = Invoke-RestMethod -Uri $setPosterUrl -Method PUT -Headers $PlexHeaders
                        Write-Entry -Subtext "Poster was reset for: $title (Season $($season.index))" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
                    }
                    catch {
                        Write-Entry -Subtext "Error setting Season poster for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                    }
                }
                else {
                    Write-Entry -Subtext "No Season posters found for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
                }

                # Fetch episodes for the season
                try {
                    $EpisodedataUrl = "$PlexUrl/library/metadata/$SeasonratingKey/children?"
                    $Episodedata = Invoke-RestMethod -Uri $EpisodedataUrl -Headers $PlexHeaders
                }
                catch {
                    Write-Entry -Subtext "Error fetching episode data for season [$SeasonratingKey]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                    continue
                }

                foreach ($episode in $Episodedata.MediaContainer.Video) {
                    $EpisodeRatingKey = $episode.ratingKey
                    Write-Entry -Subtext "Season $($season.index) - Episode $($episode.index): $($episode.title) [$EpisodeRatingKey]" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Debug

                    # Get posters for the episode
                    try {
                        $EpisodeposterUrls = "$PlexUrl/library/metadata/$EpisodeRatingKey/posters?"
                        $EpisodePosters = Invoke-RestMethod -Uri $EpisodeposterUrls -Headers $PlexHeaders
                    }
                    catch {
                        Write-Entry -Subtext "Error fetching episode posters for [$episode.title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                        continue
                    }

                    if ($EpisodePosters.MediaContainer.Photo.Count -gt 0) {
                        $firstPosterKey = $EpisodePosters.MediaContainer.Photo[0].ratingKey -replace "^metadata://posters/", ""
                        $setPosterUrl = "$PlexUrl/library/metadata/$EpisodeRatingKey/poster?url=$firstPosterKey"

                        try {
                            $response = Invoke-RestMethod -Uri $setPosterUrl -Method PUT -Headers $PlexHeaders
                            Write-Entry -Subtext "Poster was reset for: $title (Season $($season.index) - Episode $($episode.index))" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
                        }
                        catch {
                            Write-Entry -Subtext "Error setting Episode poster for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
                        }
                    }
                    else {
                        Write-Entry -Subtext "No Episode posters found for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
                    }
                }
            }
        }

        # Get posters for the main show
        try {
            $postersUrl = "$PlexUrl/library/metadata/$ratingKey/posters?"
            $posters = Invoke-RestMethod -Uri $postersUrl -Headers $PlexHeaders
        }
        catch {
            Write-Entry -Subtext "Error fetching posters for main show [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
            continue
        }

        if ($posters.MediaContainer.Photo.Count -gt 0) {
            $firstPosterKey = $posters.MediaContainer.Photo[0].ratingKey -replace "^metadata://posters/", ""
            $setPosterUrl = "$PlexUrl/library/metadata/$ratingKey/poster?url=$firstPosterKey"

            try {
                $response = Invoke-RestMethod -Uri $setPosterUrl -Method PUT -Headers $PlexHeaders
                Write-Entry -Subtext "Poster was reset for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
            }
            catch {
                Write-Entry -Subtext "Error setting poster for [$title]: $_" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
            }
        }
        else {
            Write-Entry -Subtext "No posters found for: $title" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        }

        Start-Sleep -Seconds 1  # Avoid hammering server
    }
}
function Get-Resolution {
    param ($Width)
    switch ($true) {
        ($Width -ge 7680) { return "8K" }
        ($Width -ge 5120) { return "5K" }
        ($Width -ge 3840) { return "4K" }
        ($Width -ge 2560) { return "1440p" }
        ($Width -ge 1920) { return "1080p" }
        ($Width -ge 1280) { return "720p" }
        ($Width -ge 854) { return "480p" }
        ($Width -ge 640) { return "360p" }
        ($Width -ge 426) { return "240p" }
        default { return "unknown" }
    }
}
function Get-CPUModel {
    if ($Platform -eq 'Docker') {
        $cpuInfo = cat /proc/cpuinfo | Out-String
        $cpuModelLine = $cpuInfo -split "`n" | Where-Object { $_ -like "model name*" }
        $cpuModel = $cpuModelLine -replace "model name\s*:\s*", ""
        $cpuModel = $cpuModel[0]
    }
    Elseif ($Platform -eq 'Windows') {
        $cpuModel = (Get-CimInstance win32_processor).name
    }
    Elseif ($Platform -eq 'Linux') {
        $cpuInfo = lscpu | Out-String
        $cpuInfoLines = $cpuInfo -split "`n"
        $cpuModel = ($cpuInfoLines | Where-Object { $_ -like "Model name*" }) -replace "Model name\s*:\s*", ""
    }
    Elseif ($Platform -eq 'macOS') {
        $cpuModel = system_profiler SPHardwareDataType | grep "Processor Name" | awk -F': ' '{print $2}' | xargs
    }
    Else {
        $cpuModel = 'Unknown'
    }
    return $cpuModel
}
function GetHash {
    param ([byte[]]$imageBytes)

    # Create a hash algorithm instance (SHA256)
    $hashAlgorithm = [System.Security.Cryptography.SHA256]::Create()

    # Compute the hash from the byte array
    $hashBytes = $hashAlgorithm.ComputeHash($imageBytes)

    # Convert the hash bytes to a readable hex string
    $hashString = [BitConverter]::ToString($hashBytes) -replace "-", ""
    return $hashString
}
function Set-OSTypeAndScriptRoot {
    if ($env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
        $global:OSType = "Docker"
        $currentuser = whoami
        if ($currentuser -eq 'posterizarr' -or $currentuser -eq 'abc' -or $env:VIRTUAL_ENV -eq '/lsiopy' -or $env:POSTERIZARR_NON_ROOT -eq 'TRUE') {
            $global:ScriptRoot = "/config"
        }
        Else {
            $global:ScriptRoot = "./config"
        }
    }
    elseif ($env:APP_DATA) {
        $global:ScriptRoot = $env:APP_DATA
    }
    Else {
        $global:ScriptRoot = $PSScriptRoot
        $global:OSType = [System.Environment]::OSVersion.Platform
    }
}
function Write-Entry {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$Path,

        [Parameter(Mandatory = $false)]
        [string]$Message,

        [Parameter(Mandatory = $true)]
        [ValidateSet('Info', 'Warning', 'Error', 'Optional', 'Debug', 'Trace', 'Success')]
        [string]$log,

        [Parameter(Mandatory = $true)]
        [ValidateSet('White', 'Yellow', 'Red', 'Blue', 'DarkMagenta', 'Cyan', 'Green')]
        [string]$Color,

        [string]$Subtext = $null
    )
    switch ($log) {
        'Info' { $theLog = 2 }
        'Warning' { $theLog = 1 }
        'Error' { $theLog = 1 }
        'Debug' { $theLog = 3 }
        'Optional' { $theLog = 3 }
    }
    if (!(Test-Path -path $path)) {
        New-Item -Path $Path -Force | out-null
    }
    # ASCII art header
    if (-not $global:HeaderWritten) {
        # Retrieve CPU model
        $cpuModel = Get-CPUModel
        # Retrieve RAM Info
        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
            # Check Memory Usage (Total and Free)
            $memoryUsage = free -m | Out-String
            $memoryUsageLines = $memoryUsage -split "`n"
            $memValues = $memoryUsageLines[1] -split "\s+"

            $totalMemory = [int]$memValues[1]
            $usedMemory = [int]$memValues[2]
            $freeMemory = [int]$memValues[3]
            $sharedMemory = [int]$memValues[4]
            $buffersCache = [int]$memValues[5]
            $availableMemory = [int]$memValues[6]
            if (Test-Path /etc/os-release) {
                $OSVersion = (Get-Content /etc/os-release | Select-String -Pattern "^PRETTY_NAME=").ToString().Split('=')[1].Trim('"')
            }
            $Header = @"
======================================================
  _____          _            _
 |  __ \        | |          (_)
 | |__) |__  ___| |_ ___ _ __ _ ______ _ _ __ _ __
 |  ___/ _ \/ __| __/ _ \ '__| |_  / _``` | '__| '__|
 | |  | (_) \__ \ ||  __/ |  | |/ / (_| | |  | |
 |_|   \___/|___/\__\___|_|  |_/___\__,_|_|  |_|

 Current Version: $CurrentScriptVersion
 Latest Version: $LatestScriptVersion
 Platform: $Platform
 OS Version: $OSVersion
 Branch: $Branch

 CPU Model: $cpuModel

 Total Memory: $totalMemory MB
 Used Memory: $usedMemory MB
 Free Memory: $freeMemory MB
 Shared Memory: $sharedMemory MB
 Buffers/Cache: $buffersCache MB
 Available: $availableMemory MB
 ======================================================
"@
        }
        Elseif ($Platform -eq 'Windows') {
            # Retrieve memory information in GB or MB
            $memoryInfo = Get-CimInstance Win32_OperatingSystem | Select-Object @{Name = "FreePhysicalMemory"; Expression = {
                    if ($_.FreePhysicalMemory -ge 1GB) {
                        "$([math]::Round($_.FreePhysicalMemory / 1GB, 2)) MB"
                    }
                    elseif ($_.FreePhysicalMemory -ge 1MB) {
                        "$([math]::Round($_.FreePhysicalMemory / 1MB, 2)) GB"
                    }
                    else {
                        "$($_.FreePhysicalMemory)"
                    } }
            },
            @{Name = "TotalVisibleMemorySize"; Expression = {
                    if ($_.TotalVisibleMemorySize -ge 1GB) {
                        "$([math]::Round($_.TotalVisibleMemorySize / 1GB, 2)) MB"
                    }
                    elseif ($_.TotalVisibleMemorySize -ge 1MB) {
                        "$([math]::Round($_.TotalVisibleMemorySize / 1MB, 2)) GB"
                    }
                    else {
                        "$($_.TotalVisibleMemorySize)"
                    }
                }
            },
            @{Name = "UsedMemory"; Expression = {
                    $totalMemory = $_.TotalVisibleMemorySize
                    $freeMemory = $_.FreePhysicalMemory
                    $usedMemory = $totalMemory - $freeMemory

                    if ($usedMemory -ge 1GB) {
                        "$([math]::Round($usedMemory / 1GB, 2)) MB"
                    }
                    elseif ($usedMemory -ge 1MB) {
                        "$([math]::Round($usedMemory / 1MB, 2)) GB"
                    }
                    else {
                        $usedMemory
                    }
                }
            }
            $totalMemory = $memoryInfo.TotalVisibleMemorySize
            $usedMemory = $memoryInfo.UsedMemory
            $freeMemory = $memoryInfo.FreePhysicalMemory
            $OSVersion = (Get-CimInstance -class Win32_OperatingSystem).Caption
            $Header = @"
======================================================
  _____          _            _
 |  __ \        | |          (_)
 | |__) |__  ___| |_ ___ _ __ _ ______ _ _ __ _ __
 |  ___/ _ \/ __| __/ _ \ '__| |_  / _``` | '__| '__|
 | |  | (_) \__ \ ||  __/ |  | |/ / (_| | |  | |
 |_|   \___/|___/\__\___|_|  |_/___\__,_|_|  |_|

 Current Version: $CurrentScriptVersion
 Latest Version: $LatestScriptVersion
 Platform: $Platform
 OS Version: $OSVersion
 Branch: $Branch

 CPU Model: $cpuModel

 Total Memory: $totalMemory
 Used Memory: $usedMemory
 Free Memory: $freeMemory
 ======================================================
"@
        }
        Else {
            $Header = @"
======================================================
  _____          _            _
 |  __ \        | |          (_)
 | |__) |__  ___| |_ ___ _ __ _ ______ _ _ __ _ __
 |  ___/ _ \/ __| __/ _ \ '__| |_  / _``` | '__| '__|
 | |  | (_) \__ \ ||  __/ |  | |/ / (_| | |  | |
 |_|   \___/|___/\__\___|_|  |_/___\__,_|_|  |_|

 Current Version: $CurrentScriptVersion
 Latest Version: $LatestScriptVersion
 Platform: $Platform
 Branch: $Branch
 CPU Model: $cpuModel
 ======================================================
"@
        }
        Write-Host $Header
        $Header | Out-File $Path -Append
        $global:HeaderWritten = $true
    }
    if ($theLog -le $global:logLevel) {
        $Timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        $PaddedType = "[" + $log + "]"
        $PaddedType = $PaddedType.PadRight(10)
        $Linenumber = "L" + "." + "$($MyInvocation.ScriptLineNumber)"
        if ($Linenumber.Length -eq '4') {
            $Linenumber = $Linenumber + "   "
        }
        if ($Linenumber.Length -eq '5') {
            $Linenumber = $Linenumber + "  "
        }
        if ($Linenumber.Length -eq '6') {
            $Linenumber = $Linenumber + " "
        }
        $TypeFormatted = "[{0}] {1}|{2}" -f $Timestamp, $PaddedType.ToUpper(), $Linenumber

        if ($Message) {
            $FormattedLine1 = "{0}| {1}" -f ($TypeFormatted, $Message)
            $FormattedLineWritehost = "{0}| " -f ($TypeFormatted)
        }

        if ($Subtext) {
            $FormattedLine = "{0}|      {1}" -f ($TypeFormatted, $Subtext)
            $FormattedLineWritehost = "{0}|      " -f ($TypeFormatted)
            Write-Host $FormattedLineWritehost -NoNewline
            Write-Host $Subtext -ForegroundColor $Color
            $FormattedLine | Out-File $Path -Append
        }
        else {

            Write-Host $FormattedLineWritehost -NoNewline
            Write-Host $Message -ForegroundColor $Color
            $FormattedLine1 | Out-File $Path -Append
        }
    }
}
function SendMessage {
    param(
        [string]$type,
        [string]$title,
        [string]$Lib,
        [string]$DLSource,
        [string]$lang,
        [string]$favurl,
        [string]$fallback,
        [string]$truncated
    )
    function Build-DiscordPayload {

        # Create a list for the fields
        $fieldList = [System.Collections.Generic.List[object]]::new()

        # Add all common fields
        $fieldList.Add([PSCustomObject]@{ name = ""; value = ":bar_chart:"; inline = $false })
        $fieldList.Add([PSCustomObject]@{ name = "Type"; value = $type; inline = $false })
        $fieldList.Add([PSCustomObject]@{ name = "Fallback"; value = $fallback; inline = $true })
        $fieldList.Add([PSCustomObject]@{ name = "Language"; value = $lang; inline = $true })
        $fieldList.Add([PSCustomObject]@{ name = "Truncated"; value = $truncated; inline = $true })

        # Add conditional fields
        if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
            $fieldList.Add([PSCustomObject]@{ name = "TBA Skipped"; value = "$SkipTBACount"; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Jap/Chinese Skipped"; value = "$SkipJapTitleCount"; inline = $true })
        }

        # Add remaining fields
        $fieldList.Add([PSCustomObject]@{ name = ""; value = ":frame_photo:"; inline = $false })

        # Add the title. ConvertTo-Json will handle any special characters in $title
        $fieldList.Add([PSCustomObject]@{ name = "Title"; value = $title; inline = $false })

        $fieldList.Add([PSCustomObject]@{ name = "Library"; value = $Lib; inline = $true })

        # Add the URL. ConvertTo-Json will handle any special characters in $favurl
        $fieldList.Add([PSCustomObject]@{ name = "Fav Url"; value = $favurl; inline = $true })

        # Build the final payload object
        $payloadObject = [PSCustomObject]@{
            username   = $global:DiscordUserName
            avatar_url = "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/docs/images/webhook.png"
            content    = ""
            embeds     = @(
                [PSCustomObject]@{
                    author      = @{
                        name = "Posterizarr @Github"
                        url  = "https://github.com/fscorrupt/posterizarr"
                    }
                    description = "Recently Added`n`n"
                    timestamp   = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
                    color       = $(if ($errorCount -ge '1') { 16711680 } Elseif ($global:IsFallback -eq 'true' -or $global:IsTruncated -eq 'true') { 15120384 } Else { 5763719 })
                    fields      = $fieldList
                    thumbnail   = @{
                        url = $DLSource
                    }
                    footer      = @{
                        text = "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $global:CurrentImagemagickversion | IM vNext: $global:LatestImagemagickversion"
                    }
                }
            )
        }

        # Convert the entire object to a JSON string safely
        # -Depth 6 is needed to make sure it nests everything (payload->embeds->fields)
        return $payloadObject | ConvertTo-Json -Depth 6
    }

    if ($global:NotifyUrl -and $global:SendNotification -eq 'true') {

        # Handle Discord notifications
        if ($global:NotifyUrl -like '*discord*') {
            $jsonPayload = Build-DiscordPayload
            $webhookUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
            Push-ObjectToDiscord -strDiscordWebhook $webhookUrl -objPayload $jsonPayload
        }

        # Handle Apprise notifications
        Elseif ($env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
            if ($errorCount -ge '1') {
                apprise --notification-type="failure" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images`n`nDuring execution '$errorCount' Errors occurred, please check log for detailed description." "$global:NotifyUrl"
            }
            Else {
                apprise --notification-type="success" --title="Posterizarr" --body="Run took: $FormattedTimespawn`nIt Created '$posterCount' Images" "$global:NotifyUrl"
            }
        }
    }
}
function AddTrailingSlash($path) {
    if (-not ($path -match '[\\/]$')) {
        $path += if ($path -match '\\') { '\' } else { '/' }
    }
    return $path
}
function RemoveTrailingSlash($path) {
    if ($path -match '[\\/]$') {
        $path = $path.TrimEnd('\', '/')
    }
    return $path
}
function Get-OptimalPointSize {
    param(
        [string]$text,
        [string]$fontImagemagick,
        [int]$box_width,
        [int]$box_height,
        [int]$min_pointsize,
        [int]$max_pointsize,
        [int]$lineSpacing  # New parameter for line height
    )

    # ----- Text size cache: try hit -----
    try {
        if (-not $script:IMVersion) { $script:IMVersion = (& $magick -version | Select-Object -First 1) }
    } catch {}
    $__tsc_Params = @{
        font=$fontImagemagick; w=$box_width; h=$box_height;
        min=$min_pointsize; max=$max_pointsize; line=$lineSpacing;
        imv=$script:IMVersion; algo='Get-OptimalPointSize-v1'
    }
    $__tsc_Key  = New-TextSizeCacheKey -Text $text -Params $__tsc_Params
    $__tsc_Path = if ($Global:TextSizeCachePath) { $Global:TextSizeCachePath } else { Join-Path $global:ScriptRoot 'Cache\text_size_cache.json' }
    $__tsc_Hit  = Get-TextSizeFromCache -Key $__tsc_Key -Path $__tsc_Path
    if ($__tsc_Hit) {
        if ($__tsc_Hit.PSObject.Properties.Name -contains 'isTruncated') { $global:IsTruncated = [bool]$__tsc_Hit.isTruncated } else { $global:IsTruncated = $null }
        $script:CurrentTextSizeSource = 'cache'
        $script:tsHits++   # [stats] count cache hits
        return [int]$__tsc_Hit.pointSize
    }
    # ----- /cache hit -----

    $global:IsTruncated = $null

    # Construct the command with interline spacing and font option
    $cmd = "& `"$magick`" -size ${box_width}x${box_height} -font `"$fontImagemagick`" -gravity center -fill black -interline-spacing ${lineSpacing} caption:`"$text`" -format `"%[caption:pointsize]`" info:"

    # Log the command for debugging purposes
    $cmd | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

    # [stats] start timing the “miss” compute path
    $tsc_sw = [Diagnostics.Stopwatch]::StartNew()

    # Execute the command and get the current point size
    $current_pointsize = [int](Invoke-Expression $cmd | Out-String).Trim()

    # Apply point size limits
    if ($current_pointsize -gt $max_pointsize) {
        $current_pointsize = $max_pointsize
    }
    elseif ($current_pointsize -lt $min_pointsize) {
        Write-Entry -Subtext "Text truncated! optimalFontSize: $current_pointsize below min_pointsize: $min_pointsize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        $global:IsTruncated = $true
        $current_pointsize = $min_pointsize
    }

    # [stats] stop timer and record miss metrics
    $tsc_sw.Stop()
    $script:tsMiss++
    $script:tsRuns++
    $script:tsMs += $tsc_sw.ElapsedMilliseconds

    # ----- cache store -----
    $__tsc_Save = [PSCustomObject]@{ pointSize = [int]$current_pointsize; isTruncated = [bool]$global:IsTruncated }
    Set-TextSizeCacheEntry -Key $__tsc_Key -Result $__tsc_Save -Path $__tsc_Path
    # ----- /cache store -----

    $script:CurrentTextSizeSource = 'calculated'
    return $current_pointsize
}

function GetTMDBMoviePoster {
    Write-Entry -Subtext "Searching on TMDB for a movie poster - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:PosterPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"

        }
        if ($response) {
            if ($response.images.posters) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                    $NoLangPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:PosterPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:PosterOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:PosterOnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.posters

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.posters

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.posters

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                }
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($global:FavProvider -eq 'TMDB') {
                                $global:Fallback = "fanart"
                                $global:tmdbfallbackposterurl = $global:posterurl
                            }
                            Write-Entry -Subtext "Found Poster with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $global:TMDBAssetTextLang = $response.images.posters[0].iso_639_1
                            }
                            Else {
                                $global:TMDBAssetTextLang = (($response.images.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                        return $global:posterurl
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null }
                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                            }

                        }
                        Else {
                            $filteredPosters = $response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            }
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                        return $global:posterurl
                    }
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=$($PreferredLanguageOrder[0])&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"

        }
        if ($response) {
            if ($response.images.posters) {
                foreach ($lang in $global:PreferredLanguageOrderTMDB) {
                    if ($lang -eq 'null' -or $lang -eq 'xx') {
                        if ($global:WidthHeightFilter -eq 'true') {
                            $FavPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            $FavPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                        }
                    }
                    Else {
                        if ($global:WidthHeightFilter -eq 'true') {
                            $FavPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.posters | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null' -or $lang -eq 'xx') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
                        }
                        return $global:posterurl
                        continue
                    }
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/posters"
        }
    }
}
function GetTMDBMovieBackground {
    Write-Entry -Subtext "Searching on TMDB for a movie background - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:BackgroundPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"

        }
        if ($response) {
            if ($response.images.backdrops) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                    $NoLangPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:BackgroundOnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.images.backdrops[0].file_path
                            }
                            Else {
                                $posterpath = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($global:FavProvider -eq 'TMDB') {
                                $global:Fallback = "fanart"
                                $global:tmdbfallbackposterurl = $global:posterurl
                            }
                            Write-Entry -Subtext "Found background with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $global:TMDBAssetTextLang = $response.images.backdrops[0].iso_639_1
                            }
                            Else {
                                $global:TMDBAssetTextLang = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                            return $global:posterurl
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null } | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless background on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                        return $global:posterurl
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -eq 'TMDB') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/movie/$($global:tmdbid)?append_to_response=images&language=$($PreferredBackgroundLanguageOrder[0])&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"

        }
        if ($response) {
            if ($response.images.backdrops) {
                foreach ($lang in $global:PreferredBackgroundLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                            $FavPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            Write-Entry -Subtext "Found background without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found background with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null' -or $lang -eq 'xx') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                        }
                        return $global:posterurl
                        continue
                    }
                }
                if (!$global:posterurl -and $global:WidthHeightFilter -eq 'false') {
                    Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
                if (!$global:posterurl -and $global:WidthHeightFilter -eq 'true') {
                    Write-Entry -Subtext "No Background found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -ne 'fanart') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/movie/$($global:tmdbid)/images/backdrops"
        }
    }
}
function GetTMDBShowPoster {
    Write-Entry -Subtext "Searching on TMDB for a show poster - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        $global:tmdbsearched = $true
    }
    Else {
        if ($global:PosterPreferTextless -eq $true) {
            try {
                $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
            catch {
                Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"

            }
            if ($response) {
                if ($response.images.posters) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        $NoLangPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                    }
                    Else {
                        $NoLangPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                    }
                    if (!$NoLangPoster) {
                        Write-Entry -Subtext "PreferTextless Value: $global:PosterPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:PosterOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:PosterOnlyTextless -eq $false) {
                            if ($global:WidthHeightFilter -eq 'true') {
                                if ($global:TMDBVoteSorting -eq 'primary') {
                                    $filteredPosters = $response.images.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                    if ($filteredPosters) {
                                        $posterpath = $filteredPosters[0].file_path
                                        $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                        Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                }
                                Else {
                                    $filteredPosters = $response.images.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                    if ($filteredPosters) {
                                        $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                        $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                        Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                }
                            }
                            Else {
                                if ($global:TMDBVoteSorting -eq 'primary') {
                                    $posterpath = $response.images.posters[0].file_path
                                    $global:TMDBAssetTextLang = $response.images.posters[0].iso_639_1
                                }
                                Else {
                                    $posterpath = (($response.images.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($response.images.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                }
                            }
                            if ($posterpath) {
                                $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                                if ($global:FavProvider -ne 'fanart') {
                                    $global:Fallback = "fanart"
                                    $global:tmdbfallbackposterurl = $global:posterurl
                                }
                                Write-Entry -Subtext "Found Poster with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:PosterWithText = $true

                                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                                return $global:posterurl
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                        }
                    }
                    Else {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = ($response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                                if ($posterpath) {
                                    $posterpath = $posterpath[0].file_path
                                }
                            }
                            Else {
                                $posterpath = ($response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null } | Sort-Object $global:TMDBVoteSorting -Descending)
                                if ($posterpath) {
                                    $posterpath = $posterpath[0].file_path
                                }
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            Write-Entry -Subtext "Found Textless Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                            return $global:posterurl
                        }
                    }
                    $global:tmdbsearched = $true
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                $global:tmdbsearched = $true
            }
        }
        Else {
            try {
                $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=$($PreferredLanguageOrder[0])&include_image_language=$($global:PreferredLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
            catch {
                Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"

            }
            if ($response) {
                if ($response.images.posters) {
                    foreach ($lang in $global:PreferredLanguageOrderTMDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null' -or $lang -eq 'xx') {
                                $FavPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                                $FavPoster = ($response.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            }
                            Else {
                                $FavPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            }
                        }
                        Else {
                            if ($lang -eq 'null' -or $lang -eq 'xx') {
                                $FavPoster = ($response.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                            }
                            Else {
                                $FavPoster = ($response.images.posters | Where-Object iso_639_1 -eq $lang)
                            }
                        }
                        if ($FavPoster) {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $FavPoster[0].file_path
                            }
                            Else {
                                $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                            }
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($lang -eq 'null' -or $lang -eq 'xx') {
                                Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:TextlessPoster = $true
                                $global:PosterWithText = $null
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null' -or $lang -eq 'xx') {
                                $global:PosterWithText = $true
                                $global:TMDBAssetTextLang = $lang
                                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                            }
                            return $global:posterurl
                            continue
                        }
                        $global:tmdbsearched = $true
                    }
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/posters"
                $global:tmdbsearched = $true
            }
        }
    }
}
function GetTMDBSeasonPoster {
    Write-Entry -Subtext "Searching on TMDB for Season '$global:SeasonNumber' poster - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:SeasonPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$global:SeasonNumber/images?append_to_response=images&language=xx&include_image_language=$($global:PreferredSeasonLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"

        }
        if ($response) {
            if ($response.posters) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) })
                }
                Write-Entry -Subtext "NoLangPoster: $NoLangPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                if (!$NoLangPoster) {
                    if (!$global:SeasonOnlyTextless) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.poster | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.posters | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.posters[0].file_path
                                $global:TMDBAssetTextLang = $response.posters[0].iso_639_1
                            }
                            Else {
                                $posterpath = (($response.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                $global:TMDBAssetTextLang = (($response.posters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            Write-Entry -Subtext "Found Season Poster with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                            $global:TMDBSeasonFallback = $global:posterurl
                            Write-Entry -Subtext "Posterpath: $posterpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterUrl: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TMDBAssetTextLang: $global:TMDBAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TMDBAssetChangeUrl: $global:TMDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TMDBSeasonFallback: $global:TMDBSeasonFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            return $global:posterurl
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Found Season Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Season posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null } | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless Season Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                        Write-Entry -Subtext "Posterpath: $posterpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterUrl: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TextlessPoster: $global:TextlessPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TMDBAssetChangeUrl: $global:TMDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        return $global:posterurl
                    }
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
            }
        }
        Else {
            Write-Entry -Subtext "No Season Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
        }
    }
    Else {
        try {
            if ($global:SeasonNumber -match '\b\d{1,2}\b') {
                $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$global:SeasonNumber/images?append_to_response=images&language=$($global:PreferredSeasonLanguageOrder[0])&include_image_language=$($global:PreferredSeasonLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
            Else {
                $responseBackup = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=$($global:PreferredSeasonLanguageOrder[0])&include_image_language=$($global:PreferredSeasonLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
            }
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"

        }
        if ($responseBackup) {
            if ($responseBackup.images.posters) {
                Write-Entry -Subtext "Could not get a result with '$global:SeasonNumber' on TMDB, likely season number not in correct format, fallback to Show poster." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                foreach ($lang in $global:PreferredSeasonLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($responseBackup.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            $FavPoster = ($responseBackup.images.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($responseBackup.images.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($responseBackup.images.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                        }
                        Else {
                            $FavPoster = ($responseBackup.images.posters | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null' -or $lang -eq 'xx') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                        }
                        Write-Entry -Subtext "Posterpath: $posterpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterUrl: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TMDBAssetTextLang: $global:TMDBAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TMDBAssetChangeUrl: $global:TMDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        return $global:posterurl
                        continue
                    }
                }
            }
        }
        if ($response) {
            if ($response.posters) {
                foreach ($lang in $global:PreferredSeasonLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            $FavPoster = ($response.posters | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.posters | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.posters | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                        }
                        Else {
                            $FavPoster = ($response.posters | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            Write-Entry -Subtext "Found Poster without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null' -or $lang -eq 'xx') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
                        }
                        return $global:posterurl
                        continue
                    }
                }
            }
            Else {
                Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
            }
        }
        Else {
            Write-Entry -Subtext "No Season Poster on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:SeasonNumber/images/posters"
        }

    }
}
function GetTMDBShowBackground {
    Write-Entry -Subtext "Searching on TMDB for a show background - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:BackgroundPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=xx&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"

        }
        if ($response) {
            if ($response.images.backdrops) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                    $NoLangPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:BackgroundOnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.images.backdrops | Where-Object { $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.images.backdrops[0].file_path
                                $global:TMDBAssetTextLang = $response.images.backdrops[0].iso_639_1
                            }
                            Else {
                                $posterpath = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                $global:TMDBAssetTextLang = (($response.images.backdrops | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            if ($global:FavProvider -ne 'fanart') {

                                $global:Fallback = "fanart"
                                $global:tmdbfallbackposterurl = $global:posterurl
                            }
                            Write-Entry -Subtext "Found background with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No Background posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null } | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless background on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                        return $global:posterurl
                    }
                }
                if (!$global:posterurl) {
                    Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -ne 'fanart') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)?append_to_response=images&language=$($PreferredBackgroundLanguageOrder[0])&include_image_language=$($global:PreferredBackgroundLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"

        }
        if ($response) {
            if ($response.images.backdrops) {
                foreach ($lang in $global:PreferredBackgroundLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                            $FavPoster = ($response.images.backdrops | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.images.backdrops | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                        }
                        Else {
                            $FavPoster = ($response.images.backdrops | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            Write-Entry -Subtext "Found background without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found background with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null' -or $lang -eq 'xx') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                        }
                        return $global:posterurl
                        continue
                    }
                }
                if (!$global:posterurl) {
                    Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                    if ($global:FavProvider -ne 'fanart') {
                        $global:Fallback = "fanart"
                    }
                }
            }
            Else {
                Write-Entry -Subtext "No Background found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
                if ($global:FavProvider -ne 'fanart') {
                    $global:Fallback = "fanart"
                }
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/images/backdrops"
        }
    }
}
function GetTMDBTitleCard {
    Write-Entry -Subtext "Searching on TMDB for: $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card - TMDBID: $global:tmdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if (!$global:tmdbid) {
        Write-Entry -Subtext "Cannot search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if ($global:TCPreferTextless -eq $true) {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$($global:season_number)/episode/$($global:episodenumber)/images?append_to_response=images&language=xx&include_image_language=$($global:PreferredTCLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
        }
        if ($response) {
            if ($response.stills) {
                if ($global:WidthHeightFilter -eq 'true') {
                    $NoLangPoster = ($response.stills | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                }
                Else {
                    $NoLangPoster = ($response.stills | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                }
                if (!$NoLangPoster) {
                    Write-Entry -Subtext "PreferTextless Value: $global:TCPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:TCOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:TCOnlyTextless -eq $false) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $filteredPosters = $response.stills | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = $filteredPosters[0].file_path
                                    $global:TMDBAssetTextLang = $filteredPosters[0].iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No TC posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                            Else {
                                $filteredPosters = $response.stills | Where-Object { $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                                if ($filteredPosters) {
                                    $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                    $global:TMDBAssetTextLang = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                                    Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                                else {
                                    Write-Entry -Subtext "No TC posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                            }
                        }
                        Else {
                            if ($global:TMDBVoteSorting -eq 'primary') {
                                $posterpath = $response.stills[0].file_path
                                $global:TMDBAssetTextLang = $response.stills[0].iso_639_1
                            }
                            Else {
                                $posterpath = (($response.stills | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                $global:TMDBAssetTextLang = (($response.stills | Sort-Object $global:TMDBVoteSorting -Descending)[0]).iso_639_1
                            }
                        }
                        if ($posterpath) {
                            $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                            Write-Entry -Subtext "Found TC with text on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                        }
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on TMDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                    }
                }
                Else {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $filteredPosters = $response.stills | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                            if ($filteredPosters) {
                                $posterpath = $filteredPosters[0].file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $($filteredPosters[0].width) | height: $($filteredPosters[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No TC posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                        Else {
                            $filteredPosters = $response.stills | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }

                            if ($filteredPosters) {
                                $posterpath = (($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                                Write-Entry -Subtext "Found a poster sized at - width: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).width) | height: $((($filteredPosters | Sort-Object $global:TMDBVoteSorting -Descending)[0]).height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            else {
                                Write-Entry -Subtext "No TC posters found on TMDB with the specified dimensions." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                        }
                    }
                    Else {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = (($response.stills | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })[0]).file_path
                        }
                        Else {
                            $posterpath = (($response.stills | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null } | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                    }
                    if ($posterpath) {
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        Write-Entry -Subtext "Found Textless TC on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                        return $global:posterurl
                    }
                }
                if (!$global:posterurl) {
                    Write-Entry -Subtext "No TC found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
            }
            Else {
                Write-Entry -Subtext "No TC found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
        }
    }
    Else {
        try {
            $response = (Invoke-WebRequest -Uri "https://api.themoviedb.org/3/tv/$($global:tmdbid)/season/$($global:season_number)/episode/$($global:episodenumber)/images?append_to_response=images&language=$($global:PreferredTCLanguageOrderTMDB[0])&include_image_language=$($global:PreferredTCLanguageOrderTMDB -join ',')" -Method GET -Headers $global:headers -ErrorAction SilentlyContinue).content | ConvertFrom-Json -ErrorAction SilentlyContinue
        }
        catch {
            Write-Entry -Subtext "Could not query TMDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"

        }
        if ($response) {
            if ($response.stills) {
                foreach ($lang in $global:PreferredTCLanguageOrderTMDB) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.stills | Where-Object { ($_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null) -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                        }
                        Else {
                            $FavPoster = ($response.stills | Where-Object { $_.iso_639_1 -eq $lang -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight })
                        }
                    }
                    Else {
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            $FavPoster = ($response.stills | Where-Object { $_.iso_639_1 -eq 'xx' -or $_.iso_3166_1 -eq 'XX' -or $_.iso_3166_1 -eq $null -or $_.iso_639_1 -eq $null })
                        }
                        Else {
                            $FavPoster = ($response.stills | Where-Object iso_639_1 -eq $lang)
                        }
                    }
                    if ($FavPoster) {
                        if ($global:TMDBVoteSorting -eq 'primary') {
                            $posterpath = $FavPoster[0].file_path
                        }
                        Else {
                            $posterpath = (($FavPoster | Sort-Object $global:TMDBVoteSorting -Descending)[0]).file_path
                        }
                        $global:posterurl = "https://image.tmdb.org/t/p/original$posterpath"
                        if ($lang -eq 'null' -or $lang -eq 'xx') {
                            Write-Entry -Subtext "Found TC without Language on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        Else {
                            Write-Entry -Subtext "Found TC with Language '$lang' on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne 'null' -or $lang -eq 'xx') {
                            $global:PosterWithText = $true
                            $global:TMDBAssetTextLang = $lang
                            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                        }
                        return $global:posterurl
                        continue
                    }
                }
                if (!$global:posterurl) {
                    Write-Entry -Subtext "No TC found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
                }
            }
            Else {
                Write-Entry -Subtext "No TC found on TMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
            }
        }
        Else {
            Write-Entry -Subtext "TMDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TMDBAssetChangeUrl = "https://www.themoviedb.org/tv/$($global:tmdbid)/season/$global:season_number/episode/$global:episodenumber/images/backdrops"
        }
    }
}
function GetFanartMoviePoster {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if ($global:PosterPreferTextless -eq $true) {
        $ids = @($global:tmdbid, $global:imdbid)
        $entrytemp = $null

        foreach ($id in $ids) {
            if ($id) {
                $entrytemp = Get-FanartTv -Type movies -id $id -ErrorAction SilentlyContinue
                if ($entrytemp -and $entrytemp.movieposter) {
                    if (!($entrytemp.movieposter | Where-Object lang -eq '00')) {
                        Write-Entry -Subtext "PreferTextless Value: $global:PosterPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:PosterOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:PosterOnlyTextless -eq $false) {
                            $global:posterurl = ($entrytemp.movieposter)[0].url
                            Write-Entry -Subtext "Found Poster with text on Fanart.tv"  -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            $global:FANARTAssetTextLang = ($entrytemp.movieposter)[0].lang
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"

                            if ($global:FavProvider -eq 'FANART') {
                                $global:Fallback = "TMDB"
                                $global:fanartfallbackposterurl = ($entrytemp.movieposter)[0].url
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                        }
                        return $global:posterurl
                        continue
                    }
                    Else {
                        $global:posterurl = ($entrytemp.movieposter | Where-Object lang -eq '00')[0].url
                        Write-Entry -Subtext "Found Textless Poster on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                        return $global:posterurl
                        break
                    }
                }
            }
        }
        if ($null -eq $ids[0] -and $null -eq $ids[1]) {
            Write-Entry -Subtext "Cannot search on FANART, missing IDs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No movie match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Else {
            return $global:posterurl
        }
    }
    Else {
        $ids = @($global:tmdbid, $global:imdbid)
        $entrytemp = $null

        foreach ($id in $ids) {
            if ($id) {
                $entrytemp = Get-FanartTv -Type movies -id $id -ErrorAction SilentlyContinue
                if ($entrytemp -and $entrytemp.movieposter) {
                    foreach ($lang in $global:PreferredLanguageOrderFanart) {
                        if (($entrytemp.movieposter | Where-Object lang -eq "$lang")) {
                            $global:posterurl = ($entrytemp.movieposter)[0].url
                            if ($lang -eq '00') {
                                Write-Entry -Subtext "Found Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:TextlessPoster = $true
                                $global:PosterWithText = $null
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne '00') {
                                $global:PosterWithText = $true
                                $global:FANARTAssetTextLang = $lang
                            }
                            return $global:posterurl
                            continue
                        }
                    }
                }
            }
        }
        if ($null -eq $ids[0] -and $null -eq $ids[1]) {
            Write-Entry -Subtext "Cannot search on FANART, missing IDs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No movie match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Else {
            return $global:posterurl
        }
    }
}
function GetFanartMovieBackground {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a Background poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $ids = @($global:tmdbid, $global:imdbid)
    $entrytemp = $null

    foreach ($id in $ids) {
        if ($id) {
            $entrytemp = Get-FanartTv -Type movies -id $id -ErrorAction SilentlyContinue
            if ($entrytemp -and $entrytemp.moviebackground) {
                if (!($entrytemp.moviebackground | Where-Object lang -eq '')) {
                    Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:BackgroundOnlyTextless -eq $false) {
                        $global:posterurl = ($entrytemp.moviebackground)[0].url
                        Write-Entry -Subtext "Found Background with text on Fanart.tv"  -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:PosterWithText = $true
                        $global:FANARTAssetTextLang = ($entrytemp.moviebackground)[0].lang
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"

                        if ($global:FavProvider -eq 'FANART') {
                            $global:Fallback = "TMDB"
                            $global:fanartfallbackposterurl = ($entrytemp.moviebackground)[0].url
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Found Background with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                    }
                    return $global:posterurl
                    continue
                }
                Else {
                    $global:posterurl = ($entrytemp.moviebackground | Where-Object lang -eq '')[0].url
                    Write-Entry -Subtext "Found Textless background on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                    return $global:posterurl
                    continue
                }
            }
        }
    }
    if ($null -eq $ids[0] -and $null -eq $ids[1]) {
        Write-Entry -Subtext "Cannot search on FANART, missing IDs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if (!$global:posterurl) {
        Write-Entry -Subtext "No movie match or background found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        return $global:posterurl
    }

}
function GetFanartShowPoster {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a show poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    if ($global:PosterPreferTextless -eq $true) {
        $id = $global:tvdbid
        $entrytemp = $null
        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp -and $entrytemp.tvposter) {
                if (!($entrytemp.tvposter | Where-Object lang -eq '00')) {
                    Write-Entry -Subtext "PreferTextless Value: $global:PosterPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "OnlyTextless Value: $global:PosterOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($global:PosterOnlyTextless -eq $false) {
                        $global:posterurl = ($entrytemp.tvposter)[0].url

                        Write-Entry -Subtext "Found Poster with text on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:PosterWithText = $true
                        $global:FANARTAssetTextLang = ($entrytemp.tvposter)[0].lang
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"

                        if ($global:FavProvider -eq 'FANART') {
                            $global:Fallback = "TMDB"
                            $global:fanartfallbackposterurl = ($entrytemp.tvposter)[0].url
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                        if ($global:FavProvider -eq 'FANART') {
                            $global:Fallback = "TMDB"
                        }
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                    }
                    return $global:posterurl
                    continue
                }
                Else {
                    $global:posterurl = ($entrytemp.tvposter | Where-Object lang -eq '00')[0].url
                    Write-Entry -Subtext "Found Textless Poster on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                    return $global:posterurl
                    break
                }
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            if ($global:FavProvider -eq 'FANART') {
                $global:Fallback = "TMDB"
            }
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No show match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            if ($global:FavProvider -eq 'FANART') {
                $global:Fallback = "TMDB"
            }
        }
        Else {
            return $global:posterurl
        }
    }
    Else {
        $id = $global:tvdbid
        $entrytemp = $null

        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp -and $entrytemp.tvposter) {
                foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                    if (($entrytemp.tvposter | Where-Object lang -eq "$lang")) {
                        $global:posterurl = ($entrytemp.tvposter)[0].url
                        if ($lang -eq '00') {
                            Write-Entry -Subtext "Found Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        }
                        if ($lang -ne '00') {
                            $global:PosterWithText = $true
                            $global:FANARTAssetTextLang = $lang
                        }
                        return $global:posterurl
                        continue
                    }
                }
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if (!$global:posterurl) {
            Write-Entry -Subtext "No show match or poster found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            if ($global:FavProvider -eq 'FANART') {
                $global:Fallback = "TMDB"
            }
        }
        Else {
            return $global:posterurl
        }
    }
}
function GetFanartShowBackground {
    $global:Fallback = $null
    Write-Entry -Subtext "Searching on Fanart.tv for a Background poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $id = $global:tvdbid
    $entrytemp = $null

    if ($id) {
        $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
        if ($entrytemp -and $entrytemp.showbackground) {
            if (!($entrytemp.showbackground | Where-Object lang -eq '')) {
                Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                if ($global:BackgroundOnlyTextless -eq $false) {
                    $global:posterurl = ($entrytemp.showbackground)[0].url
                    Write-Entry -Subtext "Found Background with text on Fanart.tv"  -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    $global:PosterWithText = $true
                    $global:FANARTAssetTextLang = ($entrytemp.showbackground)[0].lang
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"

                    if ($global:FavProvider -eq 'FANART') {
                        $global:Fallback = "TMDB"
                        $global:fanartfallbackposterurl = ($entrytemp.showbackground)[0].url
                    }
                }
                Else {
                    Write-Entry -Subtext "Found Background with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    $global:FANARTAssetChangeUrl = "https://fanart.tv/movie/$id"
                }
                return $global:posterurl
                continue
            }
            Else {
                $global:posterurl = ($entrytemp.showbackground | Where-Object lang -eq '')[0].url
                Write-Entry -Subtext "Found Textless background on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $global:TextlessPoster = $true
                $global:PosterWithText = $null
                $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                return $global:posterurl
                continue
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    if (!$global:posterurl) {
        Write-Entry -Subtext "No show match or background found on Fanart.tv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        return $global:posterurl
    }

}
function GetFanartSeasonPoster {
    Write-Entry -Subtext "Searching on Fanart.tv for Season '$global:SeasonNumber' poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $id = $global:tvdbid
    $entrytemp = $null
    if ($global:SeasonPreferTextless -eq $true) {
        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp.seasonposter) {
                if ($global:SeasonNumber -match '\b\d{1,2}\b') {
                    $NoLangPoster = ($entrytemp.seasonposter | Where-Object { $_.lang -eq '00' -and $_.Season -eq $global:SeasonNumber } | Sort-Object likes)
                    if ($NoLangPoster) {
                        $global:posterurl = ($NoLangPoster | Sort-Object likes)[0].url
                        Write-Entry -Subtext "Found Season Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                        Write-Entry -Subtext "NoLangPoster: $NoLangPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "PosterUrl: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "TextlessPoster: $global:TextlessPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "FANARTAssetChangeUrl: $global:FANARTAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    }
                    Else {
                        if (!$global:SeasonOnlyTextless) {
                            Write-Entry -Subtext "No Textless Season Poster on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                                $FoundPoster = ($entrytemp.seasonposter | Where-Object { $_.lang -eq "$lang" -and $_.Season -eq $global:SeasonNumber } | Sort-Object likes)
                                if ($FoundPoster) {
                                    $global:posterurl = $FoundPoster[0].url
                                    Write-Entry -Subtext "Found season Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    $global:PosterWithText = $true
                                    $global:FANARTAssetTextLang = $lang
                                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                    $global:FANARTSeasonFallback = $global:posterurl
                                    Write-Entry -Subtext "FoundPoster: $FoundPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "PosterUrl: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "FANARTAssetTextLang: $global:FANARTAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "FANARTAssetChangeUrl: $global:FANARTAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    return $global:posterurl
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "Could not get a result with '$global:SeasonNumber' on Fanart, likely season number not in correct format, fallback to Show poster." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    if ($entrytemp -and $entrytemp.tvposter) {
                        foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                            if (($entrytemp.tvposter | Where-Object lang -eq "$lang")) {
                                $global:posterurl = ($entrytemp.tvposter)[0].url
                                if ($lang -eq '00') {
                                    Write-Entry -Subtext "Found Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    $global:TextlessPoster = $true
                                    $global:PosterWithText = $null
                                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                }
                                Else {
                                    if (!$global:SeasonOnlyTextless) {
                                        Write-Entry -Subtext "Found Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                }
                                if (!$global:SeasonOnlyTextless -and !$global:TextlessPoster) {
                                    if ($lang -ne '00') {
                                        $global:PosterWithText = $true
                                        $global:FANARTAssetTextLang = $lang
                                        $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                        $global:FANARTSeasonFallback = $global:posterurl
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Found Poster with text on FANART, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                                    $global:posterurl = $null
                                }
                                return $global:posterurl
                            }
                        }
                    }
                }
            }
            Else {
                $global:posterurl = $null
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if ($global:posterurl) {
            Write-Entry -Subtext "Found season poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            return $global:posterurl
        }
        Else {
            if ($global:PosterOnlyTextless -eq $true) {
                Write-Entry -Subtext "No Textless Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                Write-Entry -Subtext "No Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
        }
    }
    Else {
        if ($id) {
            $entrytemp = Get-FanartTv -Type tv -id $id -ErrorAction SilentlyContinue
            if ($entrytemp.seasonposter) {
                foreach ($lang in $global:PreferredSeasonLanguageOrderFanart) {
                    $FoundPoster = ($entrytemp.seasonposter | Where-Object { $_.lang -eq "$lang" -and $_.Season -eq $global:SeasonNumber } | Sort-Object likes)
                    if ($FoundPoster) {
                        $global:posterurl = $FoundPoster[0].url
                    }
                    if ($global:posterurl) {
                        if ($lang -eq '00') {
                            Write-Entry -Subtext "Found season Poster without Language on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TextlessPoster = $true
                            $global:PosterWithText = $null
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                        }
                        Else {
                            Write-Entry -Subtext "Found season Poster with Language '$lang' on FANART" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:PosterWithText = $true
                            $global:FANARTAssetTextLang = $lang
                            $global:FANARTAssetChangeUrl = "https://fanart.tv/series/$id"
                            return $global:posterurl
                        }
                    }
                }
            }
            Else {
                $global:posterurl = $null
                return $global:posterurl
            }
        }
        Else {
            Write-Entry -Subtext "Cannot search on FANART, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        if ($global:posterurl) {
            return $global:posterurl
        }
        Else {
            if ($global:PosterOnlyTextless -eq $true) {
                Write-Entry -Subtext "No Textless Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                Write-Entry -Subtext "No Season Poster on Fanart" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
        }
    }
}
function GetTVDBMoviePoster {
    if ($global:tvdbid) {
        if ($global:PosterPreferTextless -eq $true) {
            Write-Entry -Subtext "Searching on TVDB for a movie poster - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data.artworks) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        $global:posterurltmp = ($response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                    }
                    Else {
                        $global:posterurltmp = ($response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '14' } | Sort-Object Score -Descending)
                    }
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                    if ($global:posterurltmp) {
                        $global:posterurl = $global:posterurltmp[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $($global:posterurltmp[0].width) | height: $($global:posterurltmp[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless Poster on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        return $global:posterurl
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:PosterPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:PosterOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:PosterOnlyTextless -eq $false) {
                            foreach ($lang in $global:PreferredLanguageOrderTVDB) {
                                if ($global:WidthHeightFilter -eq 'true') {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                                    }
                                }
                                Else {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' } | Sort-Object Score -Descending)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' } | Sort-Object Score -Descending)
                                    }
                                }
                                if ($LangArtwork) {
                                    $global:posterurl = $LangArtwork[0].image
                                    if ($global:WidthHeightFilter -eq 'true') {
                                        Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($lang -eq 'null') {
                                        Write-Entry -Subtext "Found Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                        $global:TextlessPoster = $true
                                        $global:PosterWithText = $null
                                    }
                                    Else {
                                        Write-Entry -Subtext "Found Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    if ($lang -ne 'null') {
                                        $global:PosterWithText = $true
                                        $global:TVDBAssetTextLang = $lang
                                    }
                                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                                    return $global:posterurl
                                    continue
                                }
                            }
                        }
                        Else {
                            Write-Entry -Subtext "No Textless Poster on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
        Else {
            Write-Entry -Subtext "Searching on TVDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data.artworks) {
                    foreach ($lang in $global:PreferredLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '14' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '14' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:TextlessPoster = $true
                                $global:PosterWithText = $null
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                            return $global:posterurl
                            continue
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBMovieBackground {
    if ($global:tvdbid) {
        if ($global:BackgroundPreferTextless -eq $true) {
            Write-Entry -Subtext "Searching on TVDB for a movie Background - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data.artworks) {
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangArtwork = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }
                    }
                    Else {
                        $NoLangArtwork = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '15' }
                    }
                    if ($NoLangArtwork) {
                        $global:posterurl = ($NoLangArtwork | Sort-Object Score -Descending)[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $(($NoLangArtwork | Sort-Object Score -Descending)[0].width) | height: $(($NoLangArtwork | Sort-Object Score -Descending)[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless Background on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                        return $global:posterurl
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:BackgroundOnlyTextless -eq $false) {
                            # Trying other languages
                            foreach ($lang in $global:PreferredBackgroundLanguageOrderTVDB) {
                                if ($global:WidthHeightFilter -eq 'true') {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                                    }
                                }
                                Else {
                                    if ($lang -eq 'null') {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' } | Sort-Object Score -Descending)
                                    }
                                    Else {
                                        $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' } | Sort-Object Score -Descending)
                                    }
                                }
                                if ($LangArtwork) {
                                    $global:posterurl = $LangArtwork[0].image
                                    if ($global:WidthHeightFilter -eq 'true') {
                                        Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    if ($lang -eq 'null') {
                                        Write-Entry -Subtext "Found Background without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Found Background with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                    }
                                    if ($lang -ne 'null') {
                                        $global:PosterWithText = $true
                                        $global:TVDBAssetTextLang = $lang
                                    }
                                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                                    return $global:posterurl
                                    continue
                                }
                            }
                            if (!$global:posterurl) {
                                Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found background with text on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
        Else {
            Write-Entry -Subtext "Searching on TVDB for a movie Background" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/movies/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data.artworks) {
                    foreach ($lang in $global:PreferredBackgroundLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '15' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '15' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Background without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found Background with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                            return $global:posterurl
                            continue
                        }
                    }
                    if (!$global:posterurl) {
                        Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                    }
                }
                Else {
                    Write-Entry -Subtext "No Background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/movies/$($response.data.slug)#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBShowPoster {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for a poster - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        if ($global:PosterPreferTextless -eq $true) {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data) {
                    $defaultImageurl = $response.data.image
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '2' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight }
                    }
                    Else {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $null -eq $_.language -and $_.type -eq '2' }
                    }
                    if ($NoLangImageUrl) {
                        $global:posterurl = $NoLangImageUrl[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $($NoLangImageUrl[0].width) | height: $($NoLangImageUrl[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless Poster on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:PosterPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:PosterOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:PosterOnlyTextless -eq $false) {
                            $global:posterurl = $defaultImageurl
                            Write-Entry -Subtext "Found Poster with text on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                            if ($global:FavProvider -ne 'TVDB') {
                                if (!$global:tmdbsearched) {
                                    $global:Fallback = "TMDB"
                                }
                                $global:TVDBfallbackposterurl = $global:posterurl
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                        }
                    }
                    return $global:posterurl
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
            }
        }
        Else {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data) {
                    foreach ($lang in $global:PreferredLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '2' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '2' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '2' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '2' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:TextlessPoster = $true
                                $global:PosterWithText = $null
                            }
                            Else {
                                Write-Entry -Subtext "Found Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                            return $global:posterurl
                            continue
                        }
                    }
                }
                Else {
                    Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBSeasonPoster {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for a Season poster - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        try {
            $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
        }
        catch {
            Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
        if ($response) {
            if ($response.data.seasons) {
                # Select season id from current Season number
                $SeasonID = $response.data.seasons | Where-Object { $_.number -eq $global:SeasonNumber -and $_.type.type -eq 'official' }
                if (!$SeasonID) {
                    $SeasonID = $response.data.seasons | Where-Object { $_.number -eq $global:SeasonNumber -and $_.type.type -eq 'alternate' }
                }
                try {
                    $Seasonresponse = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/seasons/$($SeasonID.id)/extended" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
                }
                catch {
                    Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                }
                if ($Seasonresponse) {
                    foreach ($lang in $global:PreferredSeasonLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($Seasonresponse.data.artwork | Where-Object { $_.language -like "" -and $_.type -eq '7' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($Seasonresponse.data.artwork  | Where-Object { $_.language -like "$lang*" -and $_.type -eq '7' -and $_.width -ge $global:PosterMinWidth -and $_.height -ge $global:PosterMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($Seasonresponse.data.artwork | Where-Object { $_.language -like "" -and $_.type -eq '7' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($Seasonresponse.data.artwork  | Where-Object { $_.language -like "$lang*" -and $_.type -eq '7' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found Season Poster without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                                $global:TextlessPoster = $true
                                $global:PosterWithText = $null
                            }
                            Else {
                                Write-Entry -Subtext "Found Season Poster with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            if (!$global:SeasonOnlyTextless -and !$global:TextlessPoster) {
                                $global:TVDBSeasonFallback = $global:posterurl
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/seasons/$($Seasonresponse.data.type.type)/$global:SeasonNumber#artwork"
                            Write-Entry -Subtext "LangArtwork: $LangArtwork" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterUrl: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TextlessPoster: $global:TextlessPoster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "PosterWithText: $global:PosterWithText" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TVDBAssetTextLang: $global:TVDBAssetTextLang" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "TVDBAssetChangeUrl: $global:TVDBAssetChangeUrl" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($global:SeasonOnlyTextless -and $global:PosterWithText) {
                                continue
                            }
                            Else {
                                return $global:posterurl
                            }
                            continue
                        }
                    }
                    if (!$global:posterurl -and $global:PosterOnlyTextless -eq $true) {
                        Write-Entry -Subtext "No Textless Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    }
                    Else {
                        Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    }
                }
                return $global:posterurl
            }
            Else {
                Write-Entry -Subtext "No Poster found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/seasons/$($Seasonresponse.data.type.type)/$global:SeasonNumber#artwork"
            }
        }
        Else {
            Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/seasons/$($Seasonresponse.data.type.type)/$global:SeasonNumber#artwork"
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBShowBackground {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for a background - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        if ($global:BackgroundPreferTextless -eq $true) {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data) {
                    $defaultImageurltemp = $response.data.artworks | Where-Object { $_.type -eq '3' }
                    if ($defaultImageurltemp) {
                        $defaultImageurl = $defaultImageurltemp[0].image
                    }
                    if ($global:WidthHeightFilter -eq 'true') {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $_.language -eq $null -and $_.type -eq '3' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight }
                    }
                    Else {
                        $NoLangImageUrl = $response.data.artworks | Where-Object { $_.language -eq $null -and $_.type -eq '3' }
                    }
                    if ($NoLangImageUrl) {
                        $global:posterurl = $NoLangImageUrl[0].image
                        if ($global:WidthHeightFilter -eq 'true') {
                            Write-Entry -Subtext "Found a poster sized at - width: $($NoLangImageUrl[0].width) | height: $($NoLangImageUrl[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        }
                        Write-Entry -Subtext "Found Textless background on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                        $global:TextlessPoster = $true
                        $global:PosterWithText = $null
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                    }
                    Else {
                        Write-Entry -Subtext "PreferTextless Value: $global:BackgroundPreferTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Subtext "OnlyTextless Value: $global:BackgroundOnlyTextless" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        if ($global:BackgroundOnlyTextless -eq $false) {
                            $global:posterurl = $defaultImageurl
                            Write-Entry -Subtext "Found background with text on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                        }
                        Else {
                            Write-Entry -Subtext "Found Poster with text on TVDB, skipping because you only want textless..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                        }
                    }
                    return $global:posterurl
                }
                Else {
                    Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
            }
        }
        Else {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/artworks" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
            if ($response) {
                if ($response.data) {
                    foreach ($lang in $global:PreferredBackgroundLanguageOrderTVDB) {
                        if ($global:WidthHeightFilter -eq 'true') {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '3' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '3' -and $_.width -ge $global:BgTcMinWidth -and $_.height -ge $global:BgTcMinHeight } | Sort-Object Score -Descending)
                            }
                        }
                        Else {
                            if ($lang -eq 'null') {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "" -and $_.type -eq '3' } | Sort-Object Score -Descending)
                            }
                            Else {
                                $LangArtwork = ($response.data.artworks | Where-Object { $_.language -like "$lang*" -and $_.type -eq '3' } | Sort-Object Score -Descending)
                            }
                        }
                        if ($LangArtwork) {
                            $global:posterurl = $LangArtwork[0].image
                            if ($global:WidthHeightFilter -eq 'true') {
                                Write-Entry -Subtext "Found a poster sized at - width: $($LangArtwork[0].width) | height: $($LangArtwork[0].height)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            if ($lang -eq 'null') {
                                Write-Entry -Subtext "Found background without Language on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            Else {
                                Write-Entry -Subtext "Found background with Language '$lang' on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                            }
                            if ($lang -ne 'null') {
                                $global:PosterWithText = $true
                                $global:TVDBAssetTextLang = $lang
                            }
                            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"

                            return $global:posterurl
                            continue
                        }
                    }
                    if (!$global:posterurl) {
                        Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                    }
                }
                Else {
                    Write-Entry -Subtext "No background found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
                }
            }
            Else {
                Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"
            }
        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetTVDBTitleCard {
    if ($global:tvdbid) {
        Write-Entry -Subtext "Searching on TVDB for: $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card - TVDBID: $global:tvdbid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $allEpisodes = @()
        $page = 0

        do {
            try {
                $response = (Invoke-WebRequest -Uri "https://api4.thetvdb.com/v4/series/$($global:tvdbid)/episodes/default?page=$page" -Method GET -Headers $global:tvdbheader).content | ConvertFrom-Json
                $episodes = $response.data.episodes
                $seriesData = $response.data

                if ($episodes) {
                    $allEpisodes += $seriesData
                    $page++
                }
            }
            catch {
                Write-Entry -Subtext "Could not query TVDB url, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                break
            }
        } while ($episodes -and $episodes.Count -gt 0)

        # Now $allEpisodes contains all the episodes retrieved from the API

        if ($response) {
            if ($allEpisodes.episodes) {
                $global:NoLangImageUrl = $allEpisodes.episodes | Where-Object { $_.seasonNumber -eq $global:season_number -and $_.number -eq $global:episodenumber }
                if ($global:NoLangImageUrl.image) {
                    $global:posterurl = $global:NoLangImageUrl.image
                    Write-Entry -Subtext "Found Title Card on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
                    $global:TextlessPoster = $true
                    $global:PosterWithText = $null
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($allEpisodes.series.slug)/episodes/$($global:NoLangImageUrl.id)"

                    return $global:NoLangImageUrl.image
                }
                Else {
                    Write-Entry -Subtext "No Title Card found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($allEpisodes.slug)/#artwork"

                }
            }
            Else {
                Write-Entry -Subtext "No Title Card found on TVDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($allEpisodes.slug)/#artwork"

            }
        }
        Else {
            Write-Entry -Subtext "TVDB API response is null" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:TVDBAssetChangeUrl = "https://thetvdb.com/series/$($response.data.slug)/#artwork"

        }
    }
    Else {
        Write-Entry -Subtext "Cannot search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
}
function GetIMDBPoster {
    $response = Invoke-WebRequest -Uri "https://www.imdb.com/title/$($global:imdbid)/mediaviewer" -Method GET
    $global:posterurl = $response.images.src[1]
    if (!$global:posterurl) {
        Write-Entry -Subtext "No show match or poster found on IMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        Write-Entry -Subtext "Found Poster with text on IMDB" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Blue -log Info
        return $global:posterurl
    }
}
function GetPlexArtwork {
    param(
        [string]$Type,
        [string]$ArtUrl,
        [string]$TempImage
    )

    Write-Entry -Subtext "Searching on Plex for $Type" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    try {
        Invoke-WebRequest -Uri $ArtUrl -OutFile $TempImage -Headers $extraPlexHeaders
    }
    catch {
        Write-Entry -Subtext "Could not download Artwork from plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        continue
    }

    $magickcommand = "& `"$magick`" identify -verbose `"$TempImage`""
    $magickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

    # Execute command and get exif data
    $value = (Invoke-Expression $magickcommand | Select-String -Pattern 'overlay|titlecard|created with ppm|created with posterizarr')

    if ($value -and $DisableHashValidation -eq 'false') {
        $ExifFound = $True
        if ($global:UploadExistingAssets -eq 'true') {
            Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, skip upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Else {
            Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, cant take it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        Remove-Item -LiteralPath $TempImage | out-null
    }
    Else {
        if ($DisableHashValidation -eq 'false') {
            Write-Entry -Subtext "No posterizarr/kometa/tcm exif data found, taking Plex artwork..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        Else {
            Write-Entry -Subtext "taking Plex artwork..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }

        $global:PlexartworkDownloaded = $true
        $global:posterurl = $ArtUrl
    }
}
function Push-ObjectToDiscord {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [string]$strDiscordWebhook,

        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [string]$objPayload
    )

    try {
        $null = Invoke-RestMethod -Method Post -Uri $strDiscordWebhook -Body $objPayload -ContentType 'Application/Json'

        # This is a good, simple way to help avoid rate limits.
        Start-Sleep -Seconds 1
    }
    catch {
        $errorMessage = "Unable to send to Discord."
        $discordErrorBody = "N/A"
        $statusCode = "N/A"

        $response = $_.Exception.Response
        if ($response) {
            $statusCode = $response.StatusCode
            if ($statusCode -eq 'NotFound'){
                $errorMessage = "Unable to send to Discord. Status: $statusCode. Reason: Wrong Webhook Url"
            }Else {
                $stream = $response.GetResponseStream()
                $reader = New-Object System.IO.StreamReader($stream)
                $discordErrorBody = $reader.ReadToEnd() # This is the JSON error from Discord
                $errorMessage = "Unable to send to Discord. Status: $statusCode. Reason: $discordErrorBody"
            }
        }
        else {
            # This was a general network error (e.g., DNS failure)
            $errorMessage = "Unable to send to Discord. Error: $($_.Exception.Message)"
        }
        Write-Entry -Message $errorMessage -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Message "Failing Payload: $objPayload" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
}
function CheckJson {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [string]$jsonExampleUrl,

        [Parameter(Mandatory)]
        [ValidateNotNullOrEmpty()]
        [object]$jsonFilePath
    )
    try {
        $AttributeChanged = $null
        # Download the default configuration JSON file from the URL
        $defaultConfig = Invoke-RestMethod -Uri $jsonExampleUrl -Method Get -ErrorAction Stop

        # Read the existing configuration file if it exists
        if (Test-Path $jsonFilePath) {
            try {
                $config = Get-Content -Path $jsonFilePath -Raw | ConvertFrom-Json
            }
            catch {
                Write-Entry -Message "Failed to read the existing configuration file: $jsonFilePath. Please ensure it is valid JSON. Aborting..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Failed to read the existing configuration file."
                }
                Exit
            }
        }
        else {
            $config = @{}
        }

        # Remove keys from config that are no longer in the default config
        foreach ($existingKey in $config.PSObject.Properties.Name) {
            if (-not $defaultConfig.PSObject.Properties.Name.Contains($existingKey)) {
                Write-Entry -Message "Removing obsolete Main Attribute from your Config file: $existingKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                $config.PSObject.Properties.Remove($existingKey)
                $AttributeChanged = $True
            }
        }

        # Remove sub-attributes no longer in the default config
        foreach ($partKey in $config.PSObject.Properties.Name) {
            if ($defaultConfig.PSObject.Properties.Name.Contains($partKey)) {
                # Check each sub-attribute in the part
                foreach ($existingSubKey in $config.$partKey.PSObject.Properties.Name) {
                    if (-not $defaultConfig.$partKey.PSObject.Properties.Name.Contains($existingSubKey)) {
                        Write-Entry -Message "Removing obsolete Sub-Attribute from your Config file: $partKey.$existingSubKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        $config.$partKey.PSObject.Properties.Remove($existingSubKey)
                        $AttributeChanged = $True
                    }
                }
            }
        }

        # Check and add missing keys from the default configuration
        foreach ($partKey in $defaultConfig.PSObject.Properties.Name) {
            # Check if the part exists in the current configuration
            if (-not $config.PSObject.Properties.Name.Contains($partKey)) {
                if (-not $config.PSObject.Properties.Name.tolower().Contains($partKey.tolower())) {
                    # Add "SeasonPosterOverlayPart" if it's missing in $config
                    if (-not $config.PSObject.Properties.Name.tolower().Contains("seasonposteroverlaypart")) {
                        $config | Add-Member -MemberType NoteProperty -Name "SeasonPosterOverlayPart" -Value $defaultConfig.PosterOverlayPart
                        Write-Entry -Message "Missing Main Attribute in your Config file: $partKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        Write-Entry -Subtext "I will copy all settings from 'PosterOverlayPart'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        Write-Entry -Subtext "Adding it for you... In GH Readme, look for $partKey - if you want to see what changed..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        Write-Entry -Subtext "GH Readme -> https://fscorrupt.github.io/posterizarr/configuration" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        # Convert the updated configuration object back to JSON and save it, then reload it
                        $configJson = $config | ConvertTo-Json -Depth 10
                        $configJson | Set-Content -Path $jsonFilePath -Force
                        $config = Get-Content -Path $jsonFilePath -Raw | ConvertFrom-Json
                    }
                    Else {
                        Write-Entry -Message "Missing Main Attribute in your Config file: $partKey." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        Write-Entry -Subtext "Adding it for you... In GH Readme, look for $partKey - if you want to see what changed..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        Write-Entry -Subtext "GH Readme -> https://fscorrupt.github.io/posterizarr/configuration" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $config | Add-Member -MemberType NoteProperty -Name $partKey -Value $defaultConfig.$partKey
                        $AttributeChanged = $True
                    }
                }
                else {
                    # Inform user about the case issue
                    Write-Entry -Message "The Main Attribute '$partKey' in your configuration file has a different casing than the expected property." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Please correct the casing of the property in your configuration file to '$partKey'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Wrong Main Attribute casing in config file"
                    }
                    Exit  # Abort the script
                }
            }
            else {
                # Check each key in the part
                foreach ($propertyKey in $defaultConfig.$partKey.PSObject.Properties.Name) {
                    # Show user that a sub-attribute is missing
                    if (-not $config.$partKey.PSObject.Properties.Name.Contains($propertyKey)) {
                        if (-not $config.$partKey.PSObject.Properties.Name.tolower().Contains($propertyKey.tolower())) {
                            Write-Entry -Message "Missing Sub-Attribute in your Config file: $partKey.$propertyKey" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "Adding it for you... In GH Readme, look for $partKey.$propertyKey - if you want to see what changed..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            Write-Entry -Subtext "GH Readme -> https://fscorrupt.github.io/posterizarr/configuration" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            # Add the property using the expected casing
                            $config.$partKey | Add-Member -MemberType NoteProperty -Name $propertyKey -Value $defaultConfig.$partKey.$propertyKey -Force
                            $AttributeChanged = $True
                        }
                        else {
                            # Inform user about the case issue
                            Write-Entry -Message "The Sub-Attribute '$partKey.$propertyKey' in your configuration file has a different casing than the expected property." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Please correct the casing of the Sub-Attribute in your configuration file to '$partKey.$propertyKey'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                            # Clear Running File
                            if (Test-Path $CurrentlyRunning) {
                                try {
                                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                                }
                                catch {
                                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                            if ($global:UptimeKumaUrl) {
                                Send-UptimeKumaWebhook -status "down" -msg "Wrong Sub Attribute casing in config file"
                            }
                            Exit  # Abort the script
                        }
                    }
                }
            }
        }

        if ($AttributeChanged -eq 'true') {
            # Convert the updated configuration object back to JSON and save it
            $configJson = $config | ConvertTo-Json -Depth 10
            $configJson | Set-Content -Path $jsonFilePath -Force

            Write-Entry -Subtext "Configuration file updated successfully." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }
    catch [System.Net.WebException] {
        Write-Entry -Message "Failed to download the default configuration JSON file from the URL." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Config.json download failed."
        }
        Exit
    }
    catch {
        Write-Entry -Message "An unexpected error occurred: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "$($_.Exception.Message)"
        }
        Exit
    }
}
function CheckJsonPaths {
    param (
        [string]$font,
        [string]$RTLfont,
        [string]$backgroundfont,
        [string]$titlecardfont,
        [string]$Posteroverlay,
        [string]$Collectionoverlay,
        [string]$titlecardoverlay,
        [string]$Seasonoverlay,
        [string]$Backgroundoverlay,
        [string]$Posteroverlay4k,
        [string]$Posteroverlay1080p,
        [string]$Backgroundoverlay4k,
        [string]$Backgroundoverlay1080p,
        [string]$TCoverlay4k,
        [string]$TCoverlay1080p,
        [string]$Posteroverlay4KDoVi,
        [string]$Posteroverlay4KHDR10,
        [string]$Posteroverlay4KDoViHDR10,
        [string]$Backgroundoverlay4KDoVi,
        [string]$Backgroundoverlay4KHDR10,
        [string]$Backgroundoverlay4KDoViHDR10,
        [string]$TCoverlay4KDoVi,
        [string]$TCoverlay4KHDR10,
        [string]$TCoverlay4KDoViHDR10
    )

    $paths = @(
        $font, $RTLfont, $backgroundfont, $titlecardfont, $Posteroverlay,
        $Collectionoverlay, $Backgroundoverlay, $titlecardoverlay, $Seasonoverlay,
        $Posteroverlay4k, $Posteroverlay1080p, $Backgroundoverlay4k,
        $Backgroundoverlay1080p, $TCoverlay4k, $TCoverlay1080p,$Posteroverlay4KDoVi, $Posteroverlay4KHDR10, $Posteroverlay4KDoViHDR10,
        $Backgroundoverlay4KDoVi, $Backgroundoverlay4KHDR10, $Backgroundoverlay4KDoViHDR10,
        $TCoverlay4KDoVi, $TCoverlay4KHDR10, $TCoverlay4KDoViHDR10
    )

    foreach ($path in $paths) {
        # Only check the path if it's not null or empty.
        # This allows optional overlays (set to null in config) to pass.
        if ((-not [string]::IsNullOrEmpty($path)) -and (-not (Test-Path -LiteralPath $path.TrimEnd()))) {
            Write-Entry -Message "Could not find file in: $path" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Check config for typos and make sure that the file is present in scriptroot." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }

    if ($errorCount -ge 1) {
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "File missing"
        }
        Exit
    }
}
function Get-Platform {
    if ($global:OSType -eq 'Docker') {
        return 'Docker'
    }
    elseif ($global:OSType -eq 'Unix' -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -notlike 'PSDocker*') {
        # Check if it is a Mac
        $unameOutput = & uname
        if ($unameOutput -like "*Darwin*") {
            return 'macOS'
        }
        Else {
            return 'Linux'
        }
    }
    elseif ($global:OSType -eq 'Win32NT') {
        return 'Windows'
    }
    else {
        return 'Unknown'
    }
}
function Get-LatestScriptVersion {
    try {
        return Invoke-RestMethod -Uri "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Release.txt" -Method Get -ErrorAction Stop
    }
    catch {
        Write-Entry -Subtext "Could not query latest script version, Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return $null
    }
}
function RotateLogs {
    param (
        [string]$ScriptRoot
    )

    $logFolder = Join-Path $ScriptRoot "Logs"
    $global:RotationFolderName = "RotatedLogs"
    $RotationFolder = Join-Path $ScriptRoot $global:RotationFolderName

    # Create Rotation Folder if missing
    if (!(Test-Path -path $RotationFolder)) {
        New-Item -ItemType Directory -Path $ScriptRoot -Name $global:RotationFolderName -Force | Out-Null
    }

    # Check if the log folder exists
    if (Test-Path -Path $logFolder -PathType Container) {
        # Rename the existing log folder with a timestamp
        $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
        Rename-Item -Path $logFolder -NewName "Logs`_$timestamp"
        # Create Rotation Folder if missing
        if (!(Test-Path $RotationFolder)) {
            New-Item -ItemType Directory -Path $ScriptRoot -Name $global:RotationFolderName -Force | Out-Null
        }
        # Move logs to Rotation Folder
        Move-Item -Path "$logFolder`_$timestamp" $RotationFolder
    }
}
function CheckConfigFile {
    param (
        [string]$ScriptRoot
    )

    if (!(Test-Path (Join-Path $ScriptRoot 'config.json'))) {
        Write-Entry -Message "Config File missing, downloading it for you..." -Path "$ScriptRoot\Logs\Scriptlog.log" -Color White -log Info
        Invoke-WebRequest -Uri "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/config.example.json" -OutFile "$ScriptRoot\config.json"
        Write-Entry -Subtext "Config File downloaded here: '$ScriptRoot\config.json'" -Path "$ScriptRoot\Logs\Scriptlog.log" -Color White -log Info
        Write-Entry -Subtext "Please configure the config file according to GitHub, Exit script now..." -Path "$ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Configure config file"
        }
        Exit
    }
}
function Test-And-Download {
    param(
        [string]$url,
        [string]$destination
    )

    if (!(Test-Path $destination)) {
        Invoke-WebRequest -Uri $url -OutFile $destination
    }
}
function RedactMediaServerUrl {
    param(
        [string]$url
    )

    # Match Plex URLs containing X-Plex-Token
    $plexMatch = $url -match "(https?://)([^:/]+)(:\d+)?(/[^?]+)(\?X-Plex-Token=)([^&]+)(.*)"

    # Match Jellyfin/Emby URLs containing api_key
    $otherMatch = $url -match "(https?://)([^:/]+)(:\d+)?(/[^?]+)(\?api_key=)([^&]+)(.*)"

    if ($plexMatch -or $otherMatch) {
        $protocol = $Matches[1]
        $hostname = $Matches[2]
        $port = $Matches[3]
        $path = $Matches[4]
        $prefix = $Matches[5]   # Either "?X-Plex-Token=" or "?api_key="
        $token = $Matches[6]
        $suffix = $Matches[7]

        # Redact IP address or hostname
        $redactedHostname = $hostname -replace "(?<=.{3}).", "*"

        # Redact API Token
        $redactedToken = $($token[0..7] -join '') + "*******"

        # Construct the redacted URL
        $redactedUrl = $protocol + $redactedHostname + $port + $path + $prefix + $redactedToken + $suffix

        return $redactedUrl
    }
    else {
        return $url  # Return original if no match found
    }
}
function CheckPlexAccess {
    param (
        [string]$PlexUrl,
        [string]$PlexToken
    )

    if ($PlexToken) {
        Write-Entry -Message "Plex token found, checking access now..." -Path $configLogging -Color White -log Info
        try {
            $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/?X-Plex-Token=$PlexToken" -ErrorAction Stop -Headers $extraPlexHeaders
            if ($response.StatusCode -eq 200) {
                Write-Entry -Subtext "Plex access is working..." -Path $configLogging -Color Green -log Info
                # Check if libs are available
                [XML]$Libs = $response.Content
                # Plex Debug info
                $plexdebuginfo = Invoke-WebRequest -Uri "$PlexUrl/?X-Plex-Token=$PlexToken" -ErrorAction Stop -Headers $extraPlexHeaders
                [XML]$plexdebuginfo = $plexdebuginfo.Content
                Write-Entry -Subtext "Plex Server Version: $($plexdebuginfo.MediaContainer.version)" -Path $configLogging -Color Cyan -log Debug
                Write-Entry -Subtext "My Plex Server: $($plexdebuginfo.MediaContainer.myPlex)"-Path $configLogging -Color Cyan -log Debug
                Write-Entry -Subtext "Plex Server Signin State: $($plexdebuginfo.MediaContainer.myPlexSigninState)" -Path $configLogging -Color Cyan -log Debug
                Write-Entry -Subtext "Plex Server allow Deletion: $($plexdebuginfo.MediaContainer.allowMediaDeletion)" -Path $configLogging -Color Cyan -log Debug
                if ($Libs.MediaContainer.size -ge 1) {
                    return $Libs
                }
                else {
                    Write-Entry -Subtext "No libs on Plex, abort script now..." -Path $configLogging -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "No Plex Libs found"
                    }
                    Exit
                }
            }
            else {
                Write-Entry -Message "Could not access Plex with this URL: $(RedactMediaServerUrl -url "$PlexUrl/library/sections/?X-Plex-Token=$PlexToken")" -Path $configLogging -Color Red -Log Error
                Write-Entry -Subtext "Please check token and access..." -Path $configLogging -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Could not access plex"
                }
                Exit
            }
        }
        catch {
            Write-Entry -Subtext "Could not access Plex with this URL: $(RedactMediaServerUrl -url "$PlexUrl/library/sections/?X-Plex-Token=$PlexToken")" -Path $configLogging -Color Red -Log Error
            Write-Entry -Subtext "Error occurred while accessing Plex server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Could not access plex"
            }
            Exit
        }
    }
    else {
        Write-Entry -Message "Checking Plex access now..." -Path $configLogging -Color White -log Info
        try {
            $result = Invoke-WebRequest -Uri "$PlexUrl/library/sections" -ErrorAction SilentlyContinue -Headers $extraPlexHeaders
            if ($result.StatusCode -eq 200) {
                Write-Entry -Subtext "Plex access is working..." -Path $configLogging -Color Green -log Info
                # Check if libs are available
                [XML]$Libs = $result.Content
                # Plex Debug info
                $plexdebuginfo = Invoke-WebRequest -Uri "$PlexUrl" -ErrorAction Stop -Headers $extraPlexHeaders
                [XML]$plexdebuginfo = $plexdebuginfo.Content
                Write-Entry -Subtext "Plex Server Version: $($plexdebuginfo.MediaContainer.version)" -Path $configLogging -Color Cyan -log Debug
                Write-Entry -Subtext "My Plex Server: $($plexdebuginfo.MediaContainer.myPlex)"-Path $configLogging -Color Cyan -log Debug
                Write-Entry -Subtext "Plex Server Signin State: $($plexdebuginfo.MediaContainer.myPlexSigninState)" -Path $configLogging -Color Cyan -log Debug
                Write-Entry -Subtext "Plex Server allow Deletion: $($plexdebuginfo.MediaContainer.allowMediaDeletion)" -Path $configLogging -Color Cyan -log Debug
                if ($Libs.MediaContainer.size -ge 1) {
                    Write-Entry -Subtext "Found libs on Plex..." -Path $configLogging -Color White -log Info
                    return $Libs
                }
                else {
                    Write-Entry -Subtext "No libs on Plex, abort script now..." -Path $configLogging -Color Red -log Error
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "No libs on plex"
                    }
                    Exit
                }
            }
        }
        catch {
            Write-Entry -Subtext "Error occurred while accessing Plex server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            Write-Entry -Subtext "Please check access and settings in Plex..." -Path $configLogging -Color Yellow -log Warning
            Write-Entry -Message "To be able to connect to Plex without authentication" -Path $configLogging -Color White -log Info
            Write-Entry -Message "You have to enter your IP range in 'Settings -> Network -> List of IP addresses and networks that are allowed without auth: '192.168.1.0/255.255.255.0''" -Path $configLogging -Color White -log Info
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Could not access plex"
            }
            Exit
        }
    }
}
function CheckImageMagick {
    param (
        [string]$magick,
        [string]$magickinstalllocation
    )

    if (!(Test-Path $magick)) {
        if ($global:OSType -ne "Win32NT") {
            if ($global:OSType -ne "Docker") {
                Write-Entry -Message "ImageMagick missing, downloading the portable version for you..." -Path $configLogging -Color Yellow -log Warning
                $magickUrl = "https://imagemagick.org/archive/binaries/magick"
                Invoke-WebRequest -Uri $magickUrl -OutFile "$global:ScriptRoot/magick"
                chmod +x "$global:ScriptRoot/magick"
                Write-Entry -Subtext "Made the portable Magick executable..." -Path $configLogging -Color Green -log Info
            }
        }
        else {

            $result = Invoke-WebRequest "https://imagemagick.org/archive/binaries/?C=M;O=D"
            $LatestRelease = ($result.links.href | Where-Object { $_ -like '*portable-Q16-HDRI-x64.7z.zip' } | Sort-Object -Descending)[0]

            Write-Entry -Message "ImageMagick missing, please manually install/copy portable Imagemagick from here: https://imagemagick.org/archive/binaries/$LatestRelease" -Path $configLogging -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Exit
        }
    }
}
function CheckOverlayDimensions {
    param (
        [string]$Posteroverlay,
        [string]$Seasonoverlay,
        [string]$Backgroundoverlay,
        [string]$Collectionoverlay,
        [string]$Titlecardoverlay,
        [string]$Posteroverlay4k,
        [string]$Posteroverlay1080p,
        [string]$Backgroundoverlay4k,
        [string]$Backgroundoverlay1080p,
        [string]$TCoverlay4k,
        [string]$TCoverlay1080p,
        [string]$PosterSize,
        [string]$BackgroundSize,
        [string]$Posteroverlay4KDoVi,
        [string]$Posteroverlay4KHDR10,
        [string]$Posteroverlay4KDoViHDR10,
        [string]$Backgroundoverlay4KDoVi,
        [string]$Backgroundoverlay4KHDR10,
        [string]$Backgroundoverlay4KDoViHDR10,
        [string]$TCoverlay4KDoVi,
        [string]$TCoverlay4KHDR10,
        [string]$TCoverlay4KDoViHDR10
    )
    # This function checks a single overlay's dimensions
    function Test-Dimension {
        param (
            [string]$OverlayPath,
            [string]$ExpectedSize,
            [string]$OverlayName
        )

        # If the path is $null or empty (i.e., optional overlay not configured),
        if ([string]::IsNullOrEmpty($OverlayPath)) {
            return
        }

        try {
            $actualDimensions = & $magick $OverlayPath -format "%wx%h" info:

            if ($actualDimensions -eq $ExpectedSize) {
                Write-Entry -Subtext "$OverlayName is correctly sized at: $ExpectedSize" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            }
            else {
                Write-Entry -Subtext "$OverlayName is NOT correctly sized at: $ExpectedSize. Actual dimensions: $actualDimensions" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
        }
        catch {
            Write-Entry -Subtext "Failed to check dimensions for $OverlayName at path $OverlayPath. Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }

    # Standard Poster Types (expect PosterSize)
    Test-Dimension -OverlayPath $Posteroverlay -ExpectedSize $PosterSize -OverlayName "Poster overlay"
    Test-Dimension -OverlayPath $Seasonoverlay -ExpectedSize $PosterSize -OverlayName "Season overlay"
    Test-Dimension -OverlayPath $Collectionoverlay -ExpectedSize $PosterSize -OverlayName "Collection overlay"
    Test-Dimension -OverlayPath $Posteroverlay4k -ExpectedSize $PosterSize -OverlayName "4K Poster overlay"
    Test-Dimension -OverlayPath $Posteroverlay1080p -ExpectedSize $PosterSize -OverlayName "1080p Poster overlay"

    # Standard Background/TC Types (expect BackgroundSize)
    Test-Dimension -OverlayPath $Backgroundoverlay -ExpectedSize $BackgroundSize -OverlayName "Background overlay"
    Test-Dimension -OverlayPath $Titlecardoverlay -ExpectedSize $BackgroundSize -OverlayName "TitleCard overlay"
    Test-Dimension -OverlayPath $Backgroundoverlay4k -ExpectedSize $BackgroundSize -OverlayName "4K Background overlay"
    Test-Dimension -OverlayPath $Backgroundoverlay1080p -ExpectedSize $BackgroundSize -OverlayName "1080p Background overlay"
    Test-Dimension -OverlayPath $TCoverlay4k -ExpectedSize $BackgroundSize -OverlayName "4K TitleCard overlay"
    Test-Dimension -OverlayPath $TCoverlay1080p -ExpectedSize $BackgroundSize -OverlayName "1080p TitleCard overlay"

    # New 4K Poster Types (expect PosterSize)
    Test-Dimension -OverlayPath $Posteroverlay4KDoVi -ExpectedSize $PosterSize -OverlayName "4K DoVi Poster overlay"
    Test-Dimension -OverlayPath $Posteroverlay4KHDR10 -ExpectedSize $PosterSize -OverlayName "4K HDR10 Poster overlay"
    Test-Dimension -OverlayPath $Posteroverlay4KDoViHDR10 -ExpectedSize $PosterSize -OverlayName "4K DoVi/HDR10 Poster overlay"

    # New 4K Background Types (expect BackgroundSize)
    Test-Dimension -OverlayPath $Backgroundoverlay4KDoVi -ExpectedSize $BackgroundSize -OverlayName "4K DoVi Background overlay"
    Test-Dimension -OverlayPath $Backgroundoverlay4KHDR10 -ExpectedSize $BackgroundSize -OverlayName "4K HDR10 Background overlay"
    Test-Dimension -OverlayPath $Backgroundoverlay4KDoViHDR10 -ExpectedSize $BackgroundSize -OverlayName "4K DoVi/HDR10 Background overlay"

    # New 4K TC Types (expect BackgroundSize)
    Test-Dimension -OverlayPath $TCoverlay4KDoVi -ExpectedSize $BackgroundSize -OverlayName "4K DoVi TitleCard overlay"
    Test-Dimension -OverlayPath $TCoverlay4KHDR10 -ExpectedSize $BackgroundSize -OverlayName "4K HDR10 TitleCard overlay"
    Test-Dimension -OverlayPath $TCoverlay4KDoViHDR10 -ExpectedSize $BackgroundSize -OverlayName "4K DoVi/HDR10 TitleCard overlay"
}
function InvokeMagickCommand {
    param (
        [string]$Command,
        [string]$Arguments
    )

    function GetMagickErrorMessage {
        param (
            [string]$ErrorMessage
        )

        # Split the error message into lines
        $lines = $ErrorMessage -split "convert: |magick.exe: |@"
        if ($lines[1]) {
            return $lines[1]
        }
        Else {
            return $lines[0]
        }
    }

    try {
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = $Command
        $processInfo.Arguments = $Arguments
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.UseShellExecute = $false
        $processInfo.CreateNoWindow = $true

        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $processInfo

        try {
            $process.Start() | Out-Null

            # Capture error
            $errorOutput = $process.StandardError.ReadToEnd()

            # Wait for the process to exit
            $process.WaitForExit()

            # Check if there was any error output
            if (-not [string]::IsNullOrWhiteSpace($errorOutput)) {
                Write-Entry -Subtext "An error occurred while executing the magick command:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext (GetMagickErrorMessage $errorOutput) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "$errorOutput" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }
        catch {
            Write-Entry -Subtext "Failed to start the process or read the error output:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext $_.Exception.Message -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
        finally {
            if ($process) {
                $process.Dispose()
            }
        }
    }
    catch {
        Write-Entry -Subtext "An unexpected error occurred while setting up the process:" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Write-Entry -Subtext $_.Exception.Message -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

    }
}
function CheckCharLimit {
    # Attempt to get the registry key
    try {
        $regKey = Get-Item -ErrorAction Stop -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem"

        # Get the value of LongPathsEnabled
        $longPathsEnabled = $regKey.GetValue("LongPathsEnabled")

        if ($longPathsEnabled -eq 1) {
            return $true
        }
        Else {
            return $false
        }
    }
    catch {
        # Handle any errors accessing the registry key
        Write-Entry -Subtext "$($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return $false
    }
}
function CheckJellyfinAccess {
    param (
        [string]$JellyfinUrl,
        [string]$JellyfinAPI
    )

    if ($JellyfinAPI) {
        Write-Entry -Message "Checking Jellyfin access now..." -Path $configLogging -Color White -log Info
        try {
            $response = Invoke-RestMethod -Method Get -Uri "$JellyfinUrl/System/Info?api_key=$JellyfinAPI" -ErrorAction Stop
            if ($response.version) {
                Write-Entry -Subtext "Jellyfin access is working..." -Path $configLogging -Color Green -log Info
            }
            else {
                Write-Entry -Message "Could not access Jellyfin" -Path $configLogging -Color Red -Log Error
                Write-Entry -Subtext "Please check token and url..." -Path $configLogging -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Cloud not access jellyfin"
                }
                Exit
            }
        }
        catch {
            Write-Entry -Subtext "Could not access Jellyfin" -Path $configLogging -Color Red -Log Error
            Write-Entry -Subtext "Error occurred while accessing Jellyfin server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Cloud not access jellyfin"
            }
            Exit
        }
    }
}
function CheckEmbyAccess {
    param (
        [string]$EmbyUrl,
        [string]$EmbyAPI
    )

    if ($EmbyAPI) {
        Write-Entry -Message "Checking Emby access now..." -Path $configLogging -Color White -log Info
        try {
            $response = Invoke-RestMethod -Method Get -Uri "$EmbyUrl/System/Info?api_key=$EmbyAPI" -ErrorAction Stop
            if ($response.version) {
                Write-Entry -Subtext "Emby access is working..." -Path $configLogging -Color Green -log Info
            }
            else {
                Write-Entry -Message "Could not access Emby" -Path $configLogging -Color Red -Log Error
                Write-Entry -Subtext "Please check token and url..." -Path $configLogging -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Cloud not access emby"
                }
                Exit
            }
        }
        catch {
            Write-Entry -Subtext "Could not access Emby" -Path $configLogging -Color Red -Log Error
            Write-Entry -Subtext "Error occurred while accessing Emby server: $($_.Exception.Message)" -Path $configLogging -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Cloud not access emby"
            }
            Exit
        }
    }
}
function UploadOtherMediaServerArtwork {
    param (
        [string]$itemId,
        [string]$imageType,
        [string]$imagePath
    )

    # Check if current image already has exif data
    $Imageinfo = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/items/$itemId/images/?api_key=$OtherMediaServerApiKey"
    $Imageinfotemp = $Imageinfo | Where-Object imagetype -eq $imageType | Select-Object Height, Width, Path
    if ($Imageinfotemp) {
        $Imageinfotemp = $imageinfotemp[0]
    }
    # Clear value to ensure no old data causes a false skip
    $value = $null

    # Set the API endpoint URL for magick exif check
    if (($imageinfotemp.Height) -and ($imageinfotemp.width)) {
        try {
            $ImageUrl = "$OtherMediaServerUrl/items/$itemId/images/$imageType/?api_key=$OtherMediaServerApiKey&width=$($imageinfotemp.width)&height=$($imageinfotemp.Height)"
            $tempFile = Join-Path -Path $global:ScriptRoot -ChildPath "temp\hashcompare.jpg"

            # Try to download the image
            $response = Invoke-WebRequest -Uri $ImageUrl -OutFile $tempFile -ErrorAction Stop

            $magickcommand = "& `"$magick`" identify -verbose `"$tempFile`""
            $magickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
            $value = Invoke-Expression $magickcommand | Select-String -Pattern 'overlay|titlecard|created with ppm|created with posterizarr'

            Remove-Item $tempFile -Force -ErrorAction SilentlyContinue | out-null
        }
        catch {
            # Log as a warning (not error) so we know why the check failed, but don't stop the script
            Write-Entry -Subtext "Exif check skipped (Image 404 or missing). Proceeding to upload. Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

            # Ensure temp file cleanup happens if the download partially succeeded or failed
            if (Test-Path $tempFile) {
                Remove-Item $tempFile -Force -ErrorAction SilentlyContinue | out-null
            }
        }
    }

    if ($value -and $DisableHashValidation -eq 'false') {
        $ExifFound = $True
        Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, skip upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }
    Else {
        if ($DisableHashValidation -eq 'false') {
            Write-Entry -Subtext "No posterizarr/kometa/tcm exif data found, starting upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        # Read the image file as binary
        $imageData = [System.IO.File]::ReadAllBytes($imagePath)

        # Convert the image to a base64 string
        $imageBase64 = [Convert]::ToBase64String($imageData)

        # Determine the content type based on the file extension
        switch ([System.IO.Path]::GetExtension($imagePath).ToLower()) {
            ".jpg" { $contentType = "image/jpeg" }
            ".jpeg" { $contentType = "image/jpeg" }
            ".png" { $contentType = "image/png" }
            ".gif" { $contentType = "image/gif" }
            ".bmp" { $contentType = "image/bmp" }
            ".tiff" { $contentType = "image/tiff" }
            default {
                Write-Entry -Subtext "Unsupported image format." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Unsupported image format"
                }
                exit
            }
        }

        # Set the API endpoint URL
        $apiUrl = "$OtherMediaServerUrl/items/$itemId/images/$imageType/?api_key=$OtherMediaServerApiKey"

        if ($imageType -eq "Backdrop") {
            $deleteUrl = "$OtherMediaServerUrl/items/$itemId/images/$imageType/0?api_key=$OtherMediaServerApiKey"
            # Make the API request to delete the backdrop image
            try {
                # Delete the existing image first
                $response = Invoke-RestMethod -Uri $deleteUrl -Method Delete -ErrorAction Stop
                Write-Entry -Subtext "Image successfully deleted..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $UploadCount++
            }
            catch {
                if ($_.Exception.Response -is [System.Net.Http.HttpResponseMessage] -and $_.Exception.Response.Content) {
                    try {
                        $response = $_.Exception.Response.Content.ReadAsStringAsync().Result
                    }
                    catch {
                        $response = "Unable to read server response (content may be disposed)."
                    }
                    Write-Entry -Subtext "Failed to delete image. Server response: $response" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
                else {
                    Write-Entry -Subtext "Failed to delete image. Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:ReplaceThumbwithBackdrop -eq 'true') {
                # Make the API request to upload the Thumb image
                $thumbapiUrl = "$OtherMediaServerUrl/items/$itemId/images/Thumb/?api_key=$OtherMediaServerApiKey"
                try {
                    $response = Invoke-RestMethod -Uri $thumbapiUrl -Method Post -Body $imageBase64 -ContentType $contentType -ErrorAction Stop

                    Write-Entry -Subtext "Thumb Image successfully uploaded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $UploadCount++
                }
                catch {
                    if ($_.Exception.Response -is [System.Net.Http.HttpResponseMessage] -and $_.Exception.Response.Content) {
                        try {
                            $response = $_.Exception.Response.Content.ReadAsStringAsync().Result
                        }
                        catch {
                            $response = "Unable to read server response (content may be disposed)."
                        }
                        Write-Entry -Subtext "Failed to upload Thumb image. Server response: $response" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                    else {
                        Write-Entry -Subtext "Failed to upload Thumb image. Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
            }
        }
        # Make the API request to upload the image
        try {
            $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Body $imageBase64 -ContentType $contentType -ErrorAction Stop

            Write-Entry -Subtext "Image successfully uploaded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
            $UploadCount++
        }
        catch {
            if ($_.Exception.Response -is [System.Net.Http.HttpResponseMessage] -and $_.Exception.Response.Content) {
                try {
                    $response = $_.Exception.Response.Content.ReadAsStringAsync().Result
                }
                catch {
                    $response = "Unable to read server response (content may be disposed)."
                }
                Write-Entry -Subtext "Failed to upload image. Server response: $response" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
            else {
                Write-Entry -Subtext "Failed to upload image. Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
    }
}
function MassDownloadPlexArtwork {
    function GetPlexArtworkUrl {
        param(
            [string]$ArtUrl,
            [string]$TempImage
        )
        try {
            Invoke-WebRequest -Uri $ArtUrl -OutFile $TempImage -Headers $extraPlexHeaders
        }
        catch {
            Write-Entry -Subtext "Could not download Artwork from plex, Error Message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            continue
        }

        $magickcommand = "& `"$magick`" identify -verbose `"$TempImage`""
        $magickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

        # Execute command and get exif data
        $value = (Invoke-Expression $magickcommand | Select-String -Pattern 'overlay|titlecard|created with ppm|created with posterizarr')

        if ($value) {
            $ExifFound = $True
            Write-Entry -Subtext "Artwork has exif data from posterizarr/kometa/tcm, downloading it now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
            $global:posterurl = $ArtUrl
        }
        Else {
            Write-Entry -Subtext "No posterizarr/kometa/tcm exif data found, downloading it now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            $global:posterurl = $ArtUrl
        }
    }
    $Mode = "backup"
    Write-Entry -Message "Backup Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Query plex libs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libsoverview = @()
    foreach ($lib in $Libs.MediaContainer.Directory) {
        if ($lib.title -notin $LibstoExclude) {
            $libtemp = New-Object psobject
            $libtemp | Add-Member -MemberType NoteProperty -Name "ID" -Value $lib.key
            $libtemp | Add-Member -MemberType NoteProperty -Name "Name" -Value $lib.title
            $libtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $lib.language

            # Check if $lib.location.path is an array
            if ($lib.location.path -is [array]) {
                $paths = $lib.location.path -join ',' # Convert array to string
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $paths
            }
            else {
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $lib.location.path
            }
            # Check if Libname has chars we cant use for Folders
            if ($lib.title -notmatch "^[^\/:*?`"<>\|\\}]+$") {
                Write-Entry -Message  "Lib: '$($lib.title)' contains invalid characters." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Please rename your lib and remove all chars that are listed here: '/, :, *, ?, `", <, >, |, \, or }'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Invalid lib chars"
                }
                Exit
            }
            $Libsoverview += $libtemp
        }
    }
    if ($($Libsoverview.count) -lt 1) {
        Write-Entry -Subtext "0 libraries were found. Are you on the correct Plex server?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
    Write-Entry -Subtext "Found '$($Libsoverview.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = $Libsoverview.Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    Foreach ($Library in $Libsoverview) {
        if ($Library.Name -notin $LibstoExclude) {
            $PlexHeaders = @{}
            if ($PlexToken) {
                $PlexHeaders['X-Plex-Token'] = $PlexToken
            }

            # Create a parent XML document
            $Libcontent = New-Object -TypeName System.Xml.XmlDocument
            $mediaContainerNode = $Libcontent.CreateElement('MediaContainer')
            $Libcontent.AppendChild($mediaContainerNode) | Out-Null

            # Initialize variables for pagination
            $searchsize = 0
            $totalContentSize = 1

            # Loop until all content is retrieved
            do {
                # Set headers for the current request
                $PlexHeaders['X-Plex-Container-Start'] = $searchsize
                $PlexHeaders['X-Plex-Container-Size'] = '1000'

                # Fetch content from Plex server
                $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/$($Library.ID)/all" -Headers $PlexHeaders

                # Convert response content to XML
                [xml]$additionalContent = $response.Content

                # Get total content size if not retrieved yet
                if ($totalContentSize -eq 1) {
                    $totalContentSize = $additionalContent.MediaContainer.totalSize
                }

                # Import and append video nodes to the parent XML document
                $contentquery = if ($additionalContent.MediaContainer.video) {
                    'video'
                }
                else {
                    'Directory'
                }
                foreach ($videoNode in $additionalContent.MediaContainer.$contentquery) {
                    $importedNode = $Libcontent.ImportNode($videoNode, $true)
                    [void]$mediaContainerNode.AppendChild($importedNode)
                }

                # Update search size for next request
                $searchsize += [int]$additionalContent.MediaContainer.Size
            } until ($searchsize -ge $totalContentSize)
            if ($Libcontent.MediaContainer.video) {
                $contentquery = 'video'
            }
            Else {
                $contentquery = 'Directory'
            }
            foreach ($item in $Libcontent.MediaContainer.$contentquery) {
                $extractedFolder = $null
                $Seasondata = $null
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children? -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                }
                $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
                $tmdbpattern = 'tmdb://(\d+)'
                $imdbpattern = 'imdb://tt(\d+)'
                $tvdbpattern = 'tvdb://(\d+)'
                if ($Metadata.MediaContainer.$contentquery.Location) {
                    $location = $Metadata.MediaContainer.$contentquery.Location.path
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                Else {
                    $location = $Metadata.MediaContainer.$contentquery.media.part.file
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                        $CheckCharLimit = CheckCharLimit
                        if ($CheckCharLimit -eq $false) {
                            Write-Entry -Subtext "Skipping [$($item.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            continue
                        }
                    }

                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                if ($Seasondata) {
                    $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
                    $SeasonNames = $SeasonsTemp.Title -join ';'
                    $SeasonNumbers = $SeasonsTemp.index -join ','
                    $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
                    $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
                }
                $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
                $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
                $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
                if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
                if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
                if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

                # check if there are more then 1 entry in id´s
                if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
                if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
                if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

                if ($Metadata.MediaContainer.$contentquery.Label.tag) {
                    $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
                }
                Else {
                    $Labels = ""
                }
                $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $FileMetadata | ForEach-Object {
                        if ($_.streamType -eq '1') {
                            $Resolution = $_.displayTitle
                        }
                    }
                }
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.Name
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $($item.title)
                if ($FileMetadata) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $($item.originalTitle)
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $item.year
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
                $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $item.ratingKey
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
                $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
                $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
                $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    Write-Entry -Message "Export everything to a csv: $global:ScriptRoot\Logs\PlexLibexport.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Initialize counter variable
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $PosterUnknownCount = 0
    $SkipTBACount = 0
    $SkipJapTitleCount = 0
    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    # Getting information of all Episodes
    if ($global:TitleCards -eq 'true') {
        Write-Entry -Message "Query episodes data from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Test if csv´s are missing and create dummy file.
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -ErrorAction SilentlyContinue)) {
        $EpisodeDummycsv = New-Object psobject

        # Add members to the object with empty values
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $null

        $EpisodeDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexEpisodeExport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexLibexport.csv" -ErrorAction SilentlyContinue)) {
        # Add members to the object with empty values
        $PlexLibDummycsv = New-Object psobject
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "title" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "year" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Path" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $null

        $PlexLibDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexLibexport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
        $totalSize = 0
        $excludePath = Join-Path -Path $BackupPath -ChildPath 'Collections'

        if ($FollowSymlink) {
            Get-ChildItem -Path $BackupPath -Recurse -FollowSymlink | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $BackupPath -Recurse | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }

        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }

    # Download poster foreach movie
    Write-Entry -Message "Starting asset download now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster/Background download part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

    $checkedItems = @()
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                $SkippingText = 'false'
                $global:posterurl = $null
                $global:ImageMagickError = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $global:IsFallback = $null
                $global:PlexartworkDownloaded = $null
                $global:langCode = $null
                $global:direction = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    $PosterImageoriginal = "$BackupPath\$($entry.RootFoldername).jpg"
                    $TestPath = $BackupPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }
                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $checkedItems += $hashtestpath

                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkippingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:TextlessPoster = $null
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:ImageMagickError = $null
                        $Arturl = $null

                        if ($entry.PlexPosterUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexPosterUrl
                            }
                        }
                        Write-Entry -Message "Searching on Plex for $Titletext - Poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $PosterImage
                        if ($global:posterurl) {
                            try {
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                            }
                            catch {
                                if ($_.Exception.Response) {
                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                }
                                else {
                                    $statusCode = $_.Exception.Message
                                }
                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error


                            }
                            # Move file back to original naming with Brackets.
                            if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                try {
                                    # Attempt to move the item
                                    Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                    # Log success if move was successful
                                    Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                }
                                catch {
                                    # Log the error if the move operation fails
                                    Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $posterCount++
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
                # Now we can start the Background Poster Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        $backgroundImageoriginal = "$BackupPath\$($entry.RootFoldername)_background.jpg"
                        $TestPath = $BackupPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath

                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkippingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:ImageMagickError = $null
                        $global:TextlessPoster = $null
                        $Arturl = $null

                        if ($entry.PlexBackgroundUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl
                            }
                        }
                        Write-Entry -Message "Searching on Plex for $Titletext - Background" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                        if ($BackgroundfontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $BackgroundImage
                        if ($global:posterurl) {
                            try {
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                            }
                            catch {
                                if ($_.Exception.Response) {
                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                }
                                else {
                                    $statusCode = $_.Exception.Message
                                }
                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            }

                            # Move file back to original naming with Brackets.
                            if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                try {
                                    # Attempt to move the item
                                    Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                    # Log success if move was successful
                                    Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                }
                                catch {
                                    # Log the error if the move operation fails
                                    Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $posterCount++
                                $BackgroundCount++
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
    }

    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Download part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # Define Global Variables
            $SkippingText = 'false'
            $global:tmdbid = $entry.tmdbid
            $global:tvdbid = $entry.tvdbid
            $global:imdbid = $entry.imdbid
            $Seasonpostersearchtext = $null
            $global:ImageMagickError = $null
            $Episodepostersearchtext = $null
            $global:TMDBfallbackposterurl = $null
            $global:fanartfallbackposterurl = $null
            $FanartSearched = $null
            $global:plexalreadysearched = $null
            $global:posterurl = $null
            $global:PosterWithText = $null
            $global:AssetTextLang = $null
            $global:TMDBAssetTextLang = $null
            $global:FANARTAssetTextLang = $null
            $global:TVDBAssetTextLang = $null
            $global:TMDBAssetChangeUrl = $null
            $global:FANARTAssetChangeUrl = $null
            $global:TVDBAssetChangeUrl = $null
            $global:IsFallback = $null
            $global:FallbackText = $null
            $global:Fallback = $null
            $global:TextlessPoster = $null
            $global:tvdbalreadysearched = $null
            $global:PlexartworkDownloaded = $null
            $global:langCode = $null
            $global:direction = $null

            # Determine the language direction
            $global:langCode = $entry.'Library Language'
            $global:direction = $global:languageDirections[$global:langCode]

            $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

            if ($entry.title -match $cjkPattern) {
                $Titletext = $entry.originalTitle
            }
            else {
                $Titletext = $entry.title
            }

            if ($LibraryFolders -eq 'true') {
                $LibraryName = $entry.'Library Name'
                $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                $PosterImageoriginal = "$EntryDir\poster.jpg"
                $TestPath = $EntryDir
                $Testfile = "poster"

                if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                    New-Item -ItemType Directory -path $EntryDir -Force | out-null
                }
            }
            Else {
                $PosterImageoriginal = "$BackupPath\$($entry.RootFoldername).jpg"
                $TestPath = $BackupPath
                $Testfile = $($entry.RootFoldername)
            }

            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
            }
            else {
                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                if ($fullTestPath) {
                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                }
                Else {
                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                }
            }

            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
            $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

            # Now we can start the Poster Part
            if ($global:Posters -eq 'true') {
                $checkedItems += $hashtestpath

                if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                    $Arturl = $null
                    if ($entry.PlexPosterUrl -like "/library/*") {
                        if ($PlexToken) {
                            $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $entry.PlexPosterUrl
                        }
                    }
                    Write-Entry -Message "Searching on Plex for $Titletext - Poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                    GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $PosterImage

                    if ($fontAllCaps -eq 'true') {
                        $joinedTitle = $Titletext.ToUpper()
                    }
                    Else {
                        $joinedTitle = $Titletext
                    }
                    if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                        $global:posterurl = $global:TMDBfallbackposterurl
                    }
                    if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                        $global:posterurl = $global:fanartfallbackposterurl
                    }
                    if ($global:posterurl) {
                        try {
                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                        }
                        catch {
                            if ($_.Exception.Response) {
                                $statusCode = $_.Exception.Response.StatusCode.value__
                            }
                            else {
                                $statusCode = $_.Exception.Message
                            }
                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                        if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                            # Move file back to original naming with Brackets.
                            try {
                                # Attempt to move the item
                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                # Log success if move was successful
                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                            }
                            catch {
                                # Log the error if the move operation fails
                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            }
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $posterCount++
                        }

                    }
                    Else {
                        Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    }
                }
                else {
                    if ($show_skipped -eq 'true' ) {
                        Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                    }
                }
            }
            # Now we can start the Background Part
            if ($global:BackgroundPosters -eq 'true') {
                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    $EntryDir = "$BackupPath\$LibraryName\$($entry.RootFoldername)"
                    $backgroundImageoriginal = "$EntryDir\background.jpg"
                    $TestPath = $EntryDir
                    $Testfile = "background"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    $backgroundImageoriginal = "$BackupPath\$($entry.RootFoldername)_background.jpg"
                    $TestPath = $BackupPath
                    $Testfile = "$($entry.RootFoldername)_background"
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                $checkedItems += $hashtestpath

                if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                    # Define Global Variables
                    $SkippingText = 'false'
                    $global:tmdbid = $entry.tmdbid
                    $global:tvdbid = $entry.tvdbid
                    $global:imdbid = $entry.imdbid
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:TextlessPoster = $null
                    $global:ImageMagickError = $null
                    $Arturl = $null
                    if ($entry.PlexBackgroundUrl -like "/library/*") {
                        if ($PlexToken) {
                            $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                        }
                        Else {
                            $Arturl = $plexurl + $entry.PlexBackgroundUrl
                        }
                    }
                    Write-Entry -Message "Searching on Plex for $Titletext - Background" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                    GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $backgroundImage

                    if ($BackgroundfontAllCaps -eq 'true') {
                        $joinedTitle = $Titletext.ToUpper()
                    }
                    Else {
                        $joinedTitle = $Titletext
                    }
                    if ($global:posterurl) {
                        try {
                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                        }
                        catch {
                            if ($_.Exception.Response) {
                                $statusCode = $_.Exception.Response.StatusCode.value__
                            }
                            else {
                                $statusCode = $_.Exception.Message
                            }
                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                        # Move file back to original naming with Brackets.
                        if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                            try {
                                # Attempt to move the item
                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                # Log success if move was successful
                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                            }
                            catch {
                                # Log the error if the move operation fails
                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            }
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $BackgroundCount++
                            $posterCount++
                        }
                    }
                    Else {
                        Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    }
                }
                else {
                    if ($show_skipped -eq 'true' ) {
                        Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                    }
                }
            }
            # Now we can start the Season Part
            if ($global:SeasonPosters -eq 'true') {
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:AssetTextLang = $null
                $global:Fallback = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:PosterWithText = $null
                $global:ImageMagickError = $null
                $global:TextlessPoster = $null
                $global:seasonNames = $entry.SeasonNames -split ';'
                $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                $global:seasonNumbers = $entry.seasonNumbers -split ','
                $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                    $SkippingText = 'false'
                    $global:posterurl = $null
                    $global:seasontmp = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:TMDBSeasonFallback = $null
                    $global:TVDBSeasonFallback = $null
                    $global:FANARTSeasonFallback = $null
                    if ($SeasonfontAllCaps -eq 'true') {
                        $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                    }
                    Else {
                        $global:seasonTitle = $global:seasonNames[$i]
                    }
                    $global:SeasonNumber = $global:seasonNumbers[$i]
                    $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                    $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                    if ($null -ne $global:SeasonNumber) {
                        $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                    }
                    if ($LibraryFolders -eq 'true') {
                        $SeasonImageoriginal = "$EntryDir\$global:seasontmp.jpg"
                        $TestPath = $EntryDir
                        $Testfile = "$global:seasontmp"
                    }
                    Else {
                        $SeasonImageoriginal = "$BackupPath\$($entry.RootFoldername)_$global:seasontmp.jpg"
                        $TestPath = $BackupPath
                        $Testfile = "$($entry.RootFoldername)_$global:seasontmp"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $SeasonImageoriginal = ($SeasonImageoriginal).Replace('\', '/').Replace('./', '/')
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:seasontmp.jpg"
                    $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath

                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        $Arturl = $null
                        if ($global:PlexSeasonUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $global:PlexSeasonUrl
                            }
                        }
                        if (!$Seasonpostersearchtext) {
                            Write-Entry -Message "Searching on Plex for $Titletext - Season" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $Seasonpostersearchtext = $true
                        }
                        GetPlexArtworkUrl -ArtUrl $Arturl -TempImage $SeasonImage
                        if ($global:posterurl) {
                            try {
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                            }
                            catch {
                                if ($_.Exception.Response) {
                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                }
                                else {
                                    $statusCode = $_.Exception.Message
                                }
                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            }
                            if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                # Move file back to original naming with Brackets.
                                try {
                                    # Attempt to move the item
                                    Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                    # Log success if move was successful
                                    Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                }
                                catch {
                                    # Log the error if the move operation fails
                                    Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $SeasonCount++
                                $posterCount++
                            }
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
            }
            # Now we can start the Episode Part
            if ($global:TitleCards -eq 'true') {
                # Loop through each episode
                foreach ($episode in $Episodedata) {
                    $SkippingText = 'false'
                    $global:AssetTextLang = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:season_number = $null
                    $Episodepostersearchtext = $null
                    $global:show_name = $null
                    $global:episodenumber = $null
                    $global:episode_numbers = $null
                    $global:titles = $null
                    $global:posterurl = $null
                    $global:FileNaming = $null
                    $EpisodeImageoriginal = $null
                    $EpisodeImage = $null
                    $global:Fallback = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:TextlessPoster = $null

                    if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                        $global:show_name = $episode."Show Name"
                        $global:season_number = $episode."Season Number"
                        $global:episode_numbers = $episode."Episodes".Split(",")
                        $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                        $global:titles = $episode."Title".Split(";")
                        $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                        $global:ImageMagickError = $null
                        for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                            $SkippingText = 'false'
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:posterurl = $null
                            $Episodepostersearchtext = $null
                            $ExifFound = $null
                            $global:PlexartworkDownloaded = $null
                            $value = $null
                            $magickcommand = $null
                            $Arturl = $null
                            $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                            $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                            $global:EPTitle = $($global:titles[$i].Trim())
                            $global:episodenumber = $($global:episode_numbers[$i].Trim())
                            $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                            $bullet = [char]0x2022
                            $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                            if ($LibraryFolders -eq 'true') {
                                $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                $TestPath = $EntryDir
                                $Testfile = "$global:FileNaming"
                            }
                            Else {
                                $EpisodeImageoriginal = "$BackupPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                $TestPath = $BackupPath
                                $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                }
                            }

                            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                            $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                            $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                            $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                            $checkedItems += $hashtestpath

                            if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                $Arturl = $null
                                if ($global:PlexTitleCardUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $global:PlexTitleCardUrl
                                    }
                                }
                                Write-Entry -Message "Searching on Plex for $global:show_name | $global:SeasonEPNumber - Titlecard" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                GetPlexArtworkUrl -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                if ($global:posterurl) {
                                    try {
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        Write-Entry -Subtext "Downloading Titlecard from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $EpisodeCount++
                                        $posterCount++
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }

                            }
                            else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images downloaded: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters downloaded: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images downloaded: $SeasonCount | Background images downloaded: $BackgroundCount | TitleCards downloaded: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-TextSizeCacheSummary
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    Send-SummaryNotification -ScriptMode $Mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -FallbackCount $FallbackCount.count -TextlessCount $TextlessCount.count -TruncatedCount $TextTruncatedCount.count -PosterUnknownCount $PosterUnknownCount -PosterCount $posterCount -BackgroundCount $BackgroundCount -SeasonCount $SeasonCount -EpisodeCount $EpisodeCount

    # Export json
    $jsonObject = [PSCustomObject]@{
        Posters              = if ($posterCount) { $posterCount } Else { 0 }
        Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
        Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
        Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
        Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
        Mode                 = $Mode
        Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
        Errors               = if ($errorCount) { $errorCount } Else { 0 }
        Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
        Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
        Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
        Text                 = if ($TextCount) { $TextCount } Else { 0 }
        "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
        "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
        "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
        "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
        "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
        "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
        "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
        "Script Version"     = $CurrentScriptVersion
        "IM Version"         = $global:CurrentImagemagickversion
        "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
        "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
    }

    $jsonOutput = $jsonObject | ConvertTo-Json
    $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
function SyncPlexArtwork {
    param(
        [string]$ArtUrl,
        [string]$DestUrl,
        [string]$imageType,
        [string]$title,
        [string]$artworktype
    )
    $startmessage = $null

    if ($show_skipped -eq 'true') {
        Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $startmessage = $true
    }
    Else {
        Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
        if ($global:logLevel -eq '3') {
            $startmessage = $true
        }
    }

    try {
        Write-Entry -Subtext "Fetching image from source: $(RedactMediaServerUrl -url $ArtUrl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $imageResponse = Invoke-WebRequest -Uri $ArtUrl -Headers $extraPlexHeaders -UseBasicParsing -ErrorAction Stop
    }
    catch {
        # Attempt to parse JSON error response
        $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json -ErrorAction SilentlyContinue

        if ($errorResponse) {
            $errorTitle = $errorResponse.title
            $errorStatus = $errorResponse.status
            if (-not $startmessage) {
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve source image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
        else {
            if (-not $startmessage) {
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve source image: Unknown error" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }

        return
    }


    if ($imageResponse.StatusCode -ne 200) {
        if (-not $startmessage) {
            Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-Entry -Subtext "Unexpected response from source ($(RedactMediaServerUrl -url $ArtUrl)): $($imageResponse.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return
    }

    $remoteImageBytes = $imageResponse.Content
    if (-not $remoteImageBytes) {
        if (-not $startmessage) {
            Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-Entry -Subtext "Source image content is empty!" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return
    }

    $remoteImageContentType = $imageResponse.Headers.'Content-Type'
    if ($remoteImageContentType -is [System.Array]) {
        $remoteImageContentType = $remoteImageContentType[0]
    }

    Write-Entry -Subtext "Calculating hash for remote image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    $remoteImageHash = GetHash -imageBytes $remoteImageBytes

    try {
        Write-Entry -Subtext "Fetching existing image from destination: $(RedactMediaServerUrl -url $DestUrl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $existingImageResponse = Invoke-WebRequest -Uri $DestUrl -UseBasicParsing -ErrorAction Stop
    }
    catch {
        # Attempt to parse JSON error response
        $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json -ErrorAction SilentlyContinue

        if ($errorResponse) {
            $errorTitle = $errorResponse.title
            $errorStatus = $errorResponse.status
            if (-not $startmessage) {
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve destination image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
        else {
            if (-not $startmessage) {
                Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Write-Entry -Subtext "Failed to retrieve destination image: Unknown error" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }

        return
    }


    if ($existingImageResponse.StatusCode -ne 200) {
        if (-not $startmessage) {
            Write-Entry -Message "Starting SyncPlexArtwork for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-Entry -Subtext "Unexpected response from destination ($(RedactMediaServerUrl -url $DestUrl)): $($existingImageResponse.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        return
    }

    $existingImageBytes = $existingImageResponse.Content
    if (-not $existingImageBytes) {
        Write-Entry -Subtext "Existing image content is empty!" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    }

    $existingImageHash = GetHash -imageBytes $existingImageBytes
    if ($remoteImageHash -eq $existingImageHash) {
        if ($show_skipped -eq 'true') {
            Write-Entry -Subtext "Image hashes match, skipping upload for $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Else {
            Write-Entry -Subtext "Image hashes match, skipping upload for $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
        }
        if ($DisableHashValidation -eq 'true') {
            Write-Entry -Subtext "Hash validation is disabled, proceeding with upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
        }
        else {
            return
        }
    }

    Write-Entry -Subtext "Uploading new artwork to Jelly/Emby for: $title" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    if ($imageType -eq 'Backdrop') {
        try {
            Write-Entry -Subtext "Deleting old artwork before upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Invoke-RestMethod -Uri $DestUrl -Method Delete -ErrorAction Stop
            Write-Entry -Subtext "Successfully deleted old artwork." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        catch {
            # Attempt to parse JSON error response
            $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json -ErrorAction SilentlyContinue

            if ($errorResponse) {
                $errorTitle = $errorResponse.title
                $errorStatus = $errorResponse.status

                Write-Entry -Subtext "Error deleting image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
            else {
                Write-Entry -Subtext "Error deleting image: Unknown error" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }

    }

    try {
        $imageBase64 = [Convert]::ToBase64String($remoteImageBytes)
        $response = Invoke-RestMethod -Uri $DestUrl -Method Post -Body $imageBase64 -ContentType $remoteImageContentType -ErrorAction Stop
        Write-Entry -Subtext "Image uploaded successfully." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

        switch ($artworktype) {
            'poster' { $postercount++ }
            'tc' { $EpisodeCount++ }
            'background' { $BackgroundCount++ }
            'season' { $SeasonCount++ }
        }
        $UploadCount++
    }
    catch {
        # Attempt to parse JSON error response
        $message = $_.ErrorDetails.Message
        if ($message -match '^\s*\{.*\}\s*$') {
            $errorResponse = $message | ConvertFrom-Json -ErrorAction SilentlyContinue
        }

        if ($errorResponse) {
            $errorTitle = $errorResponse.title
            $errorStatus = $errorResponse.status

            Write-Entry -Subtext "Error uploading image: Status: $errorStatus, Title: $errorTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
        else {
            Write-Entry -Subtext "Error uploading image: $message" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }

}
function Send-UptimeKumaWebhook {
    param (
        [string]$status,
        [string]$msg = "OK",
        [int]$ping = 0
    )

    $uri = $global:UptimeKumaUrl + "?status=$status&msg=$msg&ping=$ping"
    try {
        $null = Invoke-RestMethod -Uri $uri
        Write-Entry -Message "Uptime Kuma webhook sent: Status=$status, Msg=$msg, Ping=$ping" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    catch {
        Write-Entry -Message "Failed to send Uptime Kuma webhook: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
}

function Write-TextSizeCacheSummary {
    param([string]$Label = "Text-size cache")
    $total=$script:tsHits+$script:tsMiss
    $rate = if($total){[math]::Round(100*$script:tsHits/$total,2)}else{0}
    $avg  = if($script:tsRuns){[math]::Round($script:tsMs/$script:tsRuns,2)}else{0}
    $saved=[TimeSpan]::FromMilliseconds([double]($script:tsHits*$avg))
    Write-Entry -Subtext ("{0}: hits='{1}', misses='{2}' ({3}%); magick_calls='{4}' in '{5} ms'; est_saved='{6}h {7}m {8}s'" -f `
    $Label,$script:tsHits,$script:tsMiss,$rate,$script:tsRuns,$script:tsMs,$saved.Hours,$saved.Minutes,$saved.Seconds) `
    -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
}

function Send-SummaryNotification {
    param (
        [string]$ScriptMode,
        [string]$FormattedTimespawn,
        [int]$ErrorCount,
        [int]$FallbackCount,
        [int]$TextlessCount,
        [int]$TruncatedCount,
        [int]$PosterUnknownCount,
        [int]$SkipTBACount,
        [int]$SkipJapTitleCount,
        [int]$PosterCount,
        [int]$BackgroundCount,
        [int]$SeasonCount,
        [int]$EpisodeCount,
        [int]$ImagesCleared,
        [int]$PathsCleared,
        [string]$SavedSizeString,
        [int]$UploadCount
    )

    if (-not ($global:NotifyUrl -and $global:SendNotification -eq 'true')) {
        return # Do nothing if notifications are off
    }

    # 1. Handle Apprise (Docker)
    if ($global:NotifyUrl -notlike '*discord*' -and $env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
        $body = "Run took: $FormattedTimespawn`nIt Created '$PosterCount' Images"
        if ($ScriptMode -eq 'backup') {
            $body = "Run took: $FormattedTimespawn`nIt Downloaded '$PosterCount' Images"
        }
        if ($ScriptMode -eq 'syncjelly' -or $ScriptMode -eq 'syncemby') {
            $body = "Run took: $FormattedTimespawn`nIt Synced '$UploadCount' Images"
        }

        if ($ErrorCount -ge '1') {
            apprise --notification-type="failure" --title="Posterizarr" --body="$body`n`nDuring execution '$ErrorCount' Errors occurred, please check log." "$global:NotifyUrl"
        } else {
            apprise --notification-type="success" --title="Posterizarr" --body="$body" "$global:NotifyUrl"
        }
        return
    }

    # 2. Handle Discord
    if ($global:NotifyUrl -like '*discord*') {

        $desc = "Run took: $FormattedTimespawn"
        if ($ScriptMode -eq 'backup') {
            $desc = "Backup Run took: $FormattedTimespawn"
        }
        if ($ScriptMode -eq 'syncjelly' -or $ScriptMode -eq 'syncemby') {
            $desc = "Sync Run took: $FormattedTimespawn"
        }
        if ($ScriptMode -eq 'testing') {
            $desc = "Test run took: $FormattedTimespawn"
        }
        if ($ScriptMode -eq 'tautulli' -or $ScriptMode -eq 'arr') {
            $desc = "Recently added Run took: $FormattedTimespawn"
        }

        if ($ErrorCount -ge '1') {
            $desc += "`nDuring execution Errors occurred, please check log."
        }

        # Build Fields
        $fieldList = [System.Collections.Generic.List[object]]::new()

        # --- Stats Section ---
        $fieldList.Add([PSCustomObject]@{ name = ""; value = ":bar_chart:"; inline = $false })
        if ($ScriptMode -eq 'testing') {
            $fieldList.Add([PSCustomObject]@{ name = "Truncated"; value = $TruncatedCount; inline = $false })
        } else {
            $fieldList.Add([PSCustomObject]@{ name = "Errors"; value = $ErrorCount; inline = $false })
            $fieldList.Add([PSCustomObject]@{ name = "Fallbacks"; value = $FallbackCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Textless"; value = $TextlessCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Truncated"; value = $TruncatedCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Unknown"; value = $PosterUnknownCount; inline = $true })
            if ($SkipTBA -eq 'true' -or $SkipJapTitle -eq 'true') {
                $fieldList.Add([PSCustomObject]@{ name = "TBA Skipped"; value = $SkipTBACount; inline = $true })
                $fieldList.Add([PSCustomObject]@{ name = "Jap/Chinese Skipped"; value = $SkipJapTitleCount; inline = $true })
            }
        }

        # --- Images Section ---
        $fieldList.Add([PSCustomObject]@{ name = ""; value = ":frame_photo:"; inline = $false })
        if ($ScriptMode -eq 'backup') {
            $fieldList.Add([PSCustomObject]@{ name = "Posters Downloaded"; value = ($PosterCount - $SeasonCount - $BackgroundCount - $EpisodeCount); inline = $false })
            $fieldList.Add([PSCustomObject]@{ name = "Backgrounds Downloaded"; value = $BackgroundCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Seasons Downloaded"; value = $SeasonCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "TitleCards Downloaded"; value = $EpisodeCount; inline = $true })
        } elseif ($ScriptMode -eq 'syncjelly' -or $ScriptMode -eq 'syncemby') {
            $fieldList.Add([PSCustomObject]@{ name = "Posters Uploaded"; value = ($UploadCount - $SeasonCount - $BackgroundCount - $EpisodeCount); inline = $false })
            $fieldList.Add([PSCustomObject]@{ name = "Backgrounds Uploaded"; value = $BackgroundCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Seasons Uploaded"; value = $SeasonCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "TitleCards Uploaded"; value = $EpisodeCount; inline = $true })
        } else {
            if ($ScriptMode -eq 'testing') {
                $fieldList.Add([PSCustomObject]@{ name = "Posters"; value = $posterscount; inline = $false })
            } else {
                # For Normal/Arr/Tautulli, $PosterCount IS the total, so subtraction is correct.
                $fieldList.Add([PSCustomObject]@{ name = "Posters"; value = ($PosterCount - $SeasonCount - $BackgroundCount - $EpisodeCount); inline = $false })
            }
            $fieldList.Add([PSCustomObject]@{ name = "Backgrounds"; value = $BackgroundCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Seasons"; value = $SeasonCount; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "TitleCards"; value = $EpisodeCount; inline = $true })
        }

        # --- Cleanup Section ---
        if ($AssetCleanup -eq 'true' -and $ScriptMode -ne 'testing' -and $ScriptMode -ne 'backup' -and $ScriptMode -ne 'syncjelly' -and $ScriptMode -ne 'syncemby') {
            $fieldList.Add([PSCustomObject]@{ name = ""; value = ":recycle:"; inline = $false })
            $fieldList.Add([PSCustomObject]@{ name = "Images cleared"; value = $ImagesCleared; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Folders Cleared"; value = $PathsCleared; inline = $true })
            $fieldList.Add([PSCustomObject]@{ name = "Space saved"; value = $SavedSizeString; inline = $true })
        }

        # Build final payload
        $payloadObject = [PSCustomObject]@{
            username   = $global:DiscordUserName
            avatar_url = "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/docs/images/webhook.png"
            content    = ""
            embeds     = @(
                [PSCustomObject]@{
                    author    = @{
                        name = "Posterizarr @Github"
                        url  = "https://github.com/fscorrupt/posterizarr"
                    }
                    description = $desc
                    timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
                    color     = $(if ($ErrorCount -ge '1') { 16711680 } Elseif ($Testing) { 8388736 } Elseif ($FallbackCount -gt '1' -or $PosterUnknownCount -ge '1' -or $TruncatedCount -gt '1') { 15120384 } Else { 5763719 })
                    fields    = $fieldList
                    thumbnail = @{
                        url = "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/docs/images/webhook.png"
                    }
                    footer    = @{
                        text = "$Platform  | vCurr: $CurrentScriptVersion | vNext: $LatestScriptVersion | IM vCurr: $global:CurrentImagemagickversion | IM vNext: $global:LatestImagemagickversion"
                    }
                }
            )
        }

        $jsonPayload = $payloadObject | ConvertTo-Json -Depth 6
        $webhookUrl = $global:NotifyUrl.replace('discord://', 'https://discord.com/api/webhooks/')
        Push-ObjectToDiscord -strDiscordWebhook $webhookUrl -objPayload $jsonPayload
    }
}

#### FUNCTION END ####

##### PRE-START #####
$global:errorCount = 0
# ---- text-size cache stats (minimal) ----
if (-not (Get-Variable -Name tsHits -Scope Script -ErrorAction SilentlyContinue)) { [int]  $script:tsHits = 0 }
if (-not (Get-Variable -Name tsMiss -Scope Script -ErrorAction SilentlyContinue)) { [int]  $script:tsMiss = 0 }
if (-not (Get-Variable -Name tsRuns -Scope Script -ErrorAction SilentlyContinue)) { [int]  $script:tsRuns = 0 }
if (-not (Get-Variable -Name tsMs   -Scope Script -ErrorAction SilentlyContinue)) { [int64]$script:tsMs   = 0 }
# -----------------------------------------
#region Variables
# Set Branch
if ($dev) {
    $Branch = 'dev'
}
Else {
    $Branch = 'main'
}

# Set some global vars
Set-OSTypeAndScriptRoot
# Get platform
$Platform = Get-Platform
# Get Latest Script Version
$LatestScriptVersion = (Get-LatestScriptVersion -split "`r?`n" | Select-Object -First 1).Trim()
##### START #####
$startTime = Get-Date

if ($arrTriggers) {
    $ArrTrigger = $arrTriggers['ArrTrigger']
}

# Check if the environment variable exists and is not empty, otherwise use the default
if (-not [string]::IsNullOrEmpty($env:FONTCONFIG_CACHE_DIR)) {
    $IM_Font_Cache = $env:FONTCONFIG_CACHE_DIR
}
else {
    $IM_Font_Cache = "/var/cache/fontconfig"
}

$Font_Cache = "/usr/share/fonts/custom/"
# Rotate logs before doing anything!
$folderPattern = "Logs_*"
$global:RotationFolderName = $null
$global:logLevel = 2
RotateLogs -ScriptRoot $global:ScriptRoot
$LogsPath = Join-Path $global:ScriptRoot 'Logs'
$TempPath = Join-Path $global:ScriptRoot 'temp'
$TestPath = Join-Path $global:ScriptRoot 'test'
$WatcherPath = Join-Path $global:ScriptRoot 'watcher'
$CurrentlyRunning = Join-Path $TempPath 'Posterizarr.Running'

# Check for PWSH
if ($PSVersionTable.PSVersion.Major -lt 7) {
    Write-Entry -Message "This script requires PowerShell 7 (Core) or newer." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    Write-Entry -Subtext "You are currently running version $($PSVersionTable.PSVersion.tostring()). Please upgrade and try again." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    return
}

# Set Text Size Cache Path
if (-not $Global:TextSizeCachePath) {
    $Global:TextSizeCachePath = Join-Path $global:ScriptRoot 'Cache\text_size_cache.json'
}
try {
    $cacheDir = Split-Path -Parent $Global:TextSizeCachePath
    if ($cacheDir -and -not (Test-Path -LiteralPath $cacheDir)) { New-Item -ItemType Directory -Path $cacheDir -Force | Out-Null }
} catch {}

Write-Entry -Message "Starting..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
# Create directories if they don't exist
foreach ($path in $LogsPath, $TempPath, $TestPath, $WatcherPath) {
    if (!(Test-Path $path)) {
        New-Item -ItemType Directory -Path $path -Force | Out-Null
        Write-Entry -Message "Created missing directory: $path" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}
# Check if Config file is present
CheckConfigFile -ScriptRoot $global:ScriptRoot
# Test Json if something is missing
CheckJson -jsonExampleUrl "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/config.example.json" -jsonFilePath $(Join-Path $global:ScriptRoot 'config.json')
# Check if Script is Latest
if ($CurrentScriptVersion -eq $LatestScriptVersion) {
    Write-Entry -Message "You are Running Version - v$CurrentScriptVersion" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
}
Else {
    Write-Entry -Message "You are Running Version: v$CurrentScriptVersion - Latest Version is: v$LatestScriptVersion" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
}
# load config file
$config = Get-Content -Raw -Path $(Join-Path $global:ScriptRoot 'config.json') | ConvertFrom-Json

# Replace Script with Latest
if ($Platform -ne 'Docker' -and $config.PrerequisitePart.AutoUpdatePosterizarr.tolower() -eq 'true' -and $CurrentScriptVersion -ne $LatestScriptVersion) {
    Write-Entry -Subtext "Posterizarr version upgrade started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $CurrentScriptPath = $MyInvocation.MyCommand.Path

    # Backup the current script
    Write-Entry -Subtext "Backup current Script to: $CurrentScriptPath.bak" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Copy-Item -Path $CurrentScriptPath -Destination "$CurrentScriptPath.bak" -Force
    try {
        Invoke-WebRequest -Uri "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Posterizarr.ps1" -OutFile $CurrentScriptPath -ErrorAction Stop
        Write-Entry -Subtext "Posterizarr script updated to v$LatestScriptVersion, please restart script..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    catch {
        Write-Entry -Subtext "Failed to download the latest script, Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Script download failed"
    }
    Exit
}

# Now is the earliest that you can set your logLevel other than 2
# Read logLevel value from config.json
$global:logLevel = [int]$config.PrerequisitePart.logLevel
# Check if the cast was successful
if ($null -eq $global:logLevel) {
    Write-Entry -Message "Value for logLevel was null. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:logLevel = 1
}
# Ensure $logLevel is at least 1
if ($global:logLevel -le 0) {
    Write-Entry -Message "Value for logLevel -le 0. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:logLevel = 1
}# Ensure $logLevel is le 3
if ($global:logLevel -gt 3) {
    Write-Entry -Message "Value for logLevel -gt 3. Setting it to 3. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:logLevel = 3
}
# Read naxLogs value from config.json
$maxLogs = [int]$config.PrerequisitePart.maxLogs  # Cast to integer
# Check if the cast was successful
if ($null -eq $maxLogs) {
    Write-Entry -Message "Value for maxLogs was null. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $maxLogs = 1
}
# Ensure $maxLogs is at least 1
if ($maxLogs -le 0) {
    Write-Entry -Message "Value for maxLogs -le 0. Setting it to 1. Adjust your config.json accordingly." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $maxLogs = 1
}
# Delete excess log folders
$logFolders = Get-ChildItem -Path $(Join-Path $global:ScriptRoot $global:RotationFolderName) -Directory | Where-Object { $_.Name -match $folderPattern } | Sort-Object CreationTime -Descending | Select-Object -First $maxLogs
foreach ($folder in (Get-ChildItem -Path $(Join-Path $global:ScriptRoot $global:RotationFolderName) -Directory | Where-Object { $_.Name -match $folderPattern })) {
    if ($folder.FullName -notin $logFolders.FullName) {
        Remove-Item -Path $folder.FullName -Recurse -Force
        $fldrName = $folder.FullName
        Write-Entry -Message "Deleting excess folder: $fldrName" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}

# Access variables from the config file
# Notification Part
$global:SendNotification = $config.Notification.SendNotification.tolower()
$global:UseUptimeKuma = $config.Notification.UseUptimeKuma.tolower()
$global:DiscordUserName = $config.Notification.DiscordUserName
if ($global:UseUptimeKuma -eq 'true') {
    $global:UptimeKumaUrl = $config.Notification.UptimeKumaUrl
}

if ($env:POWERSHELL_DISTRIBUTION_CHANNEL -like 'PSDocker*') {
    $global:NotifyUrl = $config.Notification.AppriseUrl
    if ($global:NotifyUrl -eq 'discord://{WebhookID}/{WebhookToken}/' -and $global:SendNotification -eq 'true') {
        # Try the normal discord url
        $global:NotifyUrl = $config.Notification.Discord
        if ($global:NotifyUrl -eq 'https://discordapp.com/api/webhooks/{WebhookID}/{WebhookToken}' -and $global:SendNotification -eq 'true') {
            Write-Entry -Message "Found default Notification Url, please update url in config..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Default notify url in config"
            }
            Exit
        }
    }
    if (!$global:NotifyUrl -and $global:SendNotification -eq 'true') {
        $global:NotifyUrl = $config.Notification.Discord
    }
}
Else {
    $global:NotifyUrl = $config.Notification.Discord
    if ($global:NotifyUrl -eq 'https://discordapp.com/api/webhooks/{WebhookID}/{WebhookToken}' -and $global:SendNotification -eq 'true') {
        Write-Entry -Message "Found default Notification Url, please update url in config..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Default notify url in config"
        }
        Exit
    }
}

# API Part
$global:tvdbapi = $config.ApiPart.tvdbapi
if ($global:tvdbapi -match '#') {
    $global:tvdbpin = $global:tvdbapi.split('#')[1]
    $global:tvdbapi = $global:tvdbapi.split('#')[0]
}
$global:tmdbtoken = $config.ApiPart.tmdbtoken
$FanartTvAPIKey = $config.ApiPart.FanartTvAPIKey
$PlexToken = $config.ApiPart.PlexToken
$JellyfinAPIKey = $config.ApiPart.JellyfinAPIKey
$EmbyAPIKey = $config.ApiPart.EmbyAPIKey
$global:WidthHeightFilter = $config.ApiPart.WidthHeightFilter.tolower()
$global:PosterMinWidth = $config.ApiPart.PosterMinWidth
$global:PosterMinHeight = $config.ApiPart.PosterMinHeight
$global:BgTcMinWidth = $config.ApiPart.BgTcMinWidth
$global:BgTcMinHeight = $config.ApiPart.BgTcMinHeight
$global:FavProvider = $config.ApiPart.FavProvider.ToUpper()
$global:TMDBVoteSorting = $config.ApiPart.tmdb_vote_sorting.tolower()

if (!$global:TMDBVoteSorting) {
    Write-Entry -Message "TMDB Sorting option not set in config, setting it to 'vote_average' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:TMDBVoteSorting = "vote_average"
}

# 1. Load user-configured values
$global:PreferredLanguageOrder = $config.ApiPart.PreferredLanguageOrder
$global:PreferredSeasonLanguageOrder = $config.ApiPart.PreferredSeasonLanguageOrder
$global:PreferredTCLanguageOrder = $config.ApiPart.PreferredTCLanguageOrder
$global:PreferredBackgroundLanguageOrder = $config.ApiPart.PreferredBackgroundLanguageOrder

# Special handling: inherit poster language if set to "PleaseFillMe"
if ($global:PreferredBackgroundLanguageOrder -eq 'PleaseFillMe') {
    $global:PreferredBackgroundLanguageOrder = $global:PreferredLanguageOrder
}
if ($global:PreferredTCLanguageOrder -eq 'PleaseFillMe') {
    $global:PreferredTCLanguageOrder = $global:PreferredLanguageOrder
}
# 2️. Initialize all settings — function will validate and set defaults if needed
Initialize-LanguageSettings -SettingName "PreferredLanguageOrder"           -Label "Poster"
Initialize-LanguageSettings -SettingName "PreferredSeasonLanguageOrder"     -Label "Season"
Initialize-LanguageSettings -SettingName "PreferredTCLanguageOrder"         -Label "TC"
Initialize-LanguageSettings -SettingName "PreferredBackgroundLanguageOrder" -Label "Background"

# default to TMDB if favprovider missing
if (!$global:FavProvider) {
    Write-Entry -Message "FavProvider not set in config, setting it to 'TMDB' for you" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    $global:FavProvider = 'TMDB'
}

# Define the language direction hash table
$global:languageDirections = @{
    "af" = "LTR"; "am" = "LTR"; "ar" = "RTL"; "az" = "LTR"; "be" = "LTR";
    "bg" = "LTR"; "bn" = "LTR"; "bs" = "LTR"; "ca" = "LTR"; "cs" = "LTR";
    "cy" = "LTR"; "da" = "LTR"; "de" = "LTR"; "dv" = "RTL"; "el" = "LTR";
    "en" = "LTR"; "eo" = "LTR"; "es" = "LTR"; "et" = "LTR"; "eu" = "LTR";
    "fa" = "RTL"; "fi" = "LTR"; "fo" = "LTR"; "fr" = "LTR"; "ga" = "LTR";
    "gd" = "LTR"; "gl" = "LTR"; "gu" = "LTR"; "he" = "RTL"; "hi" = "LTR";
    "hr" = "LTR"; "hu" = "LTR"; "hy" = "LTR"; "id" = "LTR"; "is" = "LTR";
    "it" = "LTR"; "ja" = "LTR"; "ka" = "LTR"; "kk" = "LTR"; "km" = "LTR";
    "kn" = "LTR"; "ko" = "LTR"; "ku" = "LTR"; "ky" = "LTR"; "lo" = "LTR";
    "lt" = "LTR"; "lv" = "LTR"; "mg" = "LTR"; "mk" = "LTR"; "ml" = "LTR";
    "mn" = "LTR"; "mr" = "LTR"; "ms" = "LTR"; "mt" = "LTR"; "my" = "LTR";
    "nb" = "LTR"; "ne" = "LTR"; "nl" = "LTR"; "nn" = "LTR"; "no" = "LTR";
    "om" = "LTR"; "or" = "LTR"; "pa" = "LTR"; "pl" = "LTR"; "ps" = "RTL";
    "pt" = "LTR"; "ro" = "LTR"; "ru" = "LTR"; "sd" = "RTL"; "si" = "LTR";
    "sk" = "LTR"; "sl" = "LTR"; "sq" = "LTR"; "sr" = "LTR"; "sv" = "LTR";
    "sw" = "LTR"; "ta" = "LTR"; "te" = "LTR"; "th" = "LTR"; "tk" = "LTR";
    "tr" = "LTR"; "ug" = "RTL"; "uk" = "LTR"; "ur" = "RTL"; "uz" = "LTR";
    "vi" = "LTR"; "yo" = "LTR"; "zh" = "LTR"
}

# Plex Part
$PlexUrl = $config.PlexPart.PlexUrl
$UsePlex = $config.PlexPart.UsePlex.tolower()
if ($UsePlex -eq 'true') {
    $LibstoExclude = $config.PlexPart.LibstoExclude
    $global:UploadExistingAssets = $config.PlexPart.UploadExistingAssets.tolower()
}

# Jellyfin Part
$JellyfinUrl = $config.JellyfinPart.JellyfinUrl
$UseJellyfin = $config.JellyfinPart.UseJellyfin.tolower()
if ($UseJellyfin -eq 'true') {
    $LibstoExclude = $config.JellyfinPart.LibstoExclude
    $OtherMediaServerUrl = $JellyfinUrl
    $UseOtherMediaServer = $UseJellyfin
    $OtherMediaServerApiKey = $JellyfinAPIKey
    $global:UploadExistingAssets = $config.JellyfinPart.UploadExistingAssets.tolower()
    $global:ReplaceThumbwithBackdrop = $config.JellyfinPart.ReplaceThumbwithBackdrop.tolower()
}

# Emby Part
$EmbyUrl = $config.EmbyPart.EmbyUrl
$UseEmby = $config.EmbyPart.UseEmby.tolower()
if ($UseEmby -eq 'true') {

    # Check and normalize Emby URL
    # Only modify if IP or localhost and missing /emby
    if ($EmbyUrl -match '^http[s]?://(?:localhost|\d{1,3}(?:\.\d{1,3}){3})(:\d+)?(?!/emby)(/?$)') {
        # Append /emby if it's not already there
        $EmbyUrl = $EmbyUrl.TrimEnd('/') + '/emby'
        Write-Entry -Message "Your Emby URL is missing '/emby' at the end. It has been auto-corrected, but please update your config.json to avoid this message." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
    }

    $LibstoExclude = $config.EmbyPart.LibstoExclude
    $OtherMediaServerUrl = $EmbyUrl
    $UseOtherMediaServer = $UseEmby
    $OtherMediaServerApiKey = $EmbyAPIKey
    $global:UploadExistingAssets = $config.EmbyPart.UploadExistingAssets.tolower()
    $global:ReplaceThumbwithBackdrop = $config.EmbyPart.ReplaceThumbwithBackdrop.tolower()
}

# Count how many media servers are enabled
$enabledServers = 0
if ($UseEmby -eq 'true') { $enabledServers++ }
if ($UseJellyfin -eq 'true') { $enabledServers++ }
if ($UsePlex -eq 'true') { $enabledServers++ }

# If more than one media server is enabled, exit with an error
if ($enabledServers -gt 1) {
    Write-Entry -Message "You have enabled more than one media server - Please use only one." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Multiple media servers enabled"
    }
    Exit 0
}

# Prerequisites Part
$AutoUpdateIM = $config.PrerequisitePart.AutoUpdateIM.tolower()
$show_skipped = $config.PrerequisitePart.show_skipped.tolower()
$FileTestOnTrigger = $config.PrerequisitePart.FileTestOnTrigger.tolower()
$FollowSymlink = $config.PrerequisitePart.FollowSymlink.tolower()
$ForceRunningDeletion = $config.PrerequisitePart.ForceRunningDeletion.tolower()
$AssetPath = RemoveTrailingSlash $config.PrerequisitePart.AssetPath
$BackupPath = RemoveTrailingSlash $config.PrerequisitePart.BackupPath
$ManualAssetPath = RemoveTrailingSlash $config.PrerequisitePart.ManualAssetPath
$Upload2Plex = $config.PrerequisitePart.PlexUpload.tolower()
$SkipAddText = $config.PrerequisitePart.SkipAddText.tolower()
$SkipAddTextAndOverlay = $config.PrerequisitePart.SkipAddTextAndOverlay.tolower()
$DisableHashValidation = $config.PrerequisitePart.DisableHashValidation.tolower()
$global:DisableOnlineAssetFetch = $config.PrerequisitePart.DisableOnlineAssetFetch.tolower()

# Check if its a Network Share
if ($AssetPath.StartsWith("\")) {
    # add \ if it only Starts with one
    if (!$AssetPath.StartsWith("\\")) {
        $AssetPath = "\" + $AssetPath
    }
}

# Check if its a Network Share
if ($ManualAssetPath.StartsWith("\")) {
    # add \ if it only Starts with one
    if (!$ManualAssetPath.StartsWith("\\")) {
        $ManualAssetPath = "\" + $ManualAssetPath
    }
}

# Check if its a Network Share
if ($BackupPath.StartsWith("\")) {
    # add \ if it only Starts with one
    if (!$BackupPath.StartsWith("\\")) {
        $BackupPath = "\" + $BackupPath
    }
}

# Construct cross-platform paths
if ($global:OSType -ne "Win32NT") {
    $joinsymbol = "/"
}
Else {
    $joinsymbol = "\"
}
$font = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.font -join $($joinsymbol))
$collectionfont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.collectionfont -join $($joinsymbol))
$RTLFont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.RTLFont -join $($joinsymbol))
$backgroundfont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.backgroundfont -join $($joinsymbol))
$titlecardfont = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.titlecardfont -join $($joinsymbol))
$Posteroverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.overlayfile -join $($joinsymbol))
$Seasonoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.seasonoverlayfile -join $($joinsymbol))
$collectionoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.collectionoverlayfile -join $($joinsymbol))
$Backgroundoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.backgroundoverlayfile -join $($joinsymbol))
$titlecardoverlay = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.titlecardoverlayfile -join $($joinsymbol))
$testimage = Join-Path -Path $global:ScriptRoot -ChildPath ('test', 'testimage.png' -join $($joinsymbol))
$backgroundtestimage = Join-Path -Path $global:ScriptRoot -ChildPath ('test', 'backgroundtestimage.png' -join $($joinsymbol))
$LibraryFolders = $config.PrerequisitePart.LibraryFolders.tolower()
$global:SeasonPosters = $config.PrerequisitePart.SeasonPosters.tolower()
$global:Posters = $config.PrerequisitePart.Posters.tolower()
$global:BackgroundPosters = $config.PrerequisitePart.BackgroundPosters.tolower()
$global:TitleCards = $config.PrerequisitePart.TitleCards.tolower()
$SkipTBA = $config.PrerequisitePart.SkipTBA.tolower()
$SkipJapTitle = $config.PrerequisitePart.SkipJapTitle.tolower()
$AssetCleanup = $config.PrerequisitePart.AssetCleanup.tolower()
$NewLineOnSpecificSymbols = $config.PrerequisitePart.NewLineOnSpecificSymbols
if ($NewLineOnSpecificSymbols) {
    $NewLineOnSpecificSymbols = $NewLineOnSpecificSymbols.tolower()
}
$SymbolsToKeepOnNewLine = $config.PrerequisitePart.SymbolsToKeepOnNewLine
if ($SymbolsToKeepOnNewLine) {
    $SymbolsToKeepOnNewLine = $SymbolsToKeepOnNewLine.tolower()
}
$NewLineSymbols = $config.PrerequisitePart.NewLineSymbols

# Resolution Part
$UsePosterResolutionOverlays = $config.PrerequisitePart.UsePosterResolutionOverlays.tolower()
$UseBackgroundResolutionOverlays = $config.PrerequisitePart.UseBackgroundResolutionOverlays.tolower()
$UseTCResolutionOverlays = $config.PrerequisitePart.UseTCResolutionOverlays.tolower()

$4kposter = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.poster4k -join $($joinsymbol))
$1080pPoster = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.Poster1080p -join $($joinsymbol))
$4kBackground = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.Background4k -join $($joinsymbol))
$1080pBackground = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.Background1080p -join $($joinsymbol))
$4kTC = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.TC4k -join $($joinsymbol))
$1080pTC = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.TC1080p -join $($joinsymbol))

# Optional 4k
$4KDoVi = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KDoVi' -join $($joinsymbol))
$4KHDR10 = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KHDR10' -join $($joinsymbol))
$4KDoViHDR10 = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KDoViHDR10' -join $($joinsymbol))

$4KDoViBackground = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KDoViBackground' -join $($joinsymbol))
$4KHDR10Background = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KHDR10Background' -join $($joinsymbol))
$4KDoViHDR10Background = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KDoViHDR10Background' -join $($joinsymbol))

$4KDoViTC = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KDoViTC' -join $($joinsymbol))
$4KHDR10TC = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KHDR10TC' -join $($joinsymbol))
$4KDoViHDR10TC = Join-Path -Path $global:ScriptRoot -ChildPath ('temp', $config.PrerequisitePart.'4KDoViHDR10TC' -join $($joinsymbol))

# Poster Overlay Part
$global:ImageProcessing = $config.OverlayPart.ImageProcessing.tolower()
$global:outputQuality = $config.OverlayPart.outputQuality

# Poster Overlay Part
$fontAllCaps = $config.PosterOverlayPart.fontAllCaps.tolower()
$AddBorder = $config.PosterOverlayPart.AddBorder.tolower()
$AddText = $config.PosterOverlayPart.AddText.tolower()
$AddTextStroke = $config.PosterOverlayPart.AddTextStroke.tolower()
$strokecolor = $config.PosterOverlayPart.strokecolor
$strokewidth = $config.PosterOverlayPart.strokewidth
$AddOverlay = $config.PosterOverlayPart.AddOverlay.tolower()
$fontcolor = $config.PosterOverlayPart.fontcolor
$bordercolor = $config.PosterOverlayPart.bordercolor
$minPointSize = $config.PosterOverlayPart.minPointSize
$maxPointSize = $config.PosterOverlayPart.maxPointSize
$borderwidth = $config.PosterOverlayPart.borderwidth
$MaxWidth = $config.PosterOverlayPart.MaxWidth
$MaxHeight = $config.PosterOverlayPart.MaxHeight
$text_offset = $config.PosterOverlayPart.text_offset
$lineSpacing = $config.PosterOverlayPart.lineSpacing
$textgravity = $config.PosterOverlayPart.TextGravity.tolower()
$borderwidthsecond = $borderwidth + 'x' + $borderwidth
$boxsize = $MaxWidth + 'x' + $MaxHeight

# Season Poster Overlay Part
$ShowFallback = $config.SeasonPosterOverlayPart.ShowFallback.tolower()
$SeasonfontAllCaps = $config.SeasonPosterOverlayPart.fontAllCaps.tolower()
$AddSeasonBorder = $config.SeasonPosterOverlayPart.AddBorder.tolower()
$AddSeasonText = $config.SeasonPosterOverlayPart.AddText.tolower()
$AddSeasonTextStroke = $config.SeasonPosterOverlayPart.AddTextStroke.tolower()
$Seasonstrokecolor = $config.SeasonPosterOverlayPart.strokecolor
$Seasonstrokewidth = $config.SeasonPosterOverlayPart.strokewidth
$AddSeasonOverlay = $config.SeasonPosterOverlayPart.AddOverlay.tolower()
$Seasonfontcolor = $config.SeasonPosterOverlayPart.fontcolor
$Seasonbordercolor = $config.SeasonPosterOverlayPart.bordercolor
$SeasonminPointSize = $config.SeasonPosterOverlayPart.minPointSize
$SeasonmaxPointSize = $config.SeasonPosterOverlayPart.maxPointSize
$Seasonborderwidth = $config.SeasonPosterOverlayPart.borderwidth
$SeasonMaxWidth = $config.SeasonPosterOverlayPart.MaxWidth
$SeasonMaxHeight = $config.SeasonPosterOverlayPart.MaxHeight
$Seasontext_offset = $config.SeasonPosterOverlayPart.text_offset
$SeasonlineSpacing = $config.SeasonPosterOverlayPart.lineSpacing
$Seasontextgravity = $config.SeasonPosterOverlayPart.TextGravity.tolower()
$Seasonborderwidthsecond = $borderwidth + 'x' + $borderwidth
$Seasonboxsize = $SeasonMaxWidth + 'x' + $SeasonMaxHeight

# Show Title on Season Poster Overlay Part
$ShowOnSeasonfontAllCaps = $config.ShowTitleOnSeasonPosterPart.fontAllCaps.tolower()
$AddShowTitletoSeason = $config.ShowTitleOnSeasonPosterPart.AddShowTitletoSeason.tolower()
$AddShowOnSeasonTextStroke = $config.ShowTitleOnSeasonPosterPart.AddTextStroke.tolower()
$ShowOnSeasonstrokecolor = $config.ShowTitleOnSeasonPosterPart.strokecolor
$ShowOnSeasonstrokewidth = $config.ShowTitleOnSeasonPosterPart.strokewidth
$ShowOnSeasonfontcolor = $config.ShowTitleOnSeasonPosterPart.fontcolor
$ShowOnSeasonminPointSize = $config.ShowTitleOnSeasonPosterPart.minPointSize
$ShowOnSeasonmaxPointSize = $config.ShowTitleOnSeasonPosterPart.maxPointSize
$ShowOnSeasonMaxWidth = $config.ShowTitleOnSeasonPosterPart.MaxWidth
$ShowOnSeasonMaxHeight = $config.ShowTitleOnSeasonPosterPart.MaxHeight
$ShowOnSeasontext_offset = $config.ShowTitleOnSeasonPosterPart.text_offset
$ShowOnSeasontextgravity = $config.ShowTitleOnSeasonPosterPart.TextGravity.tolower()
$ShowOnSeasonboxsize = $ShowOnSeasonMaxWidth + 'x' + $ShowOnSeasonMaxHeight
$ShowOnSeasonlineSpacing = $config.ShowTitleOnSeasonPosterPart.lineSpacing

# Collection Title on Collection Poster Overlay Part
$CollectionTitleAllCaps = $config.CollectionTitlePosterPart.fontAllCaps.tolower()
$AddCollectionTitle = $config.CollectionTitlePosterPart.AddCollectionTitle.tolower()
$CollectionTitle = $config.CollectionTitlePosterPart.CollectionTitle.tolower()
$AddCollectionTitleTextStroke = $config.CollectionTitlePosterPart.AddTextStroke.tolower()
$CollectionTitlestrokecolor = $config.CollectionTitlePosterPart.strokecolor
$CollectionTitlestrokewidth = $config.CollectionTitlePosterPart.strokewidth
$CollectionTitlefontcolor = $config.CollectionTitlePosterPart.fontcolor
$CollectionTitleminPointSize = $config.CollectionTitlePosterPart.minPointSize
$CollectionTitlemaxPointSize = $config.CollectionTitlePosterPart.maxPointSize
$CollectionTitleMaxWidth = $config.CollectionTitlePosterPart.MaxWidth
$CollectionTitleMaxHeight = $config.CollectionTitlePosterPart.MaxHeight
$CollectionTitletext_offset = $config.CollectionTitlePosterPart.text_offset
$CollectionTitletextgravity = $config.CollectionTitlePosterPart.TextGravity.tolower()
$CollectionTitleboxsize = $CollectionTitleMaxWidth + 'x' + $CollectionTitleMaxHeight
$CollectionTitlelineSpacing = $config.CollectionTitlePosterPart.lineSpacing

# Collection Poster Overlay Part
$CollectionAllCaps = $config.CollectionPosterOverlayPart.fontAllCaps.tolower()
$AddCollectionBorder = $config.CollectionPosterOverlayPart.AddBorder.tolower()
$AddCollectionText = $config.CollectionPosterOverlayPart.AddText.tolower()
$AddCollectionTextStroke = $config.CollectionPosterOverlayPart.AddTextStroke.tolower()
$Collectionstrokecolor = $config.CollectionPosterOverlayPart.strokecolor
$Collectionstrokewidth = $config.CollectionPosterOverlayPart.strokewidth
$AddCollectionOverlay = $config.CollectionPosterOverlayPart.AddOverlay.tolower()
$Collectionfontcolor = $config.CollectionPosterOverlayPart.fontcolor
$Collectionbordercolor = $config.CollectionPosterOverlayPart.bordercolor
$CollectionminPointSize = $config.CollectionPosterOverlayPart.minPointSize
$CollectionmaxPointSize = $config.CollectionPosterOverlayPart.maxPointSize
$Collectionborderwidth = $config.CollectionPosterOverlayPart.borderwidth
$CollectionMaxWidth = $config.CollectionPosterOverlayPart.MaxWidth
$CollectionMaxHeight = $config.CollectionPosterOverlayPart.MaxHeight
$Collectiontext_offset = $config.CollectionPosterOverlayPart.text_offset
$CollectionlineSpacing = $config.CollectionPosterOverlayPart.lineSpacing
$Collectiontextgravity = $config.CollectionPosterOverlayPart.TextGravity.tolower()
$Collectionborderwidthsecond = $borderwidth + 'x' + $borderwidth
$Collectionboxsize = $CollectionMaxWidth + 'x' + $CollectionMaxHeight

# Background Overlay Part
$BackgroundfontAllCaps = $config.BackgroundOverlayPart.fontAllCaps.tolower()
$AddBackgroundOverlay = $config.BackgroundOverlayPart.AddOverlay.tolower()
$AddBackgroundBorder = $config.BackgroundOverlayPart.AddBorder.tolower()
$AddBackgroundText = $config.BackgroundOverlayPart.AddText.tolower()
$AddBackgroundTextStroke = $config.BackgroundOverlayPart.AddTextStroke.tolower()
$Backgroundstrokecolor = $config.BackgroundOverlayPart.strokecolor
$Backgroundstrokewidth = $config.BackgroundOverlayPart.strokewidth
$Backgroundfontcolor = $config.BackgroundOverlayPart.fontcolor
$Backgroundbordercolor = $config.BackgroundOverlayPart.bordercolor
$BackgroundminPointSize = $config.BackgroundOverlayPart.minPointSize
$BackgroundmaxPointSize = $config.BackgroundOverlayPart.maxPointSize
$Backgroundborderwidth = $config.BackgroundOverlayPart.borderwidth
$BackgroundMaxWidth = $config.BackgroundOverlayPart.MaxWidth
$BackgroundMaxHeight = $config.BackgroundOverlayPart.MaxHeight
$Backgroundtext_offset = $config.BackgroundOverlayPart.text_offset
$BackgroundlineSpacing = $config.BackgroundOverlayPart.lineSpacing
$Backgroundtextgravity = $config.BackgroundOverlayPart.TextGravity.tolower()
$Backgroundborderwidthsecond = $Backgroundborderwidth + 'x' + $Backgroundborderwidth
$Backgroundboxsize = $BackgroundMaxWidth + 'x' + $BackgroundMaxHeight

# Title Card Overlay Part
$AddTitleCardOverlay = $config.TitleCardOverlayPart.AddOverlay.tolower()
$UseBackgroundAsTitleCard = $config.TitleCardOverlayPart.UseBackgroundAsTitleCard.tolower()
$AddTitleCardBorder = $config.TitleCardOverlayPart.AddBorder.tolower()
$TitleCardborderwidth = $config.TitleCardOverlayPart.borderwidth
$TitleCardbordercolor = $config.TitleCardOverlayPart.bordercolor
$BackgroundFallback = $config.TitleCardOverlayPart.BackgroundFallback.tolower()

# Title Card Title Text Part
$TitleCardEPTitlefontAllCaps = $config.TitleCardTitleTextPart.fontAllCaps.tolower()
$AddTitleCardEPTitleText = $config.TitleCardTitleTextPart.AddEPTitleText.tolower()
$AddTitleCardEPTitleTextStroke = $config.TitleCardTitleTextPart.AddTextStroke.tolower()
$TitleCardEPTitlestrokecolor = $config.TitleCardTitleTextPart.strokecolor
$TitleCardEPTitlestrokewidth = $config.TitleCardTitleTextPart.strokewidth
$TitleCardEPTitlefontcolor = $config.TitleCardTitleTextPart.fontcolor
$TitleCardEPTitleminPointSize = $config.TitleCardTitleTextPart.minPointSize
$TitleCardEPTitlemaxPointSize = $config.TitleCardTitleTextPart.maxPointSize
$TitleCardEPTitleMaxWidth = $config.TitleCardTitleTextPart.MaxWidth
$TitleCardEPTitleMaxHeight = $config.TitleCardTitleTextPart.MaxHeight
$TitleCardEPTitletext_offset = $config.TitleCardTitleTextPart.text_offset
$TitleCardEPTitlelineSpacing = $config.TitleCardTitleTextPart.lineSpacing
$TitleCardEPTitletextgravity = $config.TitleCardTitleTextPart.TextGravity.tolower()

# Title Card EP Text Part
$SeasonTCText = $config.TitleCardEPTextPart.SeasonTCText
$EpisodeTCText = $config.TitleCardEPTextPart.EpisodeTCText
$TitleCardEPfontAllCaps = $config.TitleCardEPTextPart.fontAllCaps.tolower()
$AddTitleCardEPText = $config.TitleCardEPTextPart.AddEPText.tolower()
$AddTitleCardTextStroke = $config.TitleCardEPTextPart.AddTextStroke.tolower()
$TitleCardstrokecolor = $config.TitleCardEPTextPart.strokecolor
$TitleCardstrokewidth = $config.TitleCardEPTextPart.strokewidth
$TitleCardEPfontcolor = $config.TitleCardEPTextPart.fontcolor
$TitleCardEPminPointSize = $config.TitleCardEPTextPart.minPointSize
$TitleCardEPmaxPointSize = $config.TitleCardEPTextPart.maxPointSize
$TitleCardEPMaxWidth = $config.TitleCardEPTextPart.MaxWidth
$TitleCardEPMaxHeight = $config.TitleCardEPTextPart.MaxHeight
$TitleCardEPtext_offset = $config.TitleCardEPTextPart.text_offset
$TitleCardEPlineSpacing = $config.TitleCardEPTextPart.lineSpacing
$TitleCardEPtextgravity = $config.TitleCardEPTextPart.TextGravity.tolower()

$TitleCardborderwidthsecond = $TitleCardborderwidth + 'x' + $TitleCardborderwidth
$TitleCardEPTitleboxsize = $TitleCardEPTitleMaxWidth + 'x' + $TitleCardEPTitleMaxHeight
$TitleCardEPboxsize = $TitleCardEPMaxWidth + 'x' + $TitleCardEPMaxHeight

$PosterSize = "2000x3000"
$BackgroundSize = "3840x2160"
$fontImagemagick = $font.replace('\', '\\')
$CollectionfontImagemagick = $collectionfont.replace('\', '\\')
$RTLfontImagemagick = $RTLFont.replace('\', '\\')
$backgroundfontImagemagick = $backgroundfont.replace('\', '\\')
$TitleCardfontImagemagick = $TitleCardfont.replace('\', '\\')
if ($global:OSType -ne "Win32NT") {
    $global:OSarch = [System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture
    if ($global:OSType -eq "Docker" -or $global:OSarch -eq "Arm64") {
        $magick = 'magick'
        if ($AssetPath -match '^./') {
            Write-Entry -Message "You have set your asset path to '$AssetPath', please change it to '/assets'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Wrong asset path"
            }
            Exit 0
        }
        if ($BackupPath -match '^./') {
            Write-Entry -Message "You have set your backup path to '$BackupPath', please change it to '/backuppath'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Wrong backup path"
            }
            Exit 0
        }
        if ($ManualAssetPath -match '^./') {
            Write-Entry -Message "You have set your manualasset path to '$ManualAssetPath', please change it to '/manualassets'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Exiting Posterizarr now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Wrong manual asset path"
            }
            Exit 0
        }
    }
    Else {
        $magickinstalllocation = $global:ScriptRoot
        $magick = Join-Path $global:ScriptRoot 'magick'
    }
}
else {
    $raw = $config.PrerequisitePart.magickinstalllocation
    $raw = RemoveTrailingSlash $raw

    if ([string]::IsNullOrWhiteSpace($raw)) {
        $raw = '.\magick'
    }
    try {
        if ($raw.StartsWith('.')) {
            $fullPath = [System.IO.Path]::GetFullPath((Join-Path $global:ScriptRoot $raw))
        }
        else {
            $fullPath = [System.IO.Path]::GetFullPath($raw)
        }
    }
    catch {
        $fullPath = Join-Path $global:ScriptRoot 'magick'
    }
    if ($fullPath -match '(?i)\.exe$') {
        $dir = Split-Path $fullPath -Parent
        if (-not (Test-Path $dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
        }
        $magickinstalllocation = $dir
        $magick = $fullPath
    }
    else {
        if (-not (Test-Path $fullPath)) {
            New-Item -ItemType Directory -Force -Path $fullPath | Out-Null
        }
        $magickinstalllocation = (Get-Item -LiteralPath $fullPath -ErrorAction Stop).FullName
        $magick = Join-Path $magickinstalllocation 'magick.exe'
    }
}
#region Prerequisites Check
$fileExtensions = @(".otf", ".ttf", ".otc", ".ttc", ".png")

# Initialize Other Variables
$SeasonsTemp = $null
$SeasonNames = $null
$SeasonNumbers = $null
$SeasonRatingkeys = $null

# Define cross-platform paths
$LogsPath = Join-Path $global:ScriptRoot 'Logs'
$TempPath = Join-Path $global:ScriptRoot 'temp'
$TestPath = Join-Path $global:ScriptRoot 'test'
$global:OverlayPath = Join-Path $global:ScriptRoot 'Overlayfiles'
$configLogging = Join-Path $LogsPath 'Scriptlog.log'

if ($Manual) {
    $configLogging = Join-Path $LogsPath 'Manuallog.log'
}
if ($Testing) {
    $configLogging = Join-Path $LogsPath 'Testinglog.log'
}

# Invoke ImageMagick Checks
InvokeIMChecks

# Create directories if they don't exist

if (!(Test-Path $AssetPath)) {
    if ($global:OSType -ne "Win32NT" -and $AssetPath -eq 'P:\assets') {
        Write-Entry -Message 'Please change default asset Path...' -Path $configLogging -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Default asset path"
        }
        Exit
    }
    New-Item -ItemType Directory -Path $AssetPath -Force | Out-Null
}

# Check directory perms
Test-PathPermissions -PathToTest $AssetPath
Test-PathPermissions -PathToTest $BackupPath
Test-PathPermissions -PathToTest $ManualAssetPath

if ($ForceRunningDeletion -eq 'true') {
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
}

if (Test-Path $CurrentlyRunning) {
    Write-Entry -Message "Another Posterizarr instance already running, exiting now..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
    Write-Entry -Subtext "If its a false positive message you can manually delete the 'Posterizarr.Running' file in temp dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Warning
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "down" -msg "Another instance running"
    }
    Exit
}
Else {
    New-Item -Path $CurrentlyRunning -Force | out-null

    if ($Tautulli) {
        Write-Entry -Message "Recently Added running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($Testing) {
        Write-Entry -Message "Testing running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($Manual) {
        Write-Entry -Message "Manual running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($SyncJelly) {
        Write-Entry -Message "SyncJelly running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($SyncEmby) {
        Write-Entry -Message "SyncEmby running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Elseif ($Backup) {
        Write-Entry -Message "Backup running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Else {
        Write-Entry -Message "Posterizarr running file created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}
# Delete all files and subfolders within the temp directory
if (Test-Path $TempPath) {
    Get-ChildItem -Path (Join-Path $TempPath '*') -Recurse -Exclude 'Posterizarr.Running', 'font_preview*' | Remove-Item -Force
    Write-Entry -Message "Deleting temp folder: $TempPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
}
if ($Testing) {
    if ((Test-Path $TestPath)) {
        Remove-Item -Path (Join-Path $TestPath '*') -Recurse -Force
        Write-Entry -Message "Deleting test folder: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
}

# Test and download files if they don't exist
if ($config.PrerequisitePart.overlayfile -eq 'overlay.png' -or $config.PrerequisitePart.seasonoverlayfile -eq 'overlay.png') {
    Test-And-Download -url "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Overlayfiles/overlay.png" -destination (Join-Path $global:OverlayPath 'overlay.png')
}
if ($config.PrerequisitePart.overlayfile -eq 'overlay-innerglow.png' -or $config.PrerequisitePart.seasonoverlayfile -eq 'overlay-innerglow.png') {
    Test-And-Download -url "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Overlayfiles/overlay-innerglow.png" -destination (Join-Path $global:OverlayPath 'overlay-innerglow.png')
}
if ($config.PrerequisitePart.backgroundoverlayfile -eq 'backgroundoverlay.png' -or $config.PrerequisitePart.titlecardoverlayfile -eq 'backgroundoverlay.png') {
    Test-And-Download -url "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Overlayfiles/backgroundoverlay.png" -destination (Join-Path $global:OverlayPath 'backgroundoverlay.png')
}
if ($config.PrerequisitePart.backgroundoverlayfile -eq 'backgroundoverlay-innerglow.png' -or $config.PrerequisitePart.titlecardoverlayfile -eq 'backgroundoverlay-innerglow.png') {
    Test-And-Download -url "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Overlayfiles/backgroundoverlay-innerglow.png" -destination (Join-Path $global:OverlayPath 'backgroundoverlay-innerglow.png')
}
if ($config.PrerequisitePart.font -eq 'Rocky.ttf' -or $config.PrerequisitePart.backgroundfont -eq 'Rocky.ttf' -or $config.PrerequisitePart.titlecardfont -eq 'Rocky.ttf' -or $config.PrerequisitePart.RTLFont -eq 'Rocky.ttf') {
    Test-And-Download -url "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Overlayfiles/Rocky.ttf" -destination (Join-Path $global:OverlayPath 'Rocky.ttf')
}
if ($config.PrerequisitePart.font -eq 'Colus-Regular.ttf' -or $config.PrerequisitePart.backgroundfont -eq 'Colus-Regular.ttf' -or $config.PrerequisitePart.titlecardfont -eq 'Colus-Regular.ttf' -or $config.PrerequisitePart.RTLFont -eq 'Colus-Regular.ttf') {
    Test-And-Download -url "https://github.com/fscorrupt/posterizarr/raw/$($Branch)/Overlayfiles/Colus-Regular.ttf" -destination (Join-Path $global:OverlayPath 'Colus-Regular.ttf')
}

# Write log message
Write-Entry -Message "Old log files cleared..." -Path $configLogging -Color White -log Info
# Display Current Config settings:
Write-Entry -Message "Current Config settings:" -Path $configLogging -Color DarkMagenta -log Info
Output-ConfigJson -obj $config
# Starting main Script now...
Write-Entry -Message "Starting main Script now..." -Path $configLogging -Color Green -log Info

# Fix asset path based on OS (do it here so that we see what is in config.json versus what script should use)
if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
    $AssetPath = $AssetPath.Replace('\', '/')
}
else {
    $AssetPath = $AssetPath.Replace('/', '\')
}

# Fix backup path based on OS (do it here so that we see what is in config.json versus what script should use)
if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
    $BackupPath = $BackupPath.Replace('\', '/')
}
else {
    $BackupPath = $BackupPath.Replace('/', '\')
}

# Migration block: Only run this when migration is needed
$DoMigration = Get-ChildItem -Path $global:ScriptRoot -File | Where-Object { $_.Extension -in $fileExtensions } -ErrorAction SilentlyContinue
if ($DoMigration.Count -gt 0) {
    Write-Entry -Message "Migration needed: Found $($DoMigration.Count) files to migrate." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info

    foreach ($file in $DoMigration) {
        try {
            Write-Entry -Subtext "Trying to migrate '$($file.Name)' from ScriptRoot to OverlayPath..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $destinationPath = Join-Path -Path $global:OverlayPath -ChildPath $file.Name

            Move-Item -LiteralPath $file.FullName -Destination $destinationPath -Force -ErrorAction Stop
            Write-Entry -Subtext "Migrated File: '$($file.Name)' from ScriptRoot to OverlayPath..." -Path $configLogging -Color Cyan -log Info
        }
        catch {
            Write-Entry -Subtext "Error migrating file '$($file.Name)': $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
}

# Always copy files from OverlayPath to temp folder
$files = Get-ChildItem -Path $global:OverlayPath -File | Where-Object { $_.Extension -in $fileExtensions } -ErrorAction SilentlyContinue
foreach ($file in $files) {
    try {
        Write-Entry -Subtext "Trying to copy '$($file.Name)' into temp dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $destinationPath = Join-Path -Path (Join-Path -Path $global:ScriptRoot -ChildPath 'temp') -ChildPath $file.Name

        if (!(Test-Path -LiteralPath $destinationPath)) {
            Copy-Item -Path $file.FullName -Destination $destinationPath -Force -ErrorAction Stop
            Write-Entry -Subtext "Found File: '$($file.Name)' in OverlayPath - copying it into temp folder..." -Path $configLogging -Color Cyan -log Info
        }

        # Font handling...
        if ($file.Extension -match "\.(ttf|otf)$" -and $env:POSTERIZARR_NON_ROOT -eq 'TRUE') {
            $fontDestination = Join-Path -Path $Font_Cache -ChildPath $file.Name
            Write-Entry -Subtext "Copying font '$($file.Name)' to ImageMagick cache..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            Copy-Item -Path $file.FullName -Destination $fontDestination -Force -ErrorAction Stop
            if (!(Test-Path -Path $IM_Font_Cache)) {
                New-Item -ItemType Directory -Path $IM_Font_Cache -Force | Out-Null
            }
        }
    }
    catch {
        Write-Entry -Subtext "Error copying file '$($file.Name)': $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
    }
}


# Refresh font cache if any fonts were copied
if ($files.Extension -match "\.(ttf|otf)$" -and $env:POSTERIZARR_NON_ROOT -eq 'TRUE') {
    Write-Entry -Subtext "Updating ImageMagick font cache..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    & fc-cache -fv 1> $null 2> $null
}

CheckJsonPaths -font "$font" -RTLfont "$RTLfont" -backgroundfont "$backgroundfont" -titlecardfont "$titlecardfont" -Posteroverlay "$Posteroverlay" -Backgroundoverlay "$Backgroundoverlay" -titlecardoverlay "$titlecardoverlay" -Collectionoverlay "$collectionoverlay" -Seasonoverlay "$Seasonoverlay" -Posteroverlay4k "$4kposter" -Posteroverlay1080p "$1080pPoster" -Backgroundoverlay4k "$4kBackground" -Backgroundoverlay1080p "$1080pBackground" -TCoverlay4k "$4kTC" -TCoverlay1080p "$1080pTC" -Posteroverlay4KDoVi "$4KDoVi" -Posteroverlay4KHDR10 "$4KHDR10" -Posteroverlay4KDoViHDR10 "$4KDoViHDR10" -Backgroundoverlay4KDoVi "$4KDoViBackground" -Backgroundoverlay4KHDR10 "$4KHDR10Background" -Backgroundoverlay4KDoViHDR10 "$4KDoViHDR10Background" -TCoverlay4KDoVi "$4KDoViTC" -TCoverlay4KHDR10 "$4KHDR10TC" -TCoverlay4KDoViHDR10 "$4KDoViHDR10TC"
# Check Plex now:
if (!$SyncJelly -and !$SyncEmby) {
    if ($UsePlex -eq 'true') {
        [xml]$Libs = CheckPlexAccess -PlexUrl $PlexUrl -PlexToken $PlexToken
    }

    if ($UseJellyfin -eq 'true') {
        # Check Jellyfin now:
        CheckJellyfinAccess -JellyfinUrl $JellyfinUrl -JellyfinApi $JellyfinAPIKey
    }
    if ($UseEmby -eq 'true') {
        # Check Emby now:
        CheckEmbyAccess -EmbyUrl $EmbyUrl -EmbyAPI $EmbyAPIKey
    }
}
# Check overlay artwork for poster, background, and titlecard dimensions
Write-Entry -Message "Checking size of overlay files..." -Path $configLogging -Color White -log Info
CheckOverlayDimensions -Posteroverlay "$Posteroverlay" -Backgroundoverlay "$Backgroundoverlay" -Titlecardoverlay "$titlecardoverlay" -PosterSize "$PosterSize" -BackgroundSize "$BackgroundSize" -Collectionoverlay "$collectionoverlay" -Seasonoverlay "$Seasonoverlay" -Posteroverlay4k "$4kposter" -Posteroverlay1080p "$1080pPoster" -Backgroundoverlay4k "$4kBackground" -Backgroundoverlay1080p "$1080pBackground" -TCoverlay4k "$4kTC" -TCoverlay1080p "$1080pTC" -Posteroverlay4KDoVi "$4KDoVi" -Posteroverlay4KHDR10 "$4KHDR10" -Posteroverlay4KDoViHDR10 "$4KDoViHDR10" -Backgroundoverlay4KDoVi "$4KDoViBackground" -Backgroundoverlay4KHDR10 "$4KHDR10Background" -Backgroundoverlay4KDoViHDR10 "$4KDoViHDR10Background" -TCoverlay4KDoVi "$4KDoViTC" -TCoverlay4KHDR10 "$4KHDR10TC" -TCoverlay4KDoViHDR10 "$4KDoViHDR10TC"

# Check if the FanartTvAPI module is installed
$module = Get-Module -ListAvailable -Name FanartTvAPI

if (-not $module) {
    # Try to install the module
    try {
        Install-Module -Name $moduleName -Force -SkipPublisherCheck -AllowPrerelease -Scope AllUsers
        Write-Entry -Message "FanartTvAPI Module missing, installing it for you..." -Path $configLogging -Color Red -log Error
        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        Write-Entry -Subtext "FanartTvAPI Module installed, importing it now..." -Path $configLogging -Color Green -log Info
        Import-Module -Name FanartTvAPI
    }
    catch {
        Write-Host "Failed to install $moduleName module. Error: $_"
    }
}

# Only connect if DisableOnlineAssetFetch is not set to false
if ($global:DisableOnlineAssetFetch -eq 'false') {
    # Add Fanart API
    Add-FanartTvAPIKey -Api_Key $FanartTvAPIKey

    # Check TMDB Token before building the Header.
    if ($global:tmdbtoken.Length -le '35') {
        Write-Entry -Message "TMDB Token is too short, you may have used the API key in your config file. Please use the 'API Read Access Token'." -Path $configLogging -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Wrong TMDB token"
        }
        Exit
    }

    $maxRetries = 6
    $retryCount = 0
    $success = $false
    Write-Entry -Message "Trying to receive a TVDB Token..." -Path $configLogging -Color White -log Info

    while (-not $success -and $retryCount -lt $maxRetries) {
        try {
            # tvdb token Header
            $global:apiUrl = "https://api4.thetvdb.com/v4/login"
            if ($global:tvdbpin) {
                $global:requestBody = @{
                    apikey = $global:tvdbapi
                    pin    = $global:tvdbpin
                } | ConvertTo-Json
            }
            Else {
                $global:requestBody = @{
                    apikey = $global:tvdbapi
                } | ConvertTo-Json
            }
            # tvdb Header
            $global:tvdbtokenheader = @{
                'accept'       = 'application/json'
                'Content-Type' = 'application/json'
            }

            # Make tvdb the POST request
            $global:tvdbtoken = (Invoke-RestMethod -Uri $global:apiUrl -Headers $global:tvdbtokenheader -Method Post -Body $global:requestBody).data.token
            $global:tvdbheader = @{}
            $global:tvdbheader.Add("accept", "application/json")
            $global:tvdbheader.Add("Authorization", "Bearer $global:tvdbtoken")

            if ($global:tvdbtoken) {
                $success = $true
                Write-Entry -Subtext "Successfully received a TVDB Token" -Path $configLogging -Color Green -log Info
            }

        }
        catch {
            $retryCount++

            if ($retryCount -lt $maxRetries) {
                Start-Sleep -Seconds 10  # Wait for 10 seconds before the next retry
            }
            else {
                if ($global:FavProvider -eq 'TVDB') {
                    Write-Entry -Subtext "Could not receive a TVDB Token - $($retryCount)/$($maxRetries) - you may have used an legacy API key in your config file. Please use an 'Project Api Key'" -Path $configLogging -Color Red -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Could not receive a TVDB Token"
                    }
                    Exit
                }
                Else {
                    Write-Entry -Subtext "Could not receive a TVDB Token - $($retryCount)/$($maxRetries) - you may have used an legacy API key in your config file. Please use an 'Project Api Key'" -Path $configLogging -Color Red -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    break
                }
            }
        }
    }

    # tmdb Header
    $global:headers = @{}
    $global:headers.Add("accept", "application/json")
    $global:headers.Add("Authorization", "Bearer $global:tmdbtoken")
}
# Plex Headers
$extraPlexHeaders = @{
    'X-Plex-Container-Size' = '1000'
}

#### MAIN SCRIPT START ####
#region Manual Mode
if ($Manual) {
    $posterCount = 0
    $BackgroundCount = 0
    $EpisodeCount = 0
    $SeasonCount = 0
    $collectionCount = 0
    $Mode = "manual"

    Write-Entry -Message "Manual Poster Creation Started" -Path $global:ScriptRoot\Logs\Manuallog.log -Color DarkMagenta -log Info
    # Regex to find a positive number (1 or greater) at the end of the string
    $seasonNumberPattern = '([1-9]\d*)$'

    # Regex to extract title excluding "Season X" patterns
    $ExtractedTitleRegex = '^\s*(?:Season\s*\d+\s*\|\s*)?(.*?)(?:\s*\|\s*Season\s*\d+)?\s*$'

    # Regex to find "Specials" keywords or the numbers 0/00
    $specialsPattern = '^(?:Specials|Extras|Spéciaux|0{1,2}|[Ss]eason ?0{1,2})$' # Add any other language keywords here

    if ([string]::IsNullOrEmpty($PicturePath)) {
        $TriggeredViaCli = 'true'
        $PicturePath = Read-Host "Enter local path or url to source picture"

        # 1. Define all poster-related parameters
        $posterParams = @(
            'SeasonPoster', 'MoviePosterCard', 'ShowPosterCard',
            'TitleCard', 'CollectionCard', 'BackgroundCard'
        )

        # 2. Check if *any* of them were provided when the script was run
        $anyPosterParamBound = $posterParams.Where({ $PSBoundParameters.ContainsKey($_) }).Count -gt 0

        # 3. Only ask questions if *none* were provided
        if (-not $anyPosterParamBound) {
            Write-Host "No poster types specified. Please select which to create."

            # Define the variable names and their prompts
            $posterPrompts = [Ordered]@{
                'SeasonPoster'     = "Create Season Poster?"
                'MoviePosterCard'  = "Create Movie Poster?"
                'ShowPosterCard'   = "Create Show Poster?"
                'TitleCard'        = "Create TitleCard?"
                'CollectionCard'   = "Create Collection?"
                'BackgroundCard'   = "Create Background?"
            }

            # Loop through each and ask the user
            foreach ($item in $posterPrompts.GetEnumerator()) {
                $response = Read-Host "$($item.Value) (y/n)"
                if ($response.ToLower() -eq 'y') {
                    # This sets the variable (e.g., $SeasonPoster) to $true
                    Set-Variable -Name $item.Key -Value $true
                }
            }
        }

        # Error handling for missing selection (CORRECTED to check all types)
        if (-not ($SeasonPoster -or $MoviePosterCard -or $ShowPosterCard -or $TitleCard -or $CollectionCard -or $BackgroundCard)) {
            Write-Entry -Message "No poster type selected. Please select at least one type." -Path $global:ScriptRoot\Logs\Manuallog.log -Color Red -log Error

            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }

            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "No poster type selected"
            }
            Exit
        }
    }

    # Error handling for missing picture path
    if ([string]::IsNullOrEmpty($PicturePath)) {
        Write-Entry -Message "No picture path provided. A source picture is required." -Path $global:ScriptRoot\Logs\Manuallog.log -Color Red -log Error
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Missing picture path"
        }
        Exit
    }

    # Starting to gather more info
    if ($CollectionCard) {
        if ([string]::IsNullOrEmpty($Titletext)) {
            $Titletext = Read-Host "Enter Movie/Show/Collection Title"
        }
        if ([string]::IsNullOrEmpty($FolderName)) {
            $FolderName = Read-Host "Enter Asset Foldername"
        }
    }
    else {
        if ([string]::IsNullOrEmpty($FolderName)) {
            $FolderName = Read-Host "Enter Media Foldername (how plex sees it)"
        }
        # Only prompt if the parameter was NOT passed at all
        if (-not $PSBoundParameters.ContainsKey('Titletext')) {
            $Titletext = Read-Host "Enter Movie/Show/Background Title"
        }
    }

    if ($PicturePath -like 'http*') {
        $isWebPic = 'true'
        $PicturePath = $PicturePath.replace('"', '')
    }
    Else {
        $PicturePath = $PicturePath.replace('"', '')
    }
    $FolderName = $FolderName.replace('"', '')
    $Titletext = $Titletext.replace('"', '')
    $SafeFolderName = $FolderName -replace '[\\/:*?"<>|\[\]{}]', '_'
    if ($MoviePosterCard) {
        $PosterType = "Movie"
    }
    Elseif ($ShowPosterCard) {
        $PosterType = "Show"
    }
    Else {
        $PosterType = "Poster"
    }
    if ($LibraryFolders -eq 'true') {
        if ([string]::IsNullOrEmpty($LibraryName)) {
            $LibraryName = Read-Host "Enter Plex Library Name"
        }
        $LibraryName = $LibraryName.replace('"', '')

        $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\poster.jpg"

        # Create Folder if Missing
        if (-not $collectionCard) {
            $TargetFolder = Join-Path -Path "$AssetPath\$LibraryName" -ChildPath $FolderName
            New-Item -ItemType Directory -Path $TargetFolder -Force | Out-Null
        }
        if ($SeasonPoster) {
            $PosterType = "Season"
            if ([string]::IsNullOrEmpty($SeasonPosterName)) {
                $SeasonPosterName = Read-Host "Enter Season Name"
                if ($SeasonPosterName -match $ExtractedTitleRegex) {
                    $global:ExtractedTitle = $Matches[1]
                }
            }
            if ($SeasonPosterName -match $seasonNumberPattern) {
                $global:SeasonNumber = $Matches[1]
                $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                if ($SeasonPosterName -match $ExtractedTitleRegex) {
                    $global:ExtractedTitle = $Matches[1]
                }
            }
            Elseif ($SeasonPosterName -match $specialsPattern) {
                $global:seasontmp = "Season00"
                if ($SeasonPosterName -match $ExtractedTitleRegex) {
                    $global:ExtractedTitle = $Matches[1]
                }
            }
            Else {
                Write-Entry -Subtext "Could not match Season name..." -Path $global:ScriptRoot\Logs\Manuallog.log -Color Yellow -log Warning
                if ($TriggeredViaCli -eq 'true'){
                    $seasontemp = Read-Host "Please enter Season Name for the local file (eq. Season 0 or Season 1....)"
                }
                if ($seasontemp -match $seasonNumberPattern) {
                    $global:SeasonNumber = $Matches[1]
                    $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                }
                else {
                    Write-Entry -Subtext "Invalid season format. Please enter something like Season00 or Season01." -Path $global:ScriptRoot\Logs\Manuallog.log -Color Yellow -log Warning
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    Exit
                }
            }
            $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\$global:seasontmp.jpg"
            # Create Folder if Missing
            $TargetFolder = Join-Path -Path "$AssetPath\$LibraryName" -ChildPath $FolderName
            New-Item -ItemType Directory -Path $TargetFolder -Force | Out-Null
        }
        Elseif ($CollectionCard) {
            $PosterType = "Collection"
            $PosterImageoriginal = "$AssetPath\Collections\$LibraryName\$SafeFolderName\poster.jpg"
            $CollectionPath = "$AssetPath\Collections\$LibraryName\$SafeFolderName"
            # Ensure the Collection directory exists
            if (!(Test-Path $CollectionPath)) {
                try {
                    New-Item -ItemType Directory -Path $CollectionPath -Force | Out-Null
                    Write-Entry -Subtext "Created Collection directory: $CollectionPath" -Path $global:ScriptRoot\Logs\Manuallog.log -Color Green -log Info
                }
                catch {
                    Write-Entry -Subtext "Failed to create Collection directory: $CollectionPath - Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Manuallog.log -Color Red -log Error
                    return
                }
            }
        }
        Elseif ($TitleCard) {
            $PosterType = "Episode"
            if ($EPTitleName -eq $null) { $EPTitleName = Read-Host "Enter Episode Title Name" }
            if ([string]::IsNullOrEmpty($EpisodeNumber)) { $EpisodeNumber = Read-Host "Enter Episode Number (eq. 1)" }
            if ([string]::IsNullOrEmpty($SeasonPosterName)) { $SeasonPosterName = Read-Host "Enter Season Number (eq. 1)" }
            if ($SeasonPosterName -match $seasonNumberPattern) {
                $global:SeasonNumber = $Matches[1]
                $global:seasontmp = "S" + $global:SeasonNumber.PadLeft(2, '0')
            }
            if ($SeasonPosterName -eq $specialsPattern) {
                $global:seasontmp = "S00"
            }
            if ($EpisodeNumber -match '(\d+)') {
                $global:EpisodeNumber = $Matches[1]
                $global:episode = "E" + $global:EpisodeNumber.PadLeft(2, '0')
            }
            $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\$global:seasontmp$global:episode.jpg"
            # Create Folder if Missing
            $TargetFolder = Join-Path -Path "$AssetPath\$LibraryName" -ChildPath $FolderName
            New-Item -ItemType Directory -Path $TargetFolder -Force | Out-Null
        }
        Elseif ($BackgroundCard) {
            if ($MoviePosterCard) {
                $PosterType = "Movie Background"
            }
            Elseif ($ShowPosterCard) {
                $PosterType = "Show Background"
            }
            else {
                $PosterType = "Background"
            }

            $PosterImageoriginal = "$AssetPath\$LibraryName\$FolderName\background.jpg"

            # Create Folder if Missing
            $TargetFolder = Join-Path -Path "$AssetPath\$LibraryName" -ChildPath $FolderName
            New-Item -ItemType Directory -Path $TargetFolder -Force | Out-Null
        }
    }
    Else {
        if ($SeasonPoster) {
            $PosterType = "Season"
            if ([string]::IsNullOrEmpty($SeasonPosterName)) {
                $SeasonPosterName = Read-Host "Enter Season Name"
                if ($SeasonPosterName -match $ExtractedTitleRegex) {
                    $global:ExtractedTitle = $Matches[1]
                }
            }
            if ($SeasonPosterName -match $seasonNumberPattern) {
                $global:SeasonNumber = $Matches[1]
                $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                if ($SeasonPosterName -match $ExtractedTitleRegex) {
                    $global:ExtractedTitle = $Matches[1]
                }
            }
            Elseif ($SeasonPosterName -eq $specialsPattern) {
                $global:seasontmp = "Season00"
                if ($SeasonPosterName -match $ExtractedTitleRegex) {
                    $global:ExtractedTitle = $Matches[1]
                }
            }
            Else {
                Write-Entry -Subtext "Could not match Season name..." -Path $global:ScriptRoot\Logs\Manuallog.log -Color Yellow -log Warning
                if ($TriggeredViaCli -eq 'true'){
                    $seasontemp = Read-Host "Please enter Season Name for the local file (eq. Season 0 or Season 1....)"
                }
                if ($seasontemp -match $seasonNumberPattern) {
                    $global:SeasonNumber = $Matches[1]
                    $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                }
                else {
                    Write-Entry -Subtext "Invalid season format. Please enter something like Season00 or Season01." -Path $global:ScriptRoot\Logs\Manuallog.log -Color Yellow -log Warning
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    Exit
                }
            }
            $PosterImageoriginal = "$AssetPath\$($FolderName)_$global:seasontmp.jpg"
        }
        Elseif ($CollectionCard) {
            $PosterType = "Collection"
            $PosterImageoriginal = "$AssetPath\Collections\$($SafeFolderName)_poster.jpg"
            $CollectionPath = "$AssetPath\Collections"
            # Ensure the Collection directory exists
            if (!(Test-Path $CollectionPath)) {
                try {
                    New-Item -ItemType Directory -Path $CollectionPath -Force | Out-Null
                    Write-Entry -Subtext "Created Collection directory: $CollectionPath" -Path $global:ScriptRoot\Logs\Manuallog.log -Color Green -log Info
                }
                catch {
                    Write-Entry -Subtext "Failed to create Collection directory: $CollectionPath - Error: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Manuallog.log -Color Red -log Error
                    return
                }
            }
        }
        Elseif ($TitleCard) {
            $PosterType = "Episode"
            if ($EPTitleName -eq $null) { $EPTitleName = Read-Host "Enter Episode Title Name" }
            if ([string]::IsNullOrEmpty($EpisodeNumber)) { $EpisodeNumber = Read-Host "Enter Episode Number (eq. 1)" }
            if ([string]::IsNullOrEmpty($SeasonPosterName)) { $SeasonPosterName = Read-Host "Enter Season Number (eq. 1)" }
            if ($SeasonPosterName -match $seasonNumberPattern) {
                $global:SeasonNumber = $Matches[1]
                $global:seasontmp = "S" + $global:SeasonNumber.PadLeft(2, '0')
            }
            if ($SeasonPosterName -eq $specialsPattern) {
                $global:seasontmp = "S00"
            }
            if ($EpisodeNumber -match '(\d+)') {
                $global:EpisodeNumber = $Matches[1]
                $global:episode = "E" + $global:EpisodeNumber.PadLeft(2, '0')
            }
            $PosterImageoriginal = "$AssetPath\$($FolderName)_$global:seasontmp$global:episode.jpg"
        }
        Elseif ($BackgroundCard) {
            if ($MoviePosterCard) {
                $PosterType = "Movie Background"
            }
            Elseif ($ShowPosterCard) {
                $PosterType = "Show Background"
            }
            else {
                $PosterType = "Background"
            }
            $PosterImageoriginal = "$AssetPath\$($FolderName)_background.jpg"
        }
    }

    if ($CollectionCard){
        $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$SafeFolderName.jpg"
    }
    Else {
        $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$FolderName.jpg"
    }
    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
    if ($global:ImageProcessing -eq 'true') {
        if ($SeasonPoster) {
            $Posteroverlay = $Seasonoverlay
            if ($AddShowTitletoSeason -eq 'true') {
                if ($fontAllCaps -eq 'true') {
                    $joinedTitle = $SeasonPosterName.ToUpper()
                }
                Else {
                    $joinedTitle = $SeasonPosterName
                }

                if ($ShowOnSeasonfontAllCaps -eq 'true') {
                    $ShowjoinedTitle = $titletext.ToUpper()
                }
                Else {
                    $ShowjoinedTitle = $titletext
                }
            }
            Else {
                if ($fontAllCaps -eq 'true') {
                    if ($global:ExtractedTitle) {
                        $joinedTitle = $global:ExtractedTitle.ToUpper()
                    }
                    else {
                        $joinedTitle = $SeasonPosterName.ToUpper()
                    }
                }
                Else {
                    if ($global:ExtractedTitle) {
                        $joinedTitle = $global:ExtractedTitle
                    }
                    else {
                        $joinedTitle = $SeasonPosterName
                    }
                }
            }
        }
        elseif ($CollectionCard) {
            $Posteroverlay = $Collectionoverlay
            if ($AddCollectionTitle -eq 'true') {
                if ($CollectionTitleAllCaps -eq 'true') {
                    $CollectionjoinedTitle = $CollectionTitle.ToUpper()
                }
                Else {
                    $CollectionjoinedTitle = $CollectionTitle
                }

                if ($CollectionAllCaps -eq 'true') {
                    $joinedTitle = $titletext.ToUpper()
                }
                Else {
                    $joinedTitle = $titletext
                }
            }
            Else {
                if ($fontAllCaps -eq 'true') {
                    $joinedTitle = $titletext.ToUpper()
                }
                Else {
                    $joinedTitle = $titletext
                }
            }
        }
        elseif ($TitleCard) {
            if ($AddTitleCardEPTitleText -eq 'true') {
                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                    $joinedTitle = $EPTitleName.ToUpper()
                }
                Else {
                    $joinedTitle = $EPTitleName
                }
            }
            if ($AddTitleCardEPText -eq 'true') {
                $bullet = [char]0x2022
                $global:SeasonEPNumber = "$SeasonTCText $global:SeasonNumber $bullet $EpisodeTCText $global:EpisodeNumber"

                if ($TitleCardEPfontAllCaps -eq 'true') {
                    $EPNumberTitle = $global:SeasonEPNumber.ToUpper()
                }
                Else {
                    $EPNumberTitle = $global:SeasonEPNumber
                }
            }
        }
        elseif ($BackgroundCard) {
            if ($AddBackgroundText -eq 'true') {
                if ($BackgroundfontAllCaps -eq 'true') {
                    $joinedTitle = $Titletext.ToUpper()
                }
                Else {
                    $joinedTitle = $Titletext
                }
            }
        }
        Else {
            if ($fontAllCaps -eq 'true') {
                $joinedTitle = $Titletext.ToUpper()
            }
            Else {
                $joinedTitle = $Titletext
            }
        }
        if ($isWebPic -eq 'true') {
            Write-Entry -Subtext "Downloading Image from: $PicturePath" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
            Invoke-WebRequest -Uri $PicturePath -OutFile $PosterImage
        }
        Else {
            Move-Item -LiteralPath $PicturePath -destination $PosterImage -Force -ErrorAction SilentlyContinue
        }
        Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

        $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
        $CommentlogEntry = "`"$magick`" $CommentArguments"
        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
        if (!$global:ImageMagickError -eq 'true') {
            if ($SeasonPoster) {
                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                elseif ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                elseif ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                else {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                $SeasonCount++
            }
            elseif ($CollectionCard) {
                if ($AddCollectionBorder -eq 'true' -and $AddCollectionOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Collectionoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Collectionborderwidthsecond`"  -bordercolor `"$Collectionbordercolor`" -border `"$Collectionborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                elseif ($AddCollectionBorder -eq 'true' -and $AddCollectionOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Collectionborderwidthsecond`"  -bordercolor `"$Collectionbordercolor`" -border `"$Collectionborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                elseif ($AddCollectionBorder -eq 'false' -and $AddCollectionOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Collectionoverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                else {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                $collectionCount++
            }
            elseif ($TitleCard) {
                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$titlecardoverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                else {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                }
                $EpisodeCount++
            }
            elseif ($BackgroundCard) {
                # Resize Image to 2000x3000 and apply Border and overlay
                if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                else {
                    $Arguments = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                $BackgroundCount++
            }
            Else {
                # Resize Image to 2000x3000 and apply Border and overlay
                if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                else {
                    $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                }
                $posterCount++
            }
            $logEntry = "`"$magick`" $Arguments"
            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
            InvokeMagickCommand -Command $magick -Arguments $Arguments

            if (($AddText -eq 'true' -or $AddSeasonText -eq 'true' -or $AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true' -or $AddCollectionText -eq 'true' -or $AddBackgroundText -eq 'true') -and -not [string]::IsNullOrWhiteSpace($joinedTitle)) {
                $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                if ($AddShowTitletoSeason -eq 'true' -and $SeasonPoster) {
                    $ShowjoinedTitle = $ShowjoinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                    # Loop through each symbol and replace it with a newline
                    if ($NewLineOnSpecificSymbols -eq 'true') {
                        foreach ($symbol in $NewLineSymbols) {
                            # Default: Replace the symbol with a newline
                            $replacementString = "`n"

                            # Check if the symbol should be kept
                            $keepThisSymbol = $false
                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                    if ($symbol -like "*$k*") {
                                        $keepThisSymbol = $true
                                        break # Match found, no need to keep checking
                                    }
                                }
                            }

                            # If it's a "keep" symbol, change the replacement string
                            if ($keepThisSymbol) {
                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                $replacementString = $symbol + "`n"
                            }
                            $ShowjoinedTitle = $ShowjoinedTitle -replace [regex]::Escape($symbol), $replacementString
                        }
                    }
                    $ShowjoinedTitlePointSize = $ShowjoinedTitle -replace '""', '""""'
                    $showoptimalFontSize = Get-OptimalPointSize -text $ShowjoinedTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                    Write-Entry -Subtext ("Optimal Show font size set to: '{0}' [{1}]" -f $showoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

                }
                if ($AddCollectionTitle -eq 'true' -and $CollectionCard) {
                    $CollectionjoinedTitle = $CollectionjoinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                    # Loop through each symbol and replace it with a newline
                    if ($NewLineOnSpecificSymbols -eq 'true') {
                        foreach ($symbol in $NewLineSymbols) {
                            # Default: Replace the symbol with a newline
                            $replacementString = "`n"

                            # Check if the symbol should be kept
                            $keepThisSymbol = $false
                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                    if ($symbol -like "*$k*") {
                                        $keepThisSymbol = $true
                                        break # Match found, no need to keep checking
                                    }
                                }
                            }

                            # If it's a "keep" symbol, change the replacement string
                            if ($keepThisSymbol) {
                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                $replacementString = $symbol + "`n"
                            }
                            $CollectionjoinedTitle = $CollectionjoinedTitle -replace [regex]::Escape($symbol), $replacementString
                        }
                    }
                    $CollectionjoinedTitlePointSize = $CollectionjoinedTitle -replace '""', '""""'
                    $CollectionTitleoptimalFontSize = Get-OptimalPointSize -text $CollectionjoinedTitlePointSize -font $CollectionfontImagemagick -box_width $CollectionTitleMaxWidth  -box_height $CollectionTitleMaxHeight -min_pointsize $CollectionTitleminPointSize -max_pointsize $CollectionTitlemaxPointSize -lineSpacing $CollectionTitlelineSpacing
                    Write-Entry -Subtext ("Optimal Collection Title font size set to: '{0}' [{1}]" -f $CollectionTitleoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

                }
                if ($AddTitleCardEPText -eq 'true' -and $TitleCard) {
                    $EPNumberjoinedTitle = $EPNumberTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                    $EPNumberjoinedTitlePointSize = $EPNumberjoinedTitle -replace '""', '""""'
                    $EPNumberoptimalFontSize = Get-OptimalPointSize -text $EPNumberjoinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                    Write-Entry -Subtext ("Optimal EP Number font size set to: '{0}' [{1}]" -f $EPNumberoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info

                }
                # Loop through each symbol and replace it with a newline
                if ($NewLineOnSpecificSymbols -eq 'true') {
                    foreach ($symbol in $NewLineSymbols) {
                        # Default: Replace the symbol with a newline
                        $replacementString = "`n"

                        # Check if the symbol should be kept
                        $keepThisSymbol = $false
                        if ($null -ne $SymbolsToKeepOnNewLine) {
                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                if ($symbol -like "*$k*") {
                                    $keepThisSymbol = $true
                                    break # Match found, no need to keep checking
                                }
                            }
                        }

                        # If it's a "keep" symbol, change the replacement string
                        if ($keepThisSymbol) {
                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                            $replacementString = $symbol + "`n"
                        }
                        $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                    }
                }

                $joinedTitlePointSize = $joinedTitle -replace '""', '""""'

                if ($SeasonPoster -and $AddSeasonText -eq 'true') {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    # Add Stroke
                    if ($AddSeasonTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    if ($AddShowTitletoSeason -eq 'true') {
                        # Show Part
                        # Add Stroke
                        if ($AddShowOnSeasonTextStroke -eq 'true') {
                            $ShowOnSeasonArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$showoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShowjoinedTitle`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                        Else {
                            $ShowOnSeasonArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$showoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$ShowjoinedTitle`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                    }

                    Write-Entry -Subtext "    Applying Season Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                    if ($AddShowTitletoSeason -eq 'true') {
                        Write-Entry -Subtext "    Applying showTitle text: `"$ShowjoinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                    }
                }
                elseif ($CollectionCard -and $AddCollectionText -eq 'true') {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $CollectionfontImagemagick -box_width $CollectionMaxWidth  -box_height $CollectionMaxHeight -min_pointsize $CollectionminPointSize -max_pointsize $CollectionmaxPointSize -lineSpacing $CollectionlineSpacing

                    # Add Stroke
                    if ($AddCollectionTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$CollectionfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Collectionfontcolor`" -stroke `"$Collectionstrokecolor`" -strokewidth `"$Collectionstrokewidth`" -size `"$Collectionboxsize`" -background none -interline-spacing `"$CollectionlineSpacing`" -gravity `"$Collectiontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Collectionboxsize`" `) -gravity south -geometry +0`"$Collectiontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$CollectionfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Collectionfontcolor`" -size `"$Collectionboxsize`" -background none -interline-spacing `"$CollectionlineSpacing`" -gravity `"$Collectiontextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Collectionboxsize`" `) -gravity south -geometry +0`"$Collectiontext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    if ($AddCollectionTitle -eq 'true') {
                        # Show Part
                        # Add Stroke
                        if ($AddCollectionTitleTextStroke -eq 'true') {
                            $CollectionTitleArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$CollectionfontImagemagick`" -pointsize `"$CollectionTitleoptimalFontSize`" -fill `"$CollectionTitlefontcolor`" -stroke `"$CollectionTitlestrokecolor`" -strokewidth `"$CollectionTitlestrokewidth`" -size `"$CollectionTitleboxsize`" -background none -interline-spacing `"$CollectionTitlelineSpacing`" -gravity `"$CollectionTitletextgravity`" caption:`"$CollectionjoinedTitle`" -trim +repage -extent `"$CollectionTitleboxsize`" `) -gravity south -geometry +0`"$CollectionTitletext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                        Else {
                            $CollectionTitleArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$CollectionfontImagemagick`" -pointsize `"$CollectionTitleoptimalFontSize`" -fill `"$CollectionTitlefontcolor`" -size `"$CollectionTitleboxsize`" -background none -interline-spacing `"$CollectionTitlelineSpacing`" -gravity `"$CollectionTitletextgravity`" caption:`"$CollectionjoinedTitle`" -trim +repage -extent `"$CollectionTitleboxsize`" `) -gravity south -geometry +0`"$CollectionTitletext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                    }
                    Write-Entry -Subtext "    Applying Collection Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                    if ($AddCollectionTitle -eq 'true') {
                        Write-Entry -Subtext "    Applying collectionTitle text: `"$CollectionjoinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $logEntry = "`"$magick`" $CollectionTitleArguments"
                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                        InvokeMagickCommand -Command $magick -Arguments $CollectionTitleArguments
                    }
                }
                Elseif ($TitleCard -and ($AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true')) {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                    # Add Stroke
                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    if ($AddTitleCardEPText -eq 'true') {
                        # EP Number Part
                        # Add Stroke
                        if ($AddTitleCardTextStroke -eq 'true') {
                            $EPNumberArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$EPNumberoptimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EPNumberjoinedTitle`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                        Else {
                            $EPNumberArguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$EPNumberoptimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$EPNumberjoinedTitle`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                        }
                    }
                    Write-Entry -Subtext "    Applying TitleCard Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                    if ($AddTitleCardEPText -eq 'true') {
                        Write-Entry -Subtext "    Applying Season + EP text: `"$EPNumberjoinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                        $logEntry = "`"$magick`" $EPNumberArguments"
                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                        InvokeMagickCommand -Command $magick -Arguments $EPNumberArguments
                    }
                }
                Elseif ($BackgroundCard -and $AddBackgroundText -eq 'true') {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    # Add Stroke
                    if ($AddTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$strokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Write-Entry -Subtext "    Applying Background Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                }
                Elseif ($AddText -eq 'true') {
                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    # Add Stroke
                    if ($AddTextStroke -eq 'true') {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Else {
                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                    }
                    Write-Entry -Subtext "    Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
                    $logEntry = "`"$magick`" $Arguments"
                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                }
            }
        }
    }
    Else {
        if ($TitleCard) {
            $Resizeargument = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
            $EpisodeCount++
        }
        Elseif ($BackgroundCard) {
            $Resizeargument = "`"$PosterImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
            $BackgroundCount++
        }
        Elseif ($SeasonPoster) {
            $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
            $SeasonCount++
        }
        Elseif ($CollectionCard) {
            $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
            $collectionCount++
        }
        Else {
            $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
            $posterCount++
        }
        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Manuallog.log -Color White -log Info
        $logEntry = "`"$magick`" $Resizeargument"
        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
    }
    if (!$global:ImageMagickError -eq 'true') {
        # Move file back to original naming with Brackets.
        Move-Item -LiteralPath $PosterImage -destination $PosterImageoriginal -Force -ErrorAction SilentlyContinue
        Write-Entry -Subtext "Poster created and moved to: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Manuallog.log -Color Green -log Info

        $endTime = Get-Date
        $executionTime = New-TimeSpan -Start $startTime -End $endTime
        # Format the execution time
        $hours = [math]::Floor($executionTime.TotalHours)
        $minutes = $executionTime.Minutes
        $seconds = $executionTime.Seconds

        $CSVtemp = New-Object psobject
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $(if ($SeasonPoster) { "$Titletext | Season $global:SeasonNumber" } Elseif ($TitleCard) { "S$($global:SeasonNumber.PadLeft(2, '0'))E$($global:EpisodeNumber.PadLeft(2, '0')) | $Titletext" } Else { $Titletext })
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value $PosterType
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $FolderName
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $LibraryName
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $PicturePath
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false'
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value "true"
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value "false"
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value "false"
        $CSVtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value "false"
        # Export the array to a CSV file
        $CSVtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append

        if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
            # Calculate Summary
            $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
            $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
            $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
            $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
            $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        }

        # Export json
        $jsonObject = [PSCustomObject]@{
            Posters              = if ($posterCount) { $posterCount } Else { 0 }
            Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
            Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
            Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
            Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
            Mode                 = $Mode
            Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
            Errors               = if ($errorCount) { $errorCount } Else { 0 }
            Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
            Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
            Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
            Text                 = if ($TextCount) { $TextCount } Else { 0 }
            "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
            "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
            "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
            "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
            "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
            "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
            "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
            "Script Version"     = $CurrentScriptVersion
            "IM Version"         = $global:CurrentImagemagickversion
            "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
            "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
        }

        $jsonOutput = $jsonObject | ConvertTo-Json
        $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8
    }

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
#region Testing Mode
Elseif ($Testing) {
    # Helper to create the initial test images
    function New-TestImage-IfNotExists {
        param (
            [string]$ImagePath,
            [string]$ImageSize,
            [string]$MagickPath,
            [string]$CommandLogPath,
            [string]$TestingLogPath,
            [string]$Message
        )

        if (!(Test-Path $ImagePath)) {
            $arguments = "-size `"$ImageSize`" xc:#FC7E10 -background none `"$ImagePath`""
            $logEntry = "`"$MagickPath`" $arguments"
            $logEntry | Out-File $CommandLogPath -Append
            InvokeMagickCommand -Command $MagickPath -Arguments $arguments
            Write-Entry -Subtext $Message -Path $TestingLogPath -Color Cyan -log Info
        }
    }
    # Helper to build the Border/Overlay argument string
    function Get-BorderOverlay-Arguments {
        param (
            [string]$SourceImage,
            [string]$OutputPath,
            [string]$AddBorder,
            [string]$AddOverlay,
            [string]$OverlayImage,
            [string]$BorderWidthSecond,
            [string]$BorderColor,
            [string]$BorderWidth,
            [string]$LogPath
        )

        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true') {
            $logMessage = "Adding Borders | Adding Overlay"
            $arguments = "`"$SourceImage`" `"$OverlayImage`" -gravity south -quality $global:outputQuality -composite -shave `"$BorderWidthSecond`"  -bordercolor `"$BorderColor`" -border `"$BorderWidth`" `"$OutputPath`""
        }
        elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false') {
            $logMessage = "Adding Borders"
            $arguments = "`"$SourceImage`" -shave `"$BorderWidthSecond`"  -bordercolor `"$BorderColor`" -border `"$BorderWidth`" `"$OutputPath`""
        }
        elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true') {
            $logMessage = "Adding Overlay"
            $arguments = "`"$SourceImage`" `"$OverlayImage`" -gravity south -quality $global:outputQuality -composite `"$OutputPath`""
        }

        Write-Entry -Subtext $logMessage -Path $LogPath -Color White -log Info
        return $arguments
    }
    # Helper to build the Text Overlay argument string
    function Get-TextOverlay-Arguments {
        param (
            [string]$AddStroke,
            [string]$InputFile,
            [string]$OutputFile,
            [string]$Font,
            [string]$PointSize,
            [string]$FontColor,
            [string]$BoxSize,
            [string]$LineSpacing,
            [string]$TextGravity,
            [string]$CaptionText,
            [string]$TextOffset,
            [string]$StrokeColor,
            [string]$StrokeWidth
        )

        $strokeArgs = ""
        if ($AddStroke -eq 'true') {
            $strokeArgs = "-stroke `"$StrokeColor`" -strokewidth `"$StrokeWidth`""
        }

        return "`"$InputFile`" -gravity center -background none -layers Flatten ( -font `"$Font`" -pointsize `"$PointSize`" -fill `"$FontColor`" $strokeArgs -size `"$BoxSize`" -background `"#F3AC7C`" -interline-spacing `"$LineSpacing`" -gravity `"$TextGravity`" caption:`"$CaptionText`" -trim +repage -extent `"$BoxSize`" ) -gravity south -geometry +0+`"$TextOffset`" -quality $global:outputQuality -composite `"$OutputFile`""
    }
    # Helper function to log and invoke
    function Invoke-MagickTestCommand {
        param([string]$Arguments, [string]$CommandLogPath)
        $logEntry = "`"$magick`" $Arguments"
        $logEntry | Out-File $CommandLogPath -Append
        InvokeMagickCommand -Command $magick -Arguments $Arguments
    }
    # =================================================================================
    # Initialization
    # =================================================================================

    $Mode = "testing"

    # Define Log Paths Once
    $testingLog = Join-Path $global:ScriptRoot 'Logs\Testinglog.log'
    $scriptLog = Join-Path $global:ScriptRoot 'Logs\Scriptlog.log'
    $magickLog = Join-Path $global:ScriptRoot 'Logs\ImageMagickCommands.log'

    Write-Entry -Message "Poster Testing Started" -Path $testingLog -Color DarkMagenta -log Info
    Write-Entry -Subtext "I will now create a few posters for you with different text lengths using your current configuration settings." -Path $testingLog -Color Yellow -log Warning

    # Create Base Test Images
    New-TestImage-IfNotExists -ImagePath $testimage -ImageSize $PosterSize -MagickPath $magick -CommandLogPath $magickLog -TestingLogPath $testingLog -Message "Test Poster Created..."
    New-TestImage-IfNotExists -ImagePath $backgroundtestimage -ImageSize $BackgroundSize -MagickPath $magick -CommandLogPath $magickLog -TestingLogPath $testingLog -Message "Test Background/TitleCard Created..."

    # Base64 Overlay
    $favicon = 'iVBORw0KGgoAAAANSUhEUgAAAfQAAAKzCAYAAADoY//DAAABfWlDQ1BpY2MAACiRfZE7SMNQFIb/pkpFKw52EHHIUJ3s4gtxKlUsgoXSVmjVweSmL2jSkKS4OAquBQcfi1UHF2ddHVwFQfAB4i44KbpIiecmhRYxHrjcj/+e/+fecwGhUWGq2RUFVM0yUvGYmM2tioFX9MGHAOYwLTFTT6QXM/Csr3vqpbqL8Czvvj+rX8mbDPCJxFGmGxbxBvHMpqVz3icOsZKkEJ8Tjxt0QeJHrssuv3EuOizwzJCRSc0Th4jFYgfLHcxKhko8RRxWVI3yhazLCuctzmqlxlr35C8M5rWVNNdpjSCOJSSQhAgZNZRRgYUI7RopJlJ0HvPwDzv+JLlkcpXByLGAKlRIjh/8D37P1ixMTrhJwRjQ/WLbH6NAYBdo1m37+9i2myeA/xm40tr+agOY/SS93tbCR8DANnBx3dbkPeByBxh60iVDciQ/LaFQAN7P6JtywOAt0Lvmzq11jtMHIEOzWr4BDg6BsSJlr3u8u6dzbv/2tOb3AwS6cuHlwHxgAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAAGYktHRAAAAAAAAPlDu38AAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfpCwoDGRhv2L6IAAABwXpUWHRSYXcgcHJvZmlsZSB0eXBlIGljYwAAOI2lU+vNHCEM/E8VKcH4uZTDwa6U/huIwXCv3BfpFEtotWMYj82QfreWfo1QwwQjsII2Je1GwDwh7XoaGwqyMSLIIUUqAthZPH3zlX0ZAFVfkjQrGRlwF2KVYPkyLq+aFvOMTtjvyr6M9OX+ri7bSKNQxgUzJG8MDC1ayroSpGY+Idh4OQLP7HoPH8fCawscW/JxzjFGoj8OvOBnu+P2hG9Bjg8i9psJqZjXsBH8wGf8h/1pSDXUHv+0E+yzcAOsFlzdC84bt90aJ4ebib7f0r7JpqKniNA+sNJO4CMEdk+xi5Bxa6NRHU4T/3pCfdMYMvb1f8aeYQnBRYDvAtK/FeT6UCCwimEUm0UoijA7kV7jQfjKDwXweBJPMRwMbwZ2TykR4bMhMzSOk9LPawShzH8rU+HVC0z8VvP89lWJeptEzVV8UqBXdEbHFYRUPipFLlcouo55Gzdt/JEQi828HfObj+6AZrfNvc1BtCeP6jF5sVoMQco8SGEzqHJ78V0EbSKo1OdB4TAYtzY3llLqqhDEl7SffLeH/XbtsN/cX8b7D6JXI6Y//zEgYtTb4LYAAIAASURBVHja7P1XkxzZkucJ/vQYc+5BwTmQ7N4it1jvPK7I7mea6Zqnfasu2dcV2a+0MtLdU91T5NLMm5yCB3FidnQf9Bw3DyQBMgG4BTm/lJAAkIiAhxtRU9W//hUSiUQikUgkEolEIpFIJBKJRCKRSCQSiUQikUgkEolEIpFIJBKJRCKRSCQSiUQikUgkEolEIpFIJBKJRCKRSCQSiUQikUgkEolEIpFIJBKJRCKRSCQSiUQikUgkEolEIpFIJBKJROKtIF2/gEQi8Xrofxm/ke8j//l51z9KIpF4DVzXLyCRSCQSicTrkzL0ROIM8pKsXLCH9fgRr3MFGsCHX+uPfoOUrScSZ4686xeQSCTeCj1gGxgDBRa8Z8Az4Akw7/oFJhKJN0sK6InE+cIBFbAD3AWuAwOgxoL5p1iG/gjL1hOJxDkhldwTiVPOK4jeHJBhWfkIy8yvA+8Ct4EhFtCfAH8Gfg98gQX4Y2CBBXf9qX8kleETidNNytATibNPhpXWL2FZ+QPgDnAT2McCvQcOwp/fBT4C/gh8DDzEArv+vH82kUicJlJATyTONhkwAa4C94G/Af4OC9xbWDCPPfQFFtTfA/4ETLEqnWAl+EMs8CcSiTNIKrknEqeQVyizl1gpfRu4hgXwd4G/Bn4d/qzH96/xGniO9dL/B/AvWKb+GfAtVpY/Dn/vR0nl90Ti9JEy9ETibDLCgvg7WIn93fD767Rl9h96YM/D117Dsvt94B7wOyywfwh8jmXyiUTiDJECeiJxNhAsAGeYav0G8CvgN8AHWGC/AvT56cqbhu+xRVuqv4pl+iPsnuCBL7ExN6WdW08kEqeYVHJPJDrkFW1bBRtFi8K3G1hW/SusH34HC8qjX/gyHmHiuD9hCvjfYmr4L4DvsGz95Iib0nbf1/6P/O+pFJ9IdEXK0BOJ00+JZdPXgb/E+uTv0JbXp1iJ/ZcywsbbxliWfwcL7P8C/BsWso9Jc+uJxKkmZeiJRAe84mx5gZXQt7FAex/4e76vYn9TD+ZLTDD3LdZP/6/Af8NG3B5imfoMaBD8TxXhk2gukdg8KUNPJE4nJZZ9X8Oy5wdYQI/itz1eLyv/IQqsEpDR9uy3seD+J+AT4GvgMZrG2xKJ00YK6InE6SMG0ruY4O0vsFG021hW3qedLX/TVbYouruKlfJvhdexj43J5UBDw2MyFKGdXE/1vkSiU9IlmEi8RfSf13Rq+pOXW4YJ34aYD/stLJj/ilbFfpnNrzyeYzPq/w78K+142+fYzPoRVqpPm9sSiY5JGXoicTrIsaz8PhbAH2BK9ltY/3yLzQdzsIeMS+HXUZh3Cwvqv8f66487fN8SiUQgBfREojsEK51XWHn7Nmbd+g+0c+XbWK886+g1KlY1uAXs0s6t72N9/mX4OWKm/tIlL4lE4u2QSu6JxFvgFVTsGa1162VstvwBNpb2aywTnmLB/jRxgKngP8ZG2v6N1l3uW2yD25yXeMKnMnwi8eZJGXoi0Q192u1oUfj2AFO172Az4UXXL/IH6GEK+4K2qvB7zBf+P7DA/hAL6olEYoOkDD2ReEO8JCt/0br1MtYjfx8zivkNVtYeYr1yx+m9PhVb3rLEMvI/YfPq/yetYC6uZG1I2XoisRFShp5IbAbFsvIrtKNgcbb8PlZi3+r6Rb4isfcfP2LQHmMVhg+xknzc4Dbr+gUnEheBFNATibePw3rh+1h5/W8wD/a7WADcwkrZb2Ou/G2TYS2CPiaWu43pAX4bfuYlFtSTbWwi8ZY5azePROJU8Aqit5jF9rHMdRcL4LG8Hvvl25yf67AGvsEWu/wO+J/Y7Pon2GjbEdZbf0EJ77Hngmb1Vsh/TttbE4mfS8rQE4m3Q4YtPVnvlb8Tfn0Ty9bHnJ9gDu0sPVjFYQtrJfwBC/DRE/6o6xeaSJxHUkBPJN48UQF+BQvgf4vNlj/AAt4AK0d3YRTztqkwFfwQU/HfwoJ6H8vKHZatH4LW5+t5JpHolnQ1JRKvyCuU2Uss697Dyul3sCD+F5iFawxsF4W4ve0TrPT+r5gi/lPikpcf2rX+AkkFn0i8GilDTyTeHENMFPY+thUtbka7ignHyq5f4IbJw3tyE3uQuYYF9P/ASvB/Aj4DOUzmconE65MCeiLxA7yi6E2waygGrutYJv4bTM3+LhbMB13/PB0h2EPMNm0LIpbj1+xs9SvinvUfsI7V/8/Y8njP6o4l/2vK2hOJF0kBPZH4ZSgWrCa041r3sXG0d7De8WUseF1k4oOPw4L6dSw09zHR3GVMLBd3rR+Q0vVE4heRAnoi8cuoaLeP/RXw91hGfg0bUZtgWWjiJGOsDbGFvVd3sZn1/4YFeo9l63XXLzSROGskUVwiEXiFMrvDsvK4VGVdxf534ddbWLDvajvaWaHGBHPfYHax/xX4F8xh7jvMUvaYl+xahySaSyQiKUNPJF6dApsfv4Fllu/SWrfepF11mh6UX05OO4cfnfSuYDPrv8fMab7ClPApW08kXoEU0BOJn0awDDHHlOp3MOHbX2Cl9rtYb7jkdG5HO804rNpRYO9ttI2d0ormPMITPA0SjsVZNMhNJDZAuiwSF5qXlNkdFlgmWGZ+ExO9vU8rfrvC+TSI6YI5ttDl37HRtt9jo21fYA5zz4HFT32DVH5PXGRShp5I/Dg51hN/B8vI38Uy8huYOnubFMzfJCXmLpdh4203saz9D1iQ/5BX6KknEheVlKEnLgw/Y7a8pM3Mb2Git/+EZeVXsSDfX/v7iTeDrn0+xMbY/oxl6/8V+B/Al+H/LbHeurIe4B3wFDtyAfnfUtaeuBikDD2RaBFsocoONlIVZ8t/hZXZr2P93arrF3pOkbXPUTCXYT32aFDzIe3M+lPSrvVEYkUK6IlESx8r+d4Ffo2tOn0XK69v0Qq4Epuhh2kXerTrZ38L/HesBC/AI6z3nkhceFK5MHGueYUye44F6bjqNI6j/RVm4XoHC+SOdL10RYOV2J/Szqz/T0ww9zkW1I+ABR7/U42QJJpLnGdShp646PSw8vq98PEgfL6DldjP287ys0gWPgQ7LoKJ5m5hAf7PwMcIXyMs0tFKXFRSQE9cRNbNTPax/vjfYQtV7mHCtzhbnjg95FggH2MPWzewscEdIENZ4viOjIYaKFA8L1nOmkicH1JAT5wb9J/WyuslP9RZFay8PsAC9iUs4/tLrMR+H8vWt0lZ+WkkZuoVrZ4hx452DgxQPqXmO+A5S2Y0NOsmvPr/BZ6NwLfThvKPz7r+uRKJN0IK6ImLRHQmu8zJ2fI7WCDfw3rpKZiffjLswQvsmO5jx/F3wL9h/fWHZByT5tYTF4QU0BNnmhOitx++bUeJVIFl5VH49je0s+U7WC+9JBnFnBUUO2aXsKnzy1gJfo9oGWvH/DE2t/79mfX4jdbOoSSaS5xlUkBPnB/W8+ol8baeIau929exLO4B1i9/F+uXD7p+6YmfTTzaOVZVqWj9ARQL8n/CZta/BB6i8pynYwvokpL2xPkjBfTE+STK3pQhpob+ABO/vY8J3y6RhG/niRxWx3qMmQL9Hiu//xb4A6JLbLwtkTiXpF5h4szwM6xbo7PYCMvAo0nMr7De+XXMRCZxPlFskctHwL9iQf3fMU/4r2n3rMcy/A+Syu+Js0bK0BPnCcWC+QQL2vex8voD2p3ll0nB/LwTrWOvh9+PMdHcdcw69iNsg9shSTCXOEekgJ44LwjWQ51givW/wkRvH9COoo1JJfaLRPTd38UEc3ewTL3CsvNvMC/4ZdcvNJF4E6SSe+JU8wpl9mgQM8Zu3FcwFftfY0r2+1gw75HO94tKg5Xgv8HK7v8d+L+Aj4FvgSdE69iYsa/bx67l8GlzW+I0kzL0xFknuofdwoL3+1iJ/Q6WmW9hAT8F84tLhgnmLmEPgCOs/fJ7LGOPJfhHpBJ84gyTAnrirLGeOxVYML+LldbXHd+2sPM7IwXzRDveFje43cQCfJ+T/gNPsXI8pOCeOGOkG13i1PGSMrtgN+FtrLx+C1Ouvxs+3w9/npFI/Dgz4DPMWe53WCn+w/Bn3yA8pWb5Uzv2kgo+cdpIGXriLLHu+PYO1id/H8vQr2PZ+pQUzBMvp8AmHqrw+TYW1H+Ljbr9iW2e8hhNZ1PirJAy9ESnvOJsecbJpSo3sF3l/4AF9OtYiT2NoyV+CYfYfPpHWE/9v2JB/SvgAFvzU2N2sj9Zhk9Ze6JLUoaeOAsMsOz7Ou3O8lhiXxe+JRK/hCiYW9/GdwWzjo2Cuac4jvFdv9RE4sdJAT1x2hlgN9u7mOPb32JZ+WVsVK2P3YQTidchLnoZYsH8PuYwN8YqRA6PYr33ROJUkkruiY3zCmX2HLvBjrHAfQfLyH+NqdjvYYrltBkt8abxWHn9Me3M+r9hgrnPge9oy/A/ma+n8nti06QMPXEaqbDyerRsfQcL4jcxb/YhKZgn3g4OG2ObYlWhEjvn/ogF+FiG/wpSAT5xukgBPXEaiLvRMiyY72MZ+d9hWfl9LMBPsHM2VZYSb5O4E+ASNh55DSvD72JVI8Gy+Ee0C15ScE90TroxJt4qr1BeB8uChsAOduO8gxnF/AWWmV8L/y+dr4kuqDEV/J+xTP3fsdn1TzA72SdYb7152TdKZfjE2yRl6ImuibacV2hnyz/ADGMuY4F8RArmie7IsUw9w0rxV7Gq0b8D/wMrwz/E1rImd7lEZ6SbZOKN84oLVdZ7lVH49lfA/w1Tse9iwriC1C9PnA48lok/xzL2fwP+f9iil88wId0Btr0tzawnNk7K0BNd4LCM5yomdLtHK357BwvwA9IDZ+J04bDzssDunYpl7fu0YrnPsQ1uz7p+sYmLRwroiS6I265+jZXXP8ACepwDTiYxidNMhp3Dt7GW0F3MMvZ/0o5TLrGVrInExkgZUOK10P8yWf9d+PjeaeWwrKZP24N8H9uO9j6maL+BldgTibPGc2xO/d+wvvp/YBn715y0jv3BEnwqvSfeFClDT2yCDBv3uQW8R7sV7Q42jrZPCuaJs8sQO48dZkN8lXbZyx8w69iDrl9k4vyTAnribeJoHd+uYiX2/yV8vo710YdY9v6DqX0icQYQLJAPsIfT61hLaRe7BprweUYrmEsk3jjpBpr42bxcxS4CGsvre9gcefRi/2tMBLeDBft0DibOEw2tCv6P2FjbvwMfY+5yj7DtbvOXfaNUik/8XFKGnngLaI4F7DtYef1XWJ/8FiZ828KEbymYJ84b0VfhMlZ52sYeZv+DuGfdSvApU0+8cdINNfFKvCQrj9atUfy2i93EfoVl5b/BAvsWrXVrmi1PnFeiOrQGFthCl7hn/d+wzP1z4CkW2F9qHZuy9cSrkDL0xJsgel/HneW3aXeW38My9V3S+Za4GEj4KMNHhgVuwTL2y5gq/lPgS8yQJmXridcm3WATr4tgwXwLU67/DZaV38WC+y5p1WniYlNgOpJR+HwLE839Oza7vsCMaJJtbOK1SCX3xPd4BetWod2MNsKC+TVsrvwfsNny61gfPZnEdMaPxYd02XfIESaO+xAL6P8d669/hYnpjrFsPi16SfxsUoae+CUoNqKzh2Ua72Dl9QdYZn4VU7inYN4JoYWr4SNOBArhsyMF9c6Io22CTXlsYy2q32Mz659j29teGtATiRdJAT3xSxhjavU4ivb34fNlWuvWNFveGUFzKIB74e1fBfhER8SH4SvAhHak8zJ23URx6ROSdWziZ5JutgnglcrscRxni3Y72ju0Fq73sECfzqmNsxag1YFkiqugGChZH1xmgdzX0BzB8lDwcwFdO1rpsHXEAhPF/QH4F6z8/hG2vS0ueXnpWtZUfk9AytATr06JZRXvYeX1qGC/jmXraTtal6gnJHcKPSXfUgbXlMG+kvUU9RbIj74U/GeOZgnUdrxSUO+SAsvU72MPzDex4P678PlDTAlfd/1CE6efFNAvIK+QjUMrfMuxUuA+Fsz/Diuvv4MtVJmGv5foDAcuBykVN4B8qgyuKNN7yviGJx9awJ8/UYqBQ7ziMsvWtQZtxB4IUim+Iyqs6rWDPTTvYkG+H/6/x7L4aEbzvYOl/zxup98D8o8pa79opICe+DFyTMG+hwXuu1hAfz/8+hp2A0ppXSf4Nit3PSUbK+W2MrgEwyvK6CpMbsJg35H3reS+eA7DMQwmysEXcPiNcvxIWD4DPRJ0gZXhk2hug8SZdWgfnGO5pY8F9suYdeznmHXsjPT0lfgBUkBP/BAxmF/GSut/C/wFNj+7j2XlQ9Jdvzvi7VwcZEOoriqjW56du7B7B8aXhf6Wo+gLWWF/t57DfE/Zuu559oXy3Yfw6M/C0efC8luHrwVNld2OybAH5SJ8voGV4/8vbMRNsWx9RjKjSbxACugXhFecLc+xUZotrC9+Gwvkf4/ZuO6F/190/fNcbARcCa5QihH0rnqGd5XJPdi7D7u3YLQjFJXgnEOC4t030J96BjtCtaXQAy2VvIRZoSy+g/oA/FLQpv23EptEsMw8Zue74aPCRtkK2kw97lpv0PCIt3a41q/5JJq7GKSAnojEFZDRuvU+1ie/Fz72SVl5R8S5csLYWaaUA2VwVRndUMa3YHIbJteF8WUYbQtlX8iyIHoLh8wJFJkgmbMAIEo5gGc78HzP8/wzOPxMmH3taA6CCj5rvz4d+k3Tw0rvgh39Ppax/wFb8vIZ8DXC01SAT0AK6AlDsJGzG1hG/qvw+QGWqfdJWXmHhDarZdqK60FvX5m869n9QNm+DdMrjuG2o+hDlomFAG8RWF/4ZplAbygUpTKYKuM95fG+p9wBVwh+IfgFaC3WT090SI5dm/dox0WvYQ/fJppTlkiYWVfMouZ9UkH+ApIC+jlE/3mtvP7jT+5xecQQc6u6hvXLf43dDqKKvdf1z3MxCS5vEjohrlSyARRDpbetjG8qOx/A9rswvSqMtoSqLzgHqmKZ/I8gTsgzKCooepBVIJXYvwHkKAcjmD9VljPBzyy4nzAvS9n6hnBYub3CAnscD41Oc0NggvI1tr3tiHepXwzmsfyeSu/nmxTQLy5R+HYby8jfx8rstzDr1ti3S3RC2KipzoK521Z6l5TpDWX7ljK9AePrwvCSoze2frll068WaeMEusugGsBkL6MolH5fGe56nn4CTz4Rnn0mzB8KehCCelTBJzpigM2qR0X8TWwd6++A32Jl+KRsvKCkgH5xiDf6DHuyH2Mzr78C/hfgr7CMfBu7aaRzo1Mymy13lZLvKNU1ZXzbs/eOsv8AJleE3kgoKkdWxBL7qw8ztRaw1msfjKCslP7IM9hT+pcVNwafgxSw/A6a56ALSfaxnZJh12gcKb2KXcdj2hn17zAV/IIfmFlPnF/STfuccELF/kOXr6IIA1rr1jhb/j7WL7+Hjcn0SPXUDojLVEKtNOvbXHlv3xzfRjdhcgu2bwlb16E/FYpScCIrzZT+wvu2c1bad5ngCsGVggu3hqKCZzvK4edw/I0yfyjUzxx+zko0B6RTZmPEcnuFXa95+HCYzmUP+DPwBRbYn2OBHfjxaZdUij8fpIB+URBy7Mn+LtYr/0vgAyyw72JP+CXpztwx3rzY85EyvOWZvOPZugPbNx3jS47BFpQDIc9lpX2W1wjmhO8RVfTOCWWVIdtKUSijbeXpNeXRx8qTP8PzjxzHteLnlqlL2r/TIQ7roV/BBHKXMSHrvwL/A1PCf47NrSeJ3AUgBfQzzk/Ml4eVWyvr1h1MIfs+Jnz7DRbYd2itW9OduRMEJAeXKeJsqcrgurL1jrL9Aezchq0rMJwKWWEZ2mqUTN9AQXXtewhCloMbQtmH3gTKCbiBx/Uhc0rmleMM6mPwTZhZT2X4DojC1gIrwe/TekXE/1dh2foTLFNv+IHgnkRz54MU0M8vih3ffUz4dhd7eo87y29hGXs6BzohltcFKBSpzIN9uKeMrymTmzC9L0xuCaM9oT8R8iqo2H2bVb9xQgVfRCCzkvpQAXGUFQz6MJh6nn8Cz78Ujr8VlgeCLgQJcULW3UwTGyCaQsXr/V0syF/CKnB/wqxjPwMedv1iE2+PdDM/n2TYBb2F9cb/Diux38eMY3Yw4VtaqtIl4jDxWx+ybc/gqrLzrrL3rrJ1QxjuOfoToeibGh0VfPO6/+pLWM/41VTtZU/IdqE3UIZTz/CS58kVyH4reOdMinUILMNoWwrmHVJh1/hW+HyTdm4dLEt/TiqpnEtSQD8jvOKGtGjdOsGC9nWsT/434fN1rF9edv3zXEzWet2usKUqxVgpd5TeZWV8E/behd0HwviSmPlLYdatryN6ex1ETCCXFyaQy3tCPhCyni1Tl8xm1mcPoX4G9SHWXw9l+DTitmlipj7A+us9LMgXtD33L7GZ9UPaMjwQPCyOQlgYLlffVP7Xg65/rsQrkAL6+aJPW2J/P3zcw8rrl7FAn4J5J0QVe40FwqFSXfYMriuTm8rWTWFyHcZXhOGuUA2FvFjrlZ8CxNmY3GAKIkpRwGAbnl5XnnyiPP8cjr9yLL8Dvwgz66n83iE97H6QYYF8H6vS/QftzPoTTjoGJc4wKaCfbeKdMj55R2vIXwH/gM2WX8Ge1kvswk6y5E4IC1LEQVZCtaeMbivTdz0792DvFoz3HOVAyHLBRRX7KaiM6nplQUwFn20rvaFnuKsMLynFFGQAkntm3rFQs49dSfETHSCYWK6iLcHfCr92tKLZJ8ARksrwZ50U0E8xr7ghbYyV0a9imfkDTBTzK+zinZACeAfEhSoxQ82UvAflROnv2lKVyQNlclfYui5MLgn9sQVz+6K3KHx7DeLmNsmEvBTyyhT6KkpWQX8IByPl8POG2XfC4pnQzARZL7+n03FDrM+sV7QP9lHosAN8SFzyojxmnh/RC0Zzvj1OaXPb2SAF9LNNhWXlH2Dl9fewEvs1LMhH3+dEF6xicaZIpRS7yuSusvPAM70tTK4Jo32hN7HtaBJ82L//DU4PK395ABFcJvTHirup9Mcw3lOeXvI8/TM8/r3QfOhoFqDNWgk+FYk6Igem2AP/NlbN+z1Wgv898AcGyzm1a1bnXiqwnClSQD8lvKLoLciiKbF++S4WxH+Dub29g6lat8LfTZfixonBKgOXBR/2gVJMldF1ZecDZf8DmF5XRjuO3sCF2fK1rz/ltOI8G6Mre0JRKb2RUk2UcqLkI/tZdKkc5TazrrX5wa/m1hMbxmF99Xjv2McqeH3i3oZGHKJPMLHcEv2+daz+08T+KGv/OInmTgcpoJ8tMqwndomTO8vfDb+/QhvMIaVBG0axYCXgCiWbKtWuMriEzZbfgK07ML0pDLaF3kDIC8ta1XejYn9tJNjGilUYBhNT5WeZUjjojZRnnykHXwtHD4XlU9ADQYMbqcR134kNEd/s6Bx5B7uvxNbdDawM/ylmHXvc9QtOvDopoJ8dCuyiu4QF8L8H/hrrk+/SPmmnu2OnBNe3bAS9K8rwtone9u/C5Kow2HaUQ9uOZiYxYi3zsxjMoVXvC6DmMjcYZeS50h8q48ueJ5/Bt39S+FA4+lyovaOJDnOJDsmxe0cPc5i7hbXs/iX8P4/Zxs5ISvgzQQroHfKKorcC64VvY/3yW5jg7W/C50vYBZmO5cbR9pOIbSXLe0o5Vgvmd5TJXdi5Czu3hPFuDOSWxa5Eb2c1mP/Ae5FlQpZBVghl31OOhWyoaAFSKGUfjvuexbfC8rng54IPIqw04rZpYgm+h1X+trCkQbBgPsC84B8Cz4BjaleTB0fAJJo7daQgcPqZYn3xu1h5/Z3w65tYD2xAW2JPbIyoYidkqA7KgTK45hnfVia3lektYRyEb4MpFD0TkZ37mCW2wY1CqIaOyb7inInmnl1Snl5Snn8iHHwizL5w+Fl4T/IQz8/9G3QaqTg5BjvFyvG/A/6AWcd+RabPun6hiR8nBfTTR0xTHPa0fANbpvJrTPj2Lm1WnpHufh0RDpEL47yuslWn0wee3V8rW3dg64ow3HYhkAd/9DexTOUUsz43LwiZE3ojpewpwy3zqq92lGKiiBN0ZqV3baTVcZ7nN+jUEnc/TLAk4QpWDdzDPC5sE6OoR/QIRMOh0nQHOj2kgL4h9J9fsq/ciBuSxtiFdB3LyD/AAvl9LMD3u/55LiZrBitSgFRKPlTKMQx2bLZ8+z3YfkeYXIHhlgnfXBZ65RcwUEkGeSZQmqGOFA5yT1ZALlDmnoMvhNljYXEkNMegwRN+la2niLEB4htdho8B1u7z2JNWLMnvovIl8Ag4QL7fW0+b27ojBfTTRY5dOLewZSq/pg3il7E+erJu7ZRwf5NCybaU3mXP9KayexemN2B8VRjsCb2RbUdDXpgtv2isZs5NBFj1hem+UFXKcKiML5lt7KOPhKefCP6hwIFl7Cdm3hMdMMDuResZ+x+Bfwf+DVgCR12/yERLCuhvkROitx9OzuJTcY5l3RMscL+Pqdh/gwXzHazslbajdYqzpSpZT8m3leqqMrql7L2j7L8D06tCfyTklSPLZOXKcREz83XaMryN6eW5UFZKb+Tp7dpyGnqgGRyWsHwIzfOw5OV7Y9CJzZFj954J7dz6LtZvr7HM/SE22jbnhV3r+l9G4Y9OjibKf04z62+LFNC7RbFAvkP7BHwfK6+/j4lSdkjjaB0RR7LCbHnWt+DTv6wMr9t2tMlNYXrDgvlgSyhKwUkK5j+GiJXhCydILkjuEKeIg2oIz/aVg8+Vo6+F+bfC8qnDz6LdbPwmXf8UF4X1mfUtWmOrWEm8Tjuz/i2mhF90/aIvMimgd8u6ucN72Fz5r7GsfJtWjJLohBiXBcQp+UgZ3vRM3/Ns34Xtm8LksjPr1p75sK8WqkDKLH8AVSCY6DhxlJXidkw0N95VnlxVHl6CJx8pz3OHLpXlQtrELwXzjogLoK5iwfwalnz8D+D/xO5lis2t+1/4byRekxTQ3wIvmS93WMkq2i/exoL5B9h2tPfCn6fyeifEnm+0by1sTWgxVAZXlem7yvb7sH0bti8Lwy0J1q3y/e+T+EFWwkKBLLe59aIP1QiyAUhPcaWSOyUXZdaD5SE0S7OOXcWL5Am/QdYFc9FVbko7MtvHAv0X2Pa2Y9AllPri5EISzb09UkDfPNGd6R62Ge0B9qR7GythTUnBvCPULFhN1qBIBflUGV1RJjeU6U1lckcY37Cd5b2xkJXR8e10bkc71UjUywlZeCYabQvilKqnjMbwbKfh2afCs0+Fw6+E+gBzNPGrb5GC+sZxWADfw1qDA+ze9cfw8SHwsYkh0q1sk6SAvhmi8C32ou4Cf4eV2B9gF0O0YExXQGeE/q7kIH3Itzz9q8r2u8r++8rWLWG0K/TGjqIHzllg8SmI/zLWZ/JVEISyp+SF0B8qwy3PYN/m+6UneHUcO/CHwDJZx3aLYverm7Qjtlcx4dwQ8FDW4WB5EA+VmnYu8bZIAf01eMUNaVHBPsVO9hu0/fL3aYN56pV3wlpWLgVkAzM9qXZN/Da+AbsPYOeeML4s9IZCUYSsPIne3igi4AohLyErICuFrCdkhb3Jeak8/xxm38HiqVIfCH4maLKO7YD1JKXC7l95+FzYn8k2VoJ/CBzAfM66Cv6fJpA19rFob3/yj8mM7peSAvrbp48F8ju0jm9xZ/keNhJSdP0iLybRvjUE9KxUyn3P8JZnetP65NNrwuiSY7AN5UDIcyEYviXeBiFrFycUlWMwEZyYaG60D08+8zz+GJ5+araxy+9AFyGKp+JWh1SYg2WBJS/Xserjv2Iz659ivfWUor9FUkD/BbwkM1+fLR/Srjr9APgHLDO/hgX6gmTf2iHO1ndmBWSVUu3bQpXpO8rOPdi7LUz2hWoguFwQF4J5sid9a6y/t87Z9ECe28z6YFepdsANgUrJMs8Mx8KBX8hKQZ/ogrjauYdN6FwNH33sgGbAl6wEczSAoqI0GUjY2CeaRHOvQQrobx7FVKCXsafUO7R7y98Lf7ZFCuIdsLZQZeXF3ld628rgklm3Tu7C5I4wvSZM9oT+xMbRCG5vSfi2OUTsgcs5wRUOV/jVcSv7yrMJPJ96jj4Xjr4RFo+FprbyiUgqwW+euB0ylNxxmAFNid0PPwQ+Ab4CHuL8EdpeWki6rl6XFNDfPD3s5P01tt70faz0dA0rRQ1Id5luEWeuZFIpxbYyvu/Zed+zdQemVx2jPUc1tlWnEq1b081m46zP8wtCljkGEyUvYDhRxnueJ5eUJx+C/NbRLDOaGqRJlrHdEwXA72NVyrvAb7Hy+28Bj3dznDdl40V2R36DpID+E+h/maz9LriFfT8WR/ekHlZi38MC+G+w7WjvYA5wW13/PBeXGBgykFzJKpt3LqbK8Jqy876y9yvYugGjHaE3cOSFnK995WeVtffeOcFVQlEp1QCKoZAPlaxHEFJ7jr4W6iOhWdiSF61JpjSdEEfbohPmFLtHxln2DNEeKo+xEvwCO1Dt3MOJ1ua6dWwSzf0YKaC/PtFB6TKtbWucLb8Z/vyV5PCJt0GwblXAlUo2Uao9ZXhFmV6HyQ1sb/l1YbBt/fIstywen2L5qUJiKd2U8P2JQ5yQZ0pVwHBHefap8uxL4fAbWD4R9MC1KviTnuKJjeFox3VL2h77n7Bd6x8C32GBPfEapID+epSYEOQSlon/J+BvMRHcDhbIYy8p0QmxD5tDPobyijK649m5p1y6D1vXhP6Wo+gLeSk2W67g04zz6SN66wOoUOSCGytloQwmnvFVz+NrkP1B0J5wnMFSFa+y8uNPdEVBO6N+Cata3sYy91gGewLMsL574heQAvoP0JZ61tMzt/ZnUmGBfH2pyntYmf19LCvvkwJ5B4RjpsEW1BWQD5RyqvSuKMPbyuQO7NwRtm/CeM965c4JEhqvabb8DCDgHLg8bHDrC/lQkNL0EVmlHIzgaOSZfyssngnNcZpZ7w7HyV3rUREf/Xu3gM+xJS9PsLWsa4E9Wce+Cimg/2w8kI2xp8v7WCB/D1OzX6N1fEvBfOOsBfM4W+4qpX/NM7nnmd4J5fWrwmhP6E+wYJ6ZS9nat0icFRSzjs0dVV+Y7AfR3Lby9LLy5JLy7GM4+LPj+AtHM5e0ua1zCqx6eR0L8PtYm/LfMcHcn7ERtxSxfyYXOqDr/3vU/qaOoxPf+2vxUd7ZRzbGeuMfYKK3v6TNyqu1v5vYOKFH6jJAlKyE3iVlck/Z/Uu1DWlXheG2o+xJ6KnKSQvSxJlhvZIi2Hhhf6xUA2W4Bf0tpZgq2RAEhQXMBXy99vVJ9NgBcdHLFhbY48x6bFGW4e98iWXqUSx34kCti+ZStm5c6ID+ajgFH92PLmPB/AGWlT/AXN+uYGWkxMZZs1+V3DZ15SOlmirDPRhfV6YPlK0HwuSKbUfrDSwrX1m3phv6ucA5IDPBnMtBnYPMkxdQ5dAbNhx8IRx9JyyeYSX45dqil1SG3yAvWseCldgLLNDvYZn6Z1gZ/jnpQn0pKaC/FF9g/Z4bmMvbX2Ol9huYuGNCe0ImOiG04aRUsqlSXfZs31F278P2TRhdEfrbjmoEeWl37bQd7fzRzq2bf0DVF9wloeqrza1f9Tz+Mzz8o/D0Y4cPFuPapCjePUOsbRltY+8Avwf+J2Yfu8AEc+mC/QkuXEA/MdsYha/ra5X/03P4P8YZ9qQ4wE6wS9g42t9hwrdbmCBuQCqvd0S8rh1kJWR9M4mpriijW8ruA2X/HVOx98ZCUVpWHg94Er6dU6IXvAhFCXlhG9yqUUO1BdkINAcy5agHy0dQP4NmnmbWuyVm5pPwOf46ww5KCTwCDmmV8O2ilx+x475opfgLF9C/x4v39f9jDHby7GIit7vYSNqD8PkmbTBPV/3GCSVyb1bQZhCz6xlc9Qyvw+QWTG4E69Yr0J8GFbusBfOuf4bEZghKeESoxCEORJQ8h8FUefaZ8uwz4egrYfa1sHzi8Isw655WLHSEo/XtyLB78Q6Wsf8BK8N/DTwjGfd/j4sd0L3AqIajrL3JCwUWzO9gffK/Af4KC+TrbkeJTgh9TlGbLy9GyvC6Z/qBZ/se7NwSppcdvbGQV2YSg0oqr19AdM0YyDlHWQnZrtIfKON9z5MrSrmrPB5b5NelUteyGnlMdIXD2pzRPvYmplXaw9qb8WnrCWlm/QQXJqD/YEnGqQVzcAg97CTax0rqcZnKX2Dl9n1Seb0j1srrZIorIa+gHCmDq8r0Xdh6D7ZuC1uXTfgWe+Unvj5xYREHubMHvKIPxUBwYYV3VkKZK88Lz/HXwuK50MzBL8Oil/ZpP7ERwkQRUb80xXw9YpN0jLnNfYGV4Q+wHvv3uGgz6xcmoL+EDCvrxCC+bt16FTuhUjDvhDhTDubFXirZljK8qmzfVqa3YXJLGF/LGOxAbyRkhYmiUnk98SIidm7klWO4DS5T+iNltKU8u6Q8/Vh4+pFw+IWjaRQJGfsqlqegvmEEy8r3sIVXW5gHyB/WPj4CHnb9Qk8DFzWgr+8sL7GAfRcTvP0NFthvYEE+zpYnOsG11q0yUPKp0r+ibL+jXPqVZ/u2mcT0Rs62o7mwWzm11xLrnHi4M1fAqq8UldAbKf0tT3/PU2wp6hy+USQT/LHakpeg2Uh0xQBLsPaxMeF9LEuviLvVTTDXYL31C3kDOHcB/cfUji/gsBNkm9a69R3a8vp1rI+eeuWdEAOygpSQjZRyS+ntKoMryvgGZhJz1zG+DL2hoygEl625xCUSP4EJ34QsGBFJIUghZicLVAPl+ZfK8bcwfyLUzwQfrWPDfoDEplg39xphYuW4ez3acF8BPgW+wQRzc9Y3t/3z2EL8khNDxvK/na9S/LkL6K9IHyvh3MEEb39NaxCzQyvISHRGyKiySqn2PIPbnq3bsHMHtq4Lwz1HbwrlwBzCIAXyxM8kjC+KCEXhGE6E3Cm9oTK5ojz+VHn4ETz9RJh94Vg2tpI1fm0q3HVFhY0SV9j9+hbwR+BfsLn1z4CnWFC/UJyboPWSzFywPnkUWUTh23vA32Ol9htY1p6T+uUdIub45qoYzJXhXWX6jrJ9D/ZuC9NLQhnc3pxr76pptjzxc1g/X7JMyPpCUSq9sae/reQToAdSKQe5Z+Ycy8fQzGQ1NpnoggwTxvWxKuslLLDHmfUe8BXwmLjkZUrDE6zmunbYzpto7twE9JegWLC+ivVh7tIK3+5jJZwJKZB3QJgrV0BDZS2rrLw+uqqMbtp2tMltx+QKjHaFaiTkhYQvCN8m3VwTr0G0fc1EkNwhzqNIEM3Bs214vus5+Ew4/EKYPxT8TFbl92Qb2wX52gfYXWRMm7F/TNzg9uRi7Fq/KAG9j/mwx4UqH2A98xjIk/CtM+JSnJCZUynljjK659n7lWf7LkyvOUa7LgRycALq0/FKvDnWPf1t0YtjMIGyUkbbymjf8/iSUmwD4vAzx6IOfzudih2iWBzbxu7z17BW6lVaUXOD8BWeBmW1w+k8FljOXEDXf1orref8mJ4xCib62BPbPpaJ/yU2+vAAe4rb7vrnubhEi05nJc2sB/lIKbdgeEXZflfZew+mN4XRrtAf2Dhasm1NbALnhKwHZc/m1rOe4HpKloOrlUyUo29heaTUM0EXoLUk69iNE9up/fCxFT7HFmsJVChjhEcIB8AcT7N+iE60bNcKf/KPz7r++X4WZy6gvyIZVmK/gmXiH2BB/C6mYN/HeumJTlDQJgT0QsnGSnXJSuxbN5XpTZhcF8ZXhP62UPbFxtYkLVRJbIjoSChWFeqNHSJCmSv9njK65Hn6KTz5XDj8Wlg8EjgI421RBZ+CegcINoZ8Dwvs+1ib9Y/YrvU/Ytvbmq5f6NvgvAX0aEKwnpX/AyZ8u0urYK9I/fIOCT1Hl0MxhfKqMrzt2bmvXHoA29eFwZZQ9ISsMA/ulX97IrEJQiXIHiCFohCyCZSVpz/1DK96eldAJqCVeb/XojQxqCc6pMSEcmOs1XoDK8X3iVaxwlNsycuSc5QhnJmA/oMq9njd2P2+xPrhe7R9lDhb/g7tzvIUyDdOuF6it7YroJgo1Y6ZxIxuK+PbsH1L2L4B4z0L5s6tOb6dm2suceYIS15cBlkuZJWQ9RxkCg7KATyfKkefe46/FZaPhfpA8HXQhqRsfcNE69gxlrxVWKxTLNhfxmbWv8aU8Iese8JLe685ayr4MxPQfxIHNIwxS8AHWIn9AyyoX8H6Kj1SMO+QtaDsKqV/xTN517N1V5neEqZXnFm3joW8xLajIcm+NXE6WPm5C1nmqPrK9JJSVjDeVZ5cUR5f8jz7SHj+J0czy2AOGpwO09x6VxRYYI9jydeAP2E71v8ds439EjgbEfslnLqArv80aH8j8eV9T/W2bt2ah2B+Ewviv6ZVsl+l9QVKwbwTgmZFMqXILDvv7SnT+8rOr5Tt+7B1RRhvC0XfMnJZW6qSgnniNLBeIRIxM6P+WKmGSn8K5VTJRjZyKY0itWf+SPDBCz46H6YTetPENmyB9dYvYy6gPVrr7xybW4/Wsd8zGVivEJ/mbP3UBfRXJI4qTDGR2x2sX/4OJoa4g/VQ+l2/0IvJuv1qbhl5PlZ628rokjK+BtP7ML1nwrfh1IRvWR5ufunGlzjNiI1OIkJYt46KQ5xSlkqvgsGW5/kXwuE3wuyJ4I+ApawWhiXr2E0SlfAZFjM8diCiaO4qlql/whnP1s9iQI8jaWMsmP8N7UKVqGCPvZNEJ6wUwmEkbapUVzzTO8r+O8rObWF0SehvZZRDUxGD4GMWk0icZnR92sIWAvUGQp5Db6AMtzzja55HH8F3v3P4jx2Lh4I/5AWL8cTmUUwYHUXS17FW7e8w69gG66fPOIMllVMT0H/YunV9D7ZmWHlkhPXEr2BZ+d9iXuy3aVXsiU6I3tgZZH0lH0Cxo/Que4Y3lZ17sPcObF2H/th2lmdZ8GE/c9dOImHE0ba8gLyCYgjFGFwPVBRXKEdDZfFIWD4T/LHtWtcmOcxtnpgQxqRwFD76tK3cMfAdlqmbdexa3/eHYtVpKcOfmoD+0yjYAdjFxA33gfcxAdwd7Clrh1Ri74gQjH3YXCg5FNvK4IZndEOZ3oLpDWFyFUb7Qn9iwdw5ObeWTYkLRjiVs1yo+jaz7lCKEkZ7ytPP4OmnysEXMP/K4R+FzW3OHoBTUO+CGLxjCzd6l/wBm1n/E9Zbf8YZWcd6SgN6vMmr4GvFFRVWSr+DrTf9G2yhym1sVK3EAn66Kjoh9ANdKLMXE2Vw3bP1vmf7PuzeFrYuC72xkJXBJIbk+pY4P8SRTADnHFVPyfeV/lgZX/L095VsCm4gPEdhqdRqmpH0UNslGa39d9zcdgML9LHv7rDtbYuuX+zL6DSg//iGtNWISB9XbGECt1tYRv4upmC/H/48qUs6IQZjB2TgSqUYQG9iO8snD2DrXWF6C7YuC8MtoSjb+mJyfEucV5wDnD245j3IK7GOYQ5FD6pSORh4jr8W5k+E5VFYy6prKUnKTTZEOy0FQ6z8nmG99FgV/ghb8vIdlq1/L7CfFhX8Kc3QV69tG1tx+itM9HYfG0+7hKkVUzDvhPXM2gGlkm0pw+uenXvK1m2Y3BTGVxz9baEaEnaWp2CeOP/EpFtCHT4vHaMdyAtlOIbxtufpFeXJh/DkT47mc0fdKNJYxi6QAnpnlFg1OMdMyu4Avw8fv8PK8I+6fpE/xsYC+kv2lYOdwQ57KqqwgH0H+CtM+PYOlqXvhv+fIkJnOMtCJFfcAPKp0rusbD9Q9n+lbN81t7feyFFU7TaqVF5PXAhO+CeYVqQ3gLKn9EZKNRXKbU82AEVRVVvHeqzownrrSSTaFUIrlNvDgvsWbQm+weLmASaWq3lBDa//NLL743IJWWbf9B8PNvLiT1OG7jBRQhwliDvL36dddRrX4UF6hN0wYbZc1cxh3FApdzz9fRheVcbXYes2bN8WRpeF3tBRFILLaI01EpvnxcskBYnN40xf4rLwcOsEyRyZmNlSf+p5/gUcfSvMHgr1M0GPgmhOgmgusSHWL5gBVg2OlrFDLKH8E7Zr/Qustz7v+kVHTlNAH9CWOP4ay8rvY84+W9ibWXT9Ii8ua3vLXU8p9z3DO56tO8ruXWH7Ogx3hWrsKPoSn0xPiIUSHZDe/O5R00iL2ohbWTrcVClzZTBRJteVRx/Ddx8q8rFw/LljWYd1rImO6WExKAb3O1j5/b/RtnyfYXPrnfNWA/orlNlzLOOe0K65ewcL5r8Jvx+Gv5dO7s4IWULWU/I+VHvK8I4yfge278DebZheFqqBhCykHUdLZfYu0HZbWKwGStubFZeupY2zVobPcrtO8lIpR55qqrg+UJp1bFEqsxIWj6COM+s+9da7IcfK7wOsDbyDxaR4YY2w0bZHmHXsAucaVCFvw+umRHNdZ+h9Tlq3PqC1br1G27dIbJRwrsYbkDrISqXaV8Y3PeObyuSOmPDtsjDctmCeFdL6sJOSw26wg6cKvlZ86McKZjcqudh4oYO4/CaxeSSU4Atn2qGtayaaG0zh2a7n2R48/1Q4/Mwx/w78Qky3ErWlKbBvGIfFK4fVWxxWfv8jNrf+IfAZ8DXa3f7cLgJ6LFPEUsZ7mPDtV+HX17FAnrLyzojWrdH0olTKbWV0x7P7F56d+zC9Jox2HL2hWE/dASopPnSNKuoVXyvNApoFaCiTuAxcGB10eRQrpmts05yoWqkjz5XhFKqBMtxWhrtKtavkEzUvjnk4RlGHki6yDimw1vAEm1e/GX4/Dv+vRvVbZrMF/b6VKZ3DbK3fPm8koOs/r5XWl7Sj+CfPuzjvN8DG0S5jwrdfY8H8PqZi397IT574PlG4JhlIqWQDKMZKtaUMr8DWA2X3XZjeEkY7Qn8g5IUF8SR66xINwkNFa6VZKn4J9Rz8EtRL2zZZWuaeFUHcmGlokaTA3gUiVjXJCptRz0uQUpAS8gwyVcrKc/itsHgOyyPBzwSWds0l69hNsr7kpcLK7TGGllhsGyPyCf3+N1hv/Rh/MprrP43bIsva/5F/fP1S/CYz9Khiv4wZw/wl1i+/jW272SX5sHdMbAsV4MZKeUkZX1e2byvbN2F8TRhddvTCdjSXpZnyTlnTKaj3+KWnnkF9LCGYCxpmm8EqLk2uuJmSV568D3kvZuuOVaM9Hc/No9iu9Rz6I4dzSlXCYKw8vep58gk8/thx8CUsH4E2AjVoUsF3iGB99ftYhn4Fi2d/wPat/x4ba9uYCv61Avqq0b/uXnjy3Iqz5VX4gfewHvnfAv8pvBFRZFCSHjU7RCxjkxzyiVJdVQa3le17yuV3YOcmDLaEonLWKw+dk5SZd4i3crpvPL72NHNleSQsD6FZCL4Ra4OoXVciijhweeitB2uyTEOm7mgFjYnNsba9TUQoK9vcVvU8/S2lf0kptkF7HgphljuWGTQHtuAlzax3SWwdTzFh9xUsOc2wYJ5jo23HWP26XSm5HjeljaevI5p7cxn6yq31xO9zbOTsEtZviLPlH4TPV7CsPTm+bZxwwNZny/OJ0tv3DK4qo5swvgXTmzaSNtqFor8mzEkK9m4QAOuTa4OV1xdKvYBmLtQzsWC+DIH8hK5BwvGW9veNkleQlR5XWrbuXFz4TQoUmyZ0PzJnojlXCJI7EMXlQn8Mz3c9h59j1rEPHfWBoMugeXHt90lsglg8H9BayMam8wQTzcWZ9YfAAULzve/whnh7JXfTAY4x0UC0b/0LLKiv7yxPZ95pwFVK/7Jn+p5n676ydUuYXhUG20I1tO1oFsglldk7xZ6ktFHqhaeeKfWx0MyEZuEs8/axzC7tuNoKQb2jWdoDgV8oTaXkfU/uIa8cUrrwNena3DjaZm4gZJmj11eyy7ZrfbKvPL6iPNpTnn5kB9fPM5rl2vdIh60jciyI51jGHsvv/wL8W/jzBnOZe2sv4GfxktnyaN1a4lYqwPVg/itsHK0i0QHr/uuZWbfmBWQV9HaU6X1l5wNl+z5sXYXRtvXK5UXlTQrmm0eD8C0E82apIZhjffOZZeXWVH3Z97LeetNY6d2HrF2DQl7VRHOrtnpSw2+WtZFREXuYzgqlGkI1VrIhuL6NkmZeyfDMHwvNAnxtZfhVZTcdtg3isBJ8hVWm9zBdmMNibS98fI0F9TkW4E/cUF9nZv1NZ+gOy7zjZrQ4W34Xy9T3ScG8O1b9bhdU7BOlv6tMriqTGzC9A5PbjtFlGAThW5ZLuNmTAvmmWQnU1P5rlHqhNPO2xN7MQ3m9cavqySvdw0MGb/Pq0MxcGHcDv1SySslLG3OTTNZeUGKjSPQQEMigGjomqmSZ0uvBcAjP9j3PPoXnXzqOH4EeAo0Ee7q1MnxiQ8QEaIQlsB7L3K9hcfDD8PE58EZdZt5UQM+wzHyIzZH/FfAP2KrTG9iTShS+JboiZlyup7gtW6gyuatces+zexdGlxz9iaMcmNoWBN+ZR0JiZfCjijbesvJjZXFECOQObVwQRv1Qef0nWNvTqV6sF9+AX3r8wpMtFR1AYebjrWAusVnWBHO26AV6I6EooT9ShjsNw6tKuQfaA++EhXPooS16SQ/hXTPGktpLWGy8gYnoKkw057FM3XNiiO2X8ZMB/RWsW2OJYYyp1a9iKvbfYGNptzHF37Cb9/Kis2b9KRm4vlKMlHJH6V2G4Q1l666y+0DYug6Die0sdyEjSwr2LlETsDXBJGYJzRyWx2J2oGsq9tcurWrou/v4uR11Q620azPrHnGSrGM7RETIC+yjtLHDvK9IDohS9OHoK8/8obB8Cs2hnStpZr0LBEt0C0w0V2HxsiTsnQb+DHwDPAGOsF3r7ea2H4jBP1WGf90MvcAC+Q0sG/817ZrTuFSl1/GbekGJ54QPBhQ5FFvK4JZZt27dhumNYN26J/TGQfiW1M2dEpNg79VG0Ra66pE386Bgr+0Gjb75u7Oq4GuzhYqiubwHec+T9SArnM2sp/Okc1wmlH0ruzlRqj5MLiuPP1WefAKHnwuzLxz+UdjclrVVukQXjLDJrhITzd3EZtX/FRPPfYWNuNW/9B/4XkB/SVa+/ojXw7Lv25jw7TfA32H98qj0S/atnRHL6+EiLibK8Loyfdez/UDZvSNsX7FAnhUO5ySNo50CTJRmbm7NXKln3rLyI1Oxq49TBmvX1Zu4xFbzpqaZ8EurDPjgLBdfF2qz0JJJ6s12xHrlLHOOqm8LXfpTZbhvFbhsBK4Hooo0aqNtTTKC6paofo+bRW9gpfjowZJjSfIT2kz9ewfrp0RzPzdDV9pAfhXLxO9jWfl72FKVfdJClY7wq1YbZDaKVo6V/rbtLJ/cVaYPbKnK9JIEo5iTmVYK5l0QjCb8Wnl9oTRzaObOsvOlw9drD9Rv+TlZ1URVfnU+tKK5vPJWhs8Fyfn+FERiY4iDzJnmJSvB5Q4VxeVKNYBnA+X51HP0pTB7ZPaxupQ2NUuHboOsW8dGNTyY0n2IZe8fYUtevgEeY2Y0r8zPDejRKOZdrEf+HhbQo0F9lOgnOiUDqZRsqgxuenYeKDv3lMkNYXzJ0d8KCvaMdl45BfJu8R5f2yja8pgQzC2QaxNGkTYtSpOggm8EnQUP+IXHL5Ss523vvTjr39oXdP0uXjh0pZ+wIJ2XwnhHKXswnCqjPc/TK57HfxQe/85RLx2NV/Dpmu+eEsvQe5gC/i7w2/DxH1gwf/xzvmH+CiX2LPzDfaxccAtTsf8tFthvYcG86PrduZiszZZLCVlhc6rZ1Cwjt+4pe79Sdu7BeE/ojxxFZeX1NIrWMXpyqUq9UJbHynJNxe4b1/EximI5woOFjc9Z2TeY3JTW2rGZ9WQdu3FW54c9pGdDoexbhl6OhWKsuMKqP4hn/kjwM/Bz0KjHCCNuiU2SYUnwCNOiTbByfFzTCjbaFmfWl7xQhtf/soW13DNAX5qhS/jmu1gW/gArr7+DqdmvYtvRUjDvBGV1s5UCsoFS7nn6l5TxNWy2/KYwvSmM9qE3chRFuPlq6qd1wqpXrfiQlfuFbUZr5kI9F8vOazN/WU2ydHmzXTtXfOMgrGT13ra5ZZWSV2rWsZmc3N6Wzq+NInHu3AllH1QEcY5MoKxgdEl59rly8LVw/B3UTxx6JFb1XbeOTWyYHpatx7b2FIuvf8LsYz+j7a3/KD8V0ONg/B4mfPsN8PdYVn4JG1UbkIJ5h8S95RnkfQvmw7ue6V1l/x7s3BSGu0I1dOSVbUdLs+UdEwKcb7RdqHIM9ZGjnkcF+5qK/TRkTbL+HCL4xq3tXFfyhYnmcoDS4XBptK0jVLH2DABCWTqyLShLZbjtGd9QHn6kuD8K9ISZKHUD3p+Sc+1C08eCeNzcdhcrvQ9pZ1OfATN+5Ek5/5E/69MuVYmZ+V9hffNb4R/Y5OrVBNAK16AN5AOlGEJvTxncUsb3Yfsu7N4SppeF3jDMlYv12JLorSt0VVHxjeKX0e0trDs9FpqlBfNTfWfVYBOLgDfDm1iutWBi5V2Xe8vWHaf75znHiGDLdnKbWS+HQjFUpBDIoegph33Pcd8xfwT1QTuzvnqIS4dug2S0JfcxVoIvsfJJjrnLfYkteXkOzKDx64vVs//X//N7TqwDTE7/AZaV/ydsHO192qeHFMw7Yc3j2RMWqlzyTB94dn7t2f817L8j7NwURnuO3tCFuWFJ12WXiIJYFtssPfWxpz62Vaf1saOeu1VmftbuoIqsvOG1DtWfKM5waxvAkstcJ8haYHYZuMw0NL0R9CZCMVJcX1FRmplQH4KPKvjk+NsRcYQt+r9vYdNj2+H3gvXTj+Hk5rY4Jx7dBnpY0H4P+Gtsmcr7WJYeFeypydIZGTgHZEpWQjlVRreUnb/w7LwLW9eE8Y5QjdZ6mZramJ2ituwErzR1mCs/UuqZa1XsZ1ZxLKGvLquqQ1MrvlEKD+ARHC7cZpJ17ObRNcGcqJAXynBL6A2VwbbS21GKbSXrKboU/FyoD628uxLNnslz8zxQ0QbyG1gZfoJl8BmW1n0Hsogil5xWwR6/6C6Wnb+HCd9uYgq8RBdo2JokWVioMlTKKfS2ldEVZXoXdt4VprdguCP0B+b4horNEKeLsSN0tRnNPNJtrnw5s1Wnq355YzfOM13e9JapewUWznyu1JTwvraHz6wIc+vu7FUhzg1iM+sSSvAuBzLT1uQChVP6Y8/ht8LsqbI8NDW8Lk2cmewGNkl8s+MG0x7tCr0eFth3gT+DfokJ5mY5VkLfxgJ4LK1H69ZtLDNPdEYMyhm4sVJeNmHL7l3Yvg2TK8Jgz9GbCkXPepZWuiUF8y5Yc9tbLVSZYWtO54JfWHndN+1xOtPBPLx2idvbGvALxzJk7NlcyXuK9s133IJ68h/tivWMPcthMM7IM6XXU0bbnmc3lUcfwcOPhMMvHMtHpoCPLnOpyNIVgsXjd7AS/HVa0dx/x6xjNQ9/uI/tK/97LKDvYb30tB2tM4Ko0ZXgSqWYKOUVE75t31X234Gd28JwC/LKkeXSTgqlQN4ZNtOrQcWu1HOlPhaWh0K9sD6zqrx569auWZ179jNKY4I5X5tQzspMkHlwubbb287Dz37GiPcHEdvalhdC2ff0pkJv1+NG4AtwpWdWOZYPw5KXZTA4SnvWOyLuU4/Z+S5WXY9LXQY58H/HZt4eYCX2y5iKPfXKN05cl7k2W16MPP2ryuCaMr6pTG7B5LowvSoMd8zxzTmSD3uXCKy2o9Weplaaxdpc+QyaGMyj8O083xTVSvC2o91TE0ryNWQVZJUnK8AVbqX1SJ4IHSCtaK6owt77zO77eQnDHXj+mefgczj6Uph/66if2aIXSYteOqSHtcEdFsifYcn3oxz4f4S/sIcF8x4pmHfECz2qrFJ6l5Tpe56td5WdW8L0ijDcFrPdLIJ6XSUF8i4Jb76V2D31TKmPYTlzNHNna079ms3u2qdzyfqiF+9oljaqF2fW89pbCR4QnOl7Ui138+gLJXjn6PUhv6L0x8rkkvLosvJwR3EDZ5WnmeCjq1w6ZB1SYIn4DWwufQwc5JgALs6ej0hGMRsmXlDBZVcKJS9tRrS3A5P7yvb7yvYD2LoK423LykVC6TbRISErjyX22C9fX3caZssvarxSXevBNoR52TC07m2UzxXgnJpg7swLCs4ukgm5izPrUAwU6YGUpo7PUYrcM3ss1DNolkAtJ5Xw6dBtCMFU8NFRLgeOc9rUPc69JTaJKnaTy03F7iZKf1+ZXlemN5XpbWFy0zG8JPQnQl69YNaRMvPNsmbdqqqo92bbOtNg22pB3C/DXvH00GWoGZY0NXDsLGNfQr7wZJUJ5rKwltWEhel96wIJA+iZQDVwTPYhL5TBUBlNladXPE8/Fp59Jsy+czRHitRJBd8dBdYiXwC9mJlDOhLdIA4kB9dT3JZSXVImd5T9Dzx792F8SehPnJXYw81ufR9yYsNEnYMqvvGWlR8ry0PzY18tVPGyJj7q+kWfAkLmrV5oFtEtz96/vA61XxEynBnSkARzG+fEfgfzsuiPoKqU/kgZ7DT0Lyv5lqK5Q8WzfOzQY0Wjw1yiA6IBjQ0idv1qLha6lpVnkPWVYqpUu0r/sjK8Dlu3ld37wvQ6DCZCEZZeQNqQ1gnrWfmagr2J1q0zsRL7Is6Vn3PR2+vgwzORRs/69sFHPfhKcTm4vEEy1yrh0zm/cVx0+cvF2iKV4MpgKeugGitHX3lm38HiqVAfCH4mKyvgtOhlE8RZ9ZwwtpbYON76iS6HYqoM7jRM7ihbt4XtG8L4stDfFnojIS9axzcg3dg6RDUsVFnE2XIx29Yl7VKV1Ev8adaCs2poS2Cjbc3cHMvyvpL3QqqRgnpnrBIPQJxQVRmyreSZieam15RHnyiP/wwHnwr6hUPnJppLwbwTUkDfKEH45sIK02KsDG8qk3eV7QfK7h3YvmK98iy3jVVptrxjQnmd4HpWL3SlYq+PrWfuvaSe789hXQWvQrNUfC00S0/eEOY2Qb0nK83JLM2sd8OqbQRkudAbCGXl6U9hsKPkYxPOZSVkKDOU+nk0TiI9hG0MJWXom8C329FwJnwrp8pgTxlds3755J4wuSFMgvCt6MVxNPsWKZh3hYas3EaumrW95c1caBZhJE0vwCja20TFHppUaATARHP5EnxlQT0rzGWOKAhN18TGkbDh0YUSPOLwKFkBg5HybKI83204/EI4+kZYPrMW1Eorl0Rzb5sU0N86MbHIgUrJp8rghmf3PWXngTK9IYz3Hf1g3epyTFDV9eu+8OhK+FbPlOWxth7sy3a2nCTeekNYu8JaF9AslWbhyZeevAf0rSnr0gqwzlglFuEBtiiFyS70BspoWxntex5fVh7/XvA4m/Y4VuTMLh86c6SA/lbQ1vdYCltzmo+UYgq9fVuosveBsnMfxntCf2TCNyQZxHROHEdrohlK8GE/elHFToopbxwL5toAjaBeg3guGPeoLXqJK1njiFVi80jwgs8LKPtQ9CEfCNlAcU6hUfLSM38s1EfQzGzXOtE61r5J4s2SAvobZ826lRyygVLuewZXlMkN2LoBkxswueYY7GE7y8u4hYpkgdkFJ1TsftUrb2a0s+ULF3zJU7bxVlkTf2rjaOaYAU0DzQLynpJXFtjJXSjlJk+GLpBoHStCUcFgy+EcFBn0R/D0mvL0M+XZF3D8raCPHf4wBHWXnsXeAimgv3FCn0kyC+bVvjK4q0zvKvv3Ye8WDHeFcuDIwziaKGanmOiGMArofeiXzz31MSwOhWYOvnZBwS4pu3jbrL2vtifeUXtW0wW+ttFBQjvdZW71MJzYLLpmHSsilJWQbwtVXxnuekbXlHJfYSRIiQnmPDSzdLzeEimgvzZ64hNkSt6HMji+DW8q43vK9Dbs3BQml6E3EpwL42gk0Vt36CqQa40tVZnrara8mbXWrSmCd4OG/mvjTxqXqIad3qXicm8Pxg5L+9L1tHHEgRPIMiErIe8LWQXqbDy3N1AORp7jL4TZQxPMNesz6+kSexOkgP5GiEFdbCSt3PVM7yvTe8pW2I422hf6U6Hsg3OS6k1ds9pOZ45l9cxmy03BHgQ9azvLEx2xPuLWCM3CMvRmCU2l5L1gHVsJrnBtXz0F9c2y9n6L2Nhtb6Ts3FB6Q2Wypzy5rDz5WHn2ofD8I2uneG/bIlc+A+lyex1SQH9twhpBV9iSiWKqjG8rOx94dt6DrevCZEeoRtHtre33pXtOR2hYqrIWzJdHwSxm7vALlwL5qcMEo1oLvlGkVjSU32PmnqE2s56sYzthvdLoRCgqoSjNNrY/9ZRTTz5WXO7Qpanfl4dq11qaW38TpID+S1ideM62o2UjpdyCwZ4yvmrl9a37wuQmDHccvYGQlxbM1acSeycIawtVbDPayrp1HsRvC1uqEh3f0uKvU4iy0jI0Yc2z2fFCvjSxXFYqLo8trXQAO0GsBC/O5tYH4kL5XSly6FXKs92Gg6+Fo0fC4pmgx8AyLHpJu9Z/CSmgvw4uh2yslJeV8U1l956ydxfGV4XBjqMa21OquLZ0m4J5RwQBj/q1hSpHwYN96Vrr1mh1mW4mp5NV4i2mfJ9nYbzQ08zNNrbwtr3N5S6NtnVFrECGh+Msh8E4o8iV/kAZ7XrGN5Xv/iTwJ8F/IdSPHHqQ7pGvQQror8zabLkrIavCUpXLyuCWMr2j7D+A3dsw2IaiCvatclINmtg8GkvsjccvMfvWY1iG2fJ2oUq68Z8lVGW1Y10b+7WuXWiuCItesjSz3hUrFbwTygqKQij6nnIslBOFygxLs54y6yvLh1AfgJ/H45kqZT+DFNBfyvomqMZWnZZDz+Ba8GG/pUxuCpNrpmAfbAtlP4yjrQs9UkDfKBK8c9WD1j44j4Wd5TNHvTCjC23WVOxJlHP2CL7KvnGhF2YlW79UsqqdWXeF2IibSPJ66IDY/ZAMchFE7FiIKGUfxvvw7FPP88/g8Ath/rWjfhoe2LJUgn9FUkB/KfFEDCsDs77Sv6RM3vVsv6fs3Iatq8JwO1i3Zu12tJSVd4d5g4NvPE0Uvq0WqrTWrXaIkhf7mWVNBe+9QxesVttmC0UbbyNuOAQNK9zSgd4062ufBSHLhGqo5IUy2FLGl5T+nu1ad5WD2nasN7O0ue1nkAL6DxJPPoc9HZa2zrEYKv1dW6iy9QFs3YPpNWG8LVQDC+QnzEcSHaDW4gg7y/1STfQ2C3vL563wLZXyzhkalPDNamFbsFNWOx8qWyQimYbRUUgnQDe4DCQT8tJsY7MSKBQphCJXykw5GHhmj1qDJ60FWTfgSofuRVJA/yFOPE0WihsrvcvK1i1l+44yvQnj68Jgz9GLwrd0czgFWFkk7tZezlr7Vr90NLWgtfXK0+E6z5i40S+FWmW1LS9fePLKBHNStcZO6UTYPK3hoq3HLfsw3c8oS2U4UkY7nmfX4PFHwtOPhePvBD0CfFDBpwGGHyIF9B9iZd3aU9xUqS4pk9vK3gee/XdgfMnRnziKnlsJbjRZt3aK7SyPpiMWzJeHtlilWQrauGTdelEIT2vamMOcVWrMo1+b8LQuQQWflrx0wwmHTSHPhWysVD2hN/b0d5TenkcGghcHGSwfC3qsJphLM+s/RArowNpIk/VrsoFSbCu9PWVwRRldh+kt2L4jTK+Z41tR2pNlGG9O/fJNc2KhiuKbF2bLZ2LOb0vLylMwv4CE2K0qeFrho61ptUmV1cx6ZkKt9rzq+sVfLMSZg2YWSvGShwcuoChhsKscfuk5+gYWj4X6meCjdaxLffZACugnUMvMi6kyuOWZ3FV27sL2TWF8CfpTRzkU8mJN+EYK5l2iqmFxh7c++XGcLW8V7JoC+cXkhUUvfpm1pkJzJe8pxUDJepCRIZmmTL0jVLHgjI24Vb0Mt6MUhTLcUaY3lId/Vh59BM8/caCwXEiqjJ4kBXQEyCDLbWa1nMDgpjJ5V9l6oOzeFravwWAiZIU7YSmZAnlHrFu3hv5oM2OlYq/nVmI30g06QSuY86C1ZejtnnX7dVaYdayt9kznzaZZ39yW5eAyoex5ehOoJor0gBKyQjl0cJwp9fPYUiNVVS5sQNd2ZFUzxZWQbymjK8r4hjK5BZM7Nls+2hP6EyGv1ubKScG8O7QN5HOlXsSFKmbd2oTZ8jifnOJ54iShYtNAs3CAWvl9AXnlg3WslXxxa/4Eic0RLlsRIG7Rw6EoRQ+GU3i2ozzbbzj4VDj6Ulg8FaiFVdfkYormLmhAjzvLc+yJb6IMrnu2P/DsvQfTG8J4z9GfBAV7xuoJP9EhqqsSu82Vq82VL0zF7ut4jFIgT/wUZi7jw0a9ZqFkS49fevK+/X/EmVN8GofYPOuLq9Qic1Ep0z2lP4LRtme47+ntQzYwUyG/BD8Lf//i3qcvUEAPYhgRkAJcX8lHSrml9C/B9Dbsvg/b92C8LwyGcRxNkuita6LwzVs21SxMvb48tvlUv3TmFBb7aen+m3gZ6yV4TwgE0acZvLeZdZeDOEXcxUz5TgMituAlLyCvQgWlJ7hSzSpEledDOH4Ey0Nojs06lrq951+QQ3dxAno0nCC3YF5c9gyv2kz59i2YXIfxFcdgR6iGQlaYPVyK4x1xQsXuaWq/CuT1LJTXo4K9SQr2xC/DHIKDdezc7hFNrWRzyHuWsdumRBfsR9v1x4nNogjilKJyDKdC5pSyUAZTeHbT8/gT4clnwuwbQR9bBQYP6i6M1vGCBPRQYne5jaSVl5TBbWV6zxaq7N2G0Z5Q9h1Z0fqwJwVlh2grVvLBh315TNiQBr52YZNTCuaJX8gLKvhGs7Br3dMs1BKAMPuWFZgXvEvtnC5ozb4EJ1D1hDxXegNluOcZXIFsS9G+4kphLo4l4GdywijsnHNOA/qacE3VrB7zAVQ75sM+vKmM74TZ8hvC+LLQH4VAHq7WtMChI0RtuYZvrVtN/BbmymeCX7h2oUoi8abwoMG+WdcW9fgmlnoVlzc2t+7Cgod0j9g40QzIOSErIKsEya1jkpUwGMPB1HP0hTD7Vlg8EZojO6atkVDXP8Vb4ZwG9EhUpedQbHsm73i23lG2bptBzHDP0R8LRT+OqayV2NOF2g0KqmFn+SzMls8czVzwteCbJE5MvCXWFr3QCH6hLBpb8tL0lLzXkPeEnDDCKvYAkO4VmyWuVLVnLiHLHP2Rkt1QBmOYXFKeXPY8+Rie/sHha0czA+rzGcXXOGcBPT5VBwV7ViiugGKsjG8r2+8pux/A1nUY7wr9oeDytce1dGF2hoZyiobVl6vtaLMwlrbKyhOJt00QzNUmrPK1x/s1F6nw2eWsNjFelCbtaWH9od45EzAXldIbKdVYyUeQDUBEoTZ/gfrQqi1aB0Oa89dSPT8BfXWAnG1Hc2Ol2lGG+zC5ZrPlW/eE8XVbddobiKklRYJJSdc/wQUkPGar+jUHL6jnFsTrueAX2FKV4PiWpogSGyOOTzXW5lliAcEmLcKu9coU2Fbhc23qmNgcwTIgluH7E4eK9dirEgYj5dkV5dmXwtG3wuIp7aIXPVe71s9PQF9dTyVkY6W4rIxuKnvvKHv3YXpV6G85qpEjL82FaLViMdENapm5et9m5YeyUrH7Jti3ql1tKQlKbJSV/i2ci3NBa8UvPFlpGo8CIUfNd1zWGu+JzbEqmth7n+UwnAhlCf2RZ3TJM7yhFH8Q9PeCZkItDj0018BzxBkP6GuOb6404VsxtVWng5thQ9p92L0Nwx0oKiGLCvbw9YkuCNatq6UqlvHUwb61mWMmMUn4ljgtKGgjNB58I/j1qp4HVygu9yasjeliohOyzKxj8wKKnlCMhGwAZPbxfKgcf+VZPBSWzwV/LPiauITvLN9yzmhAjyp2b+UvcZD1lf4Nz/i2ldent4TJVWG0L/S37MBmmZzhY3UOEJMdqgdtPM1Sqeca+uSOZhHcu1IwT5xGwtiUemcVpaD5aBa26CXvKVkpuEJsxC36WKTEoRPEQVYI1cDBnpI5pT+GZ1fgyaeeZ58Kh58J8y8dzdOwuS0/0229MxrQQ8/DZTaSlvWgf0mZPlC23/fs3BW2r1qvPK/iXHm7HS3REV7NcrOx7WjLmYYNaY56tl5eP5tXU+Kcs6aCV28qeOun+7DsxaOq5JhHvFs3oklsjPW5cwm71t1IqSpluGVz6+W2ko1Cq2Sp0JjrZPtNuv4pfhFnKKBH+9XYK6+UvK9UE9uVO76tbL0H03uO6VVhtC1UA8HFudLwPRJdYB7stuXKTGLqOdRzCSI4wdfO9tEnH/bEWSDsWccrXoUmpHW2zU1t13qhttd7ZUaTTuyNEwRzzgkE61jJHZrZ8akqpdfzHGwpx98J86dCfQwE98mVLOJsHLqzFdBRTqrYLyvbdzw792DrJoyvCYNdRzWCogwGMSmYd0wYR2uUeqHUx9qOosXyerx4UjBPnCXWgnizDFl7eGDNF568B3lPkFKQ7OxEhXOFrjolCLaNrewLW5eUXl8ZTpXRvvL0mufRHxxPPxSa7wQNQf2MyRzPQEAP76jkZt3q+ko+Ucp9ZXzL5sr331EmV4T+2FH2nO00Dl+b4nhHKCi2VEUbbVXsR2G2fGE7y0/Mlp+hKyeRaLF93E0j+EbR2qONrvatQ7vkJe1a74hVLAhLXgqh6ivV0FNNlXIC5B5Vhytg+bRd8qIN1l8//dH9FAf06OXdhPnCkVJE69Zryvg6TG7AVhC/9adCUQpZFkZB04a0zbO+UEWjgl3DXHkosc9CNtME4VvyYU+cB6JQtxEaBCW0+jw0S8gqJa/MNpYgmGuvl65f/MVCJFjAOqESOx4u8ziB3gCeXlGef6Ecfi3MHwnNU1PCo7YT5BTfq05xQF9rO0kBxUQZ3PJM7pvobfcWjC8JvYlQ9Ez4ILGHlcwduiE8wcad5c3CrFttoYqE/dMSVleGq+L0XhyJxKvzwqIXv8xWZklubnof9UreEzKwoJ5O/k5QxXz7FZxzVD0l2xGqnjLeV8Y3lO8+BPehIh875o2wXJ6JmfVTFtBjQCBsRyuUvIJyogxuKON3la37sHMbtq8Kg2nwVI7RX9e+T2LDrM2WrwvfZlAfm+ubNi783XQjS5xj1nat+xpc2Nq2mrRp1ObWM7vPSRLMbZxYvRUHuROyXCj6nmoM+QAoFCmhqJTD0jPrCYtnVmH0ddT8BE7PoTtFAX3NJEYzIFfyLWV03TO9pUxuw/S2MLoqDHeE3ljICxM5rMpdXf8MFxFbKL0K5PXctqNF69ZmYZn5qrye+oeJC0MM4OazsJpZr5SsasirYD+di43iIukm1hEi5h6aVzDYsj+oBspoG57teZ59As//7Dj4XGieYip4d+qC+ikK6EH4JrmNpGVjZXDNs/0rz/77ytZNYbTn6E+EvBSb8Qw9qkR3qDexgm889VxZHin1cVSxOxO+xQmF03HSJxIbxNpLzdJm1v1S8cuGvI6iOWvorjTw6YF3s5wQTlvbtuwpeQH9kTLc9vT3lHIHpPDhngZ+DhLjz+l5COs4oJ+wbgU3UIqJUm0rg0vK5Kay866wfS84vo2EsjRrxbRQpSNWC1VaBXtTK35xsrzul8765X7t6xLdkMRX3aKAigmlFSwd96uyfN4oWRGU8JmadWy6YDpBxJbt5CW286MQpDAr2UyhyJTn23D8CObPlPpI0Jmgy/brOzx03Qb0eEJLBtJXikue4XVl65aycxum12F0SehvC+XAhG+r1YadvvILyupEDQtVaiuv25rTtfJ6E2fLk/Ctc+SFX6cLpzNCd8pMlFRWUyDNHPK+J+9DVglO1lTw6XhtnJVviUBROoZbtrmt11NGe8rTz5SHfxaefALHXzuaR6DLkLxkr/dvvybdBnSXg1Tmw15dVvq3lcldZf++sndXGO8LZd+R5WbfCidt/RIbxreZua+VeuGpjwkb0uxGhV9TsEMK5l2hZrP7vZ3PIqmq2wVrzVarLor5M9S2aXDlgomaICtTG61KB2vzrEaeBZdB1RfyQqmGSn/HU+0pMlS0hKz0zDPHMgd/bDPrHVaONxjQo3Atltkd5AOlv6cMrtqq0/FtmNwUpteE8T70RqY+XB/vSGX2DhArifi4s3y1t1zaveXLtYUqqV/eHRKc+RTLAGv7tYRALpnY/u4kwuqOkJSoWBWrUeDY7m0+zKxnZUNWxGNluyjSvW/zxBJ6XogZm0UBo0DRh2c7cLDrOfxcOP5amD8U/FE7s77hEvwGA3ooH4mzSqwrlHJbGd/3bH/g2b4N02uO0Z5QDcNSlSh829yrTHwPDVoHyySWM5stb46Feu5W1q3xiZa1T4kOWJn6mEixXphwUcQ8xbNSEImjnunJqxPWZ9ZVoBHqeVj0MlfynqfoK/QAHFnhVi5nic2yeogK1tRZ7hiMlaKA0Zby7LLn8SXl8Q5I5fBzh5+bwVAH/fQNBPT1hSq54iooK6gmyuiGsv2+svs+TK8Lk12xrDx7oWyb6ARVteUTTTuSVh8H8dtc8Iu12fJ0uDrlpEjR0yyU5czGpLwPl2Cu5Evr3ZoIS3CZnnQtS2yY8DDcCE2j+IaVM1Z0u1SvwTo2ZnzpYG2UtYzSOcH1hKKnVEPIB4Lrg6sUh5I1ylEPFgfmEOiXAg3tLpK3e+jeckAPM5gnFqrsKqMrytYNmNxUpreF8TUTvlX9UGIXWTn5JDZMFOKoB3/SIKZZyMmlKv7MLS84V0ismHtFfUOzVJbHUaQI9cKmDdSHkruDrLSNU3lPKfrBuSyPQT0cyXTdbR4Fxe57zSKI5sL0iNnGqgnmChAJNd8kmts84W0XAUrbH4IoRaH0e8pwy2bWn34uHHwlLJ44W/SylFWF+i3eMN9yQI9LVQpwE6W8rIxuePbeVfbfgelVYbAllANHXtoNR306RzslZAQmfAvWrYewPJYTHuyxgpKShe7QOD7YeJqlZznzzA+E+fNotetQ79oLyoELayOLvtrDdii7u0zaDDCxeWKRRM0eWb2iteIXnmxpmXuBkotVVczUJB2sjRMmrOL9L8+F4QSqShmMPcNLDYOrSvY7wRcOMk/zxOEPN2Id+4YDehS+rc2W5yPrlfcvm33r5Bbs3BW2b8NoRyh74Waymm9+6z904kdoA3kQv4XZ8uWxZeZ+tVAllWg7I2we0mAh2kSb3XCcFofC8kgsy4u++fFLxW4qPipxJQixeqz2d7s8aFfS2FR3eMvWGyU8PEM8EOohK7zNR2etYC4dq25wGTajnps+JesJrgTEqinPp8rxV575d8LyqdAcCX7J28rW33yGrmtl9qyv9G94xnc909uwdVOYXBGGu0J/CkVlQp04rZHOxw6I9wLfZnr1nNArN/W6Zea0KvYUzDtDbCmt7ZefW1a+PLIgvpw5a4sso4NiqKLEL45l3ca2382DFemyB+XQUwwgrwQpnQV10jXZCau2l6DemRhV10VztuwlK8EVDgmLXtJSqm6IjtZZLlTDDMFK8MNteHpNefyJ8vQTOPzEMf/C0cxD+T1emG/ufvoGA3oQvjkXZssrpX9Vmd73bH+g7NyB7WvCaFvIK4c4cLI2W57oBq/4mO0tws7yGdRHYRytjiXbFMW7ZuUB0CjNwrM48iyOlMUhLI+ylV/4iWP1A4dNvdCEHm2zgGYZFuuoBitLE81JRrv4KLFZopxBQ1VsEZYeLW18VINoLg9lTcmSdWwXrPuiiJj5WTZWqr4y2FJ6O0o+UdwAnFNco4hAMwux781ax75mQF8vkQcP9nyo9LaV4T6MbynTBzC9K0wuC8MtoRrEhSopmHeLhv5ruKkvTs6WNwsL5jFApPtEB7y4X742D4B61pbYl2F8sFnE1bSvOPvqwSOIQj23vx93dzcLpeiZCCsrNJg6pROgM2K2bkMnNEFsZN7wkFXeZtYLM0KxDD8dr40j4ARwYlMkBag4cEpeKv0+PBt7Dj4VDr8RZo8FfwSsb297vUvtzWTo4oDSFqpUlz3b95XdB8rWLWF0WRjsOJstL+zvqyZDi24JwdyH8aYjK7E3C+u9RgU7mpyqOicI33xj++UXhzA/CLqGhbNlEbUEJXv4mlc5ZNIW5LUxD36/DKOJPaXuQzVSGAZDGveq3zjxVgh3e1VWD29+qfiFki2tDF8gYZohPYB1wouLXgSqgZBlSm+gjLaV0SXPk6vw8LeC/5Nj5gWdgazvvfjl/MKAHksMYWd5NoBiS6n2bbZ89z1l712YXoH+RCgrh8vWPHJTMO8GPVm29XUQvR1p8GLHtqP5dDPoHG33y68L3+YHyuLArHab+gUVO/yi+7h6C+q+EXwTMr+mddTQntk0u4xkR9o1YcOXHTPFN41V0XwQzWmw1Ha+FcwlNk9IhvISilIo+2o6lbGQD9tr66APyyfQHEEzA63D3Dr8kmv5Zwb0aHTQ2D+W9ZRiT+lf8YyuwfSmMrlhJjHjy0JvIhQhmCfhW0dE0ZuCqg+Z3gvl9fnJkbRWFt31i794SLhQvA8GMXNlOVMrrR8H4dscmjouwIlf+Br/aLguxYOv176nt/560VOKga72d7vMDDYgtcw6Iyjgfe2oiQ/p0Cwgryxjd7kp4e0pjHTz7QDB3v4st3Yz4nCi5Bn0p/DsM+Xp58rBV8L8W6F+AroItbPYPnl1fmZAX/OecAWUW8rgpmdy37NzD/buWK+8NzLhW1aYqCbNlndInJsM42jNwq9Eb8tjVsYjeDEFNKRA3iEa7MHMA8CzPPIsDiVk5baSVnXNavdNHKv1b6P2oFDPbXSxnkHdt4qO7e92UErb70tsnnXr2KCC18b0Fdlc8QMrg+aVKZUl0zSz3hGrBBhwzlH1QzAfeMb7ypNrSv4nkKEiuWPuhboJM+tvJUOPs+VBxZ6VSjHAdpZfU8YPlOk9YfsWbF014VteWA9n9VCYonkHtHOrsbxumbmszZaHWeV0sZ8CWg+AJownLY5pR9KCsY9diG9Xed5akbYz6yLtuVT0FF+quTrGBRTpHOoGjUp4oGk9QAQLJFmpuMKvsvWVdWy6J28c56yylWVQ9IRiYBNhmtkIYtVXDvue46+ExROhPlybWX81fcxLAvqail3FvNizqTK65ZneU6a3YHpTGF0RBttxO9oLDkbpxOkGabPyem7KaCuvu5XHcOqVd8zaE6+qp6mV+lhZHLU75k8q2DfsAxAChV8Ki0MbmarnSt33FH0o+kLREyQPi16SsrpDZGW1Xc9kNYaaV0rWU/IKssrZsYIU1Dsg2mTHh6q8guGW4JzSHyuTPXhyyfPsY3j6J8fhp3btE7aTrm3g/TFeEtCdyfClMC/2bKwMrypb7yl7v1a2b8J439EfO/Iy+EWnPnm3KCvjEQ0bt5ZHYanKXPDBQSz1Pk8B6za7wShmfqjMn7cqdhsd7Gglbci8fQPeS1idC01tD4oxc8gUG20TTSKsTgm2zB6zjV0qvm7IffAXkLCzLQt/Ox2rzfI9FbxQ9ZWyEgYTpb/lKbeVYgKIRxfCsWDb24Jw9SWi8vyH/9Egn5cK3FAppkpvVxldhvENZfs+bN0VRvtCfyQUpZUSNC1U6YaVs9Sa8chqZ7k9sTdz8/b2De14RLqeN8/abLkpypU6KNjrY1jE8vpC2tW0dOwXEip13kcb2bA8yYOvlbxnQqwomBO3VkVI94ONo6EMT02YN/SriYmssgU9WaGQRRV8uhF0QZwYEbHJBJwgmSPLlFyg6nmefyYcfQezp0J9IOhxG9h/wDr2RzJ0BTJwPaXY8wxueLbvwN49mF6D4b7QmzrKvvUDSMK3U4GV2JuVdWub5QXr1li2TddvZ4TFmHgfbHZnNlu+OBCWx8422TVrO+ZPw+FaW52uPvrEtyY3RV8px0qpQl4JDncyqCc2ymppnsqqwuPD6GNW2fFiAFkpkLmUqXeFsqYxE4rSMdqCIlcGQ8/4kvLkU+W7D+HJx8LxV47Gc3K65ST5iW8OVo7Jeko+hHJf6d9SJndg976yf1eYXLLtaFkWDQwgjaN1SJxXbkwZbQtVlOWRmFlMLaZgT/3NjgkLVYKwrFkGL/YjZX5gKva4AAdc1y/2+6xl3NoIjZfV+baaWQ/nYlaqaWmcvJprXeKtYSV4CZU7H/at60pjkxWKZP7kkpfE5liLnS4XygzyAqqhUG1ZdZwKKKCoPLPSsXwEzbHga16cWc/DZp92tjzvKb0rnuENZXwTxrdhcsOWqoz3hGpkM3Urj+e0IW3zrA31e6/4pd1YX7RuXc0qp6u0W0RX7ZB1v/zlTKiPXTD1WRe+cboPWejjqVgVoZ7ZjaCplXpO2LOu5KWYJWlwmUv3iQ5Y24AZHTprQoAPu9Zt056YEt7ZvT1NJ20eAZski25/zgGKc9Abw7N9ePap5+AzOP4iY/6d0MzD19oEQ27quSiezZRySxnfUbb/wrN9F7avO0a7NhSfFWJetZoOeKdoHEnzYVbYr7aj1TO38mBfzSonusUHL/alzZXPD8M42rGzlsjK9vGMZEgn5LZWzl0eCs3cJiqapVLUig4ECUvWRbpQ9SVOHCuVsKUPEzjOlbzvyRtzA8xxOHFWIEoVvY2jJwRvjjxXBhMoe8pwx2xje3tKMbUA7ucOXdrDmjgFyHFDxeUmaqkmMLqubH2g7LxrI2mTXRO+uUxWCwISXRHLttruwp4HBfuMVWZuWTnp/tkxcflN3I5Wz20z2uLQsvNmHh6+tGPR22v9kMGxjLU966gp84MQK69sZ7TL25GdRDdEsVwjUfwcy6z2+7yxeCCZJk/4DhEByQWXQ9GDsg9ZJUgZWlpA4ZSjrzyL5/Yg7Wty3K6nHMLokrJzy2bLJzeF0VVHf0so+1YyW5VhEptnTcWOX3PwmsVRNDMdWS1VSXRGHO+1h66GeulZHmEfx2JVlIXtmY/ilnNzxNT6evWxQxtW/vNFXymG9jnL5WRQTzeVbggeA83CmXhuqWQLaCpPXgl5D1wRKizn5ww9c8SVuC6H3sixLUpVwWAA4/2GZ582PPnUc/CVsjjwOYObnt4Edm4rlz+A7ZsSArkzxzeJYxBd/2gXmNWu6mgJCstQtm2WErZtrQnf0vXXGbGC4htTsS+PPfMDYf7cvNij6ni1cfA8HKv1KTUfHi7DWt5Ygl+N3lVhyUuWVvJ2xvqu9Vpah8KlJ1va+YuYZNoy9TSz3glrKnhRoSiFPDdHuf5YGewr/UseGXq08LgnPufKrxuqkTC9IWzfttnysic4Z/3yFMw7YiU4DGXbMHZiKnZaIdVq1WkK5p0RRIrtjdGO1XIGy2MXJg5CO8SHMuZ5CeY/RBBgNWFWfUF4fxoT3eY9yArb4S2OE9MyiQ0TphY07FxvRXR6ctd6nGqKSvh0rDZL0MhJbmp4l4OrHK4QVJWi55k98zk3/8aTl0J/yzHcyihKh5N2k1I6bh2wumbM7a1ZeOqZrTiNgeHErPJZEVOdW4KKvfGrUbTFESyPHPUszpaH/uVFWICzStdDWXcuzJsowlKKoW1vK1TISxd2rSc6Yf1YNY4mjB62ojml6HuySshyh2SpBN8Za8l1lgu9gUP2hAwYbnmWsyZn+xpBFCfkRbtqU9B2+1Zig+hKoe6bdswpOok1M1kJqdKF1TGxghKD+UJZHIaPmJXPg3XrBT1U0YrU1+AX0NTtexZ1IZm3Mrxtc7ygb9QpQFVsKY+3ZU4+HCv7fwql4opYgieJGzfMqlKutjfBiVBWgmxD2YOmJocmt+AhQuNM6pgVprAjzI+mNH1ThPGmRvGxvD6n3Vm+kNVIWsrKO2LNulWDfastv4HlsYbZ8rBUZRn75Stb9ItJsCL1AAtT+ftGLMCHmfWiZ85lEpwnU1m3Q7ygAn4JjbiVENdXaiX40gRz5t+/1u5LbIBw34kt2KXiF4I2GaJ5zuJ5bgvYSxPxFD3QgZCL2EwicHHvRJukzfSahVKHjVtNDAyr2fIUyDtlvccYSuzzQ2XxvF1J6+t2bzmSEpn2PbA2UTML63zn1koqBtZrLwHK4HGdTvLuiMdKCUkENEuLD/nSk/ehCOu/omlQYhO8IIw+Cls0Fw6/zPCN5vilGQlYGcxUcIqCB1d6XOYQF7YoXfg701tA29lyE1SZ49vyKArfQJsON24lWsKxMutWvxK+LQ6ExaEdL6uguHSsfgRV0DrMqDdhx4CG5p6Pgrkws74umEtsnqCBsA+32gyosVXS2LE6YR2bePPECafQCmkWYVfHUXjgWgq+ceBd8HJXCxrNIgYWmyE1RWpDXkrYzONI86NvgFhRjGXb2psyehZ3YMelKuGm50nvd5esqdibZRC+Hbdub/WckxMHiZejBN/6MD4VHMyKQRDM9SArHZm0QT1N23RE3LZXmyAuxoh8AXnP5tZdsR4jSPer12W9tec9Te3N2nsmZiK2cPiF4hu3vqwlb2cSvaCarVL6ZkHYeWx+dFnhcNE9KN2zXo+4s3z1XvuwUMVRH7HqvcbeI5De8w5Rb9dBs/QsZ57FkWd5KCwOTMXuwwV1QkSajtePs6as9o2sRqSsfBiWvSioesAFh7n0hnbCiYkFM6DR2jQ+fqFhlacnQ8jUwcphLvFaBBtYv1q6pWZOdWgJn9bW0lN1ayPL+sL61NCjjcpUCA9bDfjKLOdc7lfGECtbrMQrEj3Yg/AtzCs38+AgNpPW2zv1yk8BMSsPc+XBZnd5HDLzWTD2UbnYorfXIVjHmrse0R4e9VAsLamI+7tddJlLb3Q3hARDAYlVw+BVkteYaK7w5jCXrTkCphjxM1hbulXbg25curVyBl2uVwJPXAsvBPQfeBpbeCu/Zz0N5RUbccvEIZltXEoH7GegHl9rUEYrzcwU0T7OlocHqXTP6ohVubAtdS2PlfkBLI+jriELfSuLPinGvCZx4ZMSHpAI62Xto+gr5RBycRbUk0ChYyRoSQSdtYrrfGExIusJeeVsUir8/cQrINFT358YV45TTr5+IUZ8n/zHvrM9JdQCtYZv1FjpcfXNFBeuqzST+BK0FZLEk79VsUejGJcejE4BVl4n7I62i2p+oMyjin3hWpFiJJ36r89KBQ9NYyNTNgutYd+6PWllJeZaJpr2d3dKFMzZtj1f2+4C1Ti7rmS65i+Qxmx/Eg17OqKpj7VgY0B3+KV7FX1O/pJ/JfQFG8UvHTXYTGJj/2hWKlkpuCL2uJIgYsV6phey8pM7y9vySbs+k3TSd8BK5+nD2OBSqRehvD4TE7/NWuEbfi1HTMfrzRLdKb3QLMGywRDoF5hzWU/JS0IJ3rVV3XTf2TjRMlZrm1lft6rOKtvimRUCuYRaVvIYAL7nZ6GhBVuvYsRasrfa1fHSe07+0n9Uwi/MujKztZ0LH2wBoVAlE8wWMO08bomihrioY67m6X20ZhCzUrCnp9cusWBgYyH1sqE+9iwOhfmBoz4269aYjcRjlQ7XW+J7i17azW3LY6UcKDpWGEKGI8sVklC3M1YPwxpHNi2Yu1CC11phIGQIZM4Ecxc9mEPrZ6GgjccvleVMTfQ2E/zSrdl7hyj88nM8f+nfaF9AeEr24BuH937NFhC0MMGcZO7Cb+ex8kkI5ktPswwLVcIKTb+M27Yu7nt0OggeAI1VnZqFt4UqR4S95da7Wi1USWyWsDikaYDayvCtEEsp6uBeVoQNbqkE3ykmphak8WgTFPDhCU292ca6PM6sc4HbtPG+E1p7y/jASmjDxnHln33f+RkB3V4HsXfil446DLw3C8wQovLklQaVo0NELlYpLBjhawjk9SLMls/NQcxGAVOAOBVIXKiiNlc+05XobXmchb5Vu5Y2ldc7Yu3eoY0pfaODWR0Wh+R9KCohK93KuSzNrHfA6mHLFr2AjVppozRzm1nPKrP4dbll63F3yEVA1vwsNGxlrOetMLpZRCOxX7yV8WcG9B9QwUeRl6+VvLGbZKbOjPyz9S+6AISyrV966pmZj9iCDisd4l+YVU50Q3DmU6/UC5srXxyEhSozR7PM1jbZXeBE4jQg7S/M3MTU1XGVcLP0lI2COntIwwRz6aB1wNqxIpgFNb7VW/lGKXy75NtdsOMUFxJZzLQkIo7BNnN3cnvm997TV+JnBvQTr46V6s57oSYMkYZheG1iicV2q5/fFCeIGjzt3OBizdFn3q47hQt1/p4eTrguBQ+A1eggLI4kBHPBL6IP+zk+Zc8wURzUuie2v/e1uVtmheByTXakHaMaLH5Xgt9gwOQtRmSlD0te1i1+z+PxCll5E4L5Ulcz5c3spMvka95zXiOgx39YJdiXOupjG2HIFvYEkvcg7wlSmtFA+0XngBPzyjErN4/dlXXr2h7sc/JTn0niodIwjlYvvPXJD9qn42YZ5jy9rL4mHbRTyAtCXXPqs2zdRHNQjpS8L+Yzvt6rvSCl3VPF+jji3FnWvrQYkVe6ihFZIWbef+7QVSJhkzNrs+XhnqPBSOwN3HNeM6CvXkCcH5WVVZ1v7IeIf8UV4Skszo+edTztqtPG08yCNd9R6IPUgvdrs+Xn4Ec+k9h455rNrqlJFwcwfy4mUqxdeDBNs+VngjW76sZLWJYTWn+NxgET1EOWJ8HcaUA12JU2WHwIHxqr7gqSaSuoPgfHSjVm5iHhO4bloQmkm6W8DT+LNxDQV68+fGoEv/JvtJKLryEvlaxqcHkYX1g/aGflyfmFeWW/tO1odXDysScvwviGpGDeJesLVaKZz8q61a0EcK2NYvLMP3OsVtnKah46epH6mtWe9TgLLZm0pd2zcs85T4TVIIqYlkhdEKYKeWWi6qwAyZ21ac/asXqxtVdHe+9161ZWrqDoG48RbzCgr70gE8yFRS9Lxc2Vpq8U3i6yDCyon8W752pnuQ/WfGLCtxcMANKwcsfETXaNUseFKkdiC3BmjqaOqztJwoazyvphC8pqe6C2h7e8rzRDT9lA0XfkVRyX6vqFX1DWRdWNo9HWGa2ZK/nAU/QhQyHPcGc0U19VA+dhb/mxiW39ck3B/naWbr3BgH7iJ1oXqoBrsJJKsIHSRskKReLO41PfsAzWrQ1teS/47C6PoZkJTR3L66f557gArO0s943d2JdHyuLQ5suXYQFO1HAmzg/RUU5rwuphgnCinWrISjXr2AvuldE5KsFjQNtjFdQu6m0RmBY+2Pxy+h+6w8NJzMzNi93K68sjcwZV73jLN523FNBXBFVjA/XCLrim1lBesT3rrhSyXMC1f/9UsTavbGVbK6s3c9uD3S6XD6//lJ9355ITNoqepg5eyMGoYXncznn61fjgasopcZ5Y88polsCRM9OgpfkNFH0oekJeCbzYWz9t954LQThWNTBzNva7iJ4mQlbah2Sczs1tsbWn7eRME2xb6zjhFNt6b78F+7YDur16VUGXak/OS8UvPPlS0b6SE/yYOYWZ+spn16+sJ5dHcRQtO+HrfZpe9oVj3Wa3NhX74hBmz8yH3exDW5OY9Nx1jjmhgg/bwJbQzD3ZzJtgNVRnshKcI+3v7hy7NmO7xC882dKu5cID4shwQQR/yi5eH1t7flUNbL1HstDW25g+ZxMBnXDDFTycEK+ottabWQkuB3EaLrAOj9q6YX5jwrdm1Qsxl7yV41vK8rohvuc+mPnUZjJSz03sZiX2MFveRAEO6VhdJIKRU+PNK2M9S1IfRqbK4JURBXMpW++GMI0ift0lTYOJWdy1riZsjGX4Di/mEwr2sHjLxpYlLN2yGLFhYfSGAvr6z6RWotZ5GHFbKk1ltoB5Xyywhw1KGy+xhPEJK5/41gBg9cQV5wbXzBISHWIPXs3SswzOfMtDYTlz4XixmvEEUjC/aKxt9Votegn6inrOas960VfySnDiTIhFiudd0HbOwrGKI4mhBF/0IevRLnqJ7ZJNHawTKvawQXOurY5qISa2jbPlL37d22eDAf0FFbwGa0Bf2/iXiSLaFTSyEq5s7iVG8YyP/fKZN1X0EasTTPWFh4wUJDZOtFBUbwLF5bFncagsjmB56ILZSBx5SQfoQvOCXXWzUPxSaOaWTGisxqmjqBTytdZfOnU2ywkVvIRNlVaC9zUWSEMAd4XiMt3szHocu4tOk4s4Wx4qt+t+Ft2MLG82Qz+BBxXLnppo6g9hj66Sl43ZAuaysnB8Kyb+0gYHs+WzzTe2k9bZk1csn6QrvDtWT+I+BHLs6XiuLI+F5VGw252HKkpaqJJ4kRdbf+JAvAWPJTS94F5WBuvYNOPWHWFenQYz6ApCGfWKryCrgnVsHmMEvDVRtaxvz4wmRoSlKvJ9P4vuWnsdBvS1Pbo0Qj0PfdC5kve8CeZ6AI4sd60K/k0TLKXiiJNZ87V2oFqHneXpwu6W4N3qVWlqz/JImR+EPnm02l3bZJeCeeIHkbXW3xKWPgvVOCXve8oB6FAo+mJr1tOJ1A0vLuVZEzi6IKrOe96sxcUh0i7nebPEhM/jF8oyzJY3x4567lbWrSeWqnR3unQY0FeENyPOJK5UgUEwp4qWGgRzvLmZxCjI874tsR/HFZrBzadOQqrTwGr5TXDnq+cwP4he7LbcQBuXrFsTPwuzjgXfxA8JdtV2E88qs41N1rFdY0mVNrYrxHkJfs6sHvSzUpHszfqaqJpSL7b2otNknC/3YXrmFJ0XpyGgB9ZLLAtHHVclLq28kldqe3SL11A4vjCvHEUN9ZwwX97ODZoyuus35eKy2qcRRkKahSnYl0eEhy638kT2jXsbNoqJ807c5OktW69Dn13rVjS3EsxFJbxI3MmU2DDmHSFo7WgkipdjjPDB30RgXQX/c0Vzq01OHlaB3Kac4lx56wp66vwsTlFAf3F+1AuuNlP7bGEHrlAll9Az+SWKufjw7UOQmAch1ZGp2Fce7B4LEKfjIF1INNw14+7gxbFneQjz5476OLRDdO1YQTpeiZ/H+pSaxuvfvDKWM6vaaZgzLnoCZLis6xd9cZG1Nq1lx2HRy8K2t6m3TS+uFJxzv8wJMFaF1zZoLg9tZNkv1+29T+U67FMU0NeJ86Nh57quVCysbAFd7lfLFl7pwK3KtnHrVjDMP3phSUdSRXdM600Ql6osg33iiYcvL9YpT4cr8SbQYB0bSvCuaf9HtLDOK29VwkxwjlN3N79IxJ0Z4uNOBl2NOWc1wVrcr2x+f/JGIbQt2OA9slqqMosrlmXNe+TU3ndOaUBflT0E9c6emNX6681CyXv2kZXgCoeEmcQfKoVJOFje27zyqsQe5wYXnDSJSXTHms3ucu5X5fVYYm8W0mbmp/SKSpwDgid8PQcNork8lN+LvmXrUr1lZXXip1kXVXtoFpmV4GOLtm8leErB5c6SP/j+pJTYjhEl2ntHc6p2ttzXYn7z8b5zem89pzSgw4kDpl6QRTtW5us4Owp5qKP/4BPzSvhmwbye+eDx7UJW7loFe7ooOyUKUHy4qJaHyuy5BhW7wy+zE7qGlBwl3iZmVy1oHcZYl2GHd6MhQ3O26lOSYK5bYglcw/hhWPbi/cpfIEdxth3sB2OE17VgHnZA1MfBz6I+U34WpzigrxPKYdEesBYH+NBDUfLSr5a8SCZtCcWz2nxj5RNZ7S6P/RBIwaETXtwd3LQ7y9sSe3Toc6vRkDRFlNgUcWOkqN031tXWzTJUCiuxXeux9bdJ57JES9zwuRLGOgvoNWgdZtZLLEa48CVxwmHZLt6y+EDrZ+E5S629MxLQYXUnV7UNZ7W3p7Fs7ml6nqIH9B2Z2AFTbz3Y+pi1hSr2xGWiuxTIu2TVVVFowkKV5REsDtpAbseKMFuegnlis6zfH7QR6lm2ZveplEOlGikM4POEWQAAgABJREFUYlAPQt0U1LshxogGmnkWFr1Y5p1XSjEA6Qkut7/rvVVfzJRKV94jcbYcPXMrds9QQI+E/lbTmM+vNq1JfuM92ULABWefZWuY3/bKXbrYukYV7wlrE8OWopmyOLCAvjyOY4MviBTP1LWVOBfEiquP2bmtZc2WurbPQdEq2pESsvWuX/jFRdVaJTSCNj4cN8UrNLWuArp6W4Vts+WxautWCcQZ5AwGdGgDsrcA3SygaTz+WFF8eEgOvS7vwoFdm1U+PXODF4u4O3jdqGEWSuxB11DPZLWW9hQ4LyUSRlwzEbwyGhwc2yB7s9SwZ92cy7IiZOxpZr071pby+Nqh6lkuFRVv4luxUrp4ixHaxLbemfazOKMBfSWYC1l37agXMDtuWC7ssdk5yAuhKIWidDjn2uvq7B2o80FYhOFr2462ODAfgDraKC7b+c6U4iROFXLyN5bdmfq5niv13NMMlbJRioGV321mPZ3HnbC26MXXDj+H+axhPjO9joiSZUJeZpSVkOXOeuVnO9k7wwE9jLHVS1Mlzp7B4SOYHzjbr54L5UDob0FvSykHSl6YjePG17JecNZ3Bzd1EL4dwvww7g92q212qU+eOBOszayv7KqDEDeWeLMSXK449wqz0Ik3i8TpJlguLHE4eiQcPxbquf2FvBR6E6G/DdVYKSrIcmuZnFEdxNkK6KukTWzUoF4qR0+Vg4fK4Vdw+IVj/kjwC7uQyikMr8Hohme4pwwmQtkLphCkcthbZTVsEG12vZXWD8Ns+czRzFmJUM7IWEgi8X284BeOpcpqWmM58xQDoexD3hOcyMnxtnTfefOsi9FDjJgfK4dPlMNvlYPP4eirnOUBoJD3oL+vjG4qwysNwy2hN3IUMemDsxYjzlZAN3vd0INdeI6fK8++UZ5+AQefCcefORYPrbwiGRRTZTFrqNXKLHiBiSOvWM2tp8ruWyKMGFpW7qnnnsUBzJ8Li0Mrr3vvTAeRZssTZ5G1ABLtqqNVsW2PtB67AJQgmSbB3Nsk3nPCGOxy5jl8pDz9Snn2BRx+4ph94Vg+tw2fWV+ZPfUsG0/d+JWynaGzZWASsvWzw+kP6PHk98HtrZ4r8wPl+AkcPoSDr4WDr+H4G8fikaN+bosWxNnBlcJ2HjfHsDyA+a7S34JqZI5PceHCqsJydp7GTh9B9Eaw2I3WrfUMljM5MVvuo4Xi2e5ZJRJGmIFWlZUZ1urPa8LMuscVwS8jBPZ0z3k9pH2bV6PKiyNl9kw5fgwH38Hzr4Sjb4TZ147lU0dzFCdsBM0EcjMZaw5h+RwGO57eRCgHmNWvtPbierqP1SkP6FHoHJ66lgvP8XPP8y+Fp58Jh1855o9g8USoDwU/s0fm1VhCLSweO/xCWDxRZo+Uw8vK5KoyuQoDJxSVIws9k7PZNjlNWEbifZgrD+tol4fCcpYFG0VO2uymYJ44D6zPrHvB1xn1sYbRWaUYKOXQUwwAHFnhTiYSiV+OtJXA+bHn8BE8/QyefyEcf+uYP4blM6E5spFnyewDoDkSZl9aMJ8/Vo4eKcMryvSaMr4ElQhSZGelqnK6A7p6zIO9hsWxPXUdPoQnn8LTj+H4W6F+JuhxmDskPLHFjUgemhDo62NlceyZH5szkD05K72x2rhJKakc9hqoKjTRM9+MNxaHyuLQMvN6dqbnOxOJV2fNK6MJSz58oysnM/VhZ0Ee9ndD6jf9EtTMYVaV20Pl+Kny/Ct48rHw/HNYPBL8geDnYTOjtMEcQBfCcik0MxPOzY9tjJbGKo3NNlRDT165sOXzVB+q0xfQRQhLOswEYDFTjp8px99hwrevHYffCscPheXzkJXXBFcfTmZ8wbpRPRb0g4sQC6F5rsy+hdEVZXBJrcTSF/LCSiwnbAQT32dN3KPqUR/nygl+yMIyzJU3Cxc2Iv3AMUokziuhBO+x5ULtOmCCexmtdWwa73g1om5BzJxquVDmR8rxE+Xoazj8ynH4DRx+K8yfCM2hoAvzDghffrKaoljgnttxUnWwVPRYWT6G4WUYXlH6Ow3VSChLFx4IgvbndMWI0xfQ45vkG89yphw+9jz72kRvB392HH/tWB7aOkNtBAlPXcD3rwfboWB/7kFnjrpWjg5h8a1y9LUye+6Z1krjAXW4gUPyYCCR+HGicUMQKcYS+/wZ3/dg9yQBYuLiEYOPWqtpeRQy9rmJ5sqBoiqItCKsdJG8BAUNrb1m4ZkfKM8fep5/Bc//LBx+4iyQB48AmjAK637424k9Z9mBqgV/CIu5UD+B2TfK0SPPfO6ZhNFEGUMpDnF6GidzTldAV22FVIvw1PX8W3j+FRx8BkdfiJVQlqEPsv5+/th7u55JLq2vHgVy9RxwZhXbLKDZh3pLqYa2cz3LX3HX+gVEva5EKM3SMvPFobA4DPuDw1w5/swsNkgk3hrahL3djf3ae21bUN5m1rMi3NfcmfMQ3xBhhXZtVtHzA+XwkfL8azj4Eg4+NeFbfbC2dOtV3sb4d8KxqefAIdRHmHg3E+vRz6DZVXoTT9GT9nidnhtcxwF9fSxTFe89i5ly9FB5/g0cfgNH3zhm38H8kR0obVoxdfweP4tQAdBGaI7g+Ks10dxjGFxWRnvKcAd6I3MQiofsoitSV4pSr/jGRtHMthXqIyuxNwubLdeoYk8kEis0OJdB0AjVQTTXV4qhkleYYC5rK1oXufUXg3LUHtS1aakOvoODb+DoG1Owzx8KiydCM+PkVsZfMkVjBQD8Ulg8cRyoUB94Zo/h+AoML3lGu8JgCwon4NwqqHd8rDoO6PGNWz11eY6eKE++gCefCIdfCouHjuaZ0MzChjTHj5ZPXsqaq6hg2fryidAcKotnyuzAc3xka/RQa+UXfW+2gEkwF9oh0e3NszjyLI5g8dxRH9smuzi6k1TsicQaL6rgl87ue2Gss14qXv3KcY7SHOYu+vUTV9j62ozE5gee59/C40/h2efC7Bth+UhoDgSt7b7jsl/4j70QHwD8sTCfC/VzYf7cMzv0zI+DxwBCfwx5qTb+/Evj0pujm4C+mi33Gqxbw9zgQxMzPP/q/9/en7XJkR3X2uC7t3tEJIACqoozKYkUKYqiZulM/R/6HPHr2/6XfUSd277r5+kzaKJIiiwONY+Yc4pw973Nvgvb290TRFWhAGR6ZKa9elJAVSHByPCIMDfby9aC448CuweBfFRU7Ll838t80qSoJIeAKAgRyQKdolsYDuHGl5SDV4XVjUBb8tZnUd7XhJpZXj6Aeoul7beWjJZ2kdRfuuxgx1mMurqpmaIxgYDZVssN21lv1iaYi7WJuSYTr2kyoeQMqVf64yJ8K5153S0fHpVi3pUxe9VMvQzUmk3z1QhkgtWIQdGdko7h1lfg4DUx69h1OHNMu0B9WKCgjyMU6/R2J+bmc/wBHL0dOP0o0D0ODFusK+9n5iMv+/U8+zs1BfIhdCkix9DdV06+qtz+feXO7wu3vhzgZmQVrVu/VsW8HIcMO7Uz8lOLG0yz/GBzxPJi7jjPxORROga9dLncLO+U1U2xBLebkXYTiNfNKCNYEzF0yvZQOLmrHL4TzBH0fqA/DqTTgHRALj4i51AjQgAtwjndBYb7Ad0q6ZGyvWsK+DvfVm5/Q7lxJ7AJkaZd7FpdbEGv5yAqFjm4O1ZOHipHH9nFOnrTRA25m9v/MF2sc2AckwhIuYFIJ0r3GLpjOwqoxgXymiLlnOvKW8fqpGCX8kHTnyjdkal1U1diCbPnlTvOC1FU8JLMOlaSIMXToVaFpq3BUldbMKdqO/tm3Wory8f3lKMP4PFbcPxOZDgs68dadsvh/Mbds9qjQyAnG8P3R0r32KbLinkMyAB6R1nfsMz1BcSN51/QJ2s+W+y2Qg6nj5TT+0X49nHg9ONIdz+QZuP1KYzlAp6Kui4nWNhC2Vs8JqKd0j9Udt+Am18RDl4LHNwKrDbmzVxHYZe+ax8DVcztTdLUMaSdraMN27oSYsK3MwIUx3Gei3FdN9URZnl/Jcid0t5Q2oNAuwIaW3W7EkEvZ/JqrIEw7xHYPrBQlZOPbbx++rF5j+RdyTIv339hnz1zX5OyjrsNkSCQj5X+67D7unLzS5kbdyzts2knFfwFiKrPv6DXH8Ic34TdiXL4CRao8iHsPor09wPpOJB7+9Ff6jnIs1JeGOP/rATkFHZ9ID2G3X3l9LHwyqlwuw/wVXOWa+FKmUJUT2RJwtCJxZwem9tb7oOFUGQPVHGcl8l8XKw5kLvG8hA6Zdgo617ZiMJNaIjERvdpXer5KcLoOg0cOhNGP/4QDj+A0w+LB/ujQNpZlxznu+MXyazJDACD7aufnDb0D5TtQ+XmsXB7q+QcuB0C4WYc0z0vgHMq6NV/fUzbstFEdwynD+Dxh1bQTz8ODPcC+TDabnl9Ue/D67TchaWd7SOmDpIGstoePIPtJW5egdVB2SGtSvjLeNZVspwl23FI6mwdrT+B/tjOzMfuYS8ukONcTbRYxyI2xs3FCdPEqRb00qy0ZHdfukQwY6wRJrZNnTKcKrtDOLpr9eHoQ9h9bCp2OS3TwDj7/iVRINuKbt5C2gZSFnOMTRbIoz3ceFVLyMuF+Jq8/II+jspDWUUbhN2RcHIXjj8INj65H9g9Kob5J8XRZ5/XnMQEev29ACmSj5T+IZx+FV75unLra8rB7cBqHYhxGoVdihF8Weo3tzcbrw/FujVtI6krI/Z6ZuXCN8c5fxSqvagku7lWCeTexu+rG5nVQTDr2FCEuuP37Te1RogqOVvGxvaRcvwRHH8YOL0b2D4IdI9gOI5IV9wm68+3L58/Ov0qCdJRYPthg2yVdKjs7tvO+u2vw80v2Qi+LSvQwPQzvTxefkHXWWfed5aOdnxfOXwHHv/WEtLScUB6G5+oPBGosk/MjfwF8nGk65ThSNk9Uk4f2XmPjYsC+kpktbE7scuCioUI5ySkrQUcjG5vXTPulu/VG8lxrjpnVPCB3Cm5JLe1vSDJ8hPKPpuJsOBSnIFVcXQerJifPBKOP4KHbwaO3gl0DwJ5G9Cecbc87Gt9mK1SaxdIDwJyYoK50wfC7sh26E0fENAbwYLAzucyvaSCPlvMztnGtf2pJd/Y3mDg+H0ziukeTMk34bzW0c6DMo6WFAgJ0mDjsJCBvuTofkW58bqwvmUXrWlM5bhXd86zUZedlZfM8s7ShvrTMj4ahW8uenOcRVEQtYCRmotQ1900KzIITQl5iU0R6u7bG3acBNqR3rCD7lg5fWDeI8cfWV7H6Semp2IIVh8uUY3QxLitQLJxPNlqRN4q/Vfh5peVzR1hdYAFgZXz9Zc0zX3xgh5GUzBF1UIHTooH+8lHcPJBYPexJd8MJwEd6s4yl+IiTT/o7OHmgO7sTP1kp6QHyvZj5dYfKK/8gfLKV+Dmq5F4w9yDggabVi9d1Mf1SEVFppjT47Jb3lkyWk4mfBuvk+M4ixIoJ15achI0IEMRzR3UvHVYHQRiiGeDXpb83HliJVtE6E6VowfK8Sdw8n7g9IPI7n6gP7SVMJ48gr0sH0JjGA8wgJxEdkmRY6X7BE6/pbzybeGVb8Kt1wM3XgnE9UvdVnjxgi7CGNKROnN8O/xEefS+FfPt+4HhfiTvJnngpSvmlfkTn2wnMR8H+odKd6gMKZNVS8qPwKvRdtYb9sM6VuzcSnINVBH6E9gdmYpdhoBKdOtWx9k35utdOZAllOmakHt7T9c/YFaksz3oJd/D42dOicPeWqDK4w/VVOzvBnYfRtJREQKG2eT2sjF/zGWtLXWB9Ng0V/0uk1TJomiKJry+Zccl8eVcq+co6PNFe5kMAHaHysl9OL0X7M7rk8Dunpnb57pbHq9QHrYwWQMOdncZPow2pTgx29jdV5Qbr5uD0OpGoGlmtoDj/ztnAoQ66iqFPHeT8G04DaQt5L505QQ/L3ecfaYGTJVRfKJamYH02M76RmnXgdgG8xm/wKO/eaCKqOlzuhNl+xDzHrkbOP4kcHoXunuRdAy5K814Mc+59NRrJCZmHFThfoQGpFPSEXSP4eaXhZuvweaVQLuy6/QCQS/PUdB1+iUnpd8J28fC4Qfw6J3IyUfBktGOIJ+a81qYi8uuwsWa/RyhPIWaA8NDU2T2j2wn8eTryqvfAv2WcjME2ERiU89NLghVC8ARIfdCf6oMpxZ1mrbFujWHs4rLq3KNHOcqMhfMFTOaQUw0N2yV9S1hdUvRm4HVQbQicdHBIaPwzQJNTu4pj98NHL4X2N61ZLR0HJCdfXbGq1ofiqdKCIF8ArsPG9Kxsntok4rb31Ty76ndBd0KtG0DzXM/DV+8oKsoWSD30J2a2vv4Hhy+Fzh8B07vzszy0+yHuyoXas4ZIxq7gcldsNWvEi2qSW1fcaccvKqsb4p5MzezEcs53TXXzPI6Yh+2Zt/anxajmG5m3XoVr4/jXHW0JBxKtY0te+zWHqOirDZKXFki2EVYx+Zsj6Nmlp8+VI4+gkfvwPH70D0M6Ok553TsC09Yx6bBphFDB32n5B4TOw7KzS/B+hVhdRBpVhC/+Aj+GQr6eOZdrFtF2Z0q20eYLd8HFqhyei+we1T2yjtT96GXYovi5VBGYGSQLpAeR8jK4baI5r4Gt74l3PpG4MZrsLkZWa0mFfxLUTnOzvhVba0ldcqwtT3WYVeS0TqQIdo46DpdI8e5qigo5heRu0hfRHOph3RgQS/tgW3fjCKml9VMzGpE9bPYVgX7R3DyQeT0E9g+CPSHAdkWcbSM3351C/qMuv6rQ0CPAY2c9ooeK909eOUbyq1vCTe/ohy8ElhvAk0MKLPV4c/mGQq63egBtk/XnSonD4TDj5Wj9wLHb0V2H0VLvsmlQFz1u66n8cTOuu7K3dhhoLurbO8p3VZJKuYXrxBuRprJO/bFqcchtSvvLa+8OzQf9tSVzPIcTPjGOYYaOI5zcYwKaxO3jsLXXkidkBNsMA/4MTjkZX1Al7NytBTzQ+Xonh3DHr8dOXkn0j2soltsZRlebhT2JeDMZ20KyHGg2yrDQ2X7ibJ7DEMSE81JINyOsAmE+MyipqcX9CmPtsScDnpmfHJcMstPPoxsPw4MD80ONTRXSPT2Imix/it73Om0iOdKrF7eYsK517VYxyrNqp5zPceqSUlUMevWInzrS6DKiZ2XD7tJxe4Kdse5umgJmMpFkFWz1+1zydIim7US21C2b754tx6K6E1RNNskoD+t4mjl6BM4+TBw8r6Jo9OJ7ZVfOS3V85JBcxU1WnwuUQhNWUc8hfRl5eCOmMPcuqbtfWZ9eEpBnz3RipKz0G3Fzsk/NOvW7V3o7kf6Gi6v3ul9KnV3dAu7jyOyU7oHyvYbcOsbwu2vBV75Chy8YhaO4yTsWd9g1bBB6+qg2Hi9uL3ZbnmdnnjUqeNcGzSg2eKoVRQpTnOrm8L6FrQH0K4bQhO+0GfOmSAZUdIgnB4qRx/D0Udw+klgdzfSPYDhMCJ9ODtW98+eiVB8Sgalfxg5zoHhUNk9UE6/odz6unL7a4FbrwVWZfU5lCLxlGPapxR0saMNG9na3uDpQ+Xx+/DoncDxRxbyXoVve23duiRVazZLUOofBdIJ9MfCbit0O3NNCgACqxtC05oS/plukKrjm5rj27AThtNi3XoSGU7LiB3GiNf5Y3Mc5woyb8rEjtdUFOnNxXO0IrVoRZp1WW174ns/jXpkmJMydDa5PfpEefiuiaN3nwTSo0g+qbnle2rduiRzLXL5f/kUdrvAcKR0p8JuqwwdIEpQOHiFp/ianKnq7fi3VlGDZBh6NevWh8r2rnLySeDo48DJ3UD3cKZir0YA3p1/PmIjlpxBQ0BDRJNAB3IMu6+adezB68L6JrSrSNNMozCdj8lr8lLpynNX0op2MJyGIn4LxfFtD8wlHMdZDjHBXBXfDjECYkluPawOMs3aBHOxAWI42wAw3y235qHvlO5I2d6H00/M3vvoExNHD4cBPQEdsGK+RBz2ZaPurNcthQcB1Yj2ip7C8AhuflW58SXl4I6tIzazxq+sHbfjXzZXKO6OhOMHytH7gaM3A6cfRvpDc72RHkjhWooaXoiZaE5TIB9BNzTkI2V3Vzn+qnLn28qrWbj55cCNW5iF45PRiLNiLllIO4ulHU5LoEpvUbSS7U3pmgbHueY8sbdu6YnB0hU7Jd2wJgKNtAeBGH7nG8t2mYlt+045fSQcf6Icvh04ftusW4dTSH2AHpCwX3HYl4AQQBtMZLgNDBKQU2V4CCefKK98S3n1O4Io3AA2B5HmbA1uS0iHjdhTp+yOleP75TzkXTh+x7zYc/cU61K/UF+M+nwJyM5ujtIp9EclHrG04blX5HXl4LYJWGI7E8KrXSuzfZzyyvvT8kZNRQTz5P+m4ziOlrjqXPfWM1pDX8oYvikCrLEgq43ZczIvi9NHyvE95egDOHo7cPJuoH9snztnPm78s+eLMbf3HYq1+C4wHFveRh7M3lcz5E6RV4XVTaVp1axjIy2iQh5gd2TWrSd34eQT2xvc3Q30D0OxBQXirLD4xXp+quK0ZIxngf4hHGtETpXuAey+CTe/Jtx8HW7cDrQb+x6zbi175adM4/UeJMVyZnZ9djsdx/nimGdGQIbIgBV0SZA6WN1QVjeUZh0Ijf23bgunjyw98+QunH4c2X4C23uR4dgaiTPryv7Z88Jo0SqoBJLCLkQYAsNjZffNwO4byo0vCTdeFTY3hbaVlv5U6Ldw/Ak8fBeOSzpa/yCST0pcKFfIY3cfKC/4yWXOzBZ2nTI8ht1DZVeEc2kwVeOm3EGbUUygPwr0J9FW0XJxi6q75X6dHMf5NGafPZJLclsJ10o7W3tVVdoMobFO8fQRPPoADt+D048C3SeR4fFkInahdtbXgXD2c1xTYHgUyMdK9xB2h8r2VHhlK0gSggoq0vLwTev2ju/C4fuWRzs8COSjYKKG4KKGc0dNQCI5kHcldz1aopL2IFu4cUeJbTk7H0z8lnazQBXHcZwvitoGjoWIlK8ifAutTRGHbeD0ATz+EI4/CuzuBtKjgJwGF71dBIrlqwtktWmsBhAC0oHuYDiC9Q1aPvxH+wP9sVm3DkcB2WK7a8G7vQulPNfSBfp7Ae0i6bG5CG3uwOY2tDcwdzktZ+VTIL3jOM5zYp8jkkyX0x1D6pX+CPrHgd3jSPcIusMwhm7Vb3MuiHEFGtskkEg+augfRI5uB5oNLff+3XJZZQhoV9zNSoHwdbQLZK6Cz5CPzYSmP1S294TVbTh4XbnxWmD9SqDdBJrVLJLWcRzneSnCN80w9KZY7w7Nf717aE5v0pkHu2b7Fq8PF8gTzbXsYOgj6TjSPQrEg0BoQ0v/qHR4xS7wWvqw7xtS/PNTgAFyH03VuIN8AuvbsLmjrF4R2gMr7LFYOL6UkBfHca4+o8sk4xn6sIXhGLpDW1XuHgeGY4uFRsLkw+41YllysRPP1oyzDRBDS6jxmXP/d79QyzIXzKnF0MppoO9MFDHcNm/9TRI2twObW5GwxqXtjuM8OzXMqfhZ7I4sIKR/FBgeR9KJrStrwjwtwGvEvjCvEcVzhBDb3z1/9Qu1H8yvQ7YxV9ZALipU0Wzbb7nkHt+w/dEQ6xjeL6TjOE9HRREpfhbFvnX7SNk9guFxIB3WrpyzxcM/VvaD+QUpsd08U3yqszxjLCpmDLGz0AMVRXaWzDPcVtavKKtbZuFophChBrE5jnOdmQWqqQg524pafwz9IfRHge4oMJxAPo1Iz3RWPv4/Z2+xz3gv6JeCKigt6yEqgXwS0R7yVulPhPWpcjDAjXJ20q6Kbay/ER3HUZvKqpQ47E7ojpTdPdjdN3OY3Jl6vRpeuejtEmGf817QLxUz61iVQC7CiJyKnaMoIYN0yuqm0h4ITRtKTv0Xzzx2HOcqUO29bRVt2Cr9sdI/ht2DQPcokLcBTUX4NtdTOZcJL+iXknF2VtYMd5Esym5Q8omyvgOb14X1q7C+FWg3kaa1ol6yXRzHueoEC1RRsVTGfmtn5f0j6B9FhqPAcGpmVmeKuXNZ8YJ+aZmFtZCCucvtTAWfTotwTsTMZxTYRAtcAF9cd5xrgEot5kK/VXaHJnrrHgSGB5F8Gi2YZf5N/tFwmfGCfiWoecda8nQBouXp5h7yDtavKO2B0m4CsdGigvd3r+NcGcYjtaJgH0z4Npya81t3GOgOTVCbT0sUtlu3XiW8oF8Jyhs5FDmqDpCOGntDnyrDibK+Ixy8Bgd3YHUQoIkE/Fzdca4Es7eylK58OLWOfPcI+kNze8vb4viWPa/8CuIF/cowT+aREvLSB3IvpEHJg43gQoltbdaWozsK5hzHubSMoSoZcm/GU92hcnofdg8D6Tggu2ge7PUG3t/2Vw0v6FcSpcSpQugCEOmzwqDI1oJe1neE1S0169g2EmOo3+odu+NcBmpXrnZWnkohH47MsrU/DPRHjI5vDJhRjNt7X1W8oF9J5kb+YqE7OQd2O2U4sq9NJxyIsiHABsIqeqfuOJcJBWUq5v2JsDtUuvuBruyWSw1TERjvAPxtflXxgn7lqattGehBOttH1WAnbjqAvKLIgdKsldhUQwl/1zvOvqKqaLYRe+rUzsuP1CJOHwT6R4G8izNtjXMN8IJ+bVBQtXe2bKHH7B3TsTK8qqzvZNavBNY3A021jh0DeJd+8I7jhHr8rYqKkHo19fqRMhwF+kPrytOJxZxaV16/eelH71wAXtCvBWH2i5YxXDLb2LRVhi6TBkWymvJdA7GNHvLiOHuEaglVyUIexAJVHsL2YWB4DPk4IjtTsGtdR3OuE17QryU1bz2HYjgXURHbYe9tZ311U2gOAs0qmGAueLfuOBdNCFXgajfcuVi3DsfQHQW6x9NKmuwCDKWY+1n5dcQL+nVlrM8pIKeRIQWkiObWd5SD121vnZsRVtHO1rGABy/qjnMBjAXZivmwy/QnSvcgsHsYGI4CaRvIPTZiz/YNXsyvLV7QryXzN7tgRhNDIHdCOoXU2WiPYAra1Q2lWRXBnH9YOM6FYNatIKmko50o3WPY3Yfd/UA6iWiixKiVb/L35nXGC/q1p2atZxPNaRHS7DSivZLuwPpVZXUrs7phWeuxDQQ86MVxXiqzjpxayHemYLfc8jB+pdG6NUzf5sX8uuMF/doz+xAIaspY2QX6AfKJMhwrw07YvK6IBEKIM+9n/wRxnJdGvblW0CwMO2X32L76R4HhcbSz8j5AZrJudhzDC7rzBGI769LbKF6yIASk7L2SlPUtaNYQWyXE4Ep4x3kJmILdkhLzzqJOzYvduvJ8FJAu2jqaK9id38ULuvPpaDlfHw7trE62kE5gfduEc5tXoNkEYmMuc2ZDufSjdpxLwqzBFhELVNkp/WGxbj0KDMcwnATyrqybliOxUO1bHWfCC7rzFOZbahKQ08DQB/LW7CXXp8qNZJV7reVcvQGif8I4zjOjNmVXUdJg5+X9kbC9F9jdNxW7dAFJRcHuu+XOZ+MF3fkcpBpaBEQgZOsSgoImJd+G1SvC6oY5zJkS3mNZHedTKaMsKcK3at3aH5nwbfcw0D+2lTRSAJk7QznOp+IF3fkc6odINaLpI1mVXa9mG3sHNl9SNq8p61cCq4NI0zKp4B3HmTC7RlTtrLw/Fboj6B7B8DAwHMWyW27CN9SruPPMeEF3noEnirpkM6FJJ0raKVkUUUGl+EcfxDKCd+tYx6moAqKIKDIo/VbZPjbhW/8wMDyM5NNoQUrzCZe/hZxnwwu68wUpohwtavh8ah9GSEQ6SFtYvyKsboaStW5KeA96ca4jNVBFtXTlvTJsoT+23fKuZpYfRfI2IAPTWbkXcueL4QXd+YLU47wSsaoJ0lGD9Nax9yfK+lXlxmvKAYFwIxBxhznnGqOgWUmDMJxaoMruQVlFOy0K9t5CVcb3ib9XnC+OF3TnOZmp4LUDGQIyCCkpOWGdvCgyQHsgFvIyF8w5zhXHAlWK8K034Vt3pOweBHYPYDgOaBfQVI6qvJA7L4YXdOcFUTsbDGJFXU+jRbn1Sj6B9R3YvCqs79gIvm2jpbeBW8c6V48AAbUxezYP9mEL/aHSFYOY4bhat1YVe/le3y13Xgwv6M4LMttZR6zjyEmRU2U4NOvYPCiCspFAuAEQy7m641wxym65ZCV1Qn8i7B5bmEp/z4q5DPVg3dfRnJeKF3TnJaLY3noONnEvAh9isPFjB1Kz1teB2EJsfM7oXAUUVSvkMtj2R3+qdIfYV4k7zdtoojd/2Tsvn6tX0OfvEZ/mLomNEnMX6B8GpCt7668W29g7sL4VzAs+ziS9ftGcS8RcxS5iZ+XdoU7WrYfBrFu3FlHsLMuTV+CKfdxcqYKuCuX0quJb0BfOmSliQAdIqRT0Tkl9Jg2W84wCNyGulFh31v2COZcIkSlUJfVKf1xV7Ep/GMnHZt+q1brVO/OlKPUBuLo14vIXdPNfUBE0Z1RqdkGAGCFGQowEdy5bCrWQlyz1+Y+oKDooeQfpNqxu2d76GSU8HvTi7Ce1AogoOSl5tG41+9auZpZvA7Iz4Zt6MV+MIlKsNaJ+rJQaEZqmfOJcgRpx+Qt6jTcQdOiRlMx5vFwoVitiCMSrcsEuH7XpDna2nk8jmhTZKsMR9HeUG182p7n1rUhLLEV96QfuOJ+OqiJJGXaZ/thW0br7NmYfk9ES5sM+ew84F43Whi8lqxGl6dMYCW1LAGLbEst091JfpEtb0LWM1iWXYj6gXWcXTRViRNuWoGoXtGmmoKIS9OlcGKMK3vbWcx3B70xABOW2LClyU2k3SiwX7EoNxJzLjRbhWwlVGbZKdwLdY9jdh+5+IJ0U61bCE5PdpR/8taN486kKmjLad2jfW80AiA2as8VMaa0R09LOpbxgl6ugT/bGqmrjkzSgwwBDD8NATKn80QCpgZQgr9HVCm1XBMsNwX0VF0GnX0UDQSER2alagb8D61eV9e3M6mZgtQmEtt41hyunYHEuAePHRLFuLYW8P4H+GPrHpl4fjsqIPQE6axn8Y2YBLB9S0VzrwwB9T0gDoR7LxgiphZxhtUJWa2jb2Qj+El68y1XQi4dJKeYyDGi3g24Hw0CQTBSZLkKM1rGnhKzXcKBogECDlDH8pbtgl5vwxG/FBEPDYCY0w4kwdEIalIMMgUhLUcL7pXKWoCipbMQuDFtl91jZPoL+UWA4jOSTiAw2ffLR+uLodF4ufQ+7HfQdISWCZIJquUoB4oCkAU1rm/RyQAi2d3Mp68OlKehlfIJk68yHZF1519mdV04EUQJKqKIHEfMsUxm9m1BF2xaaBol2JxYu44W7Gihosm5dBlANaAh2b51AB2V16ynWsY5znoyjwCmzPHc1VAV2jwO7xzAcBvJJsW8VF70ti9ZCLtlG7Gmw+tB1hNQTshXzOBfFiRBL/t14fi6Cti0yE1XDJbmw+1/Qi4pdTdQggwkbGHpCGbGHnKAW8ye/WwUSRO1QyZAGdL1G1xu0XUHbEENj8SGAT3WXQhWkD6TDiA6BvFWGY9jcgc1rwua2WcfGJo63YK6Cd146MwGbZCUnC1TpHps5TH9ke+Vpi62jDX4UtCT1U1tLIU/IMFhHPgz2lRMhC4ydObPDP2sSA9B0iuaErkqNWK3JbUsIgRhqUd/zS73XBb0I2qjFvO9thNJ3hL4n5mTduD7xRM97OFWCCkHLykJKUFYXbH1hhTameHSx3CLMrGM1hxIhqeSdrQKlnXVJYHnr7SbQtBT5ytIP3rlyaJ3ZmmVxv1W6I2F3P7C9GxiOY/FgtxF7bex8cLQMRfgmgg4JGXq066DfEfqBWIr1WMyB6Z6t/JMqQTIqmZASkhKIIKVGRECbhhDj/qvg97Wg6+wcxM7Bi6hh6CENVsxFrKB/7nupFH2VsamLAVtfyBldrZCmiCGaZrxge33hribVOlYDWezMxK4caI+J5krWerMJNG0wJTzBu3XnxQj2KWGFHNJOGU6U7gj6x5HucbVuDWiGoE8KQpyLZSzkKUE6O7kdO3PVUr/D5/1lthEVlJhAQkdURfOsRrQNITa27saeXvS9LOg6U7H3nd1xDT0hJWLOo7AB+II3xsG+L2dC1xGSncXrem0Kx83axivlgtl3OBfI/OmWgPZmSLMrtrH9kbL5krJ5Xdi8Egg3Is3Kl3ydl4OqkgehOy72rY8C/cNohXxnOg+klIc6uPWX3QLUYm4duU1tSYMJ32qNgC82dR0P8oQ4DNZQpoSmFZJW6HoD61Ij9lUFv1cFfRS+lc586IuK3S4WORNEiC/4PxPEmr8ggoqQyz/Xt6i24wq0j+Evnvp0K5CD5Ul3dqaehzoIA7KCKKsDiO1sZ90vl/MFsNJgUad5sECV3aGyewTdQ0iPihlS5ndfW/5au2hqVy5i591F9DatpGWi6gtdGDvGzVYjckbEbhCE2j8qGmc76/tUI5Yv6PX4VJBcLlLdGxzqiL2sG9SVtGcas38WNeFQCCRTPWpxKE0DrNZouzJjmmgSrHhGSeFcEOUJtwsUyKeBPpjTXD1jX9+G9S1ldcOsYycTRxfNOU9n1GyU8pB6ZTjFxutHgf4I2ys/KZ15wo5+3L7iwpnu72shlzSvD+X3pUbEMjp/YUlD9X0XrOuv6viys66rNbpqIbaESFlx24MasXxBL0YxImgaJlFD1xGLCYDtDdqfG/cHX4hZH6dKyJlG681Ej64TujlAUULbEmNT9tedC6YGvVTv7BThWNFeSadqe+tbQb7EeK8cm0iMe69GdRbEPCYh1678RNg+DGzvWzpaOo1oV1Yps+k0fLy+DGeNxCQlpO+g2xH6rhzBFi3VfL/8RQnTjURQIeYyOS4765IzqgewgkBLaPbEVnzJgj7tDVpnrP0w7paHoewNllW0c3sn1ZuFTNlbz0+sNAjatEhROV5aB6GrQQZJAUmBkAQpI3nLYIf8CqwOlGYjxLY4DPilcoA6slEFSbZbnsqUpzsM7B7aiH0oe+Wk2Tra3mqgrjJ221XqQxVHD72N17tudH0794tTu37EnPlnI30VgZWgOvmaLGodu1RBtwl38WAf+rGYh1HBnrG7o4tbCAnVpjkNpnhMqYxWzDo2rMw6dirqe3BHdj0RbFf9NEJWtIN0rKzvwOZ1Yf0qrG5E2lUoWXs+fr/WBAjBrEMkC0On9CdKfwj9Q0tGG04g7QLaB8i+W740oRzDFi3VE/beoW45XfTgpEx0Y9+hOZu6PhXb2NXKwl4a8zVRXuws/7m48IJeQlXmgSpSrVtT2RuUacR+0c9IUCWkZKb95VeRjKjYS6eo4C+1gf/lZX4zrmbqkZOStzAcKWkro+eTisCNSLtWs44Fv1zXFJVZMd8p3bGwe6x0DyL9Pdst1wH7AK6h2f5aWYoSqCJSivmuQ3qb2sacaOqIHbjoy1Sd5Oq2lOaM5GRn+6rmJgvjaptetGDuIgu6SnHzKaEqVEeffoA82HmICsEq50U+DU88UB3PZKBUkfrPks1hrin7iPu8k3i1qTvrZQddE/QhQiyK5R3k28r6ptAeBJoVxMav1bVgppCxEbua8G2rDCfQHQXbK38cGI5N+IZMcYz+ElmEmo6Ws+mZUrJ1tL63NbKZF/vi9+cl4CVQCrhSxNUC7QopnTpx8rW8kEd7/gW97oJZMZc0IF1H6DvrynMiZpmJ3/ZAfRYmtWKQTByKk1BK6GoF6w2y3tiIhUCM3q0vRLlQdsEC0kH/MCI7C3rpT5TNq8rBq9jeeoldGGWRPla9ktQjFrsDtxF7V1bR+sPAcBSLgt2ObgKgXswXo9p7K1IDVfrduIoWc4Zsbp8vTfT2wg+56nQVSDRarWcHS/ZcH6Drkt42Br1cwEfOuRd0FbNuzZN9a90tj+Ws+kX3Bs+HcbOlGBWU9J6cUZlSQLVtUbU7sb3aR7w+zH1+05S1nvtIHjKSbPkEBb0BcV2z1l0wd1WRuleehFTOy7cPYftgHqhSc8thH7qIa0oRm9mWU2ma+h3sdpMwukxM9/MKKUGKwl5s/G7W4jXdR6Ft0NjY+P28P3LOs6Drk9atw2DnIOP4ZAFRw/P9JNYHihA1mcFAEc2xqlnrxTo2WsyLB70sQj0n0dJ9EdGsZht7akEv69vC6hY060gzS29z0dzlJoQa0WGraENn4T79oXXl/REMx8GEb13xYq/TnX3/ALqClPzLsUYMo/At1h3zsv99KS5QXZur1uIUFU9aFV+T1oJeSta6/d85fOScV0Ef9wb73uxbh34MVIkis8/Py9DVzrp1hJgGO0tPg00dZIPqGlgTR1vAfb2jvNLMXGA1BWQbLWv9FPoj8+Y+GIQDYK0QNrFEsi79wJ0XxYo5tle+E7ojpXsQ2N2z3fLcBTSFsqAaPFBlUZTJh136Hh3qWXk/TkQvo/12UEZHU/OXX6HrhKw3aLk5iU1Tbj/P4Wd7qQVdp+Qb8pRHq30/3XGNoobLdJnO/ozjepvUSL5iWVvUmdq0EMI4YrmkP+llZWYdq4N9iEuv5N7GsPZeUqRX5JbSbsRCXpr6ovTrdbmwQi5Zyb0WFTsWd/rAIk/TSbRC7td2YcbPyZpZPvSj8G3M6xA5/9H0+f2EVtTH+lBO+8p/QxVdtbazfh7bUi9e0KeD/ipqsL3yyZYv5qGchczXDS45qnYXlhOxt9/bCL7YAq7X0LRjxueL+s87X5j5u0gC9JBOIjtRy1q/A8NrUqxjA6uDkt4WZutLzn4yfv6VEXsyD3azbi3Ct8Ni3bq1Yq4ym8Rc1mpxuZmlo1WDGNI8s3wWunUpjmI//+cNIjAMNKp2vp4GSJO3CWUE/9I8hV+8oOvYmUvOSNktZ7e1M3PJxLJXfqk78yepd1ajYK4m8yQk20oDa4Bm6taXfszXiyfTLTUgXWDoIZ/azvrQC2lQ+7Anwqastvk4dr+peYyiSBKGrSnYTx9C/ziQHkfyqfkUjLGMfk+9JLWYZxuxs9vaynJOhCxErdNOrsZbL8yOaSUTBiFky1rXlOzVW2tCjOjLCnl5oYI+T74pD5Shn1bSUhpXDa7AJfq0JwGk7q3PRvDYzjqrlVnH1p11L+xLUb0bxfy5NQQ0xGJxZCtv61tKe0OmrPV5ept37ItSTx1RtfH6GNBjXfnuELrHgXRcVezBRW8LMq2i8aQ4uu+smJeGb38V7C8JFdAwbnSJlumDKqxW0LZIU4LAXtTX5PkKer1YYnccxb6VMmYP1br1sigUX4jpI9/cg9KYymM7iWt0vUGKLWAstoCugl+MaozQB9JRRPtAPoXhWNncgYPXhc2rQIg0TRyTj/1aLU8AskBKYh7sj2D3wKxb06kp2KUPaCp//mp/9Owt0zumFnLpexhqzGmahG9X5Qj2GZ6Pmg0SSWinaB6gXaObzWQvHgIxxOevD1+4oKtO6wblLMTSb0zFHnIiqlzxIv7pz03dmdScICd7nuw/jp6SGsv0z7v1i2Y2Stcc0F1AeyV3StpC7ousE1hnYbUxhzm3jl2YUYWq5F7ot8Uo5j5s7wWGw4gO5sFecy/9Wi1GscnWnNFhGDed6Dvi0JvobebCeZ2olrEhZzRH84MvfoajeqBpxhH8F36OvkhB19k5CEPdLZ+L34pCkSt0Vv481BuajO1V6nSnympttoDFQUgv0hbQmVOtY6VYxwr0CuSIdEoad9YDqw2WtR7L/uh1aCuWxoQPpZhX61YYTpSu7pY/timLdAHNZWnozPc7F8to3ZpMAKbDMDq+hTRMwrdwORaWz/GJGlfboBunuyaYW00766X5e+Zn6pkL+ih8S2Ne+bhmMFOw++LP9PMHVUiZIDvIdgMkKaHrNaobS2/zoJeleDLoJUE+CXSdko5hOBLSl4VNAr0dWIfIZAXv1+rcKcVZRci90h2rBao8CgwPI8NR3S0HxCcoy1MbPhNG78oqWrH3lrKbDZd4Je0lEuY1YqCZ6dAkrdDNAWG9LiP4L1AfPregz4VvZSWNzgLmSQnKhXIJ6dMJKrOsdSHINNQFhaY121gv7Eui2Lg2QeoCuVPLWg8BUUUzaFJWN7ARfLlofq3OBy3PuSTzD+hPld2hsn0E/SNIjy06V7OL3hZGZx4cNVSlNnxVxT7mdDi/w8zXJIgg5dexPqiYbWwVVH/eMe3TC3o9Zix5tDPhWxiGsktXTGJGRx8/tno60+FIyNl20lVQyfY8rtaWpVtzdC/KxN95ktkTrtn2l4eHoMVpbrgD69vK5rayvhUIK9trduvYl8OUdqGIiI3Yj5nG68eB4RjSqa0fqiz9iK8v0+LH6Ag6H6+XGhGKhijqFVtZftnU50ZttS2iBC1H28XTRNvVOIL/TNHc0wv67I5rDFTpCP3OVOzVIEbnJdwv1tOZLz4JMU86BB0GdJ3tlJDyx4otoD+bF07dVah3symQjiPSQTq1XedhZ65kBGV1I9C00UNeXhJjOlqJOu1PhO0D2N6L9IeBvA1oUbCPJjH+vC9C6R9rYNUwFGH0jtB3ZwJVrtRu+Xkx31lHCGmW3JYSIoJuFGFtBjTx7LHFmbL+ZEGfrFvLAnxvwrczK2l+s/X8qBI0m5u0lKlGwPztx53EZjTxB//UWggBydYJikR7W2Xs0KSHfBvam8U6dhXsbRbrW3PpB39JKDmntZDngZJZrvRHgd1D6B8FhhMr5uSZg5+/LRZAi++GVq/yNJQa0dmW0xi65RfouShLGqEe09amWdU2NleWtU6MxGpIMyO0T/xdUlYNtJjDmEGMZdIGsZGxF/MXJ5TzkZB6VOubwywBZb0C1sS2Hcfv/pQvQag76wkLesmK7pR0COtXlc2XhPWrsL4ZaDfVEuJcUpSuJNWCSbLS7yzmtHsM/Wy3PHfmyY88af3nXDxaVnK1788o2GPZLUeu6cryOWBn65nY95OvSbIRfC4JbqFpnujQdfJhN8c3s27Vbjczy78Gbj4LMO0klolIzmQRK/AEBIhVLOc76xfN/OmWgA7FWGAbSCc2FhZVBEUlgirNuojlgmt5Pw+V8vxlJe2U7ljYPVK6h5H+fllHSzApeso3+tN60ZSucVxJK0ewWt3e0mxd2XmphCKSI2dUss0JRUZhtWVFh3FvXVsVstgOXM2jpe8J/eT4ZmfmeGt+HlQfjGzj90k0J2UnsTVBRFHCvzQTf+eLIgABKTvrHEUIZVS8hXRbWd+ys/V2Y+lt0+nY0g9+DxiVJFYacinkwwn0J9AdWlc+HJVQlT6AzDzY/WV/odThVFlFy7lMEcsq2riSlqcETfAacR6oApmQIdKPWwWIQNuiqxXStOQYkHZIZMm2M9jtCDWPNsu0W46rtM6N2RsgSCaOgghz4dP1BjaKrNejkb8X9UUIs1/UvN+HRw2yU4YToT9VNq8qN16ze+V2E4ozs1+rkRKqkpMw7JTdY9g9qB7sFqgivU1DQg0p9KdvEc4Wcyn1gb4bY7Dnjm9eyM+RaQGEQKYRm5SQBqRdoZsNst4gTUNuT7aIZEg9se8gp1Gh6LvlF4zqLL0t212xUoQPCu0KjdGsY30MvxQzFXxOIAPkFMhJbUQspoRf34RmrTQtJWv9Gl8rLSP2DHmwzrw/VnYPYfvAuvJ8GtC+5paD66oWo+6Wj5nlFqii3c6Eb7MjWL9AF0kJAkPGGkHKqCg6CNJEpL3/SDVoCCgahBjkiXU058IZb6gS2oPqlLVerWNp2+Ig5CKs5VAFUkB2dvPbZ0U7SCewuQPrO5n1K9at1xW30vpcC0KxbxVV0mBrf8NREb4dRvojGE4DeVdV7LihxULUzeZ5Znk5gh1KZnkavJjvCyp2TJsFuoSyBQ1K++AxIQZl3RA2TaD1KOh9wWwBS3JdUcGLCCJr+wNta6I5/M21AE8Evcg22jrbqRWt4US5kUzFrRqgBL1cp2ulpddLvdJvxQJVHkB3LzI8juS+hORImAr59Xl69ooisirFXIrojb4npr7Ye89MspZ+uNcdxc7Qk0CfCb1oyArt8Y7YRBgaQm5h3UAbS343nt+9JCVb3fqWKZ3I7GMFFcta17Kz7nvri1FDXjIw2Bgetb10zYp0kF9RVgfQrJTYhiueemDqdUmUUBWlOyqubw9LqMpJCVQ5I05wLp4xs3wcsfdTVscYhy1uELMHqJqAWvOsmHdJQ2+6t9j2mSZKiRkW1U2DbNpghb0xm/Hai1yTQeFeUowcgioxZ8vSHVbIeg3rDaFtIQRXES1DfXdo8QxINnbX3FjHfqysXxPWd2BzO7C+EWjaKjUNV+Od9aSKPZW98kNLRxsOA8NRtN3yXRi3BpxleELFXsbrWg3EkqVn4sK35Rk/XdTag0HQLhG6pPSZMGRiFhpRpM1CkwOaBU1ilV90/ISRppz8Re/Ul6auEJKzpd61yTr1cooeSo6uzrp158J4UgXfBxvB75TUCSkpKem4p7g6gNj8rpHjpUWsfxCxj5x+q+wewfYhdI/KXvlpQIbpBuYq/NiXFJUpeCuZUQzd1radqoq92reCX6olEcZirimjXUa3A2GXCEMmiBIVIkpsizN1yJjXuH2/BiVoElg1yCoSmvJVTrnCVegpLh2mciSUEl7NfmqW7mqFtivyaOLvQS8LUYq2CAQNpHKbpRnoQbawfkVZ3VTaA+vWzRO+CBwvyQWbTKitkOfBxuvDMfRHge4QuiMYjgNSvdjFE9KWwj4LVKbV2GrfatbeRQDnRmLLUwcoYoWcJOiQ0SFPY/YhE5JMVuwKoZ37Kap9YyOKJlH6Btk06KZF1m0IIRCb4OtsizH5AVRbwGYo7k3DgK436FrQ1YqwWkHT+Ah+Uaopig6BfNSgvZJPlP6o7Kx/WdkAHESaVTNe4EtSzwtWzNMg9CdC9wh296Odk59C7q0r11QUHl7MF2HKBKyBKjr0xe2tJ86isMN1WcLYZ8oujIqifUK6rNonQpeJQyZkJZZJ+jg8CaDtE3+JFQolZBu/Bx2HhAoEXUU0BnRmbunvzgWY5egSMkgeYy6otoCqZ3bWwa/VBTJ7qjVbdy4D5A5SZw5zUCyfbimrG0KzijaGvwSBe6q2V665qNhP7ax89wB292A4smMH5AmNwJ7/XFcQ1VmoSs3q6IuKvbN1tBLt7BdnYYr10jhiHzK6S6pdgi5D6crn9olnrtlT41O12JBmJfbZXgjW9ivrJsi6gdXZ4Eh/ISyF2vFHNoF1VEUljSN4aVewMutYvwFbjFrQcqDcMTNohGy2scMdC3tZv5LNOnZVRvCE/dpZL3vldpxQrFu3Sn8M/eOZdetxySzPT7za/KW3AKMHe80sn+2VU33YVa/43sUeMxvK2W2yoINAn8zaos9Wh5MQsk7H3U+7VE8t6PN81sEyvEmCDA0yNIqsgtISVraYE321bUFKkVYl5FSib0uOfVojawEgrlaWG+JFfQmeqGqaAvlUkR2kYxhOhTRkcs36vhVpxpvvPbpW4yBQyJ3SHSvbR0r/KNA/iiZ864rXvXpO/MKUfYOqYtdi3Vo92GvoFqpXQ5Z5WRkV6LaOJn1Gdwm2Q1lHU4IIsYjjPvNStZ/3PzQG1QeCqO1AgwbVQLaddW0iEsOYBu0vjYUQIQQdFaxhVKna3jpNC03jhX1Z6npbtqAXSaAabFchq0W1DsrqBrQbiK2OgrlFH3ZJRsu9kjulP4HdIewelajTwyJ8y35OvjCzQk7OSBG9MSZo5llOh7ModcRet8zKbjm7QUOX7VoVFfszXav28/5A/VvELn4csj2AJKrrJrBpGUfwIRLLoHC/JoXXhDG+GzsTUyVWT+ZhgPUaWW+g5Oi6Cn4vEGwv+5GJ5tKpqcTXd4SDV2F9K9CsAyFMhyYX9eaaUiFsEDh0JujrHgX6Q+iPSzJatW6VpZ/M68toA2C3XqmM2PuZQUzJLPdivgeEMN14DYIM2c7J+0zoTfhGFmuiv8i7/XML+vwxlL9cxeb5mkRFNFg2qymqtY2on6svSD0uEVNBDmZII00ZxzMTXTQNGqNfp2WYW8emQD4JSK+krTBsldSZxhWUlURzmGvCFCd6AWgZ9+SkpE7pT4TtA9jeg/5xRLZFwZ4n61af3S5DmcSJjj7sNSEt9J25vVUPdm+2FkelfAYnQfukuktIl4hdsmPu6gz6RS/VFyno9kiUIJiuB4h2Sxg0C6wVXUWkjVAMaWaKeueiKSN3payi1IuQ87izLm1DiDaG9znpYkgxGJCASERErNvNoB2sbyurV4T2htKsyvJoPKed9SJ8mxfytLXOvD8MdI+Ldetp7cpnKnZ/+SyAnapJEb4lKK5vof46s271C7QsdRWtjtjpbR2NzoRvYSjCN/T57o2/cEGHaRc6K2imEdEyNkDXLXrQBtah+Ivje+sLY5/QQhgG69LTgKYVslpbzvpqTQihpLf5m34ZxndvBu0iKSu6hXSorF9TNl9RNq8K61uR1Sai8byS9qx3kGQK9t2x0D8KdA8Cw+NAql15gnEYB/6yWYyaxqh9Z45vQ09IiVgc32pH7hdoeWzjQJBdgt3MujXJ5AEQOPvO+iI8V0GfHp0VdSnFPUdy1nKKS0AbaMwji+Ca1yUxYWMmSLYcXSmZulptfhWNjRn341nrF8z8qRZzU8tDIO8gbZWcBQliasescEtpNi/ZOrbIc1TMhz3tlN2RsnsM3UOlv28qdk1P2ZH3l8pFMxO+mbFUj5aEtDAMkMs62tKP05mEb2bYZo3vLinbgTA7K48vw63hhQp6ebCAPSiFWNOey8466wZZmRreusBpmdW5YOqdumRIVuSj2I5qWK/RMoanpLeZy5yL5hagbqUKiNpeN6EpZ+zKcFtZv6KsbwWzjm04O6B7xgs2t25VrJCPe+XH0B9ZbvlwHMjbgCTs9r1Ob71eXChToIqMhXyeWW6d+VjM3Yd9OUYxOdaRV+vWPkOfbR1tMC1aFJ1q4oteqhcu6JO40u4yyh2H+c42qnkVpL6u2rPn6s4FM3tjBxGiDqaAzwOSBnSzQTcKrMeoxBj8U3sB6qFWVZl3kSEreVtU8KcyiuZCCIRNOGMd9KzUT3wRyohd2D2G7X3oHgfScSRXD/ZcZmzuJrwYUzqapkQeetgV0Vsq5+TqhXxv0JovL0iXbLd8l7Rat05rxS/RcOKFC/qZH6BI7KWYYRVRdUCDisKqQduINGE0t/SX3EKM1rFaxu86+08KbVtU8M1oHevXaik0l731FJAs5ByQctilSVnfgmYjo2AuzO/DnuzWZzGntZDnburMd49g9zDQH9VAlTito3lXvhA1s5yajlY7876zYJVZoIpfoGWxvXLGzHIpojd2adotL5q3l36tXmpBnxFETU29U2JWZRB03djO+roNYWVpYJ7ctjS2tRBJaG93lAwJXa/R1Zq8aglNS7Sp7rmIsJxnQRWCYP7ox5E+KbpT0pHZxm5eU9avQHsQaWfd+hkl/LhWNqWj9adCfwTdQ1OvD8dF+NZbqIxf8GUJKKUrH4byZcK3WKxbvZjvDwrFg13QLqn2xX99yMRBxqPpc7tW51XQgWJZl0eJviRBsqKKxtAGaeOkrPZX4oJYUQ862NpLm9CcySKortE1ECAGd5hbiPl+dw7oLpAGJZ8qw7Ey7KxAm8GAgAaaVRHLzU/mBKRYj+TeivnuUOkewO5usN3yPpTZrq+jLY+qjMVciuiNviekgZjTGJ/sF2hhZpJSGcQCVbYDVcUespR8ec733XSeBR2wka5C0DwTzZVR75i1XoeEwe8yF6Ok7BEgJcAOS6WM+WhXaBnDB7eOXRIpdTYHWwHPAJEQxNLcdpBfEdob5jAX25n4TSAPSu5g2CrdkYWqdI+hPwzk05LZXpUufnkXYlKwl8zyfrBktGGAWsyrit27oUWxfPliEjMIDBl2idAlGIRQUkvPvZjDBRT00blMCSlbGlgWtM/KxnbWdWMq+FjT21xYvQy1n1M1pWwNfEkJXa3MNna9JqxWBML5nAE5n8fs3RGwApxPA10OpBNlOFFLbrtjI/jVDVtvA8gDDCewO4L+EIbDQDoqCvauXEsv5osxqdinQBWLOCXNrFvn+8p+mZahvgvrXvlgwrewS6ZgT6WQi85EihfwuM69oM9V8KoEzVbQh2iynroHLSAthMZ31helnLCGImwMkpFcdtfLh4jCGPKiLphbgif21qW3s/W8U/IgpKSkQZHB/n1s7SMl99AdmfCtP4zko2hdeZrtP/ilXIo6XhdBcpqsW7tdcXtTos53y/1SLUZxS9U8W0fbJXSb7LxczO3twvVh59+hP4FWkxMhDuV+VDSwbpjvrI9aXVw0twzFUECCHZVQbkhFYJ1G69jctISmeAz4aGUppFwsAnoaUCLaK3IC/QZiY+8kSTBsYTiFdBqQnRVzne+WOxeKvWdGg5icRvHbGevWLC5IXZqaOTYWcivm2G45sc/KkIlF+LbIu+nCC3p9biyxzeJYU1b6Btm0yIHCpgkaLA3MbWOXYpqnB7WNhaD1TG9A1xtkI+hKCWFFbJqX4ovgPBdxdttbgl50B6lk5c4Se8ysJpVVOJlJUv3SLUJxfMsZGXrryvt+NImJkovoze1bF6cEH0tWtMumYu8yoU/E8azc/uhic66lCjrUoq6EXCwyyr9TVQt8aRu0CegsDdpf0EtQzoEyhGwjQarlsJQPpLZFY7T0Nr9WS1CLdg6QIX9eOxc+5ffORVCsW8dQlaFklg+1oA9EyS4S3gdmCvaxM99ZQhp1LS2LWbcufbGWLOjTsxUIWYl9HscZDI2yboKsW1ibJ3z0WNZlKSvNZh3bz0RzA6zW5NXKBHPFOhb8Wi2ATr/qk/9u7kC3Dx8/1xZVRXKGoT9j3xpTKlGnNmL3d9FCzLRfdq3Ezsm7DH3S0MsZH/a9ORZevKBPdtKEJDQiaIqmGhxEVU1OHQCJlgjmsp2FmHmMVbWt5oS2yYRzImiw7ecQox2XuGDuopklFvszv3foNGLXoUd3O1OxDwMh5xKoUpXRfv0Wo4zX58I32SbYDhr7fEbBvth5+dNYvKDPqTvrkie5fwiKYKK5VUQbs46lrLjtzZ3RdUOkuPzpaCNrH0Il67dtkbKzHkL0FTfnelNHtlKFb8kEbyXydFxHo56X+7tlMUpm+WjdWlTsoUtKl2wlTfbUmW+vCvrvBL0I6IAOWVk3QTctsmlhFXHr2IWZT1YkE5OOojld9eh6Y8K5tsVSWaMntznXkKJiV7VVtGEY/dfjGHM6Cd98xL4gow2AoikjfVbtMnS2ihaK8I19ttndq4I+I4xZ68UXN9v43RrCxtao2njG4X4vn+DrgGoZQVlwhOQEogjl/Akl0KDhi+eBOc7lRcdQlRqoon0HXUfoO8hmtAVu3bo4T2SWa5dVS0Ja6BJhKNatSz/Oz2NfC/qIKCEoDBBJimjQbCb3smoIq2h70NHvbZdFR+ekkBLQFVfABHmNti25LYK5GPf3DtdxXgIW0mEKdtJQhG8ls7yclwcRQP0md2G0jtiTKda1z1p3y8MgsxG77r/v0t4X9Np9i8KQaLKopowMDbppkINVCJtynl721vf8Kb/SjGERqWStpwFdJ2S1RtdCWG/sOrkK3rmiVAMmSQntO7NvHQZiGohF+FZdF10yujDjiN2sW9naOTlJzCAm6+Wy2d37gl5R21enCObISjaPXHu6JUITRyW8a3yXozoBWs66TEETxeY3qFjOerGODa6Ed64C4+tcSrfXQ1dG7GkoI3bx1/o+oIoK5ThEzfFtawlplo5m9teXztjs0hR0mPRUIoQEEVOOkkRZt6Fax2prCW6xFnXXYV08NYZbxIQ/s9+zsqx1Xa2gbQnUa+WiOeeyMQWqSDYPdp2Zw4R5qIpOnbm3GwswCxHWrEiy3fKqYJ+Ebzqq2C/dwsGlKuhnVPBCHAKkIpobRDW3wbrAhkBjQS9crutxZZidNdV0qJCzieaGhG7y5HZSgl6iT1WcS0cJmBpf2z3sdiZ6S8M4Xg9jHfdX+GKUDxzLl89In9GdjdnD3IN9LlK8bJfrUhX0OTXkpeR4U8bvQQmaFdaKtJNgLrgSfjnqrjrYdGXsUgDJJWu9QWLdW/cRvLP/jAr2XLQiw0Do+5JbXnbL8c+cfaBat5LEVOy9raPRZQ192S2/BJq3z+XSFvQZY9CLJkIW1aFBU4OuG3TThrAyK9JqeHnZr9llJqgSc7b1nfpBuFqjaxvDh7YlNA22te7jd2c/mdzeBuvKhx56E74xmsQ4+4BqGbFbEVcdFeylK5dLsI72rFyFgg5FBS9myadJzHs361QS2obiReqCuYUJaqsg1LhIEXK1xMSEKBqLHMW7dWefqK9TkXGv3FTsZhQTpO6WO4ujOq6kyZDRLqHbAbpMSCZ8i3KJx+tP46oU9EmEhY1PgGgrCapJA2tBVxHaOKa3uXXsgszH8IMFvYhYkWeVkVVLaFqYjeCvwvvNubyoWNKgphJINAxm2zr0kFOxrBb7w5d+dnsJmQeqiFpDlzI6iHXkXVL6NAnf9s2H/WVwZQr6XDlagl5Cdf3ps+qmRQ/aoNU6NgaapR/zdWZuHZuz3SnXEXwa0HyAboDVym7OvFN3lqQU8zwM0J0NVKmFPKibxCxOCVQhiwV8ld3yWM/Jq4K9TlGu2uW6MgV9ThXMidnHSha7yFTTh4bQKtpEG8N7sVgWEQK2sy6Sx7x1LeEv2jRojIgL5pyLRLWI2CfhG/2AFuvWkCzm9FJYgl51ZtatFqhShG+7BLsBerGjvquuobqSBX1ONaTpBXTQkARdN7BukHUTKNaxsVrH+gh+OdTuoGN1bxKBlWWty2o1CuZCKNGsLppzzoUpUEXTpGBnOLtbjsrU6TnLEMqnQJ3Gzqxbw5AJ1b5VroiK/fO48gWdGvRiIzPKRZfcIqKKtiGs7SrH4MGFSxNKepsOZkKjqbXuSAQpnVBsMIe5pR+sc0UporeckaFH+h76HaHviTlNCnbvzJen5EdIto5cdoPSZegTzSBEmWl1rsPFug4FHbDx+2xnPVDGuaoW+LKKSNlZ1+girEVRNXGR1KOSUK6VgArarsasdVww57wktAg1VTKkOmI317exO5dclmX8FbcodYqXLbdchwy7pKFL5vxWok6vnOjt87g2BT1gh7JgY90+PymaC7ppYN0SAh4esjTFdzGoWLCFyOg0p6sVul7Dal1G8B7K47w4WtIBte/RWsRTIs6sW/01tiBzFbvOrFt3idBnZbB1tJj0+voAXJuCDrMXhI5qR60CiqyqqrahvjIBVpw5zDkXzVwFbytBWvbWJSdEZ7feJeTFxY3Oc1H3yiUj/YB2O9h1Y2JgrAp28M58Scp4XcfzckG2gyWk9Yk4erDrpIW6bpfrWhX0OQKEaRcxkoqgVQPrBlYN0kZ0Zh3rQS8LUSx+gwDJrlnE1MfkNbQrpG0IsbFrVf7PL5bzdKZAlXpWrjlNwre+J6R+5vhWz8qvW3XYA+p9vegkfDsTqjKzbi0mMdf6Kl3bgn4m6EUJg6AywJBV1y16oMi6gTUhrqLvQS/JfGddhKjJVomGBKsB3WzQ9QZZQaChiX6tnM+nZpbL0KN9Z4W8nJOHGqqCZ5Yvjdbz8kGQPql2mdAlU7DXQl62Da79lbq2BX1GUMtXDxk0CWQdBTKUwENtIurWscujSlD7wNWQTcCEWcaiAqsV2rSjdawbfThz7H0tJVRldl7edxaqkifrVn/lLEzJLLcRe0a7rOyShaoU4Zt7ADyBF/RCNQ4qxgSxS+MZO0OjumpCXjeEdlJWx6Uf83VGy9ZCTtBDFEFThiKay23ZWw91AO/j9+uOmUoV69ZhgDSMHuykoTgWmnWr3wguS01H02oQMyTbLa8K9nHEXrQ0frkML+iF2QsiiBD6aR1C+gbdtKpqw99a1NVfR8tR43BVYTAVMikhaY3kjK616B5aYu3Wl37MzmJoCVWRlNCuM+FbMYmJRfiGW7fuB8XxTQZBuwRb2y2vgSp1xB6uzXL5F8AL+lMofsChfKlYak8w+6igqwbaYFakc8Gcc/FoWW3TUH6v1V8ARQmtoG2Dxhqh6yei14kxs1yyTXCGHop1K2UdLVbHNy/myzLulWu5VrZbzq6cl5fPY5+MfgZe0D8HUSJC6FMZ12VlbTvrum6gbYhNILoKflmqdz+ZSF/W3JLZxtad9bYlUK+Vq+CvLjMVe87WlQ9mEBPKbnnICbL5e4/f4lw8tcsu6Wgy5JJbngl90tCLdeZS39/OZ+IF/VN4UgUvYiN4W5tQ1VUo21QoEY3Rb/CXIkwXK4gZgGgxoZGUrEPDyndoGohxugFzriA6pqNpSkjfo92O2O0gpakjPyOo8lfDItTd8mrd2lluObtBQ59ttxzcZvdZ8YL+DJSs9ZAByQBEgopoIAuaG7SN5DYSZoXdX4ALUZTwqBABwcbxpGwq+LYdrWODOwJeGSyko2Q25IQOllsexs58IObsu8p7QrVuZQpVKZ151nElzU9Cvhhe0L8YQYEkBB0IKasODTo0yLpFNxb0EpvpnNZfi8th64iZqF35gB/Q9Rpdr5HVmrBaEZuG6OP3q4EqIjKuoulghTymNO2WO3uBKjZiN+tWpUswzDzYS2fuxfwL4gX9izOe52QTzElWSoQ3ALqKjDNdF2EtSlD7gCDbzrqolF3kOu1T21l369jLiWoZoJUjsWFA+w7tOhPA1XW0pR+nM43Xy0qaDILuErodoCtub1l9t/xF8IL+HJQRPMI4FopmI6kkgXUTdG1j+NDYTmv0JnA5qnVshsgws/xMsFohqxW0q3EE7yPZfWd6M6mqrSmmZAV8GAj112rdWjPLvd27eJ4IVNFs2Rn0Gfpi29pnm3rmyYrb34DPiRf052C+/6hKzPahMXoMH7Sqsgp60BKIlt/tBpLLMbeOzSaKMtHcgKYVKge2lriyou42v/tOKdA1szwN6G5H6CxQxQxi8iR880K+HLWJKYZdMmRklyzqtE/EYhCDMAvAWfpBX2K8oL8gZYwUxIwOZH5Op8A6om2DNMF21qOLsBZFdezcpAqoKNoIEbRt0aZBYiAEN6TZO8rIthZzyywfoCvWrSmVwuBj26XR8tk4hqoMGe2yjdd3iTBkD1R52XhBf4moZa3TZ4Kq2ovYMtZl3YSwioQQp6LuI/jlUFtxi8mc4MkZTSvbW1+tYdUSmkAci7pfrGWxMbuqlnXEYcosHwZiSpDTmFnuBWJZRn1KsW7VIZnbWxW+JS/m54IX9JdLUAhZ0FwS3AZBkp2vK20IASJxHAP7i3k5Qinq2hcP+DRY16eK1A6vaYl+rZaniBm1pKNJ7cj7vhyjmMrRr9EeUMVvSdA+Iduk2llHHgchjh7szkvHC/o5IBAodqQUsbuNnpSsQVcR2gYtI3i/S12QYhVLKQjVQy6KQBZYZaRpTTAXo68jXjBaBIwUkxjSMDq+UV3fJJezV78qi6IlGS1PmeX0WcOurKRVL3b1QJVzwwv6ORCYinlWInlMbtNelE0T5EBh09gIPgQi/vpejNqBq0AarJinhAwDulqjmzVhtR694H0F6oKoK045IyXe1AJVEjGbD3tQ8TfOktTnvsScShakS1jMadYwZGKyG7IwWrd6MT83vKCfE+O6hhJS2Vk321hEZFzM0BXQBDRan+5NxoLMBHNIhpzJItgpe7kwMaJ1Z90v1vlQJiZaVezDYHvl3Y6QBsimYK+55V4dFkQo12omfNtZQlrospnE6EzBDn65zhMv6BdAtY4VhUQdsatmDawFVhFZNYQmEppZepsfM108Oq1EBU1EnRK7SCvbW29X0DQl6KWuuPnFejHqaqFtHkhK4255mO2WU6JOp+fcq8OFM10qNMtk3ToI9InYZ8suz+LCt4vGC/oF8ETQSxwyZEV7Ud00QTYtKgqblhgisXER1mLMd9YRYh5QzZDq+H2DrBVWK0LbQohE9xh4SVhXLoMJ37TvCN1uOiefian8HbIg1WXR0ieRXVbtEnTJRG9JJm0KfpUuFC/oF0x1QpJsXZ+qBtUw2pEWhzliQINnrS9KzVcXQYOM3XtQUBXrJpv2jHUs+PX6othr38brJPPcp56ZVxV7+bP+3C6L1r3yOmLvLK+8hKqUdTTXJy5BAIIX9AWoTpTFPSmCVtEcQ4Ou26DrBlaTFakLsZYlqCV40UOUjOYVpDU6t44NYcxZ98+zZ6OK3rRmlg8DOgzm+JaSOb6VltA1CwsxxsuXQl4NYupofR6qosWzQb0TuUjG7ZuW6fTPn/8LYvZEBxFCb6seDOZzLFntHRFaaCJW8X2suzRBlKAmytJsWeua14gWY9+29U79WSmhKuN5ebcbA1XqiD2qrzjtBYpZt5amQ3YJtpaQNgaqyCxf3m+8LhSdfUkL9DB2gQ3+3rlQqnVsGWVV20pV21mnjOBH61gv7Ati14hgmwtRi8tctbjMlrVOjPblhf2paLHc1XmoSt8T+g6eLOZeHJahduWzQj7ulnelmPfZA1X2hIzV8b4FjrFCvgY25ffOBXJmxU2Iionmhqy6boMetOi6gTYS2zAms7qwegFm14rqUJbN9ERXK1hvkPUaWjOjaULV+F73izWzbs0yWbf2nanY6165TFoFL+YLURNSymtbhox0uZyTJ42DmS4F0VmS3dIP+voiQAecAl0LvIsV89vA68BN/Mx2Eeq+puZynh4gq+oommsQIDSlSPgkcgFmKvjypZLtfD0nEw1RxENti9T0tutenKp1a87oMJiKveuI3Q6SJeCNjorOskgRfebiw96V3fIuaejzmUJ+zV/Vi5OxQv4A+Ag4bYH/H1bMvw18Hyvu66Uf6XVGahiIBb1EUBUNmgTWgqysWw9NHFXw/sZaiLl1LGCdjUBew2qFtiukaWxvvYjmrpOPtcKUjJYTOpzdLR+Fbz5d3wvMulXRlKHP1b6V0Jvr2yR8wz90FkaBHXAf+A3wK+BxC/x/gS8Df4F15zewAr/Cr9kilCc9KDba6hSSqAW9CLJR2LQhhDDurM++zVmAoFoczDo0JxgGZL1B1xlZm21sbBrgmnU2qhZTO/Rob19h6Il1t7x2etfmCdlfVEGyWle+G5QuWUORhJiLMRZ+rfYBAbZYZ/4O8DPgX4C7LfBvWEFX4BYwAN8AXi3/vMbP1ZciFFEKeRLNIZMQS9sITcAO1l2EtSRB1URdIaMiNo6vNqaKCeaaCOGKC+ZmP7eUzHLt5l7sAyFnoju9LY/OdstzXUlLsE3QTyr2M9atzmIk7Lz8EOvM3wd+Xr7eAO61wCfYHD4DJ1jF/wHwR8DvAV/BunZnAXT6TchC6KGxN58yNLBugm4adNUQGkqAyJPf61wos6x16hl7SrBao2sbw4cygoerUtKqLNoKhJSzcoYps5waqlJudq7QD3+5mH0+aIk5lcHG66EEqtBnK+biKvZ94hT4EKvRdcz+6/L7j4GTFiviHaZ2/6j84Xvlm/vyF30NU8A7F8z8TaRKTDJaLuoQ0dSq6srebxqJTbRY1qUf93Vlbh2bc4lhzWgz2L61HlAVEiFG4iyS9XJTdARnAlV2hK4bO/KgMgoJfW67IPVGXxRSRvpsCWllt7yO10NdqQUv5gtS76VOsfr8BtaR/6T8+gFWuxOQWiAF+9r1cNRaEY9Yx36MtfffBr6KjeFv4Nd3EWrIS7ZYVpFZC64KK+vUpY22sx6vUgd4CZkL5mpXGsqIc2Wrbdo0SNlbv6zixsm61dz0ZBhstN7PjGKqin3pB3vN0dEzQcZ0NLps4/UumeObB6rsDQlruB9hHfhvgV+Ur18Cb4I8nuuim//3DyZB+xo0Qw524P4IO3R/iBX2esZ+Ez9T3xeCFAezsheq9Xg9hqC1qPt6214QMF/4+b61Yi6AxEgIES5V0EvZxVBFh4T2PdJ1sNsR+o44DEXB7gViH5iulSBdUtkmdDsQukTsMjGLX6s9ogrfPsR0bv8T+N9YZ/7r8u+PKEtRlbY2ean8DcHG7x9hhfyT8nUP+/fVKvZVTCy3wrp5fwFcPKMKXgRNES2jsnnnrk0cd0x8yrkcoXRFdq2SBZGIIKWoR0CbxsSNlyFLTBWlZpabD7t0Hdp3xLqO5rvK+0EVvik1UAXdJaS6vaVMrCN2Z1EUm4xXo5j72Dn5PwL/BLyF1eMjxuPwBqve1mO3n/KXgu243cPq/FC+6xib2X8H+BbwJaxr9459IUbrWIGhWPgKqKiSJOiqQVdlZx1Pb1uWsqkQgonkCES1okg2pzltWhPMxcnaad+ul6qO1q2kYRS/hb6GqtgEwn29F6SaE5ZAFUmWFVFG7EqfiIMJ32KeFXO/XIsyAI+Bu5iC/U2soP8M68o/wWpw/rS/4PPS1hI2ek/YWfp75S/+6/L1Xew1cHvpZ+K6MlOshKxEzWguorm+UTYtetAG3VCMaIJPVJakKttVIA00Ug1XWrOMXR+gZW+9Xqu9ohaInGwVbRaoEiVPCnYv5MtSfKlU1AKf+rOBKjHbOpqL3vYH5WyN/bfy9RbWWB9iI3j5rL+k/b/+4fjMv/j7//bK/B8F69R7pjuHh0x3CDvs0P5rwB2mnXV/fSyAqu2MSihuT0+M31cKRQVfW3W/TgtRLH5RG8NLOVev21yqCjGO1rEsHcpTd8tzts58GKyYd7uiYheCyv7dgFxHiu/BKHzri3XrbiB2+cxeub//l0WYdssfMxXzXwD/jHXmHzFtm/3OqciP/uHwzD8/ax66lK8j7DC+wVr/94A/Br7HNIZ/deln6TpTlfAlzjCaqlo1ZVi3sG6QVQy0jbnMheD+2UsxPu8lgpIpH5z1yvbW2xW5aQhNJFJX3C7qetUVvLKKllMZrw+TfWsaikOeG48syrQtWQxiBB1stE6fiX2GwYv5vqFYIX8HU7D/pny9CbzNpF17Zp61oM8fwHH5H/0EC3b5gMmcpsGEcrZt6y+aC2dmGhFQexOnbA5QSRBpUW1tJhoi9ajWr9MCzHfWAbLZoWpKaFqhm2Lzy4oQWogXfVxSgmZKZrn0PdrvYFSwy7iW56+fhanbLdnOyaVLqrsMnZ2VxyTjXjn4+31phGkt/D3MtvVfsR3zt7FJ+Al2pv6F+J2C/qPZCP6J8TvYi2awr3AKuiv/3M9+fQR8HevUb+Ke8ItR0tuYhYcExdKURFVzE8w6NqKRK+ZcdsnQWRTlLEI0FCU5ImjTIjXk5Zyvlc5MYkimYqfvJ/FbTtbp+Vn54qjU4xCxzrzPyi7VUJUiUvRAlX2gKtiPsaPrDzHR279g4/W3mZrjT+VHTxyTz/miHfoMBbuL+ICpkL+PJbb9OfAnwDcxwdwL/O84L0wgCJCEqMkMQIYGXTcqmyaETQurxpPb9gTz688w9DQituO9WqHrNbpaE1arMbkNXn53XMf+UkbrOvTFg71at2Z/jSxNddpV08noUM7J+2wRp0mIySJQo6ej7Q09Vsjfw87Jf45Nu9/BzsofYbq05+aZCu2Y5QkoNTJKgZDLg6g7c+9hBf4Ue/1kTDB3G7OOdYX1AtT0tmwe41UsI2Yjq/X9TmuhIRp8Z31pgphYrorQJGdLLSsC8ti2FvICL08wV4RvNmIf0L5DdzvrynMiZBlzy+v/rrMQgl2v+l7eJdgOGnYZkmWWR/V1tKWZVDKmUK818g3MJOafsGPrI6xzT7ygQuaZrvOP/9vN2SM8U9Cf/LtuYgX8T7Au/fvYatvvYdaxr+Ge8Isxf3PHgDQRWUfYtOimDWHVQNlZpwlFXY0bTixFrd4hIk2DrFboag1r69IpIS/mMheeY7pSl5XtnFyr6U0y4ZsW61ZSIoqUAuEraYswD1SRqZCXETv0SdllwpDHQJXogSp7QW12a07Kb7Ex+88xRft9rJA/lc8arz+NlzkKV+wu4x42WvgIGyf8KfBnWIJbgxf0xXgi6CVkoelsvU37rLppgx60yKYh0EBb9qCnz33nIpmL5iTTDDYK1zTYCH5zgK430LaEGGlCLelf8GJJGbGnhPQdodsRhoGYk3nQn0lH8wqxHKEchwjSZ9XOok5DN4s5FfUkuz0iY/bpNVDll+X372F18jNNYp6HZyrof/cPTz+jf4porrrJHWFKvQfYqKHDRHOCFfvbTNaxfm67AFUwJyamIUfbbysHLLouZ6nVOtYFcwtS1hBFCMHWx5Bc/guoChTB3DPvrBfrVupYP5kXO90O7XcWqCIeqLIXnMksN9Gbdslyy3eJMGRze8Ov1dJU69YBOwt/hHXkPylfvwR+q4F7Uci5gSbDnUN4PFv2/qJd+ZzzEKvV/qDH7kJ+hRX0h1jX/kfY3vofAK9jhd1ZCK0jdYEeoqKaJZCasrPemGCucRX8XqAW8MJQ7ChECMMaVit0tSK3xTo21PS2J7v1YIW8CN90GMYRexh3yyfHN1exL0/NLNchl93yol7vswldx91yd4paGsUK+X1Msf7r8vUrzPHtA+BhULKG4tEdzhbzF+W81ecdUyrMR+WHfAtbpg+YSK526+4ytQBVMKcQkqKSIInqIGYZuRGAEEJjO+te1BcnlBG89mIrZe2A5A2SM2w2ZhnbTFfo7LWyYi45l3S03WgSE7OdlY8rc17Ml6Wq2LOgfUKLdat5S+iYjgZ+rfaBzHRe/iYWqPKPWIf+CVbzToEU1Ar5efBCBb2OBp4yep//kNvyVbPVTynpUuWH/CYW8vIKZkjjQS8LIWrrbSLl9/PdaKXurOPWsctTO/VSgEM5QtHy37RtIU5bC/V7quubppkXexoglXU0F70tjzKelWvdLe9S2S0vXuwlHc2v1PIMWH17jBXu97CO/J+An2Kr3MfMTGLqqD0KDKvpL/p//f3zj9orF7kf3mFnCvVJ+AQTzf0Qs4/9A0whf+MCH5MzY5bQFATikK0IZFHtM2zaIJt2VMLH+Xqbi+YWI0gmplLQi2iO1QptV0jbEkIZvEsmpFSsW2syWrJ89vk6mnPx1EXxMR0t10IOXdIwZBjEPPNrMXcV+16w5Wwy2i+xrvxd4GPgGA3DRe0KXWRBr+cL97C7mffL12Mm0RxYUd8wvVb9NXuB1Ce7dOeN2PmdDIJmVSBoedUo0XfWl+QJFXxQQcXWziSt0PUGlRUayjxMbMwe+t6K+ahgn521+8VchjHqdApUkc4S0kYVe7lOvlu+LDr7OsXOxX+JOb39BFOzv1/+m1m8Br2wRaFzfU18xii+/m9/FdtVr13697GQl29gY/ib5/0YnWdCmoCuGvSgDawbdN0QVg2hLXvr8Xn2oJ2XR2nXQkDL3rqWXfVx5C5m4xqGvnTlrozeB1QpNrtahW+2W95l6JLGoXTlfsS1F9RNrntYMX8Tc337Vfl6m6CPP+uQ/EVU7J/HkpasNf/119go/l1MMPcD4C+w/fUVroLfB4IoYRCQQbXP6KZB17azzroNYVViPvEPnWWYnZNjymdVtfNxzp6hM9sr92u1LNaY63hOrl3xYB+k7JbXfHm/VvtA1YR9hJ2P/wSrX9W69QGf48N+3lzYi+RzuvUV1pH/Ptap/4fy9YeYu9wNPGt9byjdet40yKaFgzaEdUtswhQc4h9AjvPplMxyLUda2iV0N6gWt7dYhW9LP05nTEbbYtkl97Ai/n8wFfubmOfKEZCIMqneUjv6bP7ofxxdyIPdl9CUAdtTV2ykUU3sv8+0s/4VTAnvKviFKFnrZAiIrRmK2tn6IEHXDbpqoJ2sSKO7zC3Hp+Xc+zn5MsxEp1ILeZ+hWLeGeWcufla+LySsFn2CrV3/Bivov2Qq5pPjmyy7fb0vBR3siXvMVNzrk/cfMdFctci7g7/GF2Ee2SRC6JWmrNVI36getHCjiG9bG8G7EHdBvHDvF1X4lhVJUkRvg4ne6jm5W7fuFYLVpLqK9q/l6y2m8fqu/Lm9YNHXzGeM4RtMEPf7wF8Bf4ON4r/DlLV+AxvVOwsSQENA24hsGvRgFXTTFsFcIMZIiD6Cd643OtosK5oy0meky1bQ+1xMYtwGex9QbEJ8yhR1WjvyqmL/kNle+ZOcp+jt89inDn1Oxs4rPir//AgTHnyfs2P4l2ia5zwPdeUp2QheRZUho5s26Lohr4oavqS3BfX5u3ONCKZD1DQq2FW7DH0iDmKub1m9mO8RtSuve+W/xibFb2PF/T6fUcyXZl8LOtid0hF2p/QJtiLwMTbq6Mpjj1inXm1k/Q2xAHU/dshoErCddSSrGZkBkQadXSC/Ts6VZ3R8s2Iuu6Ji7zJxSKMHO+74tjjzUJVjrHn8Ceb29kb557tMu+V7Kw3amxfSZ6ngi/ftq9gI/rtMkazfw6xjv4wJ5mp6m7MAVTQXTQUv6zbIuoFNC+uys94GQgwe9OJcaVR0VLBje+VjZ04vxJyLit3PopZGsHPwx1jRfh/ryn+KjdffxRrK7Wf9JUuO2efsc4c+Unb0qyvPlinN5o+Bv8aK+zexoBc/V1+I0b4S85vWpCELmjI6NDaG37SE9aSC988y58pQ2jatKvY+o7vJujU8ad3qxXwv6LCp77tMbm+/wQr7XcwrpV/6QT4re/d6+u9/N3XqNV7uice7wsbsr2Md+n/BlPB/hNnG3mEKefEEtwUpOeraRGQVkYMWbqwCm9a69RhKfvcevg4d54tSfNhHFftupmIvq2i+W748Zr007ZbfY1Kx14S0t7HRe1/+3Jnx+r5040/jUnToM6oCcWASJkTsrP09JrHcN7AxvLvMLUQ1Ow729gmoieYUJYnZx64achsJoyENFxVh4DgvhzAFqmiSMbecPhO6rKFPFqpS1tE8UGV5AtaVf4J14fPd8npe/gBbo750XLaCPqdnEiq8jyXc/Hn5qqK5ry79IK8rsw+toMWMRnIx02hUN03Qg5V5wq+b4jK39IN2nC+IalGxC9JnlS7BLhH7RKwGMcJk8uOv8cVJ2JHtG9g5+S/K79/F1tS27NFe+Rdl7wr6//Xjp48zzormgoImkAThBOJD0BMml7naxZ8w7ayv8RH8IpSs7uoyR7aDRiUEs8BUC35pAuqCOecyoNNueenKTfRmcafQZx+v7wlVwb7Dmr8HmDHMv5WvXwJvBY33NORSyKu8Z5oX7vOYfc7eFfRnoz7RtT7LAOE+dg5yip2LvI/trP8A84R/HR/BL0pdzxGFPtMoah+GAmtB1k1gFcfzdV/ncfYVVTsnp89on5Q+E3ohDHk8L7eu3AUiS1Nju+9iU9xfMu2W11CVxxpEzl6py3n4d0kLemVe2HWHOfg8xi7Su0y5tCURmttY1vol/7kvJ3UHXZWQz3Q3yNAguVVYhRBCuVNzwZyzZ5RQFcmC9gndJmWXzCCmBqqUWFo/Q1qeOqV9gBnF/B/gf2PFvAaqbIEcZYXEgTGHeH9XzT+TS/eS+/v/dnv2T1/CtA0tTzz5VQX/bSyK9a8wFfzvYSEvdQzvQS8LMbsV0yYibazJbbBuQs1aJ84Ec0s/Zuf6MQaqlN3yfEb4proboMuEXIq5TNubznLMC/nHWCf+a2wl7afY+vMxZ4RvARA0QJSpLPzd/zhc+mf5QlzVTrXD7GKFaX/9+5hg7k+wQv8NrKg7CzD7oAxZiQhBk31Yrhtl0wbZtLCO0ESaUtQv4T2zc1kZK7OiIsggyJBhl6DPWmNOme+WeyHfC7bY1lMdsf97+f0H2HFs1VtdOa7M6+8pTnMB68AbbNT+h1jIy18DP8Qc576G7axH3Dp2UcqHp0aQtkEPWvTGKsjGvOBjE2kio2DOcc4dBaUGqogFquwS7AYNXQ1UmXzYneUQpt3y2sD9AjOK+bfy63sa2Aa1PfSg6Nzj5LKI3j6Pq9qhw5StXpXvESvu1UzgYyy97fex9bZbSz/g68yZrPVsIxZVjakNrAVW0YJemrq3jovmnHNDFVQEimjTcssToc+WW15X0vCufB8Q7Dy8aqd+iwmkf4WdnX8QlKP5N+gVvWhXuaA/yWPsAt/HLvrbWKf+11ixbzEV/BW91JeCqoIPfbbOaBDVobFoVlHCpg0hRGIMfp2cc8Fiy0shr4EqfaaO2MfMctd17AWJKZnzJ8A/Y5/z72ACq0fAtuSBXHmu3I/4WSEvhRZT0/0e5gX/t9go/juYkO4WNoZvr+Lzc9koQS953VTRXAjrhlhX21ww57wsquNb3b7oMrobVHelmFfh29KP00Ew4dsp5rVeV9L+qXz9FpvCHmNjeDRAk2F3AKtZ+Omn+Z5cVq5Th15J2F0bTC+Kjzm7s/5V7NzdVfALUcVvUrPWbc2NLMrQBF036LqFUthDgOiiOeeLMoozLe7XnAwTdLnslpfx+kz4Nn6fsxgJc3X7EBupv8HZ3fIqfMtLP9CL5joWdJiK+g4bwb+FjeAPy3+rhvx38KK+CHPrWBHCEAhZa3KbSm7LEboFvcQIJYzScZ6dUszHzPIuozVQpXqwixJQX0fbE2oxfxcr5P+Kjdl/y/SZ3nOJ7VtfhGvz+vyMUXwAbmKhLn8B/CXWrX8Hi2T9EjaG91jW5dFY0ts2DXqwCqybKWu98ax159lRKeZGeRK+aVfiTrtsN5I6uYw4y7LDhG81He03WEH/GbaW9iGfsYp2VVTsn8d17dDnVGvAj7AXxF1sjPMD7Iy9juG9oC9PEEtvix2QVXVoStZ6g67bEFZW2GNJwXKc3yFggSpZalc+jtdjcXxjNl73Yr48gk1Pf40V718xjdc/5BKno71srt2L9VM69TD7ugV8Cyvkf4YJ5v6i/LvqLtfgd+6LMmatB3TTkg9adNPCpg2xLelt5c/5NXJGinWrjdgTskuquwSdFfMmi0f47gE1fbmuHB9jxfufsbzyX5Z/voutIevs+85wXTrzinfoRn0Bgd0JVnrsBfMQy1r/fcyM5g4e9LIoYlcsECzZSkGyQlZlJUFqyEsT0BD85ssp1q1Fh9GbdWvtzBnMvtVeV34XuDSKfe4+wian72Ad+c8xw5j3sNH7dukHum94QX86W8xt6BTbZawj+P+AdesBU8F7UV+I6uahTKEYZYSq61Z10wY9aAmhrrf5Z/R1RsVU7NJn2A2wS1oDVULWmXWrv0r2gR02Rn8Hc3r7F2zMXsfrR1iz5TzBtX75/sN/ncbv8vRnosV20l/Hwl3+M1bUvwt8HXgNG8Ov8Kz1xYmWpy6rBjlo4YaJ5p4UzF3r1/x1oirYS2cuyURvelpU7EkIAlF9t3wfyEyhKnexLvzXTLvlbzEFqvzOOtp1G61/Gt6hfzbVhUiYIlgfYMX9+5hYria4ebe+EPOddTXr2AioqDI0gXWDrhu0LWP4UAq7i+auJkUQOaajDdOIPcx2y8nFurUGZjqL0jGN199k2iv/Dbai9hgXvn0uXtA/g5lRSY+N3g+ZbGPrPw/Y8/gVvEtfhPnOuiohg9bktj6rHrRBRdGNOQo0bfTP76vMrJhLl1VsFY3QJWI5nqkbEL5bviz1lnrAzsR/hdm3/hwTvtVC3gGC33l9Lv70PIWnKeHrEyXQBttP/wEWxfpn5dc/wHbWXwE2eHFfGsWy1nXTIJsm6KaFdUOsIS/RxvDg74OrgCq2V17cBbXPqn1COgtWiX2mESGoCyqWRrGx+RZriu5hI/Wfla9fAW/JintxmCnXn7CC9DH77+Id+jNSX0cNJLGx+xvYi/FjrGP/Y6y4/xFW2H0EvyzzoJcgqpoU7QVdC7ppQlg3JppzI5orgWr1YE9oVbDXQJVkUafXIqDjElBV7Hex4l2L+JvA++XfH8aes+oGPyL7XLygfwbz188aO0hPdkS3xRSXj7GC/j42gk/Yc5qw1bYDJkMa/yi5eIIqJCVk69okCZIFUVUtWvnYxHGv3a/RJUS0FHNF+oRuB2WXCIMl9kVRorpLzNLU1eABE7dVy+1/Av4XVtBroMoOECIgpTGP081YuJamrs+Gv74/g/8+G70fMMkwn3jSDjC1+x9gHfqfY136H2BK+Jrg5iP4hag3ZtFG8NJGE8ltWsK6CawaWEUbw9f0Ng962V9mgSqWjDbtlmuflV2JO63paOpn5ftAYhqvf4BNNX/DZN36AbN0NMAuWCnoMkvU+L/+3kftn4Z36C9Oj3XqGXvBvoON3/8K+FNMCd9i623OAtQPcoWQlahihWAQdN0oB21QbZEVhDbSeKd+KVBRZBCkz+guEbqkoe6WF+FbGbw4e8AJNsl8AzOH+RkWqPIR9vl5yjUNVHmZ+Gv9OfgU+9hYvm5je+p/gwW9/LD889ewot4yWcc6CxFAQ7Bu/WCF3mhNNLeKNE0klqx1N6TZM9TOypGSjtZbQho72y1vko7riH7dlqWcUI675R9gyvWfAT/FlOzvrum3AyuUoD/kmF8wfba66O2L4x36y0PK12PMFCEwiebew6xjvwN8AxvBOwsiQFBiFVGpqiaxnfVVQ15FQttAU0bw6gViUUrWjmZBk0A/7pYThlw6cy3hPd6V7wOKjdDfx8Ruv8XOyX+Ljds/EuJpP9MOz4u583x4QX/5KFMub3U8egcbLe2w5zxiOruIF4pFqJ236uTjPWSVoUE2LSotEEIIpVufvs1ZABVQETsr3ybVLqGdKdibOmJHvZDvAVX4doJ95v0U+D9Me+V3sUanW9MzsCK4WuWl4a//F+AzMtYrEVth+xZ2rv432Bj+O8CXMSV8tY71a7EQ1a8iBuvO1w2yaWDT2mpbGwkxEiK+4nbBaDkLH0NVuozuktIlGMSMYlTd7W0PEKZktEfYZPJNzIf9n8vvq4pdAQJKouWI27zOw/Ev+rt/OFn6Z7m0eId+vtQcX7C71uo09wNMMPc9TAl/BztXdxaimJKQshUIG+2q9g26aYNuGmitW3cV/DnzhIpdBivk9MmsW4dMGGpmuXrc6Z6QsFTK9zH1es0tf6v8uweY8M0v1zniBf38GbA71i22q/42tsO+xZTx9etVpuvhzcYFMreOzUoQKR2hIKuMiu2sg23PxCbU4FbnPKiOb3kSvul20FB2y8dktBqq4hdiMWpx7rGC/TamYv9XbL/8N5imqMc+B13Ffs74e+Ec+NRRvLUeN5l21v+UKeTlW5gf/B0mMxpnOTQEtA3IuoWDJui6hVVDqDvrjYW8UERzzoujolBupsbd8i5DV7rzLGO2vX92Lc+Oabz+LlbA38DOy9/AGpdPDVRxFfvLxzv0i8Q+9WuqUIe94GvW+p8wjeG9oC9PUIUMsUuQRbUXdGOGNLJuQqAhtoFIQPEIzhdlVLF3GemzapcI/WTdikzPsT/Xy1N9N36NCd9+yZSM9glW6PPz/uXO8+FvjHPkTKcesDmtaohJlECQJt5iEsz9GSaa+3Ms/OUWVthbvCNZnADaRnTdkjctetDCpglx1ZRzdd9Zfy7qXnkt5kNGdkm1uL3FPhOzuMviHqDYyHzAOvMjbIPnX4B/xMxi3sFU7LvP+ou8Mz8/vEO/KJS6nqHSRgDVGI6D6EflT3TYm+RjzDr2u1hhv4MHvSxKKTghWUZUVC0rVK2yliBnrGP95utzmQkKVRUphZyaWd5lWyVMQpASquJ3S4tTA1Wq8K1mlv+y/Po+5s++e97/AefF8YK+IM2QkSaeYi5KR9go/k1s9F7XOxQr6pulH+91pS43F/V7LOe8Mgg6NKoHbYCVbb81gejWsZ9NeVGrqoXlDBndDoRdUopBTCNiGRw6rQo6y7LFCvbbwL9hXfkbTNatJ5j4zVkQf6tcED/+f07mcFpl0npGStVgRftLmFDuP2J+8N/FVttq1no1pHEWJAS0CcjKjGi40QbWDbQNsbGcdR/DP4U6Ys+CZrGboi6hu2Qq9hJzGt2Zby/ITOP1u9j5+K+Bn2C75W+V/5Z4yjqaj9YvHu/Q94eM3QU/wMQlPSaa+z4mmvseU4KbF/SFqAYmRTAXyggeEdW+CWwaU8WXEXyMwRbc9JrL4EOYpaNlZMhqu+Vlr7wq2IvwzYv5flCFu7/FPpPm1q11qjgs/SCdCS/o+0eHqUQfYnfEH5Tf12jBFnOZ8531BZjvrKsSMqhkSIKusmpugwqoNugaQoiod+mzzHJBuqzSJdglQm9deZTphufaP1cLU0466LHPobpX/nNM+PYupm5P2OeReyztEf7mWZDPtI61LOCGwDexLv2PsbP1H2Cd+tews/UDvGNflNK1a2M567JuzFlu3RJWxTq2CRDDtes+Vetu+RiqYj7sfYY+EQax83LFE1X2gAFzc3uEnY2/jTm+/Rwbtb/DarjH8NlbtT5qXw7v0PcVBf4Pmf/MA+wu+RHT3vqfYOfr32c6e3cWotShIGqrViJKKufDa7OOZdMQzQx+/i1XHhO+FXOYXdI6Yo+uYN876pHfXUy5/pPya3W2vA8cfV4xd5bF30d7wt//11m33pavjtr+RSzE5TVsb/1Pgf+C7a3/Htap38T21j3BbWECECPSRmTdIDdWcGBBL7G4y9nX0g/0nJj7sCcZrVup1q1lUyD6nHZxbBHTxutHWHjK25jg7X9ijcQ9JgW7WbdqDRSeruCPfuyBKvuAd+j7jn3qC/amSuVLyq/3sZ31P8QK/ZeB20s/5OtM3TNECKnUdoAsytAGXUd01UATCTEQr0rQyzxQJVsh16Hsk3dZQ8kupxTzsRRc1ZuaS0Jmsm59cre8Wree4I5vlwYv6JeLhO18JkwN/ybwQ6xTP8UKfYt1684C1AKlNoKPQ7Yz5KHYmR60QW+oecK3jfnBL/2YXyKaLR1N+ozuEqFLGgexvPmSjgZ+XL4vnGCF/JfYOflPsYJ+F+vYd3igyqXC31d7zOfkrUesG/8e8NeYZeyfYN3617Cd9Q1+07YPaAhIG9GDFj1og25awioSa1EP0znyZXtPqqp96ouggyBdQmqgSpdosoneLtvPdRWp1q0dplT/kKmY1693cevWS4t/2F9eBFtlew+bdj7A7ra/jxX5P8LO1/0aL4wZ/hJzMVERVU0C6wZZC2HVBFa1sFNcgi8HFqiilorWZ6VYuMbeVvliLuP1ur/vLIpiXfk72E75r7H98jexz5FPcOvWS41/2F9uFNtRP2E6B3sfG5llTCT3VaxTb/D1tkWozbcqYZBxhUuG8uuB+QaG0BAvS6euoOg4Ytd5oMpggSpB/ax8XxCsKz/FuvKfAf8LW0l7l6pgt+79Kkg6ri3+PrskfM74HaxYvw7j3vpfYQlu38Hc5V7DEtw86GVB6idlE9A2kqt1bFHB15310TqWPXuPFutWc3yzG5KaV06XYMjErCZ827sHf/1QrOM+xIp2XXv9KWYW82b59yd8ThH3MfvlwDv0q4Ngd9mK3Y3PRXN/gRX5bwCvYt26syCiNpIu4jmGrLpu4KANsinWsfukgj+jYp882KmBKkX4FrIJ31z0th8MTI6Tv8IK+RvYyP1jTOG+ZfmXl/OS8PfdJeeJzr2uSa2wMfuXmXbWa9BLLeq+s74HhIAG0BjRVURvrNCbbdB1S2jNCz7uw856LeYlHS13tlsedqmYxCgB3y1fmipXEGxv/D5WvN/AjGL+ESvsdVMmz74H8E78suMd+tWiGkXUlKQB68YD9ib+ABPM/T5W2F/Hu/VFqefMWrNC7d8xmGhOVw3SRmgmM5pwUUWzdOXz8TpDRvsSptKVdLSqYl/6psMhYNO5+9h7/R2mUJVfYxO7e1gxd64gXtCvKvZpXBPbTjAV61uYaO5PsTW3NeYy5yxLqOltXUaTKH2DblpkI8imuMy1U8W8kNqpVcVu5+TSJdU+EfpMHIp1a11SdvfWvaD6VPwGOyP/9/L7d7FCfozvlV9p/E14RZiP3rVs/Z5+9ZRbH9+qO0M3sDW2GvLyN+XXb2I76wdMY3hnIWrQS2tBL3nTopu9G4ueAAAVg0lEQVQWNk2IdbWtRrKeVxGtmeViKnYdMrpNlpDWJ+IgxCz+OtkD5tatp1gxfw8br/8TtmP+Drb10n/WX+Sj9quBd+hXkKABFCvmYJ/8GrYa9JPyR04xscx7mFju+9gY/lVcBb8sChoIWaEXoiY0C6RGWTdB1y26agjt5DD3Uor6THhngSrFutUyy7Wuo5GEWNPRXtr/uPMi7LAR+7vYWfl8vP4h9j7vn/tvdy4VXtCvCRo0YIX8A+xOvq6wfMBkJiFMkaz+Wb0A9SBa1UJMVCBFc2AbRDWrrbQDoXmJgrmijFIRJGsNVIFd0tBPgSrjbrm/OBZHsRF6DVT5N6bd8k+wjZctfl5+rfD35RXkv//o1vj7IOFpNl0BU8F/CevO/wZbbftDLOTlK5it7A38NbIY9bIVFbysIrpp0YNVYN3AKhJbW28L8QV21p/ILJcifGNnu+WhqNh9I2I/yEyZ5Z8wCd9+io3a38SK+VMDVXy0frXxDv16otgY7hH2YXCCjex+gPnBfx8r7t/EXyOLcSboRYgDqCYTza2bYKK5pgS9RItmJZiS7Zn+/jDGnOqQrZB3CbpMGLKGJJCK4xtezPeFKnSto/U3sPfwe9huuaejXWP8TXpNeIrTXP2QjljRfh3zf/8rTAH/F+Wfv8TZnXV/zSxEsV7TEGxn/aANctAim5a4bohlb338o5+F1pTXUsz7jOwS7BKht4S0WJPRlv65rzlV+FbtWz/Bxur/glm4VuHbIU/ZK694Z3498O7r+jI3oUjYB0VVLlfF7CeYdey3sMJ+sPSDvs4Uc5dQ99W7pEEJsY7LVw2yimPW+iiam3X6UFbRpO6Vi43X+0zoE/RZzShGyv2Dl/OlyUxn5e9jq6e/BH5BDVXJ+T6N20k4XtCdCcHsYofy63vAb7Fu/W+xcfyXMBW8f8wvRA1uKRnrjahqymjfIOsGPWgDJZo1hPC7q2XlvFySoNti3dpnQiqBKlnt7/ZCvhckbIR+F+vK/5kp4rRat55w6xbsPCTN8Q/ma8kzBL0cYCts38ICXqp17O+Vf/8KVtirC52zEAGIlrUu6wY5WMHBKoR1JDSRELAENzD/eFUkKdIn2A6q20QYsoneivDNWRbFCvkOm5LdxUbq/4qp2H+JdeunzNfRiiBiLqD40f84WfpncS4Y79Cdp7FjGsnXxKYPMVOamrP+Vay4OwsxHpaqKdEV81LPqvQxsGrQJpJj+XMlEMbCVGy3PAx5ClTx3fK9QLHO+0NsHe03mPjt19jE7BPc8c35FLygO5/GgHUIHdYl2Hnd2YSmFotkdRbgjApebWddFB0EbaPqukHXDVrj2rKWs/I8BqpQQlXAp+z7wiH2Pvt3bLz+E0zRfg973/V4OprzKfh72AGeaQx/Bwt2+QvMMvYHWHrb17FO/QZ+g7gPaAhoE9F1RNsGjWUQK2odebFu9UCV/aCukNbd8g+wVbSfY8K3X4TAuyJ08OkXzFXsDvgHsPPs1ICXAevY38X21f8Y213/ffz1tA8EVRAh9JZdrkzucxTRW3H7d/YAwd5bb2Fded0rfxsr7vfWa7quW/phOpcB/wB2npWqgj/CzvE+BD7CugowgdxXMQc6z1pfllAEcCE/eQX0acaBzgVTd8s77Dz8I2yn/H+WX9/D/NlPgNR1hL5H2xbWa8jFNuZZDYSc64O/r53f4RnG7xF4DctU/x622vanTNaxX2ZSwjsL8uRnvr/hF0exs/Dq8/A+pk/5OWbf+iZ243xGon56CpsNtLMW7O9+7GN25yzeoTvPg2CdxQfYh9Mn2JjwzzFf+D/Giv1rWOfuLIQX8L2j+jy8g43Xf4Kdlb+HCd8OmcKSHOcL4e9355n4lK49YDeFG6wr/3PgP2PCue9iRf3V8t8bPGvduZ7k8lWjTt/GlOs/xXLL38COrqrFq1u3Os+Fd+jOi6BYxzFgH0RvYB9KVTT3PeDb2N76l5d+sI6zENVa+R1M/FZ3y3+LFfeH2HvIcV4IL+jOy6Jnylp/DyvoH2IfVoKdp9/Bu3Tn+lBzEh5iRfyfMdHbb7D3xwPsyMrT0ZyXgo/cnS/MM4jmbmDiuD8CfojZxv4Qi2N9FTOjWePF3bmaVOvWI6yYv4cV8n/GrFvfxc7LP7Mr9zG780XxDt05B3QH4S6TeO4uNmr8E6ywf5vpbN1xrhJVxX4Pe83/Aiviv8VG7h9jUywfsTsvHS/ozgtSt5oDT2w4H2N7to+wUfw7mCCojhdrt34DV8I7l5v6wq9Rp59gZ+M/xQJVflb+3Qn2nkhMbxjHeWn4yN15If7+v82t3OeF/QwbLHr1j4C/xLr072Lucl/D1tvcE965rAg2Xr+PmcTUUJVfYEX9rfLfnxqo4qN152XhHbpzEdSgl1+XX9/CvOD/rPz6Pazo++vRuYx0WCGv4/VfYgX9A6zIb/F0NOcC8A7deel8xs462Hj9S5gP/F9iu+t/jnXvX8LEci1uHevsL4KN1wdM/HYXK+b/go3Xfwm8A3oIItA8dWzlnbnzsvGOyLko6gdawtZ13i7/ro4qP8DG8H8AfAU7W3ecfaQGqnyMvY5/ixnFvMEYqqKPIWiRh/hZuXMheEF3lkCwIl67m3cxD+u/xPbZq0hugwvmnP1iYBK+/Tvwf7Bz8rqK9hjY+nDJWQJ/1TnnyjPsrG8wtfs3sTP1/1R+re5yt4EDLMHNcZbgyczy6vr2U6yg/ztWzLfYBKpQJ+1Tg/6jfzh5pv9Bx3kevEN3lqbDuhplUgu/je2s/wDbWf86VvQdZwmUyQHxLWy0Xq1b38GK+Snu+OYsjBd0Z2kCkwr+FFMLv8XZvV3BRHKv8JSFd8c5B2pbLdhr810s4vRnWELar7BCvsO6clexO4vjH4rOhfMMY/jbmEDuz7BO/Y/LP38TU8K/gp+tO+dHHbEfYUX7fayA17W0Xwd4V+xm81M/RF3F7lw03qE7+8gWG29usYCXt7E1tx9iRf7buBGNc35Ux7e3sHPyf2cKVPkY29IYwDsiZ7/w16OzKJ+xs65YF14Fc9/DVPD/GSvsdbVtjWetOy9GVa4l7CbyGDv6+SnwP5lU7A+AkwBZIaxAt5xVa/6dd+XOgniH7uwj9fwyY6piZTLyqOfs38U69a9isazrpR+0c2kJ2OvqIfbaegcTvP0S685rDsEpjC9O3y139g4v6M6+o5g47gOsc/oQG3/+JfAfMCU8mB+8v56d56HHuu+3sCL+L5gA7n3shvK4/BnH2Wt85O7sHZ8hmmuwvfWvYGfp/7H8WgVzr2Nj+BX+2nY+m8y0W34f02m8gRXyfyXwSwKPaMkco2PQ76wvd9Gbs294R+NcJrIGToNyH/vw7bCO/fuYF/x3ge9gBd8LuvNZJGw18k1s4lP3yt/CBJmHJBIZO8zxAbtzCfCC7lwqghKwQv4+NiZ9r/z+E2zNKGAd+m2mgBcv7g6c1WI8xAp4tW79NfZaeojtlmduYMN29yh0Lgn+QefsNc+ws34AfAvrzv8E+Ivy67ewnfXb2JjeVfDXm6pgf4Ttlr+LCd5+gp2bv4+N3ofxO+rt4Mwy5kc/9jG7s794h+5cdnos4CVhjl5VNFdjWb+DCeY2z/n3O5cfxYp5HbH/DDsrfxMTW94FDpkXc291nEuIv2ydS8OP/6t160FBIuwO4GA3voZbTBB3Bwt2+Rvg/wH8KSaYew24iQnrfAx/9Znvlh9hRfttrJj/L+DfMJOYLXZTmHnipNxFb85lwzt057JTP4SHAIPa+XrCBqYJ+yD/Hpaz/k0swc1d5q4Hh1hX/j4mdvsNk4Xr++W/u9zNuTJ4QXeuGjXo5VfYmehvMWe5Py+/KqZbdqnT1abaBv8cOyv/BVbQP2TMLPdi7lwtfOzoXGrmorn5izkDLUQxYdz3mc7U/wzr2L/MtLPe4O+Fy45gE5kO2y3/BFtt/FdszP4G8A5NPiQ3oLPLHeZ55T5mdy4v3qE7V4Z5uxWBbEftj9XOThOmcK7Wnt/HlPFfx98HVwHBHAWrKPLX5auGqnwEHJNLSF/w5ty5evgHmXMl0ekrM/lw38U+3N8u/64GwLyOqeB9DH856bCN8Y+x0fr/wjrzGqhyVP6MV3HnSuNjRufK8OPZ+L2M3OcrxGAF+w4mjvszzAv+h8DvYyEvr2JKeC/sl4MOK9YPsA78bey8/J+w3fK7VJOYShSb28xG7j/6H0dL/xyO81LwDt25TgxYAQAbwT9gEs39KfCHwDewFTdnv1FM3PY2dg1/gRXxt7Hd8vs8Wcwd54rjBd25blQV/AnW1VW7zw7bR65N/Su4dew+MTtFIWMrZ29jKvafYSP22pUP2HWU5/pfcpxLin9QOVeaZ7COvY115j8A/rh8fRczp/kaNqJ329j9oMNuxj7Czsd/jRXxKn57v/yZT8VV7M5Vxjt057qzw1TvR9io9m2sqP85lrm+wo1o9oF6XPI2llf+U2zU/h7WlT9mbt3qONcQ79Cda8PndOsBE8V9E+vQ/wr4T1jn/hWsqB9gN8HesV8MNRntBBuxf4yN2Kt1a1Wxn/IZCnbvyp3rgnfojmMoVjTACkmPdX1P7qy/ijnNOefPDhO3fYB147/GHAB/jRXzh7jjm+OMeEF3nAnFusEPsOL+PnY2+zdY4Ujlz7yOr7adNzss5vQtTMH+z1hXXq9NDVVxHKfgI3fnWvMZY/iAmc18FVtp+1ssZ/27WNb6lzElvMeyvjwyVshrOto7mGXrL7Bi/gbWlX+qet3H6851xjt0x3k6iimmH2BK6mNszPt9TDRXx/Bfw2+MXxY1He9XWPH+NTZqfxezdD3CV9Ec51Pxgu44n80OG73fx4rKx1iR32LiuAZbfWvKP7tg7tmZZ5b3WPf9G8zp7V+xgv5++fc9flbuOJ+JdxaOU3iGnfUDzEnuO5j6/c+wbv0PsE79VWwE70X92RgwhfpDJuvWN7CVtF9hxfwBVvA/FR+zO47hHbrjPDs9JtTqseS297Au8q/K13cwwdzB0g/0EqBMMae/BX6CnZO/xTQFOcatWx3nmfEO3XGewo//q3Xrx6/ArRPL9OjX0Fqv2GBF+zYW7PK3wH/BRHPfwrzgbzFlrTtGtW0dMKX6J0yBKv8bK+ofY8cZ1b71DN6NO86n4x264zwj7TT4zdh624AVqYgVofeBP8KsZKt1rLvMTQRM2PYhJnSru+U1v/wjrND7WbnjPAde0B3n+UmY+cwbWGf5JjaGn4vmVrgRTeUEK+Y/xQJV/p2pkNfMcsdxnhMfuTvOM/IMorkvY+tsf4oJ5v4UW237CtPO+nW6iRbspucUK9gfY2K3f8MsXH8FvIuGI8KnN+U+ZnecZ+M6fbg4znlTw0M6bM3tPazA/wmmhv86dqZ+XW6kBevK38emGP+OjdffKv/uLnD6WcXccZxnxwu647w8EqaCr05n72GF64ipiH8JE9StubqFXbCbmiNM+PZL4P+P2be+g62pnVDz5zVAUMZfHcd5Lq7qB4rjnCvPMH5fYSr4bwI/xNbafgB8G+vUv4SN4a+aJ/wO0xXcY4qj/SVmFPMGdqOzY65g33TQbaDJILbC/6Mfnyz9czjOpcM7dMc5HxK2R/0h1q1+jAnA/rx8fRdTwr+29AN9iShWzN8sP+u/Yz7sb5ef/1F5Lty+1XHOAe/QHecl8ZSuPTDZwW6wHfW/xPbW/xQ7X/8W1qm3XL7z9bl1a90tfwsTvP0c2yv/JYFPgKH8aRmfmYKL3hzn5eAduuOcH9VIpZqpfIi956rj3EdYp/5tbDT/GperoAcmD/b3sGL+G0y9/tvyz3cRuvGnukw/neNcMrygO87FscNEYY8xsdw72Ln6X5X/vsKMaAL7X/qEqSt/mylQ5bflZ7uHHTkMSz9Qx7ku7PuHhuNcSp5BNHcHC3r5LlbQ/xZbbftq+W83sQK/b0EvNRntmClU5RfAP2Ij9rmxjhGxsj5rH370Yx+zO87Lxjt0x1mGE2ylK2Od+12su60763UEv28ucx3TSt48t/wtrDN/VH4ex3EuGC/ojrMMgnW5NbntXWx0/RDrghNW7L+ECer2gZqO9ibWlf8T1pW/X36Wjs+JOnUc5/zwkbvjXBCfM4ZfY2EuP8SU8D/AxvG/j1nHvsoysazClFn+MXbT8Wtst/zn5fcP+IxAFVexO87F4B264+wHA1Y0f1F+fRsbvf8AG8N/H+vUL/omfMBG7L/A9sp/xRRCcxfrzN3ezXH2AO/QHWcB5t16ALQo21WDhqAbrFv/Hrav/lfAX2Md+22mnPXIy38PzzPLO+zm4leY6O1fsI78/fLvh9n3nMG7cse5eLxDd5yF0ekXDeZlvsPOqgNTWtkjrJD+ISaYex0bwb/sgp6xrruGy7yJFfQarPIh0zm/4zh7hBd0x9kzSsdeR907rLi+gxXUvwX+pvzR14EbvLyiXoV6H2OK+3/Gdsvfwm4wHmM3F3np58hxnN/FR+6OsyD/n/96e/z9KgqigayBOKWOBezs/DbwB1gx/0/Y2fq3MBX8bUxU97w36AN243DIJHyb75Z/hO2VZ3y87jh7i3fojrPfKFM6Wb0Br+5sf4yds38bM6l53vfzMdN4/bdMwre3sM7chW+Ocwnwgu44+089S68j7w+ZEsweY+K1iJ2tH2DF9/OmbzVY5RSLOf0Z8G9Mq2gfYeY3flbuOJcEH7k7zh7yaTvrAZO3J/gy1p3/Cba7/kNMBf81bGf9ZvmjT6KYmc0Jk3Xrb7BiXoVv72Fd+afiY3bH2T+8Q3ecS0TdKQOOsC69ure9g+2q/zlW3L+BFfUnyVgxfx/rxn+GdeTvYMX9PnMfdsdxLg3eoTvOnvPfS7eu2B14BsKUyLbGOvK6t/6fgP+Cdet1tW1V/qoOuxH4BDsn/1+Y8O1tbC3uFBPIKUEVDSARGruF+NGPT5Z+KhzH+Qy8Q3ecy0k9A98xJaAlrMhvsY77W0xFXbDO/C7mG/9brEP/LRZ1usWFb45zqfGC7jiXnzpG/xArzO9jxfx7wO9ho/eEqeNrMf8A82A/xDp3L+aOc8nxkbvjXEI+RTQXMLX7BhPNfRcr6Dewov8YK/ZvY8W8dvS+W+44VwDv0B3n6lA1c6ezf/cIO0MXbDz/kLPWrd6ZO84VwQu641w9Anamfg8r6BEr3IKJ3ty61XGuID5yd5xLzufkrD8zPmZ3nMtNXPoBOI7jOI7z4nhBdxzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcRzHcZx95v8GG2x5Zg2jlXAAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDI1LTExLTA3VDE5OjIzOjA2KzAwOjAwwngOPwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyNS0xMS0wN1QxOToyMzowNiswMDowMLMltoMAAAAodEVYdGRhdGU6dGltZXN0YW1wADIwMjUtMTEtMTBUMDM6MjU6MjQrMDA6MDDhm0UpAAAAG3RFWHRpY2M6Y29weXJpZ2h0AFB1YmxpYyBEb21haW62kTFbAAAAInRFWHRpY2M6ZGVzY3JpcHRpb24AR0lNUCBidWlsdC1pbiBzUkdCTGdBEwAAABV0RVh0aWNjOm1hbnVmYWN0dXJlcgBHSU1QTJ6QygAAAA50RVh0aWNjOm1vZGVsAHNSR0JbYElDAAAAAElFTkSuQmCC'
    $dir = Split-Path -LiteralPath $testimage
    $ovr = Join-Path $dir 'ovr_from_b64.png'
    $favicon = ($favicon -replace '\s', '')
    if ($favicon -like 'data:*') { $favicon = $favicon.Split(',', 2)[-1] }
    [IO.File]::WriteAllBytes($ovr, [Convert]::FromBase64String($favicon))

    foreach ($img in @($testimage, $backgroundtestimage)) {
        InvokeMagickCommand -Command $magick -Arguments @(
            $img, $ovr, '-gravity', 'center', '-compose', 'over', '-composite', $img
        )
    }
    if (Test-Path $ovr) { Remove-Item $ovr -Force }

    # =================================================================================
    # Define Test Cases
    # =================================================================================

    # Define Text Strings
    $ShortText = "The Hobbit"
    $MediumText = "The Hobbit is a great movie"
    $LongText = "The Hobbit is a great movie that we all loved and enjoyed watching"
    $bullet = [char]0x2022
    $Episodetext = "$SeasonTCText 9999 $bullet $EpisodeTCText 9999"

    # Define a single list of all test cases
    $testCases = @(
        [PSCustomObject]@{ ID = 'Short';       Text = $ShortText;                  VarSuffix = 'ShortText' }
        [PSCustomObject]@{ ID = 'Medium';      Text = $MediumText;                 VarSuffix = 'MediumText' }
        [PSCustomObject]@{ ID = 'Long';        Text = $LongText;                   VarSuffix = 'LongText' }
        [PSCustomObject]@{ ID = 'ShortCAPS';   Text = $ShortText.ToUpper();        VarSuffix = 'ShortTextCAPS' }
        [PSCustomObject]@{ ID = 'MediumCAPS';  Text = $MediumText.ToUpper();       VarSuffix = 'MediumTextCAPS' }
        [PSCustomObject]@{ ID = 'LongCAPS';    Text = $LongText.ToUpper();         VarSuffix = 'LongTextCAPS' }
    )

    $EpisodetextCAPS = $Episodetext.ToUpper()

    # =================================================================================
    # Generate Paths (Looping)
    # =================================================================================

    # Use Hashtables to store dynamic paths
    $posterPaths = @{}
    $seasonPosterPaths = @{}
    $backgroundPaths = @{}
    $titleCardPaths = @{}

    $testDir = Join-Path -Path $global:ScriptRoot -ChildPath "test"

    if ($AddText -eq 'true') {
        $testCases | ForEach-Object { $posterPaths[$_.ID] = Join-Path $testDir "poster$($_.VarSuffix).jpg" }
    } Else {
        $TestPosterTextless = Join-Path $testDir "PosterTextless.jpg"
    }

    if ($AddSeasonText -eq 'true') {
        $testCases | ForEach-Object { $seasonPosterPaths[$_.ID] = Join-Path $testDir "SeasonPoster$($_.VarSuffix).jpg" }
    } Else {
        $TestSeasonPosterTextless = Join-Path $testDir "SeasonPosterTextless.jpg"
    }

    if ($AddBackgroundText -eq 'true') {
        $testCases | ForEach-Object { $backgroundPaths[$_.ID] = Join-Path $testDir "background$($_.VarSuffix).jpg" }
    } Else {
        $BackgroundTestPosterTextless = Join-Path $testDir "BackgroundTextless.jpg"
    }

    if ($AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        $testCases | ForEach-Object { $titleCardPaths[$_.ID] = Join-Path $testDir "TitleCard$($_.VarSuffix).jpg" }
    } Else {
        $TitleCardTestPosterTextless = Join-Path $testDir "TitleCardTextless.jpg"
    }

    # =================================================================================
    # Calculate Font Sizes (Looping)
    # =================================================================================

    if ($AddText -eq 'true' -or $AddBackgroundText -eq 'true' -or $AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        Write-Entry -Subtext "Calculating Optimal Font Sizes. This may take a while..." -Path $testingLog -Color Cyan -log Info
    }

    $TruncatedCount = 0

    # Use Hashtables to store dynamic font sizes
    $posterFontSizes = @{}
    $showFontSizes = @{}
    $seasonFontSizes = @{}
    $backgroundFontSizes = @{}
    $titleCardFontSizes = @{}

    if ($AddText -eq 'true') {
        Write-Entry -Subtext "Finished Optimal Font Sizes for posters..." -Path $testingLog -Color Cyan -log Info
        foreach ($case in $testCases) {
            $posterFontSizes[$case.ID] = Get-OptimalPointSize -text $case.Text -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
        }
    }

    if ($AddSeasonText -eq 'true') {
        if ($AddShowTitletoSeason -eq 'true') {
            # Title
            foreach ($case in $testCases) {
                $showFontSizes[$case.ID] = Get-OptimalPointSize -text $case.Text -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                if ($global:IsTruncated) { $TruncatedCount++ }
            }
            # Season
            foreach ($case in $testCases) {
                $seasonFontSizes[$case.ID] = Get-OptimalPointSize -text $case.Text -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                if ($global:IsTruncated) { $TruncatedCount++ }
            }
        }
        Else {
            foreach ($case in $testCases) {
                $seasonFontSizes[$case.ID] = Get-OptimalPointSize -text $case.Text -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                if ($global:IsTruncated) { $TruncatedCount++ }
            }
        }
        Write-Entry -Subtext "Finished Optimal Font Sizes for season posters..." -Path $testingLog -Color Cyan -log Info
    }

    if ($AddBackgroundText -eq 'true') {
        foreach ($case in $testCases) {
            $backgroundFontSizes[$case.ID] = Get-OptimalPointSize -text $case.Text -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
        }
        Write-Entry -Subtext "Finished Optimal Font Sizes for backgrounds..." -Path $testingLog -Color Cyan -log Info
    }

    if ($AddTitleCardEPTitleText -eq 'true') {
        foreach ($case in $testCases) {
            $titleCardFontSizes[$case.ID] = Get-OptimalPointSize -text $case.Text -font $titlecardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
            if ($global:IsTruncated) { $TruncatedCount++ }
        }
    }

    if ($AddTitleCardEPText -eq 'true') {
        $Episodetext = $Episodetext -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
        $TitleCardoptimalFontSizeEpisodetext = Get-OptimalPointSize -text $Episodetext -font $titlecardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }

        $EpisodetextCAPS = $EpisodetextCAPS -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
        $TitleCardoptimalFontSizeEpisodetextCAPS = Get-OptimalPointSize -text $EpisodetextCAPS -font $titlecardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
        if ($global:IsTruncated) { $TruncatedCount++ }
    }

    if ($AddText -eq 'true' -or $AddBackgroundText -eq 'true' -or $AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        Write-Entry -Subtext "Finished Optimal Font Sizes for titlecards..." -Path $testingLog -Color Cyan -log Info
    }


    # =================================================================================
    # Process Images (Looping)
    # =================================================================================
    # POSTER PART
    Write-Entry -Subtext "Poster Part:" -Path $testingLog -Color Green -log Info
    if ($AddText -eq 'true') {
        # Apply Border/Overlay
        foreach ($case in $testCases) {
            $testingargs = Get-BorderOverlay-Arguments -SourceImage $testimage -OutputPath $posterPaths[$case.ID] -AddBorder $AddBorder -AddOverlay $AddOverlay -OverlayImage $Posteroverlay -BorderWidthSecond $borderwidthsecond -BorderColor $bordercolor -BorderWidth $borderwidth -LogPath $scriptLog
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }
        # Apply Text
        foreach ($case in $testCases) {
            Write-Entry -Subtext "Optimal font size for $($case.ID) text is: '$($posterFontSizes[$case.ID])'" -Path $testingLog -Color White -log Info
            Write-Entry -Subtext "    Applying text: `"$($case.Text)`"" -Path $testingLog -Color White -log Info

            $testingargs = Get-TextOverlay-Arguments -AddStroke $AddTextStroke -InputFile $posterPaths[$case.ID] -OutputFile $posterPaths[$case.ID] -Font $fontImagemagick -PointSize $posterFontSizes[$case.ID] -FontColor $fontcolor -BoxSize $boxsize -LineSpacing $lineSpacing -TextGravity $textgravity -CaptionText $case.Text -TextOffset $text_offset -StrokeColor $strokecolor -StrokeWidth $strokewidth
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }
    }
    Else {
        # Textless
        $testingargs = Get-BorderOverlay-Arguments -SourceImage $testimage -OutputPath $TestPosterTextless -AddBorder $AddBorder -AddOverlay $AddOverlay -OverlayImage $Posteroverlay -BorderWidthSecond $borderwidthsecond -BorderColor $bordercolor -BorderWidth $borderwidth -LogPath $scriptLog
        Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog

        Write-Entry -Subtext "    Applying textbox only to Poster..." -Path $testingLog -Color White -log Info
        $testingargsNoText = "`"$TestPosterTextless`" -size `"$boxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$text_offset`" -compose over -composite `"$TestPosterTextless`""
        Invoke-MagickTestCommand -Arguments $testingargsNoText -CommandLogPath $magickLog
    }

    # SEASON POSTER PART
    Write-Entry -Subtext "Season Poster Part:" -Path $testingLog -Color Green -log Info
    if ($AddSeasonText -eq 'true') {
        # Apply Border/Overlay
        foreach ($case in $testCases) {
            $testingargs = Get-BorderOverlay-Arguments -SourceImage $testimage -OutputPath $seasonPosterPaths[$case.ID] -AddBorder $AddSeasonBorder -AddOverlay $AddSeasonOverlay -OverlayImage $Seasonoverlay -BorderWidthSecond $Seasonborderwidthsecond -BorderColor $Seasonbordercolor -BorderWidth $Seasonborderwidth -LogPath $scriptLog
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }
        # Apply Season Text
        foreach ($case in $testCases) {
            Write-Entry -Subtext "Optimal font size for $($case.ID) text is: '$($seasonFontSizes[$case.ID])'" -Path $testingLog -Color White -log Info
            Write-Entry -Subtext "    Applying text: `"$($case.Text)`"" -Path $testingLog -Color White -log Info

            $testingargs = Get-TextOverlay-Arguments -AddStroke $AddSeasonTextStroke -InputFile $seasonPosterPaths[$case.ID] -OutputFile $seasonPosterPaths[$case.ID] -Font $fontImagemagick -PointSize $seasonFontSizes[$case.ID] -FontColor $Seasonfontcolor -BoxSize $Seasonboxsize -LineSpacing $SeasonlineSpacing -TextGravity $Seasontextgravity -CaptionText $case.Text -TextOffset $Seasontext_offset -StrokeColor $Seasonstrokecolor -StrokeWidth $Seasonstrokewidth
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }
        # Apply Show Title on Season Text
        if ($AddShowTitletoSeason -eq 'true') {
            foreach ($case in $testCases) {
                Write-Entry -Subtext "Optimal font size for Show Title $($case.ID) text is: '$($showFontSizes[$case.ID])'" -Path $testingLog -Color White -log Info
                Write-Entry -Subtext "    Applying text: `"$($case.Text)`"" -Path $testingLog -Color White -log Info

                $testingargs = Get-TextOverlay-Arguments -AddStroke $AddSeasonTextStroke -InputFile $seasonPosterPaths[$case.ID] -OutputFile $seasonPosterPaths[$case.ID] -Font $fontImagemagick -PointSize $showFontSizes[$case.ID] -FontColor $ShowOnSeasonfontcolor -BoxSize $ShowOnSeasonboxsize -LineSpacing $ShowOnSeasonlineSpacing -TextGravity $ShowOnSeasontextgravity -CaptionText $case.Text -TextOffset $ShowOnSeasontext_offset -StrokeColor $ShowOnSeasonstrokecolor -StrokeWidth $ShowOnSeasonstrokewidth
                Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
            }
        }
    }
    Else {
        # Textless
        $testingargs = Get-BorderOverlay-Arguments -SourceImage $testimage -OutputPath $TestSeasonPosterTextless -AddBorder $AddSeasonBorder -AddOverlay $AddSeasonOverlay -OverlayImage $Seasonoverlay -BorderWidthSecond $Seasonborderwidthsecond -BorderColor $Seasonbordercolor -BorderWidth $Seasonborderwidth -LogPath $scriptLog
        Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog

        Write-Entry -Subtext "    Applying textbox only to Season Poster..." -Path $testingLog -Color White -log Info
        $testingargsNoText = "`"$TestSeasonPosterTextless`" -size `"$Seasonboxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$Seasontext_offset`" -compose over -composite `"$TestSeasonPosterTextless`""
        Invoke-MagickTestCommand -Arguments $testingargsNoText -CommandLogPath $magickLog
    }

    # BACKGROUND PART
    Write-Entry -Subtext "Background Part:" -Path $testingLog -Color Green -log Info
    if ($AddBackgroundText -eq 'true') {
        # Apply Border/Overlay
        foreach ($case in $testCases) {
            $testingargs = Get-BorderOverlay-Arguments -SourceImage $backgroundtestimage -OutputPath $backgroundPaths[$case.ID] -AddBorder $AddBackgroundBorder -AddOverlay $AddBackgroundOverlay -OverlayImage $Backgroundoverlay -BorderWidthSecond $Backgroundborderwidthsecond -BorderColor $Backgroundbordercolor -BorderWidth $Backgroundborderwidth -LogPath $scriptLog
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }
        # Apply Text
        foreach ($case in $testCases) {
            Write-Entry -Subtext "Optimal font size for $($case.ID) text is: '$($backgroundFontSizes[$case.ID])'" -Path $testingLog -Color White -log Info
            Write-Entry -Subtext "    Applying text: `"$($case.Text)`"" -Path $testingLog -Color White -log Info

            $testingargs = Get-TextOverlay-Arguments -AddStroke $AddBackgroundTextStroke -InputFile $backgroundPaths[$case.ID] -OutputFile $backgroundPaths[$case.ID] -Font $backgroundfontImagemagick -PointSize $backgroundFontSizes[$case.ID] -FontColor $Backgroundfontcolor -BoxSize $Backgroundboxsize -LineSpacing $BackgroundlineSpacing -TextGravity $Backgroundtextgravity -CaptionText $case.Text -TextOffset $Backgroundtext_offset -StrokeColor $Backgroundstrokecolor -StrokeWidth $Backgroundstrokewidth
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }
    }
    Else {
        # Textless
        $testingargs = Get-BorderOverlay-Arguments -SourceImage $backgroundtestimage -OutputPath $BackgroundTestPosterTextless -AddBorder $AddBackgroundBorder -AddOverlay $AddBackgroundOverlay -OverlayImage $Backgroundoverlay -BorderWidthSecond $Backgroundborderwidthsecond -BorderColor $Backgroundbordercolor -BorderWidth $Backgroundborderwidth -LogPath $scriptLog
        Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog

        Write-Entry -Subtext "    Applying textbox only to Background..." -Path $testingLog -Color White -log Info
        $testingargsNoText = "`"$BackgroundTestPosterTextless`" -size `"$Backgroundboxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$Backgroundtext_offset`" -compose over -composite `"$BackgroundTestPosterTextless`""
        Invoke-MagickTestCommand -Arguments $testingargsNoText -CommandLogPath $magickLog
    }

    # TITLECARD PART
    Write-Entry -Subtext "TitleCard Part:" -Path $testingLog -Color Green -log Info
    if ($AddTitleCardEPTitleText -eq 'true' -or $AddTitleCardEPText -eq 'true') {
        # Apply Border/Overlay
        foreach ($case in $testCases) {
            $testingargs = Get-BorderOverlay-Arguments -SourceImage $backgroundtestimage -OutputPath $titleCardPaths[$case.ID] -AddBorder $AddTitleCardBorder -AddOverlay $AddTitleCardOverlay -OverlayImage $titlecardoverlay -BorderWidthSecond $titlecardborderwidthsecond -BorderColor $titlecardbordercolor -BorderWidth $titlecardborderwidth -LogPath $scriptLog
            Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
        }

        # Apply Title Text
        if ($AddTitleCardEPTitleText -eq 'true') {
            foreach ($case in $testCases) {
                Write-Entry -Subtext "Optimal font size for $($case.ID) text is: '$($titleCardFontSizes[$case.ID])'" -Path $testingLog -Color White -log Info
                Write-Entry -Subtext "    Applying text: `"$($case.Text)`"" -Path $testingLog -Color White -log Info

                $testingargs = Get-TextOverlay-Arguments -AddStroke $AddTitleCardEPTitleTextStroke -InputFile $titleCardPaths[$case.ID] -OutputFile $titleCardPaths[$case.ID] -Font $titlecardfontImagemagick -PointSize $titleCardFontSizes[$case.ID] -FontColor $TitleCardEPTitlefontcolor -BoxSize $TitleCardEPTitleboxsize -LineSpacing $TitleCardEPTitlelineSpacing -TextGravity $TitleCardEPTitletextgravity -CaptionText $case.Text -TextOffset $TitleCardEPTitletext_offset -StrokeColor $TitleCardEPTitlestrokecolor -StrokeWidth $TitleCardEPTitlestrokewidth
                Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
            }
        }
        Elseif ($AddTitleCardEPText -eq 'true') {
            # Add empty box where title would go
            Write-Entry -Subtext "    Applying Title textbox only to TitleCard..." -Path $testingLog -Color White -log Info
            foreach ($case in $testCases) {
                $testingargsNoText = "`"$($titleCardPaths[$case.ID])`" -size `"$TitleCardEPTitleboxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$($titleCardPaths[$case.ID])`""
                Invoke-MagickTestCommand -Arguments $testingargsNoText -CommandLogPath $magickLog
            }
        }

        # Apply EP Text
        if ($AddTitleCardEPText -eq 'true') {
            Write-Entry -Subtext "Optimal font size for Episode CAPS text is: '$TitleCardoptimalFontSizeEpisodetextCAPS'" -Path $testingLog -Color White -log Info
            Write-Entry -Subtext "    Applying CAPS text: `"$EpisodetextCAPS`"" -Path $testingLog -Color White -log Info
            Write-Entry -Subtext "Optimal font size for Episode text is: '$TitleCardoptimalFontSizeEpisodetext'" -Path $testingLog -Color White -log Info
            Write-Entry -Subtext "    Applying text: `"$Episodetext`"" -Path $testingLog -Color White -log Info

            foreach ($case in $testCases) {
                # first 3 use normal text, last 3 use CAPS
                $epText = if ($case.ID -like '*CAPS') { $EpisodetextCAPS } else { $Episodetext }
                $epFontSize = if ($case.ID -like '*CAPS') { $TitleCardoptimalFontSizeEpisodetextCAPS } else { $TitleCardoptimalFontSizeEpisodetext }

                $testingargs = Get-TextOverlay-Arguments -AddStroke $AddTitleCardTextStroke -InputFile $titleCardPaths[$case.ID] -OutputFile $titleCardPaths[$case.ID] -Font $titlecardfontImagemagick -PointSize $epFontSize -FontColor $TitleCardEPfontcolor -BoxSize $TitleCardEPboxsize -LineSpacing $TitleCardEPlineSpacing -TextGravity $TitleCardEPtextgravity -CaptionText $epText -TextOffset $TitleCardEPtext_offset -StrokeColor $TitleCardstrokecolor -StrokeWidth $TitleCardstrokewidth
                Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog
            }
        }
        Elseif ($AddTitleCardEPTitleText -eq 'true') {
            # Add empty box where EP text would go
            Write-Entry -Subtext "    Applying EP textbox only to TitleCard..." -Path $testingLog -Color White -log Info
            foreach ($case in $testCases) {
                $testingargsNoText = "`"$($titleCardPaths[$case.ID])`" -size `"$TitleCardEPboxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$($titleCardPaths[$case.ID])`""
                Invoke-MagickTestCommand -Arguments $testingargsNoText -CommandLogPath $magickLog
            }
        }
    }
    Else {
        # Textless TitleCard
        $testingargs = Get-BorderOverlay-Arguments -SourceImage $backgroundtestimage -OutputPath $TitleCardTestPosterTextless -AddBorder $AddTitleCardBorder -AddOverlay $AddTitleCardOverlay -OverlayImage $titlecardoverlay -BorderWidthSecond $titlecardborderwidthsecond -BorderColor $titlecardbordercolor -BorderWidth $titlecardborderwidth -LogPath $scriptLog
        Invoke-MagickTestCommand -Arguments $testingargs -CommandLogPath $magickLog

        Write-Entry -Subtext "    Applying Title textbox only to TitleCard..." -Path $testingLog -Color White -log Info
        $testingargsNoTextTitle = "`"$TitleCardTestPosterTextless`" -size `"$TitleCardEPTitleboxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$TitleCardEPTitletext_offset`" -compose over -composite `"$TitleCardTestPosterTextless`""
        Invoke-MagickTestCommand -Arguments $testingargsNoTextTitle -CommandLogPath $magickLog

        Write-Entry -Subtext "    Applying EP textbox only to TitleCard..." -Path $testingLog -Color White -log Info
        $testingargsNoTextEP = "`"$TitleCardTestPosterTextless`" -size `"$TitleCardEPboxsize`" xc:`"#F3AC7C`" -gravity south -geometry +0+`"$TitleCardEPtext_offset`" -compose over -composite `"$TitleCardTestPosterTextless`""
        Invoke-MagickTestCommand -Arguments $testingargsNoTextEP -CommandLogPath $magickLog
    }

    # =================================================================================
    # Finalization
    # =================================================================================

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "

    Write-Entry -Subtext "Final cleanup starting..." -Path $scriptLog -Color Green -log Info
    Write-Entry -Subtext "Deleting testimage: $testimage" -Path $scriptLog -Color White -log Info
    Remove-Item -LiteralPath $testimage | out-null
    Write-Entry -Subtext "Deleting backgroundtestimage: $backgroundtestimage" -Path $scriptLog -Color White -log Info
    Remove-Item -LiteralPath $backgroundtestimage | out-null

    Write-Entry -Subtext "Poster/Background/TitleCard Tests finished, you can find them here: $testDir" -Path $testingLog -Color Green -log Info
    Write-TextSizeCacheSummary
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $testingLog -Color Green -log Info

    $gettestimages = Get-ChildItem $testDir
    $titlecardscount = ($gettestimages | Where-Object { $_.name -like 'Title*' }).count
    $backgroundsscount = ($gettestimages | Where-Object { $_.name -like 'back*' }).count
    $posterscount = ($gettestimages | Where-Object { $_.name -like 'poster*' }).count
    $seasonscount = ($gettestimages | Where-Object { $_.name -like 'SeasonPoster*' }).count

    # Send Notification
    Send-SummaryNotification -ScriptMode $mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -TruncatedCount $TruncatedCount -PosterCount $posterscount -BackgroundCount $backgroundsscount -SeasonCount $seasonscount -EpisodeCount $titlecardscount

    if ((Test-Path "$global:ScriptRoot\Logs\ImageChoices.csv")) {
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
    }

    # Export json
    $jsonObject = [PSCustomObject]@{
        Posters              = if ($posterscount) { $posterscount } Else { 0 }
        Backgrounds          = if ($backgroundsscount) { $backgroundsscount } Else { 0 }
        Titlecards           = if ($titlecardscount) { $titlecardscount } Else { 0 }
        Seasons              = if ($seasonscount) { $seasonscount } Else { 0 }
        Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
        Mode                 = $Mode
        Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
        Errors               = if ($errorCount) { $errorCount } Else { 0 }
        Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
        Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
        Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
        Text                 = if ($TextCount) { $TextCount } Else { 0 }
        "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
        "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
        "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
        "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
        "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
        "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
        "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
        "Script Version"     = $CurrentScriptVersion
        "IM Version"         = $global:CurrentImagemagickversion
        "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
        "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
    }

    $jsonOutput = $jsonObject | ConvertTo-Json
    $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $scriptLog -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $scriptLog -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $scriptLog -Color Red -log Error
        }
    }

    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
#region Tautulli Mode
Elseif ($Tautulli) {
    # Get Plex data for this Show/Movie
    # {rating_key}	The unique identifier for the movie, episode, or track.
    # {parent_rating_key}	The unique identifier for the season or album.
    # {grandparent_rating_key}	The unique identifier for the TV show or artist.
    $Mode = "tautulli"
    Write-Entry -Message "Tautulli Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    if (($RatingKey -or $parentratingkey -or $grandparentratingkey) -and $mediatype) {
        if ($mediatype -eq 'movie') {
            $contentquery = "video"
            $queryKey = $RatingKey
        }
        Elseif ($mediatype -eq 'show') {
            $contentquery = "Directory"
            $queryKey = $RatingKey
        }
        Elseif ($mediatype -eq 'season') {
            $contentquery = "Directory"
            $queryKey = $parentratingkey
        }
        Else {
            $contentquery = "Directory"
            $queryKey = if ($grandparentratingkey) { $grandparentratingkey }Else { $parentratingkey }
        }
        $extractedFolder = $null
        $Seasondata = $null
        if ($PlexToken) {
            if ($contentquery -eq 'Directory') {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
            }
            Else {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
            }
        }
        Else {
            if ($contentquery -eq 'Directory') {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey) -Headers $extraPlexHeaders).content
                [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey)/children? -Headers $extraPlexHeaders).content
            }
            Else {
                [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($queryKey) -Headers $extraPlexHeaders).content
            }
        }

        $Library = $Libs.mediaContainer.Directory | Where-Object { $_.key -eq $Metadata.MediaContainer.$contentquery.librarySectionID }
        $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
        $tmdbpattern = 'tmdb://(\d+)'
        $imdbpattern = 'imdb://tt(\d+)'
        $tvdbpattern = 'tvdb://(\d+)'
        if ($Metadata.MediaContainer.$contentquery.Location) {
            $location = $Metadata.MediaContainer.$contentquery.Location.path
            if ($location.count -gt '1') {
                $location = $location[0]
                $MultipleVersions = $true
            }
            Else {
                $MultipleVersions = $false
            }
            $libpaths = $($Library.location.path).split(',')
            Write-Entry -Subtext "Plex Lib Paths before split: $($Library.location.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            foreach ($libpath in $libpaths) {
                if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                    Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $libpath
                    $libpath = $Matchedpath
                    $relativePath = $location.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    continue
                }
            }
        }
        Else {
            $location = $Metadata.MediaContainer.$contentquery.media.part.file

            if ($location.count -gt '1') {
                Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $location = $location[0]
                $MultipleVersions = $true
            }
            Else {
                $MultipleVersions = $false
            }
            Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                $CheckCharLimit = CheckCharLimit
                if ($CheckCharLimit -eq $false) {
                    Write-Entry -Subtext "Skipping [$($Metadata.MediaContainer.$contentquery.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    continue
                }
            }

            $libpaths = $($Library.location.path).split(',')
            Write-Entry -Subtext "Plex Lib Paths before split: $($Library.location.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            foreach ($libpath in $libpaths) {
                if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                    Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $libpath
                    $libpath = $Matchedpath
                    $relativePath = $location.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    continue
                }
            }
        }
        if ($Seasondata) {
            $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
            $SeasonNames = $SeasonsTemp.Title -join ';'
            $SeasonNumbers = $SeasonsTemp.index -join ','
            $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
            $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
        }
        $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
        $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
        $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
        if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
        if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
        if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

        # check if there are more then 1 entry in id´s
        if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
        if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
        if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

        if ($Metadata.MediaContainer.$contentquery.Label.tag) {
            $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
        }
        Else {
            $Labels = ""
        }
        $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
        $Resolution = $null
        # Get Resolution
        if ($FileMetadata) {
            $FileMetadata | ForEach-Object {
                if ($_.streamType -eq '1') {
                    $Resolution = $_.displayTitle
                }
            }
        }
        $temp = New-Object psobject
        $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.title
        $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
        $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
        $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Metadata.MediaContainer.$contentquery.title
        if ($FileMetadata) {
            $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
        }
        $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Metadata.MediaContainer.$contentquery.originalTitle
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
        $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Metadata.MediaContainer.$contentquery.year
        $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
        $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
        $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
        $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $Metadata.MediaContainer.$contentquery.ratingKey
        $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
        $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
        $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
        $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
        $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
        $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
        $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
        $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
        $Libraries += $temp
        Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }

    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    if ($global:TitleCards -eq 'true' -and $mediatype -ne 'movie') {
        Write-Entry -Message "Query episodes data..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
        $totalSize = 0
        $excludePath = Join-Path -Path $AssetPath -ChildPath 'Collections'

        if ($FollowSymlink) {
            Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $AssetPath -Recurse | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }

        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }
    # Download poster foreach movie
    Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    $SkippingText = 'false'
                    $global:posterurl = $null
                    $global:ImageMagickError = $null
                    $global:TextlessPoster = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $global:IsFallback = $null
                    $global:PlexartworkDownloaded = $null
                    $global:langCode = $null
                    $global:direction = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern -and $entry.originalTitle) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }
                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }
                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {

                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            $Arturl = $null

                            if ($entry.PlexPosterUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl
                                }
                            }
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                    Default { $global:posterurl = GetFanartMoviePoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                }
                                if ($global:PosterPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if ($global:PosterOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Elseif ($global:FavProvider -eq 'FANART') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMoviePoster
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB' -and !$global:PosterOnlyTextless -and !$global:PosterPreferTextless) {
                                        $global:posterurl = GetTVDBMoviePoster
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl -and !$global:PosterOnlyTextless) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl -and $global:imdbid -and !$global:PosterOnlyTextless) {
                                        Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:posterurl = GetIMDBPoster
                                        $global:IsFallback = $true
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        if ($global:FavProvider -ne 'PLEX') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UsePosterResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                '4K'            { $Posteroverlay = $4kposter }
                                                '1080p'         { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }

                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                # Move file back to original naming with Brackets.
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "PosterImage: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $movietemp = New-Object psobject
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }

                                        # Export the array to a CSV file
                                        $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $movietemp.Type -title $movietemp.Title -Lib $movietemp.LibraryName -DLSource $movietemp.'Download Source' -lang $movietemp.Language -favurl $movietemp.'Fav Provider Link' -fallback $movietemp.Fallback -Truncated $movietemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $movietemp = New-Object psobject
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                    # Now we can start the Background Poster Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:ImageMagickError = $null
                            $global:TMDBfallbackposterurl = $null
                            $global:fanartfallbackposterurl = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            $Arturl = $null

                            if ($entry.PlexBackgroundUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl
                                }
                            }

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                    Default { $global:posterurl = GetFanartMovieBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMovieBackground
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBMovieBackground
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        if ($global:FavProvider -ne 'PLEX') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UseBackgroundResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                '4K'            { $backgroundoverlay = $4kBackground }
                                                '1080p'         { $backgroundoverlay = $1080pBackground }
                                                Default { $backgroundoverlay = $backgroundoverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "BackgroundImage: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                            $BackgroundCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $moviebackgroundtemp = New-Object psobject
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $moviebackgroundtemp.Type -title $moviebackgroundtemp.Title -Lib $moviebackgroundtemp.LibraryName -DLSource $moviebackgroundtemp.'Download Source' -lang $moviebackgroundtemp.Language -favurl $moviebackgroundtemp.'Fav Provider Link' -fallback $moviebackgroundtemp.Fallback -Truncated $moviebackgroundtemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $moviebackgroundtemp = New-Object psobject
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            if ($global:PosterOnlyTextless) {
                $moviebackgroundtemp = New-Object psobject
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                switch -Wildcard ($global:FavProvider) {
                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                    Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                }
                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                }
                # Export the array to a CSV file
                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            }

        }
    }

    $SkipTBACount = 0
    $SkipJapTitleCount = 0
    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Define Global Variables
                $SkippingText = 'false'
                $global:tmdbsearched = $null
                $global:tmdbid = $entry.tmdbid
                $global:tvdbid = $entry.tvdbid
                $global:imdbid = $entry.imdbid
                $Seasonpostersearchtext = $null
                $global:ImageMagickError = $null
                $Episodepostersearchtext = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $FanartSearched = $null
                $global:plexalreadysearched = $null
                $global:posterurl = $null
                $global:PosterWithText = $null
                $global:AssetTextLang = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:Fallback = $null
                $global:TextlessPoster = $null
                $global:tvdbalreadysearched = $null
                $global:PlexartworkDownloaded = $null
                $TakeLocal = $null
                $LocalAssetMissing = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    if ($entry.extraFolder) {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                    }
                    Else {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                    }
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $ManualTestPath = $ManualEntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    if ($entry.extraFolder) {
                        $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                    }
                    Else {
                        $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                    }
                    $TestPath = $AssetPath
                    $ManualTestPath = $ManualPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                        $Arturl = $null
                        if ($entry.PlexPosterUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexPosterUrl
                            }
                        }
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                            Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                            $LocalAssetMissing = 'true'
                        }
                        Else {
                            Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                Default { $global:posterurl = GetFanartShowPoster }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                            }
                            if ($global:PosterPreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                # try to find textless on TVDB
                                if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid ) {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    $global:tvdbalreadysearched = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                    $global:posterurl = GetFanartMoviePoster
                                    $global:IsFallback = $true
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                $global:PosterWithText = $true
                            }

                            if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                $global:posterurl = GetTVDBShowPoster
                                $global:IsFallback = $true
                                if (!$global:posterurl -and !$global:TMDBfallbackposterurl -and !$global:fanartfallbackposterurl) {
                                    if ($ArtUrl -and !$global:PosterOnlyTextless) {
                                        GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                        $global:plexalreadysearched = $True
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                            }
                            if (!$global:posterurl -and !$global:plexalreadysearched -eq 'true') {
                                $global:IsFallback = $true
                                if ($ArtUrl -and !$global:PosterOnlyTextless) {
                                    GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                    $global:plexalreadysearched = $True
                                }
                                Else {
                                    Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                if (!$global:posterurl) {
                                    Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                                $global:posterurl = $global:TMDBfallbackposterurl
                            }
                            if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                                $global:posterurl = $global:fanartfallbackposterurl
                            }
                        }
                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    if ($_.Exception.Response) {
                                        $statusCode = $_.Exception.Response.StatusCode.value__
                                    }
                                    else {
                                        $statusCode = $_.Exception.Message
                                    }
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TMDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'FANART') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    if ($global:FavProvider -ne 'PLEX') {
                                        $global:IsFallback = $true
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    if ($UsePosterResolutionOverlays -eq 'true') {
                                        switch ($entry.Resolution) {
                                            '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                            '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                            '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                            '4K'            { $Posteroverlay = $4kposter }
                                            '1080p'         { $Posteroverlay = $1080pPoster }
                                            Default { $Posteroverlay = $Posteroverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                        $SkippingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $fontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                # Default: Replace the symbol with a newline
                                                $replacementString = "`n"

                                                # Check if the symbol should be kept
                                                $keepThisSymbol = $false
                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                        if ($symbol -like "*$k*") {
                                                            $keepThisSymbol = $true
                                                            break # Match found, no need to keep checking
                                                        }
                                                    }
                                                }

                                                # If it's a "keep" symbol, change the replacement string
                                                if ($keepThisSymbol) {
                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                    $replacementString = $symbol + "`n"
                                                }
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddTextStroke -eq 'true') {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }

                                            Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                    # Move file back to original naming with Brackets.
                                    if (!$global:IsTruncated) {
                                        try {
                                            Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                            # Verify variables before uploading
                                            Write-Entry -Subtext "PosterImage: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                            $uri = if ($PlexToken) {
                                                "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                            }
                                            Else {
                                                "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                            }
                                            Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            # Try uploading, capturing the response in detail
                                            $Upload = Invoke-WebRequest -Uri $uri `
                                                                        -Method Post `
                                                                        -Headers $extraPlexHeaders `
                                                                        -Body $fileContent `
                                                                        -ContentType 'application/octet-stream' `
                                                                        -SkipHttpErrorCheck `
                                                                        -ErrorAction Stop

                                            if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                            }
                                            else {
                                                Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                            }
                                        }
                                        catch {
                                            Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            $global:errorCount++
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    $showtemp = New-Object psobject
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    # Export the array to a CSV file
                                    $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    SendMessage -type $showtemp.Type -title $showtemp.Title -Lib $showtemp.LibraryName -DLSource $showtemp.'Download Source' -lang $showtemp.Language -favurl $showtemp.'Fav Provider Link' -fallback $showtemp.Fallback -Truncated $showtemp.TextTruncated
                                }
                            }
                        }
                        Elseif ($LocalAssetMissing -eq 'true') {
                            Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            $showtemp = New-Object psobject
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                            $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                            $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                            }
                            if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                            }
                            # Export the array to a CSV file
                            $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
                # Now we can start the Background Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                        }
                        Else {
                            $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                    if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                        # Define Global Variables
                        $SkippingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:TextlessPoster = $null
                        $global:ImageMagickError = $null
                        $global:TMDBfallbackposterurl = $null
                        $global:fanartfallbackposterurl = $null
                        $TakeLocal = $null
                        $LocalAssetMissing = $null
                        $Arturl = $null

                        if ($entry.PlexBackgroundUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl
                            }
                        }

                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                            Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                            $LocalAssetMissing = 'true'
                        }
                        Else {
                            Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                Default { $global:posterurl = GetFanartShowBackground }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                            }
                            if ($global:BackgroundPreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                            }
                            if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                if ($global:FavProvider -eq 'TVDB') {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                                Else {
                                    $global:posterurl = GetFanartShowBackground
                                }
                            }
                            if (!$global:posterurl) {
                                if ($global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowBackground
                                    $global:IsFallback = $true
                                }
                                $global:FallbackText = 'True-Background'
                                if (!$global:posterurl) {
                                    if ($ArtUrl) {
                                        GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                            }

                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    if ($_.Exception.Response) {
                                        $statusCode = $_.Exception.Response.StatusCode.value__
                                    }
                                    else {
                                        $statusCode = $_.Exception.Message
                                    }
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TMDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'FANART') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    if ($global:FavProvider -ne 'PLEX') {
                                        $global:IsFallback = $true
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    if ($UseBackgroundResolutionOverlays -eq 'true') {
                                        switch ($entry.Resolution) {
                                            '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                            '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                            '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                            '4K'            { $backgroundoverlay = $4kBackground }
                                            '1080p'         { $backgroundoverlay = $1080pBackground }
                                            Default { $Backgroundoverlay = $Backgroundoverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                        $SkippingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $backgroundfontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                # Default: Replace the symbol with a newline
                                                $replacementString = "`n"

                                                # Check if the symbol should be kept
                                                $keepThisSymbol = $false
                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                        if ($symbol -like "*$k*") {
                                                            $keepThisSymbol = $true
                                                            break # Match found, no need to keep checking
                                                        }
                                                    }
                                                }

                                                # If it's a "keep" symbol, change the replacement string
                                                if ($keepThisSymbol) {
                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                    $replacementString = $symbol + "`n"
                                                }
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddBackgroundTextStroke -eq 'true') {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }

                                            Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument

                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                # Move file back to original naming with Brackets.
                                if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                    if (!$global:IsTruncated) {
                                        try {
                                            Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                            # Verify variables before uploading
                                            Write-Entry -Subtext "BackgroundImage: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                            $uri = if ($PlexToken) {
                                                "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                            }
                                            Else {
                                                "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                            }
                                            Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            # Try uploading, capturing the response in detail
                                            $Upload = Invoke-WebRequest -Uri $uri `
                                                                        -Method Post `
                                                                        -Headers $extraPlexHeaders `
                                                                        -Body $fileContent `
                                                                        -ContentType 'application/octet-stream' `
                                                                        -SkipHttpErrorCheck `
                                                                        -ErrorAction Stop

                                            if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                            }
                                            else {
                                                Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                            }
                                        }
                                        catch {
                                            Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            $global:errorCount++
                                            Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        $BackgroundCount++
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    $showbackgroundtemp = New-Object psobject
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    # Export the array to a CSV file
                                    $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    SendMessage -type $showbackgroundtemp.Type -title $showbackgroundtemp.Title -Lib $showbackgroundtemp.LibraryName -DLSource $showbackgroundtemp.'Download Source' -lang $showbackgroundtemp.Language -favurl $showbackgroundtemp.'Fav Provider Link' -fallback $showbackgroundtemp.Fallback -Truncated $showbackgroundtemp.TextTruncated
                                }
                            }
                        }
                        Elseif ($LocalAssetMissing -eq 'true') {
                            Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            $showbackgroundtemp = New-Object psobject
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                            }
                            if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                            }
                            # Export the array to a CSV file
                            $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                        }
                    }
                    else {
                        if ($show_skipped -eq 'true' ) {
                            Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                        }
                    }
                }
                # Now we can start the Season Part
                if ($global:SeasonPosters -eq 'true') {
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:TextlessPoster = $null
                    $global:seasonNames = $entry.SeasonNames -split ';'
                    $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                    $global:seasonNumbers = $entry.seasonNumbers -split ','
                    $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                    for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                        $SkippingText = 'false'
                        $global:tmdbsearched = $null
                        $global:seasontmp = $null
                        $global:posterurl = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TMDBSeasonFallback = $null
                        $global:TVDBSeasonFallback = $null
                        $global:FANARTSeasonFallback = $null
                        $TakeLocal = $null
                        $LocalAssetMissing = $null

                        if ($SeasonfontAllCaps -eq 'true') {
                            $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                        }
                        Else {
                            $global:seasonTitle = $global:seasonNames[$i]
                        }
                        $global:SeasonNumber = $global:seasonNumbers[$i]
                        $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                        $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                        if ($null -ne $global:SeasonNumber) {
                            $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                        }
                        if ($LibraryFolders -eq 'true') {
                            $SeasonImageoriginal = "$EntryDir\$global:seasontmp.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "$global:seasontmp"
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:seasontmp.jpg"
                            }
                            Else {
                                $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:seasontmp.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_$global:seasontmp"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $SeasonImageoriginal = ($SeasonImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                        $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:seasontmp.jpg"
                        $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            $Arturl = $null
                            if ($global:PlexSeasonUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $global:PlexSeasonUrl
                                }
                            }
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                if (!$Seasonpostersearchtext) {
                                    Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $Seasonpostersearchtext = $true
                                }
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage } }
                                    Default { $global:posterurl = GetFanartSeasonPoster }
                                }
                                # do a specific order
                                if ($global:SeasonPreferTextless -eq $true) {
                                    if (!$global:posterurl -or !$global:TextlessPoster) {
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                                $global:posterurl = GetTVDBSeasonPoster
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                    if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if (!$global:posterurl -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                                $global:posterurl = GetTVDBSeasonPoster
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ($ArtUrl) {
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                                GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage
                                                Write-Entry -Subtext "Function GetPlexArtwork called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Season Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                                if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                    # Lets just try to grab a show poster.
                                    Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'FANART' { $global:posterurl = GetFanartShowPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                        Default { $global:posterurl = GetFanartShowPoster }
                                    }
                                    if ($global:posterurl) {
                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Show'
                                    }
                                    Else {
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:posterurl = GetTMDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                            $global:posterurl = GetTVDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                            $global:posterurl = GetFanartShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                    }
                                }
                                if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                    $global:posterurl = $global:TMDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                    $global:posterurl = $global:FANARTSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                    $global:posterurl = $global:TVDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }

                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($global:ImageProcessing -eq 'true') {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'true') {
                                            # Resize Image to 2000x3000 and apply Border and overlay
                                            if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            else {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }

                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                $SkippingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddSeasonText -eq 'true' -and $SkippingText -eq 'false') {
                                                $global:seasonTitle = $global:seasonTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                    $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                Else {
                                                    $global:ShowTitleOnSeason = $titletext -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        # Default: Replace the symbol with a newline
                                                        $replacementString = "`n"

                                                        # Check if the symbol should be kept
                                                        $keepThisSymbol = $false
                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                if ($symbol -like "*$k*") {
                                                                    $keepThisSymbol = $true
                                                                    break # Match found, no need to keep checking
                                                                }
                                                            }
                                                        }

                                                        # If it's a "keep" symbol, change the replacement string
                                                        if ($keepThisSymbol) {
                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                            $replacementString = $symbol + "`n"
                                                        }
                                                        $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), $replacementString
                                                        if ($AddShowTitletoSeason -eq 'true') {
                                                            $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), $replacementString
                                                        }
                                                    }
                                                }
                                                $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                if ($AddShowTitletoSeason -eq 'true') {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext ("Optimal Season font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        Write-Entry -Subtext ("Optimal Show font size set to: '{0}' [{1}]" -f $showoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Season Part
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $SeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                        # Show Part
                                                        # Add Stroke
                                                        if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                    }
                                                }
                                                Else {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Arguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Resize Image to 2000x3000
                                        $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($SeasonImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "SeasonImage: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($global:SeasonRatingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $SeasonCount++
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $seasontemp = New-Object psobject
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$SeasonImage} Else {$global:posterurl})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $seasontemp.Type -title $seasontemp.Title -Lib $seasontemp.LibraryName -DLSource $seasontemp.'Download Source' -lang $seasontemp.Language -favurl $seasontemp.'Fav Provider Link' -fallback $seasontemp.Fallback -Truncated $seasontemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $seasontemp = New-Object psobject
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Episode Part
                if ($global:TitleCards -eq 'true') {
                    # Loop through each episode
                    foreach ($episode in $Episodedata) {
                        $SkippingText = 'false'
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:TempImagecopied = $false
                        $EpisodeTempImage = $null
                        $global:ImageMagickError = $null
                        $global:season_number = $null
                        $Episodepostersearchtext = $null
                        $global:show_name = $null
                        $global:episodenumber = $null
                        $global:episode_numbers = $null
                        $global:titles = $null
                        $global:posterurl = $null
                        $global:FileNaming = $null
                        $EpisodeImageoriginal = $null
                        $EpisodeImage = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TextlessPoster = $null
                        $global:EPResolutions = $null

                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                            $global:show_name = $episode."Show Name"
                            $global:EPResolutions = $episode."Resolutions".Split(",")
                            $global:season_number = $episode."Season Number"
                            $global:episode_numbers = $episode."Episodes".Split(",")
                            $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                            $global:titles = $episode."Title".Split(";")
                            $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                            if ($UseBackgroundAsTitleCard -eq 'true') {
                                $global:ImageMagickError = $null
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkippingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $LocalAssetMissing = $null
                                    $global:PlexTitleCardUrl = $entry.PlexBackgroundUrl
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:EPResolution = $($global:EPResolutions[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                    $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {

                                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                            $Arturl = $null
                                            if ($global:PlexTitleCardUrl -like "/library/*") {
                                                if ($PlexToken) {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                }
                                            }
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }

                                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                $LocalAssetMissing = 'true'
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                if ($global:TempImagecopied -ne 'true') {
                                                    # now search for TitleCards
                                                    if ($global:FavProvider -eq 'TMDB') {
                                                        if ($episode.tmdbid) {
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if ($global:tmdbfallbackposterurl) {
                                                                    $global:posterurl = $global:tmdbfallbackposterurl
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($episode.tvdbid) {
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal -or $global:TempImagecopied -eq 'true') {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded -and $global:TempImagecopied -ne 'true') {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }

                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Taking temp image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                            Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                        }
                                                    }
                                                    $global:TempImagecopied = $true
                                                    # Check temp image
                                                    if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                        Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'true') {
                                                                if ($UseTCResolutionOverlays -eq 'true') {
                                                                    switch ($global:EPResolution) {
                                                                        '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                        '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                        '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                        '4K'            { $TitleCardoverlay = $4kTC }
                                                                        '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                        Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                    }
                                                                }
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                else {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                    $SkippingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            # Default: Replace the symbol with a newline
                                                                            $replacementString = "`n"

                                                                            # Check if the symbol should be kept
                                                                            $keepThisSymbol = $false
                                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                    if ($symbol -like "*$k*") {
                                                                                        $keepThisSymbol = $true
                                                                                        break # Match found, no need to keep checking
                                                                                    }
                                                                                }
                                                                            }

                                                                            # If it's a "keep" symbol, change the replacement string
                                                                            if ($keepThisSymbol) {
                                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                $replacementString = $symbol + "`n"
                                                                            }
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            try {
                                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                # Verify variables before uploading
                                                                Write-Entry -Subtext "EpisodeImage: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                                $uri = if ($PlexToken) {
                                                                    "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                                }
                                                                Else {
                                                                    "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                                }
                                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                # Try uploading, capturing the response in detail
                                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                                            -Method Post `
                                                                                            -Headers $extraPlexHeaders `
                                                                                            -Body $fileContent `
                                                                                            -ContentType 'application/octet-stream' `
                                                                                            -SkipHttpErrorCheck `
                                                                                            -ErrorAction Stop

                                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                                }
                                                                else {
                                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                }
                                                            }
                                                            catch {
                                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                $global:errorCount++
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                        SendMessage -type $episodetemp.Type -title $($global:show_name + " | " + $episodetemp.Title) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                    }
                                                }
                                            }
                                            Elseif ($LocalAssetMissing -eq 'true') {
                                                Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:BackgroundOnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                    }
                                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                    }
                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }

                                            }

                                        }
                                        else {
                                            if ($show_skipped -eq 'true' ) {
                                                Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            }
                                        }
                                    }
                                }
                                if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                    Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkippingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:FallbackText = $null
                                    $global:ImageMagickError = $null
                                    $global:TextlessPoster = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $LocalAssetMissing = $null
                                    $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {

                                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                            $Arturl = $null
                                            if ($global:PlexTitleCardUrl -like "/library/*") {
                                                if ($PlexToken) {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                }
                                            }
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }
                                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                $LocalAssetMissing = 'true'
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl -or $global:Fallback -eq "TVDB") {
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if ($global:posterurl){
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl -or $global:Fallback -eq "TMDB") {
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if ($global:posterurl){
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                        if (!$global:ImageMagickError -eq 'true') {
                                                            if ($UseTCResolutionOverlays -eq 'true') {
                                                                switch ($global:EPResolution) {
                                                                    '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                    '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                    '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                    '4K'            { $TitleCardoverlay = $4kTC }
                                                                    '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                    Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                }
                                                            }
                                                            # Resize Image to 2000x3000 and apply Border and overlay
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            else {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                $SkippingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                    $global:EPTitle = $global:EPTitle.ToUpper()
                                                                }
                                                                $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                                if ($global:direction -eq "RTL") {
                                                                    $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                }
                                                                # Loop through each symbol and replace it with a newline
                                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                    foreach ($symbol in $NewLineSymbols) {
                                                                        # Default: Replace the symbol with a newline
                                                                        $replacementString = "`n"

                                                                        # Check if the symbol should be kept
                                                                        $keepThisSymbol = $false
                                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                if ($symbol -like "*$k*") {
                                                                                    $keepThisSymbol = $true
                                                                                    break # Match found, no need to keep checking
                                                                                }
                                                                            }
                                                                        }

                                                                        # If it's a "keep" symbol, change the replacement string
                                                                        if ($keepThisSymbol) {
                                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                            $replacementString = $symbol + "`n"
                                                                        }
                                                                        $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                    }
                                                                }
                                                                $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                            if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                }
                                                                $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            try {
                                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                # Verify variables before uploading
                                                                Write-Entry -Subtext "EpisodeImage: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                                $uri = if ($PlexToken) {
                                                                    "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                                }
                                                                Else {
                                                                    "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                                }
                                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                # Try uploading, capturing the response in detail
                                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                                            -Method Post `
                                                                                            -Headers $extraPlexHeaders `
                                                                                            -Body $fileContent `
                                                                                            -ContentType 'application/octet-stream' `
                                                                                            -SkipHttpErrorCheck `
                                                                                            -ErrorAction Stop

                                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                                }
                                                                else {
                                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                }
                                                            }
                                                            catch {
                                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                $global:errorCount++
                                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                        SendMessage -type $episodetemp.Type -title $($global:show_name + " | " + $episodetemp.Title) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                    }
                                                }
                                            }
                                            Elseif ($LocalAssetMissing -eq 'true') {
                                                Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:BackgroundOnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                    }
                                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                    }
                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }

                                            }

                                        }
                                        else {
                                            if ($show_skipped -eq 'true' ) {
                                                Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
    }
    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "

    Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
        $ImageChoicesDummycsv = New-Object psobject

        # Add members to the object with empty values
        $ImageChoicesDummycsv = New-Object psobject
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Manual" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

        $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
        Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-TextSizeCacheSummary
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Export json
    $jsonObject = [PSCustomObject]@{
        Posters              = if ($posterCount) { $posterCount } Else { 0 }
        Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
        Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
        Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
        Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
        Mode                 = $Mode
        Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
        Errors               = if ($errorCount) { $errorCount } Else { 0 }
        Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
        Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
        Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
        Text                 = if ($TextCount) { $TextCount } Else { 0 }
        "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
        "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
        "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
        "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
        "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
        "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
        "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
        "Script Version"     = $CurrentScriptVersion
        "IM Version"         = $global:CurrentImagemagickversion
        "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
        "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
    }

    $jsonOutput = $jsonObject | ConvertTo-Json
    $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
#region Arr Mode
Elseif ($ArrTrigger) {
    $posterCount = 0
    $arrplatform = $arrTriggers['arr_platform']
    $Mode = "arr"
    Write-Entry -Message "ArrTrigger Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    switch ($arrplatform) {
        'Sonarr' {
            Write-Entry -Message "Processing Sonarr trigger" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            $seriesTitle = $arrTriggers['arr_series_title']
            $seasonIndex = $arrTriggers['arr_episode_season']
            $episodeIndex = $arrTriggers['arr_episode_numbers']
            $seriesYear = $arrTriggers['arr_sonarr_series_year']
            Write-Entry -Message "Series: '$seriesTitle' ($seriesYear) - Season $seasonIndex, Episode $episodeIndex" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

            if ($UseJellyfin -eq 'true') {
                Write-Entry -Message "Using Jellyfin media server" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $seriesSearch = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?IncludeItemTypes=Series&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags,Width,Height&Recursive=true&SearchTerm=$seriesTitle&api_key=$OtherMediaServerApiKey"
                $seriesItem = $seriesSearch.Items | Where-Object { $_.ProductionYear -eq $seriesYear } | Select-Object -First 1
                if (-not $seriesItem) {
                    Write-Entry -Message "Series '$seriesTitle' ($seriesYear) not found in Jellyfin" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
                Write-Entry -Message "Found series: $($seriesItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $seriesId = $seriesItem.Id

                $seasons = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?ParentId=$seriesId&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags,Width,Height&IncludeItemTypes=Season&api_key=$OtherMediaServerApiKey"
                $seasonItem = $seasons.Items | Where-Object { $_.IndexNumber -eq $seasonIndex }
                if (-not $seasonItem) {
                    Write-Entry -Message "Season $seasonIndex not found for series $($seriesItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
                Write-Entry -Message "Found season $seasonIndex" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $seasonId = $seasonItem.Id

                $episodes = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?ParentId=$seasonId&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,Settings,Tags,Width,Height&IncludeItemTypes=Episode&api_key=$OtherMediaServerApiKey"
                $episodeItem = $episodes.Items | Where-Object { $_.IndexNumber -eq $episodeIndex }
                if (-not $episodeItem) {
                    Write-Entry -Message "Episode $episodeIndex not found in season $seasonIndex of series $($seriesItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
                Write-Entry -Message "Found episode $($episodeIndex): $($episodeItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

                $AllShows = [PSCustomObject]@{ Items = @($seriesItem) }
                $AllEpisodes = [PSCustomObject]@{ Items = @($episodeItem) }
            }
            elseif ($UseEmby -eq 'true') {
                Write-Entry -Message "Using Emby media server" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $seriesSearch = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?IncludeItemTypes=Series&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags,Width,Height&Recursive=true&SearchTerm=$seriesTitle&api_key=$OtherMediaServerApiKey"
                $seriesItem = $seriesSearch.Items | Where-Object { $_.ProductionYear -eq $seriesYear } | Select-Object -First 1
                if (-not $seriesItem) {
                    Write-Entry -Message "Series '$seriesTitle' ($seriesYear) not found in Jellyfin" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Series '$seriesTitle' ($seriesYear) not found in Jellyfin"
                    }
                    Exit
                }
                Write-Entry -Message "Found series: $($seriesItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $seriesId = $seriesItem.Id

                $seasons = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?ParentId=$seriesId&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags,Width,Height&IncludeItemTypes=Season&api_key=$OtherMediaServerApiKey"
                $seasonItem = $seasons.Items | Where-Object { $_.IndexNumber -eq $seasonIndex }
                if (-not $seasonItem) {
                    Write-Entry -Message "Season $seasonIndex not found for series $($seriesItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Season $seasonIndex not found for series $($seriesItem.Name)"
                    }
                    Exit
                }
                Write-Entry -Message "Found season $seasonIndex" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $seasonId = $seasonItem.Id

                $episodes = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?ParentId=$seasonId&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,Settings,Tags,Width,Height&IncludeItemTypes=Episode&api_key=$OtherMediaServerApiKey"
                $episodeItem = $episodes.Items | Where-Object { $_.IndexNumber -eq $episodeIndex }
                if (-not $episodeItem) {
                    Write-Entry -Message "Episode $episodeIndex not found in season $seasonIndex of series $($seriesItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Episode $episodeIndex not found in season $seasonIndex of series $($seriesItem.Name)"
                    }
                    Exit
                }
                Write-Entry -Message "Found episode $($episodeIndex): $($episodeItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

                $AllShows = [PSCustomObject]@{ Items = @($seriesItem) }
                $AllEpisodes = [PSCustomObject]@{ Items = @($episodeItem) }
            }
            elseif ($UsePlex -eq 'true') {
                Write-Entry -Message "Using Plex media server" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $searchUrl = "$PlexUrl/search?query=$([uri]::EscapeDataString($seriesTitle))"
                if ($PlexToken) { $searchUrl += "&X-Plex-Token=$PlexToken" }
                [xml]$searchXml = (Invoke-WebRequest $searchUrl -Headers $extraPlexHeaders).content
                $shows = $searchXml.MediaContainer.directory | Where-Object { $_.type -eq 'show' }

                if ($null -eq $shows -or $shows.Count -eq 0) {
                    Write-Entry -Message "No shows found matching '$seriesTitle'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "No shows found matching '$seriesTitle'"
                    }
                    Exit
                }

                Write-Entry -Message "Found $($shows.Count) show(s) matching '$seriesTitle'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                if ($shows.Count -gt 1) { $shows = $shows | Where-Object { $_.year -eq $seriesYear } }
                if ($shows.type -eq 'show') {
                    Write-Entry -Message "Selected show: $($shows.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $contentquery = "Directory"
                    $queryKey = $shows.RatingKey
                }
                $metadataUrl = "$PlexUrl/library/metadata/$($queryKey)"
                $seasonUrl = "$PlexUrl/library/metadata/$($queryKey)/children?"
                if ($PlexToken) {
                    $metadataUrl += "?X-Plex-Token=$PlexToken"
                    $seasonUrl += "X-Plex-Token=$PlexToken"
                }
                [xml]$Metadata = (Invoke-WebRequest $metadataUrl -Headers $extraPlexHeaders).content
                if ($contentquery -eq 'Directory') {
                    [xml]$Seasondata = (Invoke-WebRequest $seasonUrl -Headers $extraPlexHeaders).content
                }
            }
        }
        'Radarr' {
            Write-Entry -Message "Processing Radarr trigger" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            $movieTitle = $arrTriggers['arr_movie_title']
            $movieYear = $arrTriggers['arr_movie_year']
            Write-Entry -Message "Movie: '$movieTitle' ($movieYear)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

            if ($UseJellyfin -eq 'true') {
                Write-Entry -Message "Using Jellyfin media server" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $movieSearch = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?IncludeItemTypes=Movie&Recursive=true&Fields=ProviderIds,OriginalTitle,Settings,Path,Overview,ProductionYear,Tags,Width,Height&SearchTerm=$movieTitle&api_key=$OtherMediaServerApiKey"
                $movieItem = $movieSearch.Items | Where-Object { $_.ProductionYear -eq $movieYear } | Select-Object -First 1
                if (-not $movieItem) {
                    Write-Entry -Message "Movie '$movieTitle' ($movieYear) not found in Jellyfin" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Movie '$movieTitle' ($movieYear) not found in Jellyfin"
                    }
                    Exit
                }
                Write-Entry -Message "Found movie: $($movieItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $AllMovies = [PSCustomObject]@{ Items = @($movieItem) }
            }
            elseif ($UseEmby -eq 'true') {
                Write-Entry -Message "Using Emby media server" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $movieSearch = Invoke-RestMethod -Uri "$OtherMediaServerUrl/Items?IncludeItemTypes=Movie&Recursive=true&Fields=ProviderIds,OriginalTitle,Settings,Path,Overview,ProductionYear,Tags,Width,Height&SearchTerm=$movieTitle&api_key=$OtherMediaServerApiKey"
                $movieItem = $movieSearch.Items | Where-Object { $_.ProductionYear -eq $movieYear } | Select-Object -First 1
                if (-not $movieItem) {
                    Write-Entry -Message "Movie '$movieTitle' ($movieYear) not found in Jellyfin" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "Movie '$movieTitle' ($movieYear) not found in Jellyfin"
                    }
                    Exit
                }
                Write-Entry -Message "Found movie: $($movieItem.Name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $AllMovies = [PSCustomObject]@{ Items = @($movieItem) }
            }
            elseif ($UsePlex -eq 'true') {
                Write-Entry -Message "Using Plex media server" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                $searchUrl = "$PlexUrl/search?query=$([uri]::EscapeDataString($movieTitle))"
                if ($PlexToken) { $searchUrl += "&X-Plex-Token=$PlexToken" }
                [xml]$searchXml = (Invoke-WebRequest $searchUrl -Headers $extraPlexHeaders).content
                $movies = $searchXml.MediaContainer.video | Where-Object { $_.type -eq 'movie' }

                if ($null -eq $movies -or $movies.Count -eq 0) {
                    Write-Entry -Message "No movies found matching '$movieTitle'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    # Clear Running File
                    if (Test-Path $CurrentlyRunning) {
                        try {
                            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                        }
                        catch {
                            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    if ($global:UptimeKumaUrl) {
                        Send-UptimeKumaWebhook -status "down" -msg "No movies found matching '$movieTitle'"
                    }
                    Exit
                }

                Write-Entry -Message "Found $($movies.Count) movie(s) matching '$movieTitle'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                if ($movies.Count -gt 1) { $movies = $movies | Where-Object { $_.year -eq $movieYear } }
                if ($movies.type -eq 'movie') {
                    Write-Entry -Message "Selected movie: $($movies.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                    $contentquery = "video"
                    $queryKey = $movies.RatingKey
                }
                $metadataUrl = "$PlexUrl/library/metadata/$($queryKey)"
                if ($PlexToken) { $metadataUrl += "?X-Plex-Token=$PlexToken" }
                [xml]$Metadata = (Invoke-WebRequest $metadataUrl -Headers $extraPlexHeaders).content
            }
        }
        default { Write-Entry -Message "Unknown platform: $arrplatform" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error }
    }
    $Libraries = @()
    if ($UseJellyfin -eq 'true' -or $UseEmby -eq 'true') {
        $PreferredMetadataLanguage = (Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/System/Configuration?api_key=$OtherMediaServerApiKey").PreferredMetadataLanguage
        foreach ($Movie in $AllMovies.Items) {
            $Resolution = $null
            if ($UseEmby -eq 'true') {
                $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
                $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

                $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
                $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
                $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations, LibraryOptions -Unique

                foreach ($singlelibrary in $librariestemp) {
                    foreach ($location in $singlelibrary.Locations) {
                        # Select correct NetworkPath
                        $LibraryOptions = $singlelibrary.LibraryOptions.PathInfos | Where-Object { $_.Path -eq $location }
                        if ($LibraryOptions.NetworkPath) {
                            $location = $LibraryOptions.NetworkPath
                        }

                        Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        # Compare lib.Path with each location
                        if ($Movie.Path -like "$($location)/*" -or $Movie.Path -like "$($location)\*") {
                            $SingleLibName = $singlelibrary.Name
                            Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            break # Exit loop after match
                        }
                    }
                }
                if ($SingleLibName -notin $LibstoExclude) {
                    Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $($lib.Path[1])" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $($lib.Path[1])
                    $libpath = $Matchedpath
                    $relativePath = $Movie.Path.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }

                    if ($Movie.Tags) {
                        $Labels = $($Movie.Tags -join ',')
                    }
                    Else {
                        $Labels = ""
                    }
                    # Determine resolution category
                    if ($movie.Width -and $movie.Height) {
                        $Resolution = Get-Resolution -Width $movie.Width
                    }

                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $temp = New-Object psobject
                    $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                    $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
                    $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                    $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
                    $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
                    $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
                    $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
                    if ($Resolution) {
                        $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                    }
                    $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
                    $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
                    $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
                    $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                    $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                    $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                    $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
                    $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
                    $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                    $Libraries += $temp
                    Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                }
            }
            Else {
                $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
                $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

                $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
                $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
                $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

                foreach ($singlelibrary in $librariestemp) {
                    # Loop through each location in the library's Locations array
                    foreach ($location in $singlelibrary.Locations) {
                        Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        # Compare lib.Path with each location
                        if ($Movie.Path -like "$location/*" -or $Movie.Path -like "$location\*") {
                            $SingleLibName = $singlelibrary.Name
                            Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            break # Exit loop after match
                        }
                    }
                }
                if ($SingleLibName -notin $LibstoExclude) {
                    Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    if ($lib.Path.count -gt '1') {
                        $Matchedpath = AddTrailingSlash $($lib.Path[0])
                    }
                    else {
                        $Matchedpath = AddTrailingSlash $($lib.Path)
                    }
                    $libpath = $Matchedpath
                    $relativePath = $Movie.Path.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }

                    if ($Movie.Tags) {
                        $Labels = $($Movie.Tags -join ',')
                    }
                    Else {
                        $Labels = ""
                    }
                    # Determine resolution category
                    if ($movie.Width -and $movie.Height) {
                        $Resolution = Get-Resolution -Width $movie.Width
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $temp = New-Object psobject
                    $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                    $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
                    $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                    $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
                    $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
                    $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
                    $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
                    if ($Resolution) {
                        $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                    }
                    $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
                    $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
                    $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
                    $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                    $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                    $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                    $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
                    $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
                    $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                    $Libraries += $temp
                    Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                }
            }
        }
        foreach ($Show in $AllShows.Items) {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Show.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, path

            $libraryQuery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
            $librarytemp = Invoke-RestMethod -Method Get -Uri $libraryQuery
            if ($UseEmby -eq 'true') {
                $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations, LibraryOptions -Unique
            }
            Else {
                $librariestemp = $librarytemp | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations -Unique
            }
            foreach ($singlelibrary in $librariestemp) {
                # Loop through each location in the library's Locations array
                foreach ($location in $singlelibrary.Locations) {
                    if ($UseEmby -eq 'true') {
                        # Select correct NetworkPath
                        $LibraryOptions = $singlelibrary.LibraryOptions.PathInfos | Where-Object { $_.Path -eq $location }
                        if ($LibraryOptions.NetworkPath) {
                            $location = $LibraryOptions.NetworkPath
                        }
                    }
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Show.Path -like "$location/*" -or $Show.Path -like "$location\*") {
                        $SingleLibName = $singlelibrary.Name
                        #Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Show.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $Matchedpath = AddTrailingSlash $($lib.Path)
                $libpath = $Matchedpath
                $relativePath = $Show.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }

                if ($Show.Tags) {
                    $Labels = $($Show.Tags -join ',')
                }
                Else {
                    $Labels = ""
                }

                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Show.Type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Show.Id
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Show.Name
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Show.OriginalTitle
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Show.ProductionYear
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Show.ProviderIds.Imdb
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Show.ProviderIds.Tmdb
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Show.ProviderIds.Tvdb
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Show.ImageTags.Primary
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Show.BackdropImageTags -join ",")
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Message "Starting episode data query now - This can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -Log Info

        $Episodedata = @()
        $TempShowLibs = $Libraries | Where-Object { $_."Library Type" -eq 'Series' }
        foreach ($show in $TempShowLibs) {
            # Iterate through all shows
            $seasons = $AllEpisodes.Items | Where-Object { $_.SeriesId -eq $show.id } | Group-Object -Property SeasonName | Sort-Object -Property Name
            foreach ($Season in $Seasons) {
                # Sort episodes within the season by IndexNumber
                $SeasonEpisodes = $Season.Group | Sort-Object -Property indexnumber

                # Collect episode IDs, Titles, and PrimaryImageTags
                $EpisodeIds = ($SeasonEpisodes.Id -join ',')
                $EpisodeWidths = ($SeasonEpisodes.Width -join ',')
                $EpisodeHeights = ($SeasonEpisodes.Height -join ',')
                $EpisodeTitles = ($SeasonEpisodes.Name -join ';')
                $Episodes = ($SeasonEpisodes.IndexNumber -join ',')
                $Thumbs = ($SeasonEpisodes.ImageTags.Primary -join ',')

                # Calculate the ShowID and SeasonId
                $ShowID = if ($SeasonEpisodes.SeriesId) { $SeasonEpisodes.SeriesId } else { $null }
                $SeasonId = if ($SeasonEpisodes.SeasonId) { $SeasonEpisodes.SeasonId } else { $null }

                # Create an object for the current season
                $seasonObject = [PSCustomObject]@{
                    "Library Name"                 = $show."Library Name"
                    "Show Name"                    = $show.title
                    "Show Original Name"           = $show.OriginalTitle
                    "Library Language"             = $PreferredMetadataLanguage
                    "ShowID"                       = $ShowID
                    "SeasonId"                     = $SeasonId
                    "EpisodeIds"                   = $EpisodeIds
                    "EpisodeWidths"                = $EpisodeWidths
                    "EpisodeHeights"               = $EpisodeHeights
                    "tvdbid"                       = $show.tvdbid
                    "imdbid"                       = $show.imdbid
                    "tmdbid"                       = $show.tmdbid
                    "type"                         = "Episode"
                    "Season Number"                = $SeasonEpisodes[0].ParentIndexNumber
                    "SeasonName"                   = $Season.Name
                    "Episodes"                     = $Episodes
                    "Title"                        = $EpisodeTitles
                    "OtherMediaServerTitleCardTag" = $Thumbs
                    "OtherMediaServerSeasonTag"    = $SeasonEpisodes[0].SeriesPrimaryImageTag
                }

                # Add the season object to the array
                $Episodedata += $seasonObject
            }
        }
        # Create an empty array to hold the custom objects
        $FormattedData = @()

        # Iterate over each item in $OtherEpisodedata
        foreach ($data in $Episodedata) {
            $EpisodeWidths = $data.EpisodeWidths -split ","
            $EpisodeHeights = $data.EpisodeHeights -split ","
            # Initialize an empty array for resolutions
            $Resolution = @()

            # Loop through each episode and determine resolution
            for ($i = 0; $i -lt $EpisodeWidths.Count; $i++) {
                $Width = [int]$EpisodeWidths[$i]
                $Resolution += Get-Resolution -Width $Width
            }
            # Create a custom object for each episode using the variables
            $FormattedData += [PSCustomObject]@{
                'Library Name'                 = $data.'Library Name'
                'Show Name'                    = $data.'Show Name'
                'Show Original Name'           = $data.'Show Original Name'
                'Library Language'             = $data.'Library Language'
                'ShowID'                       = $data.'ShowID'
                'SeasonId'                     = $data.'SeasonId'
                'EpisodeIds'                   = $data.'EpisodeIds'
                'Resolutions'                  = $Resolution -join ","
                'tvdbid'                       = $data.'tvdbid'
                'imdbid'                       = $data.'imdbid'
                'tmdbid'                       = $data.'tmdbid'
                'type'                         = $data.'type'
                'Season Number'                = $data.'Season Number'
                'SeasonName'                   = $data.'SeasonName'
                'Episodes'                     = $data.'Episodes'
                'Title'                        = $data.'Title'
                'OtherMediaServerTitleCardTag' = $data.'OtherMediaServerTitleCardTag'
                'OtherMediaServerSeasonTag'    = $data.'OtherMediaServerSeasonTag'
            }
        }

        # Export the formatted data to CSV
        $Episodedata = $FormattedData
        if ($AllEpisodes) {
            Write-Entry -Subtext "Found '$($AllEpisodes.Items.count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }

        $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'Series' }
        $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'Movie' }

        # Store all Files from asset dir in a hashtable
        Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        try {
            $directoryHashtable = @{}
            $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
            $totalSize = 0
            $excludePath = Join-Path -Path $AssetPath -ChildPath 'Collections'

            if ($FollowSymlink) {
                Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | Where-Object {
                    $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
                } | ForEach-Object {
                    if ($allowedExtensions -contains $_.Extension.ToLower()) {
                        $directory = $_.Directory
                        $basename = $_.BaseName
                        if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                            $directoryHashtable["$directory/$basename"] = $true
                        }
                        Else {
                            $directoryHashtable["$directory\$basename"] = $true
                        }
                    }
                    $totalSize += $_.Length
                }
            }
            Else {
                Get-ChildItem -Path $AssetPath -Recurse | Where-Object {
                    $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
                } | ForEach-Object {
                    if ($allowedExtensions -contains $_.Extension.ToLower()) {
                        $directory = $_.Directory
                        $basename = $_.BaseName
                        if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                            $directoryHashtable["$directory/$basename"] = $true
                        }
                        Else {
                            $directoryHashtable["$directory\$basename"] = $true
                        }
                    }
                    $totalSize += $_.Length
                }
            }

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($totalSize -gt 1GB) {
                $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
            }
            elseif ($totalSize -gt 1MB) {
                $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
            }
            elseif ($totalSize -gt 1KB) {
                $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
            }
            else {
                $totalSizeString = "$totalSize bytes"
            }

            Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
            Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
        catch {
            Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
            }
            Exit
        }
        if ($global:logLevel -eq '3') {
            Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
        }

        Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        # Movie Part
        foreach ($entry in $AllMovies) {
            try {
                if ($($entry.RootFoldername)) {
                    # check if item has skip label
                    if ($entry.labels -match 'skip_posterizarr') {
                        Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    }
                    Else {
                        $global:posterurl = $null
                        $global:ImageMagickError = $null
                        $global:TMDBfallbackposterurl = $null
                        $global:fanartfallbackposterurl = $null
                        $global:IsFallback = $null
                        $global:langCode = $null
                        $global:direction = $null

                        # Determine the language direction
                        $global:langCode = $entry.'Library Language'
                        $global:direction = $global:languageDirections[$global:langCode]

                        $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                        if ($entry.title -match $cjkPattern -and $entry.originalTitle) {
                            $Titletext = $entry.originalTitle
                        }
                        else {
                            $Titletext = $entry.title
                        }

                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $PosterImageoriginal = "$EntryDir\poster.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "poster"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                            }
                            Else {
                                $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = $($entry.RootFoldername)
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }
                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                        $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        # Now we can start the Poster Part
                        if ($global:Posters -eq 'true') {
                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                # Define Global Variables
                                $SkippingText = 'false'
                                $global:tmdbid = $entry.tmdbid
                                $global:tvdbid = $entry.tvdbid
                                $global:imdbid = $entry.imdbid
                                $global:TextlessPoster = $null
                                $global:posterurl = $null
                                $global:PosterWithText = $null
                                $global:AssetTextLang = $null
                                $global:TMDBAssetTextLang = $null
                                $global:FANARTAssetTextLang = $null
                                $global:TVDBAssetTextLang = $null
                                $global:TMDBAssetChangeUrl = $null
                                $global:FANARTAssetChangeUrl = $null
                                $global:TVDBAssetChangeUrl = $null
                                $global:Fallback = $null
                                $global:IsFallback = $null
                                $global:ImageMagickError = $null
                                $TakeLocal = $null
                                $LocalAssetMissing = $null
                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                    Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                    $LocalAssetMissing = 'true'
                                }
                                Else {
                                    Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                        'FANART' { $global:posterurl = GetFanartMoviePoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                        Default { $global:posterurl = GetFanartMoviePoster }
                                    }
                                    switch -Wildcard ($global:Fallback) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                        'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    }
                                    if ($global:PosterPreferTextless -eq 'True') {
                                        if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                            $global:posterurl = $global:fanartfallbackposterurl
                                            Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                            $global:posterurl = $global:TMDBfallbackposterurl
                                            Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }

                                    if ($global:PosterOnlyTextless -and !$global:posterurl) {
                                        if ($global:FavProvider -eq 'TVDB') {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Elseif ($global:FavProvider -eq 'FANART') {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetTVDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            $global:posterurl = GetFanartMoviePoster
                                            if (!$global:FavProvider -eq 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetTVDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }

                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TVDB' -and !$global:PosterOnlyTextless -and !$global:PosterPreferTextless) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl -and $global:imdbid -and !$global:PosterOnlyTextless) {
                                            Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:posterurl = GetIMDBPoster
                                            $global:IsFallback = $true
                                            if (!$global:posterurl) {
                                                Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                    }
                                }
                                if ($fontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                                if ($global:posterurl -or $TakeLocal) {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }
                                        try {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                    }
                                    if ($global:ImageProcessing -eq 'true') {
                                        Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'True') {
                                            if ($UsePosterResolutionOverlays -eq 'true') {
                                                switch ($entry.Resolution) {
                                                    '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                    '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                    '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                    '4K'            { $Posteroverlay = $4kposter }
                                                    '1080p'         { $Posteroverlay = $1080pPoster }
                                                    Default { $Posteroverlay = $Posteroverlay }
                                                }
                                            }
                                            # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                            if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            else {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                $SkippingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                                if ($global:direction -eq "RTL") {
                                                    $fontImagemagick = $RTLfontImagemagick
                                                }
                                                $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        # Default: Replace the symbol with a newline
                                                        $replacementString = "`n"

                                                        # Check if the symbol should be kept
                                                        $keepThisSymbol = $false
                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                if ($symbol -like "*$k*") {
                                                                    $keepThisSymbol = $true
                                                                    break # Match found, no need to keep checking
                                                                }
                                                            }
                                                        }

                                                        # If it's a "keep" symbol, change the replacement string
                                                        if ($keepThisSymbol) {
                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                            $replacementString = $symbol + "`n"
                                                        }
                                                        $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                    }
                                                }
                                                $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                                if (!$global:IsTruncated) {
                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    # Add Stroke
                                                    if ($AddTextStroke -eq 'true') {
                                                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                    }
                                                    Else {
                                                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                    }
                                                    Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $logEntry = "`"$magick`" $Arguments"
                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                    # Move file back to original naming with Brackets.
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                            if (!$global:IsTruncated) {
                                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImage
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $posterCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            $movietemp = New-Object psobject
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                            }

                                            # Export the array to a CSV file
                                            $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $movietemp.Type -title $movietemp.Title -Lib $movietemp.LibraryName -DLSource $movietemp.'Download Source' -lang $movietemp.Language -favurl $movietemp.'Fav Provider Link' -fallback $movietemp.Fallback -Truncated $movietemp.TextTruncated
                                        }
                                    }
                                }
                                Elseif ($LocalAssetMissing -eq 'true') {
                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $movietemp = New-Object psobject
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                    }
                                    # Export the array to a CSV file
                                    $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                }
                            }
                            else {
                                if ($global:UploadExistingAssets -eq 'true') {
                                    Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImageoriginal
                                }
                                Else {
                                    if ($show_skipped -eq 'True' ) {
                                        Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    }
                                }
                            }
                        }
                        # Now we can start the Background Poster Part
                        if ($global:BackgroundPosters -eq 'true') {
                            if ($LibraryFolders -eq 'true') {
                                $LibraryName = $entry.'Library Name'
                                if ($entry.extraFolder) {
                                    $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                    $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                }
                                Else {
                                    $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                    $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                                }
                                $backgroundImageoriginal = "$EntryDir\background.jpg"
                                $TestPath = $EntryDir
                                $ManualTestPath = $ManualEntryDir
                                $Testfile = "background"

                                if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                    New-Item -ItemType Directory -path $EntryDir -Force | out-null
                                }
                            }
                            Else {
                                if ($entry.extraFolder) {
                                    $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                                }
                                Else {
                                    $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                                }
                                $TestPath = $AssetPath
                                $ManualTestPath = $ManualPath
                                $Testfile = "$($entry.RootFoldername)_background"
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                                $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                }
                            }

                            $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                            $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                # Define Global Variables
                                $SkippingText = 'false'
                                $global:tmdbid = $entry.tmdbid
                                $global:tvdbid = $entry.tvdbid
                                $global:imdbid = $entry.imdbid
                                $global:posterurl = $null
                                $global:PosterWithText = $null
                                $global:AssetTextLang = $null
                                $global:Fallback = $null
                                $global:IsFallback = $null
                                $global:TMDBAssetTextLang = $null
                                $global:FANARTAssetTextLang = $null
                                $global:TVDBAssetTextLang = $null
                                $global:TMDBAssetChangeUrl = $null
                                $global:FANARTAssetChangeUrl = $null
                                $global:TVDBAssetChangeUrl = $null
                                $global:ImageMagickError = $null
                                $global:TextlessPoster = $null
                                $global:TMDBfallbackposterurl = $null
                                $global:fanartfallbackposterurl = $null
                                $TakeLocal = $null
                                $LocalAssetMissing = $null
                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                    Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                    $LocalAssetMissing = 'true'
                                }
                                Else {
                                    Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                        'FANART' { $global:posterurl = GetFanartMovieBackground }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                        Default { $global:posterurl = GetFanartMovieBackground }
                                    }
                                    switch -Wildcard ($global:Fallback) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                        'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    }
                                    if ($global:BackgroundPreferTextless -eq 'True') {
                                        if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                            $global:posterurl = $global:fanartfallbackposterurl
                                            Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                            $global:posterurl = $global:TMDBfallbackposterurl
                                            Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMovieBackground
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMovieBackground
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                        if ($global:FavProvider -eq 'TVDB') {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMovieBackground
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMovieBackground
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            $global:posterurl = GetFanartMovieBackground
                                            if (!$global:FavProvider -eq 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:posterurl = GetTVDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            if (!$global:posterurl) {
                                                Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                    }
                                }
                                if ($BackgroundfontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                                if ($global:posterurl -or $TakeLocal) {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }
                                        try {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $backgroundImage -ErrorAction Stop
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                    }
                                    if ($global:ImageProcessing -eq 'true') {
                                        Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'True') {
                                            if ($UseBackgroundResolutionOverlays -eq 'true') {
                                                switch ($entry.Resolution) {
                                                    '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                    '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                    '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                    '4K'            { $backgroundoverlay = $4kBackground }
                                                    '1080p'         { $backgroundoverlay = $1080pBackground }
                                                    Default { $backgroundoverlay = $backgroundoverlay }
                                                }
                                            }
                                            # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                            if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            else {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                $SkippingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                                if ($global:direction -eq "RTL") {
                                                    $backgroundfontImagemagick = $RTLfontImagemagick
                                                }
                                                $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        # Default: Replace the symbol with a newline
                                                        $replacementString = "`n"

                                                        # Check if the symbol should be kept
                                                        $keepThisSymbol = $false
                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                if ($symbol -like "*$k*") {
                                                                    $keepThisSymbol = $true
                                                                    break # Match found, no need to keep checking
                                                                }
                                                            }
                                                        }

                                                        # If it's a "keep" symbol, change the replacement string
                                                        if ($keepThisSymbol) {
                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                            $replacementString = $symbol + "`n"
                                                        }
                                                        $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                    }
                                                }
                                                $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                                if (!$global:IsTruncated) {
                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                    # Add Stroke
                                                    if ($AddBackgroundTextStroke -eq 'true') {
                                                        $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                    }
                                                    Else {
                                                        $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                    }

                                                    Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $logEntry = "`"$magick`" $Arguments"
                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                    if (!$global:ImageMagickError -eq 'True') {
                                        # Move file back to original naming with Brackets.
                                        if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                            if (!$global:IsTruncated) {
                                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImage
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $posterCount++
                                                $BackgroundCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            $moviebackgroundtemp = New-Object psobject
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                            }
                                            # Export the array to a CSV file
                                            $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $moviebackgroundtemp.Type -title $moviebackgroundtemp.Title -Lib $moviebackgroundtemp.LibraryName -DLSource $moviebackgroundtemp.'Download Source' -lang $moviebackgroundtemp.Language -favurl $moviebackgroundtemp.'Fav Provider Link' -fallback $moviebackgroundtemp.Fallback -Truncated $moviebackgroundtemp.TextTruncated
                                        }
                                    }
                                }
                                Elseif ($LocalAssetMissing -eq 'true') {
                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $moviebackgroundtemp = New-Object psobject
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                    }
                                    # Export the array to a CSV file
                                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                }
                            }
                            else {
                                if ($global:UploadExistingAssets -eq 'true') {
                                    Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImageoriginal
                                }
                                Else {
                                    if ($show_skipped -eq 'True' ) {
                                        Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    }
                                }
                            }
                        }
                    }
                }
                Else {
                    Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                }
            }
            catch {
                Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                if ($global:PosterOnlyTextless) {
                    $moviebackgroundtemp = New-Object psobject
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                    switch -Wildcard ($global:FavProvider) {
                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                        Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                    }
                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                    }
                    # Export the array to a CSV file
                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                }

            }
        }

        Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        # Show Part
        foreach ($entry in $AllShows) {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    # Define Global Variables
                    $SkippingText = 'false'
                    $global:tmdbsearched = $null
                    $global:tmdbid = $entry.tmdbid
                    $global:tvdbid = $entry.tvdbid
                    $global:imdbid = $entry.imdbid
                    $Seasonpostersearchtext = $null
                    $global:ImageMagickError = $null
                    $Episodepostersearchtext = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $FanartSearched = $null
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    $global:AssetTextLang = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:Fallback = $null
                    $global:TextlessPoster = $null
                    $global:tvdbalreadysearched = $null
                    $TakeLocal = $null
                    $LocalAssetMissing = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                    'FANART' { $global:posterurl = GetFanartShowPoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                    Default { $global:posterurl = GetFanartShowPoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } }
                                    'FANART' { $global:posterurl = GetFanartShowPoster }
                                }
                                if ($global:PosterPreferTextless -eq 'True') {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TVDBfallbackposterurl) {
                                        $global:posterurl = $global:TVDBfallbackposterurl
                                        Write-Entry -Subtext "Took TVDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    # try to find textless on TVDB
                                    if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBShowPoster
                                        $global:IsFallback = $true
                                        $global:tvdbalreadysearched = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                        $global:posterurl = GetFanartMoviePoster
                                        $global:IsFallback = $true
                                    }
                                }

                                if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                    $global:PosterWithText = $true
                                }

                                if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                }
                                if (!$global:posterurl) {
                                    $global:IsFallback = $true
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if (!$TakeLocal) {
                                if (!$global:TextlessPoster -eq 'True' -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                }
                                if (!$global:TextlessPoster -eq 'True' -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                }
                            }
                            if ($global:posterurl -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    try {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if ($UsePosterResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                '4K'            { $Posteroverlay = $4kposter }
                                                '1080p'         { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }

                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'True') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        if (!$global:IsTruncated) {
                                            UploadOtherMediaServerArtwork -itemId $entry.Id -imageType "Primary" -imagePath $PosterImage
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $showtemp = New-Object psobject
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $showtemp.Type -title $showtemp.Title -Lib $showtemp.LibraryName -DLSource $showtemp.'Download Source' -lang $showtemp.Language -favurl $showtemp.'Fav Provider Link' -fallback $showtemp.Fallback -Truncated $showtemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $showtemp = New-Object psobject
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImageoriginal
                            }
                            Else {
                                if ($show_skipped -eq 'True' ) {
                                    Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Background Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:TextlessPoster = $null
                            $global:ImageMagickError = $null
                            $global:TMDBfallbackposterurl = $null
                            $global:fanartfallbackposterurl = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                    'FANART' { $global:posterurl = GetFanartShowBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                    Default { $global:posterurl = GetFanartShowBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                    'FANART' { $global:posterurl = GetFanartShowBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq 'True') {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartShowBackground
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBShowBackground
                                        $global:IsFallback = $true
                                    }
                                    $global:FallbackText = 'True-Background'
                                    if (!$global:posterurl) {
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }

                                }
                            }
                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    try {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $backgroundImage -ErrorAction Stop
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if ($UseBackgroundResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                '4K'            { $backgroundoverlay = $4kBackground }
                                                '1080p'         { $backgroundoverlay = $1080pBackground }
                                                Default { $backgroundoverlay = $backgroundoverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'True') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImage
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            $BackgroundCount++
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $showbackgroundtemp = New-Object psobject
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $showbackgroundtemp.Type -title $showbackgroundtemp.Title -Lib $showbackgroundtemp.LibraryName -DLSource $showbackgroundtemp.'Download Source' -lang $showbackgroundtemp.Language -favurl $showbackgroundtemp.'Fav Provider Link' -fallback $showbackgroundtemp.Fallback -Truncated $showbackgroundtemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $showbackgroundtemp = New-Object psobject
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImageoriginal
                            }
                            Else {
                                if ($show_skipped -eq 'True' ) {
                                    Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Season Part
                    if ($global:SeasonPosters -eq 'true') {
                        # Loop through each Season
                        foreach ($season in $Episodedata) {
                            $SkippingText = 'false'
                            $global:tmdbsearched = $null
                            $global:seasontmp = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:ImageMagickError = $null
                            $global:TextlessPoster = $null
                            $global:seasonNames = $null
                            $global:posterurl = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:ImageMagickError = $null
                            $global:TMDBSeasonFallback = $null
                            $global:TVDBSeasonFallback = $null
                            $global:FANARTSeasonFallback = $null
                            $global:seasonId = $null
                            $global:SeasonNumber = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null

                            if ($season.tmdbid -eq $entry.tmdbid -or $season.tvdbid -eq $entry.tvdbid) {
                                $global:seasonId = $season.SeasonId
                                $global:seasonNames = $season.SeasonName
                                $global:SeasonNumber = $season."Season Number"
                                if ($SeasonfontAllCaps -eq 'true') {
                                    $global:seasonTitle = $global:seasonNames.ToUpper()
                                    if (!$global:seasonTitle) {
                                        $global:seasonTitle = ("Season " + $global:SeasonNumber).ToUpper()
                                    }
                                }
                                Else {
                                    $global:seasonTitle = $global:seasonNames
                                    if (!$global:seasonTitle) {
                                        $global:seasonTitle = "Season " + $global:SeasonNumber
                                    }
                                }
                                if ($null -ne $global:SeasonNumber) {
                                    $global:seasontmp = "Season" + $global:SeasonNumber.ToString().PadLeft(2, '0')
                                }
                                if ($LibraryFolders -eq 'true') {
                                    $SeasonImageoriginal = "$EntryDir\$global:seasontmp.jpg"
                                    $TestPath = $EntryDir
                                    $ManualTestPath = $ManualEntryDir
                                    $Testfile = "$global:seasontmp"
                                }
                                Else {
                                    if ($entry.extraFolder) {
                                        $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                    }
                                    Else {
                                        $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                    }
                                    $TestPath = $AssetPath
                                    $ManualTestPath = $ManualPath
                                    $Testfile = "$($entry.RootFoldername)_$global:seasontmp"
                                }

                                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    $SeasonImageoriginal = ($SeasonImageoriginal).Replace('\', '/').Replace('./', '/')
                                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                }
                                else {
                                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                    if ($fullTestPath) {
                                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    }
                                    Else {
                                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                    }
                                }

                                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                    foreach ($ext in $allowedExtensions) {
                                        $filePath = "$ManualTestPath$ext"
                                        if (Test-Path -LiteralPath $filePath) {
                                            Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            $posterext = $ext
                                            break
                                        }
                                    }

                                    if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                        Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $TakeLocal = $true
                                    }
                                    Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                        $LocalAssetMissing = 'true'
                                    }
                                    Else {
                                        if (!$Seasonpostersearchtext) {
                                            Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $Seasonpostersearchtext = $true
                                        }
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                            'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                            Default { $global:posterurl = GetFanartSeasonPoster }
                                        }
                                        # do a specific order
                                        if ($global:SeasonPreferTextless -eq 'True') {
                                            if (!$global:posterurl -or !$global:TextlessPoster) {
                                                if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                    $global:posterurl = GetTMDBSeasonPoster
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                                if (!$global:posterurl -or !$global:TextlessPoster) {
                                                    if ($global:FavProvider -ne 'FANART') {
                                                        $global:posterurl = GetFanartSeasonPoster
                                                        Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        $global:IsFallback = $true
                                                        Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    }
                                                }
                                                if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                                    if ($global:FavProvider -ne 'TVDB') {
                                                        $global:IsFallback = $true
                                                        $global:posterurl = GetTVDBSeasonPoster
                                                        Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    }
                                                }
                                            }
                                            if (!$global:posterurl) {
                                                Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                            if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                                # Lets just try to grab a show poster.
                                                Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                switch -Wildcard ($global:FavProvider) {
                                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                    'FANART' { $global:posterurl = GetFanartShowPoster }
                                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                                    Default { $global:posterurl = GetFanartShowPoster }
                                                }
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                                Else {
                                                    if ($global:FavProvider -ne 'TMDB') {
                                                        $global:posterurl = GetTMDBShowPoster
                                                        if ($global:posterurl) {
                                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:IsFallback = $true
                                                            $global:FallbackText = 'True-Show'
                                                        }
                                                    }
                                                    if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                        $global:posterurl = GetTVDBShowPoster
                                                        if ($global:posterurl) {
                                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:IsFallback = $true
                                                            $global:FallbackText = 'True-Show'
                                                        }
                                                    }
                                                    if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                        $global:posterurl = GetFanartShowPoster
                                                        if ($global:posterurl) {
                                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:IsFallback = $true
                                                            $global:FallbackText = 'True-Show'
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        Else {
                                            if (!$global:posterurl) {
                                                if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                    $global:posterurl = GetTMDBSeasonPoster
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                                if (!$global:posterurl) {
                                                    if ($global:FavProvider -ne 'FANART') {
                                                        $global:posterurl = GetFanartSeasonPoster
                                                        Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        $global:IsFallback = $true
                                                        Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    }
                                                }
                                                if (!$global:posterurl -and $entry.tvdbid) {
                                                    if ($global:FavProvider -ne 'TVDB') {
                                                        $global:IsFallback = $true
                                                        $global:posterurl = GetTVDBSeasonPoster
                                                        Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    }
                                                }
                                            }
                                            if (!$global:posterurl) {
                                                Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                        if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                            # Lets just try to grab a show poster.
                                            Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                                Default { $global:posterurl = GetFanartShowPoster }
                                            }
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                            Else {
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:posterurl = GetTMDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                    $global:posterurl = GetTVDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                    $global:posterurl = GetFanartShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                            }
                                        }
                                        if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                            $global:posterurl = $global:TMDBSeasonFallback
                                            Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }
                                        if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                            $global:posterurl = $global:FANARTSeasonFallback
                                            Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }
                                        if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                            $global:posterurl = $global:TVDBSeasonFallback
                                            Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }

                                    }
                                    if ($global:posterurl -or $TakeLocal) {
                                        if ($TakeLocal) {
                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                            }
                                            Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        }
                                        Else {
                                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                                Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $PosterUnknownCount++
                                                $global:IsFallback = $true
                                            }
                                            try {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                            catch {
                                                if ($_.Exception.Response) {
                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                }
                                                else {
                                                    $statusCode = $_.Exception.Message
                                                }
                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                        }
                                        if ($global:ImageProcessing -eq 'true') {
                                            if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                                $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                if (!$global:ImageMagickError -eq 'True') {
                                                    # Resize Image to 2000x3000 and apply Border and overlay
                                                    if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                        $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    }
                                                    elseif ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                        $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    }
                                                    elseif ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                        $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    }
                                                    else {
                                                        $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    }

                                                    $logEntry = "`"$magick`" $Arguments"
                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                        $SkippingText = 'true'
                                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                    }
                                                    if ($AddSeasonText -eq 'true' -and $SkippingText -eq 'false') {
                                                        $global:seasonTitle = $global:seasonTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                        if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                            $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                        }
                                                        Else {
                                                            $global:ShowTitleOnSeason = $titletext -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                        }
                                                        # Loop through each symbol and replace it with a newline
                                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                                            foreach ($symbol in $NewLineSymbols) {
                                                                # Default: Replace the symbol with a newline
                                                                $replacementString = "`n"

                                                                # Check if the symbol should be kept
                                                                $keepThisSymbol = $false
                                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                        if ($symbol -like "*$k*") {
                                                                            $keepThisSymbol = $true
                                                                            break # Match found, no need to keep checking
                                                                        }
                                                                    }
                                                                }

                                                                # If it's a "keep" symbol, change the replacement string
                                                                if ($keepThisSymbol) {
                                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                    $replacementString = $symbol + "`n"
                                                                }
                                                                $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), $replacementString
                                                                if ($AddShowTitletoSeason -eq 'true') {
                                                                    $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), $replacementString
                                                                }
                                                            }
                                                        }
                                                        $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                        $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                        if ($AddShowTitletoSeason -eq 'true') {
                                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                            $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                            if (!$global:IsTruncated) {
                                                                Write-Entry -Subtext ("Optimal Season font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                Write-Entry -Subtext ("Optimal Show font size set to: '{0}' [{1}]" -f $showoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                # Season Part
                                                                # Add Stroke
                                                                if ($AddSeasonTextStroke -eq 'true') {
                                                                    $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                                }
                                                                Else {
                                                                    $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                                }

                                                                Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                $logEntry = "`"$magick`" $SeasonArguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                                # Show Part
                                                                # Add Stroke
                                                                if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                                    $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                                }
                                                                Else {
                                                                    $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                                }

                                                                Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                            }
                                                        }
                                                        Else {
                                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                            if (!$global:IsTruncated) {
                                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                # Add Stroke
                                                                if ($AddSeasonTextStroke -eq 'true') {
                                                                    $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                                }
                                                                Else {
                                                                    $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                                }

                                                                Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        Else {
                                            if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                                # Resize Image to 2000x3000
                                                $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Resizeargument"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                            }
                                        }
                                        if (!$global:ImageMagickError -eq 'True') {
                                            if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                                # Move file back to original naming with Brackets.
                                                if (!$global:IsTruncated) {
                                                    UploadOtherMediaServerArtwork -itemId $global:seasonId -imageType "Primary" -imagePath $SeasonImage
                                                    try {
                                                        # Attempt to move the item
                                                        Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                        # Log success if move was successful
                                                        Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                    }
                                                    catch {
                                                        # Log the error if the move operation fails
                                                        Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                        Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    }
                                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                    $SeasonCount++
                                                    $posterCount++
                                                }
                                                Else {
                                                    Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                }
                                                $seasontemp = New-Object psobject
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$SeasonImage} Else {$global:posterurl})
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                switch -Wildcard ($global:FavProvider) {
                                                    'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                    'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                    'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                    Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                }
                                                # Export the array to a CSV file
                                                $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                SendMessage -type $seasontemp.Type -title $seasontemp.Title -Lib $seasontemp.LibraryName -DLSource $seasontemp.'Download Source' -lang $seasontemp.Language -favurl $seasontemp.'Fav Provider Link' -fallback $seasontemp.Fallback -Truncated $seasontemp.TextTruncated
                                            }
                                        }
                                    }
                                    Elseif ($LocalAssetMissing -eq 'true') {
                                        Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    Else {
                                        Write-Entry -Subtext "Missing poster URL for: $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        $seasontemp = New-Object psobject
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                            Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                        }
                                        # Export the array to a CSV file
                                        $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                    }
                                }
                                else {
                                    if ($global:UploadExistingAssets -eq 'true') {
                                        Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $SeasonImageoriginal
                                    }
                                    Else {
                                        if ($show_skipped -eq 'True' ) {
                                            Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        }
                                    }
                                }
                            }
                        }
                    }
                    # Now we can start the Episode Part
                    if ($global:TitleCards -eq 'true') {
                        # Loop through each episode
                        foreach ($episode in $Episodedata) {
                            $SkippingText = 'false'
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:TempImagecopied = $false
                            $EpisodeTempImage = $null
                            $global:ImageMagickError = $null
                            $global:season_number = $null
                            $Episodepostersearchtext = $null
                            $global:show_name = $null
                            $global:episodenumber = $null
                            $global:episode_numbers = $null
                            $global:titles = $null
                            $global:posterurl = $null
                            $global:FileNaming = $null
                            $EpisodeImageoriginal = $null
                            $EpisodeImage = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:TextlessPoster = $null
                            $global:EPResolutions = $null

                            if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title) {
                                $global:show_name = $episode."Show Name"
                                $global:season_number = $episode."Season Number"
                                $global:EPResolutions = $episode."Resolutions".Split(",")
                                $global:episode_numbers = $episode."Episodes".Split(",")
                                $global:episodeids = $episode."EpisodeIDs".Split(",")
                                $global:titles = $episode."Title".Split(";")
                                if ($UseBackgroundAsTitleCard -eq 'True') {
                                    $global:ImageMagickError = $null
                                    for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                        $SkippingText = 'false'
                                        $global:AssetTextLang = $null
                                        $global:TMDBAssetTextLang = $null
                                        $global:FANARTAssetTextLang = $null
                                        $global:TVDBAssetTextLang = $null
                                        $global:TMDBAssetChangeUrl = $null
                                        $global:FANARTAssetChangeUrl = $null
                                        $global:TVDBAssetChangeUrl = $null
                                        $global:PosterWithText = $null
                                        $global:Fallback = $null
                                        $global:IsFallback = $null
                                        $global:posterurl = $null
                                        $Episodepostersearchtext = $null
                                        $ExifFound = $null
                                        $value = $null
                                        $magickcommand = $null
                                        $Arturl = $null
                                        $TakeLocal = $null
                                        $LocalAssetMissing = $null
                                        $global:EPTitle = $($global:titles[$i].Trim())
                                        $global:EPResolution = $($global:EPResolutions[$i].Trim())
                                        $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                        $global:episodeid = $($global:episodeids[$i].Trim())
                                        $global:FileNaming = "S" + $global:season_number.ToString().PadLeft(2, '0') + "E" + $global:episodenumber.ToString().PadLeft(2, '0')
                                        $bullet = [char]0x2022
                                        $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                        if ($LibraryFolders -eq 'true') {
                                            $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                            $TestPath = $EntryDir
                                            $ManualTestPath = $ManualEntryDir
                                            $Testfile = "$global:FileNaming"
                                        }
                                        Else {
                                            if ($entry.extraFolder) {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            Else {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            $TestPath = $AssetPath
                                            $ManualTestPath = $ManualPath
                                            $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                        }

                                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                            $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        }
                                        else {
                                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                            if ($fullTestPath) {
                                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                            Else {
                                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                        }

                                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                        $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                        $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                        $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                        if ($SkipTBA -eq 'True' -and $global:EPTitle -eq 'TBA') {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipTBACount++
                                        }
                                        Elseif ($SkipJapTitle -eq 'True' -and $global:EPTitle -match $cjkTitlePattern) {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipJapTitleCount++
                                        }
                                        Else {
                                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                                foreach ($ext in $allowedExtensions) {
                                                    $filePath = "$ManualTestPath$ext"
                                                    if (Test-Path -LiteralPath $filePath) {
                                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        $posterext = $ext
                                                        break
                                                    }
                                                }

                                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                    Write-Entry -Message "Found Manual Title Card for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $TakeLocal = $true
                                                }
                                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                    $LocalAssetMissing = 'true'
                                                }
                                                Else {
                                                    if (!$Episodepostersearchtext) {
                                                        Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $Episodepostersearchtext = $true
                                                    }
                                                    # now search for TitleCards
                                                    if ($global:TempImagecopied -ne 'True') {
                                                        if ($global:FavProvider -eq 'TMDB') {
                                                            if ($episode.tmdbid) {
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetTVDBShowBackground
                                                                    if (!$global:posterurl) {
                                                                        $global:posterurl = GetFanartShowBackground
                                                                    }
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if ($global:tmdbfallbackposterurl) {
                                                                        $global:posterurl = $global:tmdbfallbackposterurl
                                                                    }
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                            else {
                                                                Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            if ($episode.tvdbid) {
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetTMDBShowBackground
                                                                    if (!$global:posterurl) {
                                                                        $global:posterurl = GetFanartShowBackground
                                                                    }
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                            else {
                                                                Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                if ($global:posterurl -or $TakeLocal -or $global:TempImagecopied -eq 'True') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        if ($global:TempImagecopied -ne 'True') {
                                                            Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Taking temp image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                            Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                        }
                                                        if ($global:TempImagecopied -ne 'True') {
                                                            try {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                            }
                                                            catch {
                                                                if ($_.Exception.Response) {
                                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                                }
                                                                else {
                                                                    $statusCode = $_.Exception.Message
                                                                }
                                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                        }
                                                    }
                                                    if ($global:ImageProcessing -eq 'true') {
                                                        $global:TempImagecopied = $true
                                                        # Check temp image
                                                        if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                            Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Else {
                                                            if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                                $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                                if (!$global:ImageMagickError -eq 'True') {
                                                                    if ($UseTCResolutionOverlays -eq 'true') {
                                                                        switch ($global:EPResolution) {
                                                                            '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                            '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                            '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                            '4K'            { $TitleCardoverlay = $4kTC }
                                                                            '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                            Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                        }
                                                                    }
                                                                    # Resize Image to 2000x3000 and apply Border and overlay
                                                                    if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    else {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                        $SkippingText = 'true'
                                                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                    }
                                                                    if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                        if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                            $global:EPTitle = $global:EPTitle.ToUpper()
                                                                        }
                                                                        $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                        if ($global:direction -eq "RTL") {
                                                                            $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                        }
                                                                        # Loop through each symbol and replace it with a newline
                                                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                            foreach ($symbol in $NewLineSymbols) {
                                                                                # Default: Replace the symbol with a newline
                                                                                $replacementString = "`n"

                                                                                # Check if the symbol should be kept
                                                                                $keepThisSymbol = $false
                                                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                        if ($symbol -like "*$k*") {
                                                                                            $keepThisSymbol = $true
                                                                                            break # Match found, no need to keep checking
                                                                                        }
                                                                                    }
                                                                                }

                                                                                # If it's a "keep" symbol, change the replacement string
                                                                                if ($keepThisSymbol) {
                                                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                    $replacementString = $symbol + "`n"
                                                                                }
                                                                                $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                            }
                                                                        }
                                                                        $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                        if (!$global:IsTruncated) {
                                                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            # Add Stroke
                                                                            if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }
                                                                            Else {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }

                                                                            Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            $logEntry = "`"$magick`" $Arguments"
                                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                        }
                                                                    }
                                                                    if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                        if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                            $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                        }
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                        $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                        if (!$global:IsTruncated) {
                                                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                            # Add Stroke
                                                                            if ($AddTitleCardTextStroke -eq 'true') {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }
                                                                            Else {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }
                                                                            Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            $logEntry = "`"$magick`" $Arguments"
                                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Resize Image to 2000x3000
                                                            $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Resizeargument"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                        }
                                                    }
                                                    if (!$global:ImageMagickError -eq 'True') {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Move file back to original naming with Brackets.
                                                            if (!$global:IsTruncated) {
                                                                UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImage
                                                                try {
                                                                    # Attempt to move the item
                                                                    Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                    # Log success if move was successful
                                                                    Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                                }
                                                                catch {
                                                                    # Log the error if the move operation fails
                                                                    Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                }
                                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                                $EpisodeCount++
                                                                $posterCount++
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'True' } Else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                            SendMessage -type $episodetemp.Type -title $($global:show_name + " | " + $episodetemp.Title) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                        }
                                                    }
                                                }
                                                Elseif ($LocalAssetMissing -eq 'true') {
                                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                }
                                                Else {
                                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    if ($global:BackgroundOnlyTextless) {
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                            Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }

                                                }

                                            }
                                            else {
                                                if ($global:UploadExistingAssets -eq 'true') {
                                                    Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                    UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImageoriginal
                                                }
                                                Else {
                                                    if ($show_skipped -eq 'True' ) {
                                                        Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                        Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                        Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                }
                                Else {
                                    for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                        $SkippingText = 'false'
                                        $global:AssetTextLang = $null
                                        $global:TMDBAssetTextLang = $null
                                        $global:FANARTAssetTextLang = $null
                                        $global:TVDBAssetTextLang = $null
                                        $global:TMDBAssetChangeUrl = $null
                                        $global:FANARTAssetChangeUrl = $null
                                        $global:TVDBAssetChangeUrl = $null
                                        $global:PosterWithText = $null
                                        $global:Fallback = $null
                                        $global:IsFallback = $null
                                        $global:FallbackText = $null
                                        $global:ImageMagickError = $null
                                        $global:TextlessPoster = $null
                                        $global:posterurl = $null
                                        $Episodepostersearchtext = $null
                                        $ExifFound = $null
                                        $value = $null
                                        $magickcommand = $null
                                        $Arturl = $null
                                        $TakeLocal = $null
                                        $LocalAssetMissing = $null
                                        $global:EPTitle = $($global:titles[$i].Trim())
                                        $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                        $global:episodeid = $($global:episodeids[$i].Trim())
                                        $global:FileNaming = "S" + $global:season_number.ToString().PadLeft(2, '0') + "E" + $global:episodenumber.ToString().PadLeft(2, '0')
                                        $bullet = [char]0x2022
                                        $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                        if ($LibraryFolders -eq 'true') {
                                            $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                            $TestPath = $EntryDir
                                            $ManualTestPath = $ManualEntryDir
                                            $Testfile = "$global:FileNaming"
                                        }
                                        Else {
                                            if ($entry.extraFolder) {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            Else {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            $TestPath = $AssetPath
                                            $ManualTestPath = $ManualPath
                                            $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                        }

                                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                            $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        }
                                        else {
                                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                            if ($fullTestPath) {
                                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                            Else {
                                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                        }

                                        $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                        $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                        if ($SkipTBA -eq 'True' -and $global:EPTitle -eq 'TBA') {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipTBACount++
                                        }
                                        Elseif ($SkipJapTitle -eq 'True' -and $global:EPTitle -match $cjkTitlePattern) {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipJapTitleCount++
                                        }
                                        Else {
                                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                                foreach ($ext in $allowedExtensions) {
                                                    $filePath = "$ManualTestPath$ext"
                                                    if (Test-Path -LiteralPath $filePath) {
                                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        $posterext = $ext
                                                        break
                                                    }
                                                }

                                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                    Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $TakeLocal = $true
                                                }
                                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                    $LocalAssetMissing = 'true'
                                                }
                                                Else {
                                                    if (!$Episodepostersearchtext) {
                                                        Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $Episodepostersearchtext = $true
                                                    }
                                                    # now search for TitleCards
                                                    if ($global:FavProvider -eq 'TMDB') {
                                                        if ($episode.tmdbid) {
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if (!$global:posterurl -or $global:Fallback -eq "TVDB") {
                                                                $global:posterurl = GetTVDBTitleCard
                                                                if ($global:posterurl){
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                                Else {
                                                                    # Lets just try to grab a background poster.
                                                                    $global:posterurl = GetTVDBShowBackground
                                                                    if ($global:posterurl) {
                                                                        Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                        $global:IsFallback = $true
                                                                        $global:FallbackText = 'True-Background'
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                                Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($episode.tvdbid) {
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if (!$global:posterurl -or $global:Fallback -eq "TMDB") {
                                                                $global:posterurl = GetTMDBTitleCard
                                                                if ($global:posterurl){
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                                Else {
                                                                    # Lets just try to grab a background poster.
                                                                    $global:posterurl = GetTMDBShowBackground
                                                                    if ($global:posterurl) {
                                                                        Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                        $global:IsFallback = $true
                                                                        $global:FallbackText = 'True-Background'
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                if ($global:posterurl -or $TakeLocal) {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        try {
                                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                    }
                                                    if ($global:ImageProcessing -eq 'true') {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'True') {
                                                                if ($UseTCResolutionOverlays -eq 'true') {
                                                                    Write-Entry -Subtext "Queried Overlay Resolution: $global:EPResolution" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                    switch ($global:EPResolution) {
                                                                        '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                        '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                        '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                        '4K'            { $TitleCardoverlay = $4kTC }
                                                                        '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                        Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                    }
                                                                }
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                else {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                    $SkippingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            # Default: Replace the symbol with a newline
                                                                            $replacementString = "`n"

                                                                            # Check if the symbol should be kept
                                                                            $keepThisSymbol = $false
                                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                    if ($symbol -like "*$k*") {
                                                                                        $keepThisSymbol = $true
                                                                                        break # Match found, no need to keep checking
                                                                                    }
                                                                                }
                                                                            }

                                                                            # If it's a "keep" symbol, change the replacement string
                                                                            if ($keepThisSymbol) {
                                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                $replacementString = $symbol + "`n"
                                                                            }
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Resize Image to 2000x3000
                                                            $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Resizeargument"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                        }
                                                    }
                                                    if (!$global:ImageMagickError -eq 'True') {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Move file back to original naming with Brackets.
                                                            if (!$global:IsTruncated) {
                                                                UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImage
                                                                try {
                                                                    # Attempt to move the item
                                                                    Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                    # Log success if move was successful
                                                                    Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                                }
                                                                catch {
                                                                    # Log the error if the move operation fails
                                                                    Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                }
                                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                                $EpisodeCount++
                                                                $posterCount++
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'True' } Else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                            SendMessage -type $episodetemp.Type -title $($global:show_name + " | " + $episodetemp.Title) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                        }
                                                    }
                                                }
                                                Elseif ($LocalAssetMissing -eq 'true') {
                                                    Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                }
                                                Else {
                                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    if ($global:BackgroundOnlyTextless) {
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                            Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }

                                                }

                                            }
                                            else {
                                                if ($global:UploadExistingAssets -eq 'true') {
                                                    Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                    UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImageoriginal
                                                }
                                                Else {
                                                    if ($show_skipped -eq 'True' ) {
                                                        Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }

        $endTime = Get-Date
        $executionTime = New-TimeSpan -Start $startTime -End $endTime
        # Format the execution time
        $hours = [math]::Floor($executionTime.TotalHours)
        $minutes = $executionTime.Minutes
        $seconds = $executionTime.Seconds
        $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
        Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        if ($UploadCount -ge '1') {
            Write-Entry -Message "Finished, Total images Uploaded: $UploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        if ($posterCount -ge '1') {
            Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
            Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            # Calculate Summary
            $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
            $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
            $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
            $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
            $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
            if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
                Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextlessCount) {
                Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($FallbackCount) {
                Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextCount) {
                Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($PosterUnknownCount -ge '1') {
                Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextTruncatedCount) {
                Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
        }
        if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
            Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            # Calculate Summary
            $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
            $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
            $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
            $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
            $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
            if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
                Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextlessCount) {
                Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($FallbackCount) {
                Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextCount) {
                Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($PosterUnknownCount -ge '1') {
                Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextTruncatedCount) {
                Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
        }
        if ($errorCount -ge '1') {
            Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
            $ImageChoicesDummycsv = New-Object psobject

            # Add members to the object with empty values
            $ImageChoicesDummycsv = New-Object psobject
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Manual" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

            $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
            Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-TextSizeCacheSummary
        Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

        # Send Notification
        Send-SummaryNotification -ScriptMode $Mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -FallbackCount $FallbackCount.count -TextlessCount $TextlessCount.count -TruncatedCount $TextTruncatedCount.count -PosterUnknownCount $PosterUnknownCount -SkipTBACount $SkipTBACount -SkipJapTitleCount $SkipJapTitleCount -PosterCount $posterCount -BackgroundCount $BackgroundCount -SeasonCount $SeasonCount -EpisodeCount $EpisodeCount -UploadCount $UploadCount

        # Export json
        $jsonObject = [PSCustomObject]@{
            Posters              = if ($posterCount) { $posterCount } Else { 0 }
            Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
            Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
            Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
            Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
            Mode                 = $Mode
            Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
            Errors               = if ($errorCount) { $errorCount } Else { 0 }
            Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
            Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
            Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
            Text                 = if ($TextCount) { $TextCount } Else { 0 }
            "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
            "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
            "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
            "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
            "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
            "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
            "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
            "Script Version"     = $CurrentScriptVersion
            "IM Version"         = $global:CurrentImagemagickversion
            "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
            "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
        }

        $jsonOutput = $jsonObject | ConvertTo-Json
        $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
        }
    }
    elseif ($UsePlex -eq 'true') {
        $Library = $Libs.mediaContainer.Directory | Where-Object { $_.key -eq $Metadata.MediaContainer.$contentquery.librarySectionID }
        $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
        $tmdbpattern = 'tmdb://(\d+)'
        $imdbpattern = 'imdb://tt(\d+)'
        $tvdbpattern = 'tvdb://(\d+)'
        if ($Metadata.MediaContainer.$contentquery.Location) {
            $location = $Metadata.MediaContainer.$contentquery.Location.path
            if ($location.count -gt '1') {
                $location = $location[0]
                $MultipleVersions = $true
            }
            Else {
                $MultipleVersions = $false
            }
            $libpaths = $($Library.location.path).split(',')
            Write-Entry -Subtext "Plex Lib Paths before split: $($Library.location.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            foreach ($libpath in $libpaths) {
                if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                    Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $libpath
                    $libpath = $Matchedpath
                    $relativePath = $location.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    continue
                }
            }
        }
        Else {
            $location = $Metadata.MediaContainer.$contentquery.media.part.file

            if ($location.count -gt '1') {
                Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $location = $location[0]
                $MultipleVersions = $true
            }
            Else {
                $MultipleVersions = $false
            }
            Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                $CheckCharLimit = CheckCharLimit
                if ($CheckCharLimit -eq $false) {
                    Write-Entry -Subtext "Skipping [$($Metadata.MediaContainer.$contentquery.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    continue
                }
            }

            $libpaths = $($Library.location.path).split(',')
            Write-Entry -Subtext "Plex Lib Paths before split: $($Library.location.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            foreach ($libpath in $libpaths) {
                if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                    Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $Matchedpath = AddTrailingSlash $libpath
                    $libpath = $Matchedpath
                    $relativePath = $location.Substring($libpath.Length)
                    $pathSegments = $relativePath -split '[\\/]'

                    # Determine the extracted folder and the root folder path
                    if ($pathSegments.Count -gt 2) {
                        $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                        $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                    }
                    else {
                        $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                        $extraFolder = $null  # No parent structure
                    }
                    Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    continue
                }
            }
        }
        if ($Seasondata) {
            $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
            $SeasonNames = $SeasonsTemp.Title -join ';'
            $SeasonNumbers = $SeasonsTemp.index -join ','
            $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
            $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
        }
        $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
        $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
        $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
        if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
        if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
        if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

        # check if there are more then 1 entry in id´s
        if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
        if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
        if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

        if ($Metadata.MediaContainer.$contentquery.Label.tag) {
            $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
        }
        Else {
            $Labels = ""
        }
        $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
        $Resolution = $null
        # Get Resolution
        if ($FileMetadata) {
            $FileMetadata | ForEach-Object {
                if ($_.streamType -eq '1') {
                    $Resolution = $_.displayTitle
                }
            }
        }
        $temp = New-Object psobject
        $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.title
        $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
        $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
        $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Metadata.MediaContainer.$contentquery.title
        if ($FileMetadata) {
            $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
        }
        $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Metadata.MediaContainer.$contentquery.originalTitle
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
        $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
        $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Metadata.MediaContainer.$contentquery.year
        $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
        $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
        $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
        $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $Metadata.MediaContainer.$contentquery.ratingKey
        $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
        $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
        $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
        $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
        $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
        $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
        $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
        $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
        $Libraries += $temp
        Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
        $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

        if ($global:TitleCards -eq 'true' -and $mediatype -ne 'movie') {
            Write-Entry -Message "Query episodes data..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            # Query episode info
            $Episodedata = @()
            foreach ($showentry in $AllShows) {
                # Getting child entries for each season
                $splittedkeys = $showentry.SeasonRatingKeys.split(',')
                foreach ($key in $splittedkeys) {
                    if ($PlexToken) {
                        if ($contentquery -eq 'Directory') {
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                    }
                    Else {
                        if ($contentquery -eq 'Directory') {
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                        }
                    }
                    $FileMetadata = $Seasondata.MediaContainer.video.media
                    $Resolution = $null
                    # Get Resolution
                    if ($FileMetadata) {
                        $ResolutionList = @()
                        $FileMetadata | ForEach-Object {
                            $Resolution = $_.videoResolution
                            $ResolutionList += $Resolution
                        }
                        $Resolution = $ResolutionList -join ","
                    }
                    $tempseasondata = New-Object psobject
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                    if ($FileMetadata) {
                        $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                    }
                    $Episodedata += $tempseasondata
                    Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                }
            }
            if ($Episodedata) {
                Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            }
        }

        # Store all Files from asset dir in a hashtable
        Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        try {
            $directoryHashtable = @{}
            $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
            $totalSize = 0
            $excludePath = Join-Path -Path $AssetPath -ChildPath 'Collections'

            if ($FollowSymlink) {
                Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | Where-Object {
                    $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
                } | ForEach-Object {
                    if ($allowedExtensions -contains $_.Extension.ToLower()) {
                        $directory = $_.Directory
                        $basename = $_.BaseName
                        if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                            $directoryHashtable["$directory/$basename"] = $true
                        }
                        Else {
                            $directoryHashtable["$directory\$basename"] = $true
                        }
                    }
                    $totalSize += $_.Length
                }
            }
            Else {
                Get-ChildItem -Path $AssetPath -Recurse | Where-Object {
                    $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
                } | ForEach-Object {
                    if ($allowedExtensions -contains $_.Extension.ToLower()) {
                        $directory = $_.Directory
                        $basename = $_.BaseName
                        if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                            $directoryHashtable["$directory/$basename"] = $true
                        }
                        Else {
                            $directoryHashtable["$directory\$basename"] = $true
                        }
                    }
                    $totalSize += $_.Length
                }
            }

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($totalSize -gt 1GB) {
                $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
            }
            elseif ($totalSize -gt 1MB) {
                $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
            }
            elseif ($totalSize -gt 1KB) {
                $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
            }
            else {
                $totalSizeString = "$totalSize bytes"
            }

            Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
            Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
            Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
        catch {
            Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            # Clear Running File
            if (Test-Path $CurrentlyRunning) {
                try {
                    Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                }
                catch {
                    Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                }
            }
            if ($global:UptimeKumaUrl) {
                Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
            }
            Exit
        }
        if ($global:logLevel -eq '3') {
            Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
        }
        # Download poster foreach movie
        Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        # Movie Part
        foreach ($entry in $AllMovies) {
            try {
                if ($($entry.RootFoldername)) {
                    # check if item has skip label
                    if ($entry.labels -match 'skip_posterizarr') {
                        Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                    }
                    Else {
                        $SkippingText = 'false'
                        $global:posterurl = $null
                        $global:ImageMagickError = $null
                        $global:TextlessPoster = $null
                        $global:TMDBfallbackposterurl = $null
                        $global:fanartfallbackposterurl = $null
                        $global:IsFallback = $null
                        $global:PlexartworkDownloaded = $null
                        $global:langCode = $null
                        $global:direction = $null

                        # Determine the language direction
                        $global:langCode = $entry.'Library Language'
                        $global:direction = $global:languageDirections[$global:langCode]

                        $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                        if ($entry.title -match $cjkPattern -and $entry.originalTitle) {
                            $Titletext = $entry.originalTitle
                        }
                        else {
                            $Titletext = $entry.title
                        }

                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $PosterImageoriginal = "$EntryDir\poster.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "poster"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                            }
                            Else {
                                $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = $($entry.RootFoldername)
                        }
                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }
                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                        $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        # Now we can start the Poster Part
                        if ($global:Posters -eq 'true') {

                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                # Define Global Variables
                                $SkippingText = 'false'
                                $global:tmdbid = $entry.tmdbid
                                $global:tvdbid = $entry.tvdbid
                                $global:imdbid = $entry.imdbid
                                $global:posterurl = $null
                                $global:PosterWithText = $null
                                $global:AssetTextLang = $null
                                $global:TMDBAssetTextLang = $null
                                $global:FANARTAssetTextLang = $null
                                $global:TVDBAssetTextLang = $null
                                $global:TMDBAssetChangeUrl = $null
                                $global:FANARTAssetChangeUrl = $null
                                $global:TVDBAssetChangeUrl = $null
                                $global:Fallback = $null
                                $global:IsFallback = $null
                                $global:ImageMagickError = $null
                                $TakeLocal = $null
                                $LocalAssetMissing = $null
                                $Arturl = $null

                                if ($entry.PlexPosterUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $entry.PlexPosterUrl
                                    }
                                }

                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                    Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                    $LocalAssetMissing = 'true'
                                }
                                Else {
                                    Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                        'FANART' { $global:posterurl = GetFanartMoviePoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                        Default { $global:posterurl = GetFanartMoviePoster }
                                    }
                                    switch -Wildcard ($global:Fallback) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                        'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    }
                                    if ($global:PosterPreferTextless -eq $true) {
                                        if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                            $global:posterurl = $global:fanartfallbackposterurl
                                            Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                            $global:posterurl = $global:TMDBfallbackposterurl
                                            Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }

                                    if ($global:PosterOnlyTextless -and !$global:posterurl) {
                                        if ($global:FavProvider -eq 'TVDB') {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Elseif ($global:FavProvider -eq 'FANART') {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetTVDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            $global:posterurl = GetFanartMoviePoster
                                            if (!$global:FavProvider -eq 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetTVDBMoviePoster
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }

                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TVDB' -and !$global:PosterOnlyTextless -and !$global:PosterPreferTextless) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl -and !$global:PosterOnlyTextless) {
                                            if ($ArtUrl) {
                                                GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                                $global:IsFallback = $true
                                            }
                                            Else {
                                                Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                        }
                                        if (!$global:posterurl -and $global:imdbid -and !$global:PosterOnlyTextless) {
                                            Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:posterurl = GetIMDBPoster
                                            $global:IsFallback = $true
                                            if (!$global:posterurl) {
                                                Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                    }
                                }
                                if ($fontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                                if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if ($global:ImageProcessing -eq 'true') {
                                        Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'true') {
                                            if ($UsePosterResolutionOverlays -eq 'true') {
                                                switch ($entry.Resolution) {
                                                    '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                    '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                    '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                    '4K'            { $Posteroverlay = $4kposter }
                                                    '1080p'         { $Posteroverlay = $1080pPoster }
                                                    Default { $Posteroverlay = $Posteroverlay }
                                                }
                                            }
                                            # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                            if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            else {
                                                $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                $SkippingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                                if ($global:direction -eq "RTL") {
                                                    $fontImagemagick = $RTLfontImagemagick
                                                }
                                                $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        # Default: Replace the symbol with a newline
                                                        $replacementString = "`n"

                                                        # Check if the symbol should be kept
                                                        $keepThisSymbol = $false
                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                if ($symbol -like "*$k*") {
                                                                    $keepThisSymbol = $true
                                                                    break # Match found, no need to keep checking
                                                                }
                                                            }
                                                        }

                                                        # If it's a "keep" symbol, change the replacement string
                                                        if ($keepThisSymbol) {
                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                            $replacementString = $symbol + "`n"
                                                        }
                                                        $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                    }
                                                }
                                                $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                                if (!$global:IsTruncated) {
                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                    # Add Stroke
                                                    if ($AddTextStroke -eq 'true') {
                                                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                    }
                                                    Else {
                                                        $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                    }

                                                    Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $logEntry = "`"$magick`" $Arguments"
                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                    # Move file back to original naming with Brackets.
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                            if (!$global:IsTruncated) {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "PosterImage: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $posterCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            $movietemp = New-Object psobject
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                            $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                            }

                                            # Export the array to a CSV file
                                            $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $movietemp.Type -title $movietemp.Title -Lib $movietemp.LibraryName -DLSource $movietemp.'Download Source' -lang $movietemp.Language -favurl $movietemp.'Fav Provider Link' -fallback $movietemp.Fallback -Truncated $movietemp.TextTruncated
                                        }
                                    }
                                }
                                Elseif ($LocalAssetMissing -eq 'true') {
                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $movietemp = New-Object psobject
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                    }
                                    # Export the array to a CSV file
                                    $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                }
                            }
                            else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                        # Now we can start the Background Poster Part
                        if ($global:BackgroundPosters -eq 'true') {
                            if ($LibraryFolders -eq 'true') {
                                $LibraryName = $entry.'Library Name'
                                if ($entry.extraFolder) {
                                    $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                    $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                }
                                Else {
                                    $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                    $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                                }
                                $backgroundImageoriginal = "$EntryDir\background.jpg"
                                $TestPath = $EntryDir
                                $ManualTestPath = $ManualEntryDir
                                $Testfile = "background"

                                if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                    New-Item -ItemType Directory -path $EntryDir -Force | out-null
                                }
                            }
                            Else {
                                if ($entry.extraFolder) {
                                    $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                                }
                                Else {
                                    $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                                }
                                $TestPath = $AssetPath
                                $ManualTestPath = $ManualPath
                                $Testfile = "$($entry.RootFoldername)_background"
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                                $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                }
                            }

                            $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                            $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                # Define Global Variables
                                $SkippingText = 'false'
                                $global:tmdbid = $entry.tmdbid
                                $global:tvdbid = $entry.tvdbid
                                $global:imdbid = $entry.imdbid
                                $global:posterurl = $null
                                $global:PosterWithText = $null
                                $global:AssetTextLang = $null
                                $global:Fallback = $null
                                $global:IsFallback = $null
                                $global:TMDBAssetTextLang = $null
                                $global:FANARTAssetTextLang = $null
                                $global:TVDBAssetTextLang = $null
                                $global:TMDBAssetChangeUrl = $null
                                $global:FANARTAssetChangeUrl = $null
                                $global:TVDBAssetChangeUrl = $null
                                $global:ImageMagickError = $null
                                $global:TMDBfallbackposterurl = $null
                                $global:fanartfallbackposterurl = $null
                                $TakeLocal = $null
                                $LocalAssetMissing = $null
                                $Arturl = $null

                                if ($entry.PlexBackgroundUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                                    }
                                }

                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                    Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                    $LocalAssetMissing = 'true'
                                }
                                Else {
                                    Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                        'FANART' { $global:posterurl = GetFanartMovieBackground }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                        Default { $global:posterurl = GetFanartMovieBackground }
                                    }
                                    switch -Wildcard ($global:Fallback) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                        'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    }
                                    if ($global:BackgroundPreferTextless -eq $true) {
                                        if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                            $global:posterurl = $global:fanartfallbackposterurl
                                            Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                            $global:posterurl = $global:TMDBfallbackposterurl
                                            Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                            $global:IsFallback = $true
                                        }
                                        if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMovieBackground
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMovieBackground
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                        if ($global:FavProvider -eq 'TVDB') {
                                            if ($entry.tmdbid) {
                                                $global:posterurl = GetTMDBMovieBackground
                                                $global:IsFallback = $true
                                            }
                                            if (!$global:posterurl) {
                                                $global:posterurl = GetFanartMovieBackground
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            $global:posterurl = GetFanartMovieBackground
                                            if (!$global:FavProvider -eq 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:posterurl = GetTVDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            if ($ArtUrl) {
                                                GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                                $global:IsFallback = $true
                                            }
                                            Else {
                                                Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            if (!$global:posterurl) {
                                                Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                    }
                                }
                                if ($BackgroundfontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                                if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            if ($global:PosterWithText) {
                                                Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                            }
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if ($global:ImageProcessing -eq 'true') {
                                        Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'true') {
                                            if ($UseBackgroundResolutionOverlays -eq 'true') {
                                                switch ($entry.Resolution) {
                                                    '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                    '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                    '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                    '4K'            { $backgroundoverlay = $4kBackground }
                                                    '1080p'         { $backgroundoverlay = $1080pBackground }
                                                    Default { $backgroundoverlay = $backgroundoverlay }
                                                }
                                            }
                                            # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                            if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            else {
                                                $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                $SkippingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                                if ($global:direction -eq "RTL") {
                                                    $backgroundfontImagemagick = $RTLfontImagemagick
                                                }
                                                $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        # Default: Replace the symbol with a newline
                                                        $replacementString = "`n"

                                                        # Check if the symbol should be kept
                                                        $keepThisSymbol = $false
                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                if ($symbol -like "*$k*") {
                                                                    $keepThisSymbol = $true
                                                                    break # Match found, no need to keep checking
                                                                }
                                                            }
                                                        }

                                                        # If it's a "keep" symbol, change the replacement string
                                                        if ($keepThisSymbol) {
                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                            $replacementString = $symbol + "`n"
                                                        }
                                                        $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                    }
                                                }
                                                $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                                if (!$global:IsTruncated) {
                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                    # Add Stroke
                                                    if ($AddBackgroundTextStroke -eq 'true') {
                                                        $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                    }
                                                    Else {
                                                        $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                    }

                                                    Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $logEntry = "`"$magick`" $Arguments"
                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                    if (!$global:ImageMagickError -eq 'true') {
                                        # Move file back to original naming with Brackets.
                                        if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                            if (!$global:IsTruncated) {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "BackgroundImage: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $posterCount++
                                                $BackgroundCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            $moviebackgroundtemp = New-Object psobject
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                            $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                            }
                                            # Export the array to a CSV file
                                            $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $moviebackgroundtemp.Type -title $moviebackgroundtemp.Title -Lib $moviebackgroundtemp.LibraryName -DLSource $moviebackgroundtemp.'Download Source' -lang $moviebackgroundtemp.Language -favurl $moviebackgroundtemp.'Fav Provider Link' -fallback $moviebackgroundtemp.Fallback -Truncated $moviebackgroundtemp.TextTruncated
                                        }
                                    }
                                }
                                Elseif ($LocalAssetMissing -eq 'true') {
                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $moviebackgroundtemp = New-Object psobject
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                    }
                                    # Export the array to a CSV file
                                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                }
                            }
                            else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
                Else {
                    Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                }
            }
            catch {
                Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                if ($global:PosterOnlyTextless) {
                    $moviebackgroundtemp = New-Object psobject
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                    $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                    switch -Wildcard ($global:FavProvider) {
                        'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                        'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                        'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                        Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                    }
                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                    }
                    # Export the array to a CSV file
                    $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                }

            }
        }

        $SkipTBACount = 0
        $SkipJapTitleCount = 0
        Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        # Show Part
        foreach ($entry in $AllShows) {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    # Define Global Variables
                    $SkippingText = 'false'
                    $global:tmdbsearched = $null
                    $global:tmdbid = $entry.tmdbid
                    $global:tvdbid = $entry.tvdbid
                    $global:imdbid = $entry.imdbid
                    $Seasonpostersearchtext = $null
                    $global:ImageMagickError = $null
                    $Episodepostersearchtext = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $FanartSearched = $null
                    $global:plexalreadysearched = $null
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    $global:AssetTextLang = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:Fallback = $null
                    $global:TextlessPoster = $null
                    $global:tvdbalreadysearched = $null
                    $global:PlexartworkDownloaded = $null
                    $TakeLocal = $null
                    $LocalAssetMissing = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            $Arturl = $null
                            if ($entry.PlexPosterUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl
                                }
                            }
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }
                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                    'FANART' { $global:posterurl = GetFanartShowPoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                    Default { $global:posterurl = GetFanartShowPoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } }
                                    'FANART' { $global:posterurl = GetFanartShowPoster }
                                }
                                if ($global:PosterPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    # try to find textless on TVDB
                                    if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid ) {
                                        $global:posterurl = GetTVDBShowPoster
                                        $global:IsFallback = $true
                                        $global:tvdbalreadysearched = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                        $global:posterurl = GetFanartMoviePoster
                                        $global:IsFallback = $true
                                    }
                                }

                                if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                    $global:PosterWithText = $true
                                }

                                if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    if (!$global:posterurl -and !$global:TMDBfallbackposterurl -and !$global:fanartfallbackposterurl) {
                                        if ($ArtUrl -and !$global:PosterOnlyTextless) {
                                            GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                            $global:plexalreadysearched = $True
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                                if (!$global:posterurl -and !$global:plexalreadysearched -eq 'true') {
                                    $global:IsFallback = $true
                                    if ($ArtUrl -and !$global:PosterOnlyTextless) {
                                        GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                        $global:plexalreadysearched = $True
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                                if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                }
                                if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        if ($global:FavProvider -ne 'PLEX') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UsePosterResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                '4K'            { $Posteroverlay = $4kposter }
                                                '1080p'         { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }

                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "PosterImage: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $showtemp = New-Object psobject
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $showtemp.Type -title $showtemp.Title -Lib $showtemp.LibraryName -DLSource $showtemp.'Download Source' -lang $showtemp.Language -favurl $showtemp.'Fav Provider Link' -fallback $showtemp.Fallback -Truncated $showtemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $showtemp = New-Object psobject
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                    # Now we can start the Background Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                        if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:TextlessPoster = $null
                            $global:ImageMagickError = $null
                            $global:TMDBfallbackposterurl = $null
                            $global:fanartfallbackposterurl = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            $Arturl = $null

                            if ($entry.PlexBackgroundUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl
                                }
                            }

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }
                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                    'FANART' { $global:posterurl = GetFanartShowBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                    Default { $global:posterurl = GetFanartShowBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                    'FANART' { $global:posterurl = GetFanartShowBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartShowBackground
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Background'
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartShowBackground
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBShowBackground
                                        $global:IsFallback = $true
                                    }
                                    $global:FallbackText = 'True-Background'
                                    if (!$global:posterurl) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }

                                }

                                if ($BackgroundfontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        if ($global:FavProvider -ne 'PLEX') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UseBackgroundResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                '4K'            { $backgroundoverlay = $4kBackground }
                                                '1080p'         { $backgroundoverlay = $1080pBackground }
                                                Default { $Backgroundoverlay = $Backgroundoverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument

                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "BackgroundImage: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            $BackgroundCount++
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $showbackgroundtemp = New-Object psobject
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        SendMessage -type $showbackgroundtemp.Type -title $showbackgroundtemp.Title -Lib $showbackgroundtemp.LibraryName -DLSource $showbackgroundtemp.'Download Source' -lang $showbackgroundtemp.Language -favurl $showbackgroundtemp.'Fav Provider Link' -fallback $showbackgroundtemp.Fallback -Truncated $showbackgroundtemp.TextTruncated
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $showbackgroundtemp = New-Object psobject
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                    # Now we can start the Season Part
                    if ($global:SeasonPosters -eq 'true') {
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TextlessPoster = $null
                        $global:seasonNames = $entry.SeasonNames -split ';'
                        $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                        $global:seasonNumbers = $entry.seasonNumbers -split ','
                        $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                        for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                            $SkippingText = 'false'
                            $global:tmdbsearched = $null
                            $global:seasontmp = $null
                            $global:posterurl = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:ImageMagickError = $null
                            $global:TMDBSeasonFallback = $null
                            $global:TVDBSeasonFallback = $null
                            $global:FANARTSeasonFallback = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null

                            if ($SeasonfontAllCaps -eq 'true') {
                                $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                            }
                            Else {
                                $global:seasonTitle = $global:seasonNames[$i]
                            }
                            $global:SeasonNumber = $global:seasonNumbers[$i]
                            $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                            $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                            if ($null -ne $global:SeasonNumber) {
                                $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                            }
                            if ($LibraryFolders -eq 'true') {
                                $SeasonImageoriginal = "$EntryDir\$global:seasontmp.jpg"
                                $TestPath = $EntryDir
                                $ManualTestPath = $ManualEntryDir
                                $Testfile = "$global:seasontmp"
                            }
                            Else {
                                if ($entry.extraFolder) {
                                    $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                }
                                Else {
                                    $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                }
                                $TestPath = $AssetPath
                                $ManualTestPath = $ManualPath
                                $Testfile = "$($entry.RootFoldername)_$global:seasontmp"
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                $SeasonImageoriginal = ($SeasonImageoriginal).Replace('\', '/').Replace('./', '/')
                                $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                }
                            }

                            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                            $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:seasontmp.jpg"
                            $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                $Arturl = $null
                                if ($global:PlexSeasonUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $global:PlexSeasonUrl
                                    }
                                }
                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                    Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                    $LocalAssetMissing = 'true'
                                }
                                Else {
                                    if (!$Seasonpostersearchtext) {
                                        Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $Seasonpostersearchtext = $true
                                    }
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                        'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage } }
                                        Default { $global:posterurl = GetFanartSeasonPoster }
                                    }
                                    # do a specific order
                                    if ($global:SeasonPreferTextless -eq $true) {
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                $global:posterurl = GetTMDBSeasonPoster
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                            if (!$global:posterurl -or !$global:TextlessPoster) {
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:posterurl = GetFanartSeasonPoster
                                                    Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                    $global:posterurl = GetTVDBSeasonPoster
                                                    Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                        if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                            # Lets just try to grab a show poster.
                                            Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                                Default { $global:posterurl = GetFanartShowPoster }
                                            }
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                            Else {
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:posterurl = GetTMDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                    $global:posterurl = GetTVDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                    $global:posterurl = GetFanartShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                $global:posterurl = GetTMDBSeasonPoster
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                            if (!$global:posterurl) {
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:posterurl = GetFanartSeasonPoster
                                                    Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if (!$global:posterurl -and $entry.tvdbid) {
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                    $global:posterurl = GetTVDBSeasonPoster
                                                    Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if ($ArtUrl) {
                                                if ($global:FavProvider -ne 'PLEX') {
                                                    $global:IsFallback = $true
                                                    GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage
                                                    Write-Entry -Subtext "Function GetPlexArtwork called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "Plex Season Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                    if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                    if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                        $global:posterurl = $global:TMDBSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                        $global:posterurl = $global:FANARTSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                        $global:posterurl = $global:TVDBSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }

                                }
                                if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                    if ($global:ImageProcessing -eq 'true') {
                                        if ($TakeLocal) {
                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                            }
                                            Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        }
                                        Else {
                                            try {
                                                if (!$global:PlexartworkDownloaded) {
                                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                                }
                                            }
                                            catch {
                                                if ($_.Exception.Response) {
                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                }
                                                else {
                                                    $statusCode = $_.Exception.Message
                                                }
                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                                Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like "$PlexUrl*") {
                                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                if ($global:FavProvider -ne 'PLEX') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $PosterUnknownCount++
                                                $global:IsFallback = $true
                                            }
                                        }
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                            if (!$global:ImageMagickError -eq 'true') {
                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                elseif ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                elseif ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                else {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }

                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                    $SkippingText = 'true'
                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                }
                                                if ($AddSeasonText -eq 'true' -and $SkippingText -eq 'false') {
                                                    $global:seasonTitle = $global:seasonTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                    if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                        $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                    }
                                                    Else {
                                                        $global:ShowTitleOnSeason = $titletext -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                    }
                                                    # Loop through each symbol and replace it with a newline
                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                        foreach ($symbol in $NewLineSymbols) {
                                                            # Default: Replace the symbol with a newline
                                                            $replacementString = "`n"

                                                            # Check if the symbol should be kept
                                                            $keepThisSymbol = $false
                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                    if ($symbol -like "*$k*") {
                                                                        $keepThisSymbol = $true
                                                                        break # Match found, no need to keep checking
                                                                    }
                                                                }
                                                            }

                                                            # If it's a "keep" symbol, change the replacement string
                                                            if ($keepThisSymbol) {
                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                $replacementString = $symbol + "`n"
                                                            }
                                                            $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), $replacementString
                                                            if ($AddShowTitletoSeason -eq 'true') {
                                                                $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), $replacementString
                                                            }
                                                        }
                                                    }
                                                    $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                    $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                    if ($AddShowTitletoSeason -eq 'true') {
                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                        $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                        if (!$global:IsTruncated) {
                                                            Write-Entry -Subtext ("Optimal Season font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            Write-Entry -Subtext ("Optimal Show font size set to: '{0}' [{1}]" -f $showoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            # Season Part
                                                            # Add Stroke
                                                            if ($AddSeasonTextStroke -eq 'true') {
                                                                $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $SeasonArguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                            # Show Part
                                                            # Add Stroke
                                                            if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                                $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                        }
                                                    }
                                                    Else {
                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                        if (!$global:IsTruncated) {
                                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            # Add Stroke
                                                            if ($AddSeasonTextStroke -eq 'true') {
                                                                $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        if ($TakeLocal) {
                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                            }
                                            Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        }
                                        Else {
                                            try {
                                                if (!$global:PlexartworkDownloaded) {
                                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                                }
                                            }
                                            catch {
                                                if ($_.Exception.Response) {
                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                }
                                                else {
                                                    $statusCode = $_.Exception.Message
                                                }
                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                                Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:FANARTAssetTextLang
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            elseif ($global:posterurl -like "$PlexUrl*") {
                                                Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                if ($global:FavProvider -ne 'PLEX') {
                                                    $global:IsFallback = $true
                                                }
                                            }
                                            Else {
                                                Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $PosterUnknownCount++
                                                $global:IsFallback = $true
                                            }
                                        }
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            # Resize Image to 2000x3000
                                            $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Resizeargument"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                        }
                                    }
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            # Move file back to original naming with Brackets.
                                            if (!$global:IsTruncated) {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($SeasonImage)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "SeasonImage: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($global:SeasonRatingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $SeasonCount++
                                                $posterCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            $seasontemp = New-Object psobject
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$SeasonImage} Else {$global:posterurl})
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                            }
                                            # Export the array to a CSV file
                                            $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                            SendMessage -type $seasontemp.Type -title $seasontemp.Title -Lib $seasontemp.LibraryName -DLSource $seasontemp.'Download Source' -lang $seasontemp.Language -favurl $seasontemp.'Fav Provider Link' -fallback $seasontemp.Fallback -Truncated $seasontemp.TextTruncated
                                        }
                                    }
                                }
                                Elseif ($LocalAssetMissing -eq 'true') {
                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $seasontemp = New-Object psobject
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                    }
                                    # Export the array to a CSV file
                                    $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                }
                            }
                            else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Episode Part
                    if ($global:TitleCards -eq 'true') {
                        # Loop through each episode
                        foreach ($episode in $Episodedata) {
                            $SkippingText = 'false'
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:PosterWithText = $null
                            $global:TempImagecopied = $false
                            $EpisodeTempImage = $null
                            $global:ImageMagickError = $null
                            $global:season_number = $null
                            $Episodepostersearchtext = $null
                            $global:show_name = $null
                            $global:episodenumber = $null
                            $global:episode_numbers = $null
                            $global:titles = $null
                            $global:posterurl = $null
                            $global:FileNaming = $null
                            $EpisodeImageoriginal = $null
                            $EpisodeImage = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:FallbackText = $null
                            $global:TextlessPoster = $null
                            $global:EPResolutions = $null

                            if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                                $global:show_name = $episode."Show Name"
                                $global:EPResolutions = $episode."Resolutions".Split(",")
                                $global:season_number = $episode."Season Number"
                                $global:episode_numbers = $episode."Episodes".Split(",")
                                $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                                $global:titles = $episode."Title".Split(";")
                                $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                                if ($UseBackgroundAsTitleCard -eq 'true') {
                                    $global:ImageMagickError = $null
                                    for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                        $SkippingText = 'false'
                                        $global:AssetTextLang = $null
                                        $global:TMDBAssetTextLang = $null
                                        $global:FANARTAssetTextLang = $null
                                        $global:TVDBAssetTextLang = $null
                                        $global:TMDBAssetChangeUrl = $null
                                        $global:FANARTAssetChangeUrl = $null
                                        $global:TVDBAssetChangeUrl = $null
                                        $global:PosterWithText = $null
                                        $global:Fallback = $null
                                        $global:IsFallback = $null
                                        $global:posterurl = $null
                                        $Episodepostersearchtext = $null
                                        $ExifFound = $null
                                        $global:PlexartworkDownloaded = $null
                                        $value = $null
                                        $magickcommand = $null
                                        $Arturl = $null
                                        $TakeLocal = $null
                                        $LocalAssetMissing = $null
                                        $global:PlexTitleCardUrl = $entry.PlexBackgroundUrl
                                        $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                        $global:EPTitle = $($global:titles[$i].Trim())
                                        $global:EPResolution = $($global:EPResolutions[$i].Trim())
                                        $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                        $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                        $bullet = [char]0x2022
                                        $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                        if ($LibraryFolders -eq 'true') {
                                            $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                            $TestPath = $EntryDir
                                            $ManualTestPath = $ManualEntryDir
                                            $Testfile = "$global:FileNaming"
                                        }
                                        Else {
                                            if ($entry.extraFolder) {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            Else {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            $TestPath = $AssetPath
                                            $ManualTestPath = $ManualPath
                                            $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                        }

                                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                            $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        }
                                        else {
                                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                            if ($fullTestPath) {
                                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                            Else {
                                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                        }

                                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                        $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                        $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                        $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                        if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipTBACount++
                                        }
                                        Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipJapTitleCount++
                                        }
                                        Else {

                                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                                $Arturl = $null
                                                if ($global:PlexTitleCardUrl -like "/library/*") {
                                                    if ($PlexToken) {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                    }
                                                }
                                                foreach ($ext in $allowedExtensions) {
                                                    $filePath = "$ManualTestPath$ext"
                                                    if (Test-Path -LiteralPath $filePath) {
                                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        $posterext = $ext
                                                        break
                                                    }
                                                }

                                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                    Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $TakeLocal = $true
                                                }
                                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                    $LocalAssetMissing = 'true'
                                                }
                                                Else {
                                                    if (!$Episodepostersearchtext) {
                                                        Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $Episodepostersearchtext = $true
                                                    }
                                                    if ($global:TempImagecopied -ne 'true') {
                                                        # now search for TitleCards
                                                        if ($global:FavProvider -eq 'TMDB') {
                                                            if ($episode.tmdbid) {
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetTVDBShowBackground
                                                                    if (!$global:posterurl) {
                                                                        $global:posterurl = GetFanartShowBackground
                                                                    }
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if ($ArtUrl) {
                                                                        GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                    }
                                                                    Else {
                                                                        Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    }
                                                                    if ($global:tmdbfallbackposterurl) {
                                                                        $global:posterurl = $global:tmdbfallbackposterurl
                                                                    }
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                            else {
                                                                Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if ($ArtUrl) {
                                                                        GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                    }
                                                                    Else {
                                                                        Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    }
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            if ($episode.tvdbid) {
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetTMDBShowBackground
                                                                    if (!$global:posterurl) {
                                                                        $global:posterurl = GetFanartShowBackground
                                                                    }
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if ($ArtUrl) {
                                                                        GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                    }
                                                                    Else {
                                                                        Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    }
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                            else {
                                                                Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                                if (!$global:posterurl) {
                                                                    $global:IsFallback = $true
                                                                    if ($ArtUrl) {
                                                                        GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                    }
                                                                    Else {
                                                                        Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    }
                                                                    if (!$global:posterurl) {
                                                                        Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal -or $global:TempImagecopied -eq 'true') {
                                                    if ($global:ImageProcessing -eq 'true') {
                                                        if ($TakeLocal) {
                                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                                Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                            }
                                                            if ($global:TempImagecopied -ne 'true') {
                                                                Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                            }
                                                            Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        }
                                                        Else {
                                                            try {
                                                                if (!$global:PlexartworkDownloaded -and $global:TempImagecopied -ne 'true') {
                                                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                    Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                                }
                                                            }
                                                            catch {
                                                                if ($_.Exception.Response) {
                                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                                }
                                                                else {
                                                                    $statusCode = $_.Exception.Message
                                                                }
                                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }

                                                            if ($global:TempImagecopied -ne 'true') {
                                                                Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                    Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                    if ($global:FavProvider -ne 'TMDB') {
                                                                        $global:IsFallback = $true
                                                                    }
                                                                }
                                                                if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                    Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                    if ($global:FavProvider -ne 'TVDB') {
                                                                        $global:IsFallback = $true
                                                                    }
                                                                }
                                                                if ($global:posterurl -like "$PlexUrl*") {
                                                                    Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    if ($global:FavProvider -ne 'PLEX') {
                                                                        $global:IsFallback = $true
                                                                    }
                                                                }
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Taking temp image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                            }
                                                        }
                                                        $global:TempImagecopied = $true
                                                        # Check temp image
                                                        if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                            Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Else {
                                                            if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                                $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                                if (!$global:ImageMagickError -eq 'true') {
                                                                    if ($UseTCResolutionOverlays -eq 'true') {
                                                                        switch ($global:EPResolution) {
                                                                            '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                            '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                            '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                            '4K'            { $TitleCardoverlay = $4kTC }
                                                                            '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                            Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                        }
                                                                    }
                                                                    # Resize Image to 2000x3000 and apply Border and overlay
                                                                    if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    else {
                                                                        $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    }
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                        $SkippingText = 'true'
                                                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                    }
                                                                    if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                        if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                            $global:EPTitle = $global:EPTitle.ToUpper()
                                                                        }
                                                                        $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                                        if ($global:direction -eq "RTL") {
                                                                            $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                        }
                                                                        # Loop through each symbol and replace it with a newline
                                                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                            foreach ($symbol in $NewLineSymbols) {
                                                                                # Default: Replace the symbol with a newline
                                                                                $replacementString = "`n"

                                                                                # Check if the symbol should be kept
                                                                                $keepThisSymbol = $false
                                                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                        if ($symbol -like "*$k*") {
                                                                                            $keepThisSymbol = $true
                                                                                            break # Match found, no need to keep checking
                                                                                        }
                                                                                    }
                                                                                }

                                                                                # If it's a "keep" symbol, change the replacement string
                                                                                if ($keepThisSymbol) {
                                                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                    $replacementString = $symbol + "`n"
                                                                                }
                                                                                $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                            }
                                                                        }
                                                                        $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                        if (!$global:IsTruncated) {
                                                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            # Add Stroke
                                                                            if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }
                                                                            Else {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }

                                                                            Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            $logEntry = "`"$magick`" $Arguments"
                                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                        }
                                                                    }
                                                                    if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                        if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                            $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                        }
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                        $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                        if (!$global:IsTruncated) {
                                                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            # Add Stroke
                                                                            if ($AddTitleCardTextStroke -eq 'true') {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }
                                                                            Else {
                                                                                $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                            }

                                                                            Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                            $logEntry = "`"$magick`" $Arguments"
                                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($TakeLocal) {
                                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                                Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                            }
                                                            Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        }
                                                        Else {
                                                            try {
                                                                if (!$global:PlexartworkDownloaded) {
                                                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                }
                                                            }
                                                            catch {
                                                                if ($_.Exception.Response) {
                                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                                }
                                                                else {
                                                                    $statusCode = $_.Exception.Message
                                                                }
                                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Resize Image to 2000x3000
                                                            $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Resizeargument"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                        }
                                                    }
                                                    if (!$global:ImageMagickError -eq 'true') {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Move file back to original naming with Brackets.
                                                            if (!$global:IsTruncated) {
                                                                try {
                                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                    # Verify variables before uploading
                                                                    Write-Entry -Subtext "EpisodeImage: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                                    $uri = if ($PlexToken) {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                                    }
                                                                    Else {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                                    }
                                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    # Try uploading, capturing the response in detail
                                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                                -Method Post `
                                                                                                -Headers $extraPlexHeaders `
                                                                                                -Body $fileContent `
                                                                                                -ContentType 'application/octet-stream' `
                                                                                                -SkipHttpErrorCheck `
                                                                                                -ErrorAction Stop

                                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                                    }
                                                                    else {
                                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                    }
                                                                }
                                                                catch {
                                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                    $global:errorCount++
                                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                                try {
                                                                    # Attempt to move the item
                                                                    Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                    # Log success if move was successful
                                                                    Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                                }
                                                                catch {
                                                                    # Log the error if the move operation fails
                                                                    Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                }
                                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                                $EpisodeCount++
                                                                $posterCount++
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                            SendMessage -type $episodetemp.Type -title $($global:show_name + " | " + $episodetemp.Title) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                        }
                                                    }
                                                }
                                                Elseif ($LocalAssetMissing -eq 'true') {
                                                    Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                }
                                                Else {
                                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    if ($global:BackgroundOnlyTextless) {
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                            Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }

                                                }

                                            }
                                            else {
                                                if ($show_skipped -eq 'true' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                    if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                        Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                        Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                }
                                Else {
                                    for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                        $SkippingText = 'false'
                                        $global:AssetTextLang = $null
                                        $global:TMDBAssetTextLang = $null
                                        $global:FANARTAssetTextLang = $null
                                        $global:TVDBAssetTextLang = $null
                                        $global:TMDBAssetChangeUrl = $null
                                        $global:FANARTAssetChangeUrl = $null
                                        $global:TVDBAssetChangeUrl = $null
                                        $global:PosterWithText = $null
                                        $global:Fallback = $null
                                        $global:IsFallback = $null
                                        $global:FallbackText = $null
                                        $global:ImageMagickError = $null
                                        $global:TextlessPoster = $null
                                        $global:posterurl = $null
                                        $Episodepostersearchtext = $null
                                        $ExifFound = $null
                                        $global:PlexartworkDownloaded = $null
                                        $value = $null
                                        $magickcommand = $null
                                        $Arturl = $null
                                        $TakeLocal = $null
                                        $LocalAssetMissing = $null
                                        $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                        $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                        $global:EPTitle = $($global:titles[$i].Trim())
                                        $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                        $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                        $bullet = [char]0x2022
                                        $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                        if ($LibraryFolders -eq 'true') {
                                            $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                            $TestPath = $EntryDir
                                            $ManualTestPath = $ManualEntryDir
                                            $Testfile = "$global:FileNaming"
                                        }
                                        Else {
                                            if ($entry.extraFolder) {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            Else {
                                                $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                            }
                                            $TestPath = $AssetPath
                                            $ManualTestPath = $ManualPath
                                            $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                        }

                                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                            $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        }
                                        else {
                                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                            if ($fullTestPath) {
                                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                            Else {
                                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                            }
                                        }

                                        $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                        $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                        if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipTBACount++
                                        }
                                        Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                            Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $SkipJapTitleCount++
                                        }
                                        Else {

                                            if (($FileTestOnTrigger -eq 'false') -or (-not $directoryHashtable.ContainsKey("$hashtestpath"))) {
                                                $Arturl = $null
                                                if ($global:PlexTitleCardUrl -like "/library/*") {
                                                    if ($PlexToken) {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                    }
                                                }
                                                foreach ($ext in $allowedExtensions) {
                                                    $filePath = "$ManualTestPath$ext"
                                                    if (Test-Path -LiteralPath $filePath) {
                                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        $posterext = $ext
                                                        break
                                                    }
                                                }
                                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                    Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $TakeLocal = $true
                                                }
                                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                    $LocalAssetMissing = 'true'
                                                }
                                                Else {
                                                    if (!$Episodepostersearchtext) {
                                                        Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $Episodepostersearchtext = $true
                                                    }
                                                    # now search for TitleCards
                                                    if ($global:FavProvider -eq 'TMDB') {
                                                        if ($episode.tmdbid) {
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if (!$global:posterurl -or $global:Fallback -eq "TVDB") {
                                                                $global:posterurl = GetTVDBTitleCard
                                                                if ($global:posterurl){
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                                Else {
                                                                    # Lets just try to grab a background poster.
                                                                    $global:posterurl = GetTVDBShowBackground
                                                                    if ($global:posterurl) {
                                                                        Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                        $global:IsFallback = $true
                                                                        $global:FallbackText = 'True-Background'
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                                Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($episode.tvdbid) {
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if (!$global:posterurl -or $global:Fallback -eq "TMDB") {
                                                                $global:posterurl = GetTMDBTitleCard
                                                                if ($global:posterurl){
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                                Else {
                                                                    # Lets just try to grab a background poster.
                                                                    $global:posterurl = GetTMDBShowBackground
                                                                    if ($global:posterurl) {
                                                                        Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                        $global:IsFallback = $true
                                                                        $global:FallbackText = 'True-Background'
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                                # Lets just try to grab a background poster.
                                                                Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                    if ($global:ImageProcessing -eq 'true') {
                                                        if ($TakeLocal) {
                                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                                Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                            }
                                                            Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        }
                                                        Else {
                                                            try {
                                                                if (!$global:PlexartworkDownloaded) {
                                                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                }
                                                            }
                                                            catch {
                                                                if ($_.Exception.Response) {
                                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                                }
                                                                else {
                                                                    $statusCode = $_.Exception.Message
                                                                }
                                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'true') {
                                                                if ($UseTCResolutionOverlays -eq 'true') {
                                                                    switch ($global:EPResolution) {
                                                                        '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                        '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                        '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                        '4K'            { $TitleCardoverlay = $4kTC }
                                                                        '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                        Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                    }
                                                                }
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                else {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                    $SkippingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            # Default: Replace the symbol with a newline
                                                                            $replacementString = "`n"

                                                                            # Check if the symbol should be kept
                                                                            $keepThisSymbol = $false
                                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                    if ($symbol -like "*$k*") {
                                                                                        $keepThisSymbol = $true
                                                                                        break # Match found, no need to keep checking
                                                                                    }
                                                                                }
                                                                            }

                                                                            # If it's a "keep" symbol, change the replacement string
                                                                            if ($keepThisSymbol) {
                                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                $replacementString = $symbol + "`n"
                                                                            }
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($TakeLocal) {
                                                            Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                                Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                            }
                                                            Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        }
                                                        Else {
                                                            try {
                                                                if (!$global:PlexartworkDownloaded) {
                                                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                }
                                                            }
                                                            catch {
                                                                if ($_.Exception.Response) {
                                                                    $statusCode = $_.Exception.Response.StatusCode.value__
                                                                }
                                                                else {
                                                                    $statusCode = $_.Exception.Message
                                                                }
                                                                Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Resize Image to 2000x3000
                                                            $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Resizeargument"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                        }
                                                    }
                                                    if (!$global:ImageMagickError -eq 'true') {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            # Move file back to original naming with Brackets.
                                                            if (!$global:IsTruncated) {
                                                                try {
                                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                    # Verify variables before uploading
                                                                    Write-Entry -Subtext "EpisodeImage: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                                    $uri = if ($PlexToken) {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                                    }
                                                                    Else {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                                    }
                                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    # Try uploading, capturing the response in detail
                                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                                -Method Post `
                                                                                                -Headers $extraPlexHeaders `
                                                                                                -Body $fileContent `
                                                                                                -ContentType 'application/octet-stream' `
                                                                                                -SkipHttpErrorCheck `
                                                                                                -ErrorAction Stop

                                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                                    }
                                                                    else {
                                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                    }
                                                                }
                                                                catch {
                                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                    $global:errorCount++
                                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                                try {
                                                                    # Attempt to move the item
                                                                    Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                    # Log success if move was successful
                                                                    Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                                }
                                                                catch {
                                                                    # Log the error if the move operation fails
                                                                    Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                }
                                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                                $EpisodeCount++
                                                                $posterCount++
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            $episodetemp = New-Object psobject
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                            $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                            switch -Wildcard ($global:FavProvider) {
                                                                'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                                'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                                'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                                Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                            }
                                                            # Export the array to a CSV file
                                                            $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                            SendMessage -type $episodetemp.Type -title $($global:show_name + " | " + $episodetemp.Title) -Lib $episodetemp.LibraryName -DLSource $episodetemp.'Download Source' -lang $episodetemp.Language -favurl $episodetemp.'Fav Provider Link' -fallback $episodetemp.Fallback -Truncated $episodetemp.TextTruncated
                                                        }
                                                    }
                                                }
                                                Elseif ($LocalAssetMissing -eq 'true') {
                                                    Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                }
                                                Else {
                                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    if ($global:BackgroundOnlyTextless) {
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                            Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }

                                                }

                                            }
                                            else {
                                                if ($show_skipped -eq 'true' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }
        $endTime = Get-Date
        $executionTime = New-TimeSpan -Start $startTime -End $endTime
        # Format the execution time
        $hours = [math]::Floor($executionTime.TotalHours)
        $minutes = $executionTime.Minutes
        $seconds = $executionTime.Seconds
        $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "

        Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        if ($posterCount -ge '1') {
            Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
            Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            # Calculate Summary
            $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
            $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
            $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
            $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
            $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
            if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
                Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextlessCount) {
                Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($FallbackCount) {
                Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextCount) {
                Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($PosterUnknownCount -ge '1') {
                Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
            if ($TextTruncatedCount) {
                Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
        }
        if ($errorCount -ge '1') {
            Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
            $ImageChoicesDummycsv = New-Object psobject

            # Add members to the object with empty values
            $ImageChoicesDummycsv = New-Object psobject
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Manual" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
            $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

            $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        }
        Write-TextSizeCacheSummary
        Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

        # Send Notification
        Send-SummaryNotification -ScriptMode $Mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -FallbackCount $FallbackCount.count -TextlessCount $TextlessCount.count -TruncatedCount $TextTruncatedCount.count -PosterUnknownCount $PosterUnknownCount -SkipTBACount $SkipTBACount -SkipJapTitleCount $SkipJapTitleCount -PosterCount $posterCount -BackgroundCount $BackgroundCount -SeasonCount $SeasonCount -EpisodeCount $EpisodeCount

        # Export json
        $jsonObject = [PSCustomObject]@{
            Posters              = if ($posterCount) { $posterCount } Else { 0 }
            Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
            Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
            Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
            Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
            Mode                 = $Mode
            Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
            Errors               = if ($errorCount) { $errorCount } Else { 0 }
            Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
            Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
            Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
            Text                 = if ($TextCount) { $TextCount } Else { 0 }
            "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
            "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
            "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
            "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
            "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
            "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
            "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
            "Script Version"     = $CurrentScriptVersion
            "IM Version"         = $global:CurrentImagemagickversion
            "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
            "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
        }

        $jsonOutput = $jsonObject | ConvertTo-Json
        $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
        }
    }
    Else {
        Write-Entry -Message "No Media Server selected, please check your settings..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        Exit
    }
}
#region Backup Mode
Elseif ($Backup) {
    if ($UsePlex -eq 'true') {
        MassDownloadPlexArtwork
    }
    Else {
        Write-Entry -Message "Backup mode currently works only for Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Warning
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
}
#region Sync Mode
Elseif ($SyncJelly -or $SyncEmby) {
    # Initialize counter variable
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $UploadCount = 0

    [xml]$Libs = CheckPlexAccess -PlexUrl $PlexUrl -PlexToken $PlexToken
    $LibstoExclude = $config.PlexPart.LibstoExclude

    if ($SyncJelly) {
        # Check Jellyfin now:
        CheckJellyfinAccess -JellyfinUrl $JellyfinUrl -JellyfinApi $JellyfinAPIKey
        $OtherMediaServerUrl = $JellyfinUrl
        $OtherMediaServerApiKey = $JellyfinAPIKey
        $Mode = "syncjelly"
        Write-Entry -Message "Sync Jelly Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if ($SyncEmby) {
        # Check Emby now:
        CheckEmbyAccess -EmbyUrl $EmbyUrl -EmbyAPI $EmbyAPIKey
        $OtherMediaServerUrl = $EmbyUrl
        $OtherMediaServerApiKey = $EmbyAPIKey
        $Mode = "syncemby"
        Write-Entry -Message "Sync Emby Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }

    Write-Entry -Message "Query plex libs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libsoverview = @()
    foreach ($lib in $Libs.MediaContainer.Directory) {
        if ($lib.title -notin $LibstoExclude) {
            $libtemp = New-Object psobject
            $libtemp | Add-Member -MemberType NoteProperty -Name "ID" -Value $lib.key
            $libtemp | Add-Member -MemberType NoteProperty -Name "Name" -Value $lib.title
            $libtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $lib.language

            # Check if $lib.location.path is an array
            if ($lib.location.path -is [array]) {
                $paths = $lib.location.path -join ',' # Convert array to string
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $paths
            }
            else {
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $lib.location.path
            }
            # Check if Libname has chars we cant use for Folders
            if ($lib.title -notmatch "^[^\/:*?`"<>\|\\}]+$") {
                Write-Entry -Message  "Lib: '$($lib.title)' contains invalid characters." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Please rename your lib and remove all chars that are listed here: '/, :, *, ?, `", <, >, |, \, or }'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Lib contains invalid chars"
                }
                Exit
            }
            $Libsoverview += $libtemp
        }
    }
    if ($($Libsoverview.count) -lt 1) {
        Write-Entry -Subtext "0 libraries were found. Are you on the correct Plex server?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
    Write-Entry -Subtext "Found '$($Libsoverview.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = $Libsoverview.Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    Foreach ($Library in $Libsoverview) {
        if ($Library.Name -notin $LibstoExclude) {
            $PlexHeaders = @{}
            if ($PlexToken) {
                $PlexHeaders['X-Plex-Token'] = $PlexToken
            }

            # Create a parent XML document
            $Libcontent = New-Object -TypeName System.Xml.XmlDocument
            $mediaContainerNode = $Libcontent.CreateElement('MediaContainer')
            $Libcontent.AppendChild($mediaContainerNode) | Out-Null

            # Initialize variables for pagination
            $searchsize = 0
            $totalContentSize = 1

            # Loop until all content is retrieved
            do {
                # Set headers for the current request
                $PlexHeaders['X-Plex-Container-Start'] = $searchsize
                $PlexHeaders['X-Plex-Container-Size'] = '1000'

                # Fetch content from Plex server
                $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/$($Library.ID)/all" -Headers $PlexHeaders

                # Convert response content to XML
                [xml]$additionalContent = $response.Content

                # Get total content size if not retrieved yet
                if ($totalContentSize -eq 1) {
                    $totalContentSize = $additionalContent.MediaContainer.totalSize
                }

                # Import and append video nodes to the parent XML document
                $contentquery = if ($additionalContent.MediaContainer.video) {
                    'video'
                }
                else {
                    'Directory'
                }
                foreach ($videoNode in $additionalContent.MediaContainer.$contentquery) {
                    $importedNode = $Libcontent.ImportNode($videoNode, $true)
                    [void]$mediaContainerNode.AppendChild($importedNode)
                }

                # Update search size for next request
                $searchsize += [int]$additionalContent.MediaContainer.Size
            } until ($searchsize -ge $totalContentSize)
            if ($Libcontent.MediaContainer.video) {
                $contentquery = 'video'
            }
            Else {
                $contentquery = 'Directory'
            }
            foreach ($item in $Libcontent.MediaContainer.$contentquery) {
                $extractedFolder = $null
                $Seasondata = $null
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children? -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                }
                $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
                $tmdbpattern = 'tmdb://(\d+)'
                $imdbpattern = 'imdb://tt(\d+)'
                $tvdbpattern = 'tvdb://(\d+)'
                if ($Metadata.MediaContainer.$contentquery.Location) {
                    $location = $Metadata.MediaContainer.$contentquery.Location.path
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                Else {
                    $location = $Metadata.MediaContainer.$contentquery.media.part.file
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                        $CheckCharLimit = CheckCharLimit
                        if ($CheckCharLimit -eq $false) {
                            Write-Entry -Subtext "Skipping [$($item.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            continue
                        }
                    }

                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                if ($Seasondata) {
                    $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
                    $SeasonNames = $SeasonsTemp.Title -join ';'
                    $SeasonNumbers = $SeasonsTemp.index -join ','
                    $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
                    $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
                }
                $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
                $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
                $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
                if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
                if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
                if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

                # check if there are more then 1 entry in id´s
                if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
                if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
                if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

                if ($Metadata.MediaContainer.$contentquery.Label.tag) {
                    $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
                }
                Else {
                    $Labels = ""
                }
                $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $FileMetadata | ForEach-Object {
                        if ($_.streamType -eq '1') {
                            $Resolution = $_.displayTitle
                        }
                    }
                }
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.Name
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $($item.title)
                if ($FileMetadata) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $($item.originalTitle)
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $item.year
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
                $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $item.ratingKey
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
                $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
                $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
                $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    # Getting information of all Episodes
    if ($global:TitleCards -eq 'true') {
        Write-Entry -Message "Query episodes data from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Query Jellyfin/Emby
    Write-Entry -Message "Query Jellyfin/Emby..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $PreferredMetadataLanguage = (Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/System/Configuration?api_key=$OtherMediaServerApiKey").PreferredMetadataLanguage
    $allLibsquery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
    $OtherAllLibs = Invoke-RestMethod -Method Get -Uri $allLibsquery

    write-Entry -Subtext "Found '$($OtherAllLibs.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = ($OtherAllLibs | Where-Object { $_.Name -notin $LibstoExclude }).Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    # Debug Output all Libs
    Write-Entry -Subtext "Media Server Lib overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Foreach ($lib in $OtherAllLibs) {
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib name: $($lib.name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib Type: $($lib.CollectionType)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib locations: $($lib.Locations)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }

    $OtherAllMovies = @()
    $OtherAllShows = @()
    $OtherAllEpisodes = @()

    foreach ($otherlib in $OtherAllLibs) {
        if ($otherlib.Name -notin $LibstoExclude) {
            if ($otherlib.CollectionType -eq 'movies') {
                Write-Entry -Subtext "Getting all Itmes from [$($otherlib.Name)] with item id [$($otherlib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allMoviesquery = "$OtherMediaServerUrl/Items?ParentId=$($otherlib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,OriginalTitle,Settings,Path,Overview,ProductionYear,Tags&IncludeItemTypes=Movie"
                $Querytemp = Invoke-RestMethod -Method Get -Uri $allMoviesquery
                $OtherAllMovies += $Querytemp
            }
            if ($otherlib.CollectionType -eq 'tvshows') {
                Write-Entry -Subtext "Getting all Itmes from [$($otherlib.Name)] with item id [$($otherlib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allShowsquery = "$OtherMediaServerUrl/Items?ParentId=$($otherlib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags&IncludeItemTypes=Series"
                $allEpisodesquery = "$OtherMediaServerUrl/Items?ParentId=$($otherlib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,Settings,Tags&IncludeItemTypes=Episode"
                $Querytempshow = Invoke-RestMethod -Method Get -Uri $allShowsquery
                $QuerytempEpisodes = Invoke-RestMethod -Method Get -Uri $allEpisodesquery
                $OtherAllShows += $Querytempshow
                $OtherAllEpisodes += $QuerytempEpisodes
            }
        }
    }

    $OtherLibraries = @()
    foreach ($Movie in $OtherAllMovies.Items) {
        if ($SyncEmby) {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $librariestemp = $OtherAllLibs | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations, LibraryOptions -Unique

            foreach ($singlelibrary in $librariestemp) {
                foreach ($location in $singlelibrary.Locations) {
                    # Select correct NetworkPath
                    $LibraryOptions = $singlelibrary.LibraryOptions.PathInfos | Where-Object { $_.Path -eq $location }
                    if ($LibraryOptions.NetworkPath) {
                        $location = $LibraryOptions.NetworkPath
                    }
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$($location)/*" -or $Movie.Path -like "$($location)\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Libpath: $($lib.Path[1])" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $Matchedpath = AddTrailingSlash $($lib.Path[1])
            $libpath = $Matchedpath
            $relativePath = $Movie.Path.Substring($libpath.Length)
            $pathSegments = $relativePath -split '[\\/]'

            # Determine the extracted folder and the root folder path
            if ($pathSegments.Count -gt 2) {
                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
            }
            else {
                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                $extraFolder = $null  # No parent structure
            }
            if ($Movie.Tags) {
                $Labels = $($Movie.Tags -join ',')
            }
            Else {
                $Labels = ""
            }
            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $temp = New-Object psobject
            $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
            $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
            $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
            $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
            $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
            $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
            $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
            $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
            $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
            $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
            $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
            $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
            $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
            $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
            $OtherLibraries += $temp
            Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        }
        Else {
            Write-Entry -Subtext "Processing - '$($Movie.Name)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $librariestemp = $OtherAllLibs | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

            foreach ($singlelibrary in $librariestemp) {
                # Loop through each location in the library's Locations array
                foreach ($location in $singlelibrary.Locations) {
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$location/*" -or $Movie.Path -like "$location\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $Matchedpath = AddTrailingSlash $($lib.Path)
                $libpath = $Matchedpath
                $relativePath = $Movie.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }
                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
            if ($Movie.Tags) {
                $Labels = $($Movie.Tags -join ',')
            }
            Else {
                $Labels = ""
            }
            $temp = New-Object psobject
            $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
            $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
            $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
            $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
            $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
            $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
            $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
            $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
            $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
            $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
            $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
            $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
            $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
            $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
            $OtherLibraries += $temp
            Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        }
    }
    foreach ($Show in $OtherAllShows.Items) {
        $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Show.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
        $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, path


        $librariestemp = $OtherAllLibs | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations -Unique
        if ($UseEmby -eq 'true') {
            $librariestemp = $OtherAllLibs | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations, LibraryOptions -Unique
        }
        Else {
            $librariestemp = $OtherAllLibs | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations -Unique
        }
        foreach ($singlelibrary in $librariestemp) {
            # Loop through each location in the library's Locations array
            foreach ($location in $singlelibrary.Locations) {
                if ($UseEmby -eq 'true') {
                    # Select correct NetworkPath
                    $LibraryOptions = $singlelibrary.LibraryOptions.PathInfos | Where-Object { $_.Path -eq $location }
                    if ($LibraryOptions.NetworkPath) {
                        $location = $LibraryOptions.NetworkPath
                    }
                }
                Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                # Compare lib.Path with each location
                if ($Show.Path -like "$location/*" -or $Show.Path -like "$location\*") {
                    $SingleLibName = $singlelibrary.Name
                    Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    break # Exit loop after match
                }
            }
        }

        Write-Entry -Subtext "Location: $($Show.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        $Matchedpath = AddTrailingSlash $($lib.Path)
        $libpath = $Matchedpath
        $relativePath = $Show.Path.Substring($libpath.Length)
        $pathSegments = $relativePath -split '[\\/]'

        # Determine the extracted folder and the root folder path
        if ($pathSegments.Count -gt 2) {
            $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
            $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
        }
        else {
            $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
            $extraFolder = $null  # No parent structure
        }
        Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

        if ($Show.Tags) {
            $Labels = $($Show.Tags -join ',')
        }
        Else {
            $Labels = ""
        }

        $temp = New-Object psobject
        $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
        $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Show.Type
        $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
        $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Show.Id
        $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Show.Name
        $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Show.OriginalTitle
        $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Show.ProductionYear
        $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Show.ProviderIds.Imdb
        $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Show.ProviderIds.Tmdb
        $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Show.ProviderIds.Tvdb
        $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
        $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
        $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
        $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Show.ImageTags.Primary
        $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Show.BackdropImageTags -join ",")
        $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
        $OtherLibraries += $temp
        Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }
    Write-Entry -Subtext "Found '$($OtherLibraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $OtherEpisodedata = @()
    $TempShowLibs = $OtherLibraries | Where-Object { $_."Library Type" -eq 'Series' }
    foreach ($show in $TempShowLibs) {
        # Iterate through all shows
        $seasons = $OtherAllEpisodes.Items | Where-Object { $_.SeriesId -eq $show.id } | Group-Object -Property SeasonName | Sort-Object -Property Name
        foreach ($Season in $Seasons) {
            # Sort episodes within the season by IndexNumber
            $SeasonEpisodes = $Season.Group | Sort-Object -Property indexnumber

            # Collect episode IDs, Titles, and PrimaryImageTags
            $EpisodeIds = ($SeasonEpisodes.Id -join ',')
            $EpisodeTitles = ($SeasonEpisodes.Name -join ';')
            $Episodes = ($SeasonEpisodes.IndexNumber -join ',')
            $Thumbs = ($SeasonEpisodes.ImageTags.Primary -join ',')

            # Calculate the ShowID and SeasonId
            if ($null -ne $SeasonEpisodes.SeriesId) {
                if ($SeasonEpisodes.SeriesId -is [System.Array]) {
                    $ShowID = $SeasonEpisodes.SeriesId[0]
                }
                else {
                    $ShowID = $SeasonEpisodes.SeriesId
                }
            }
            else {
                $ShowID = $null
            }

            if ($null -ne $SeasonEpisodes.SeasonId) {
                if ($SeasonEpisodes.SeasonId -is [System.Array]) {
                    $SeasonId = $SeasonEpisodes.SeasonId[0]
                }
                else {
                    $SeasonId = $SeasonEpisodes.SeasonId
                }
            }
            else {
                $SeasonId = $null
            }


            # Create an object for the current season
            $seasonObject = [PSCustomObject]@{
                "Library Name"                 = $show."Library Name"
                "Show Name"                    = $show.title
                "Show Original Name"           = $show.OriginalTitle
                "Library Language"             = $PreferredMetadataLanguage
                "ShowID"                       = $ShowID
                "SeasonId"                     = $SeasonId
                "EpisodeIds"                   = $EpisodeIds
                "tvdbid"                       = $show.tvdbid
                "imdbid"                       = $show.imdbid
                "tmdbid"                       = $show.tmdbid
                "type"                         = "Episode"
                "Season Number"                = $SeasonEpisodes[0].ParentIndexNumber
                "SeasonName"                   = $Season.Name
                "Episodes"                     = $Episodes
                "Title"                        = $EpisodeTitles
                "OtherMediaServerTitleCardTag" = $Thumbs
                "OtherMediaServerSeasonTag"    = $SeasonEpisodes[0].SeriesPrimaryImageTag
            }

            # Add the season object to the array
            $OtherEpisodedata += $seasonObject
        }
    }
    if ($OtherAllEpisodes) {
        Write-Entry -Subtext "Found '$($OtherAllEpisodes.items.count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }

    $OtherAllShows = $OtherLibraries | Where-Object { $_.'Library Type' -eq 'Series' }
    $OtherAllMovies = $OtherLibraries | Where-Object { $_.'Library Type' -eq 'Movie' }

    # Create an empty array to hold the custom objects
    $FormattedData = @()

    # Iterate over each item in $OtherEpisodedata
    foreach ($data in $OtherEpisodedata) {
        # Create a custom object for each episode using the variables
        $FormattedData += [PSCustomObject]@{
            'Library Name'                 = $data.'Library Name'
            'Show Name'                    = $data.'Show Name'
            'Show Original Name'           = $data.'Show Original Name'
            'Library Language'             = $data.'Library Language'
            'ShowID'                       = $data.'ShowID'
            'SeasonId'                     = $data.'SeasonId'
            'EpisodeIds'                   = $data.'EpisodeIds'
            'tvdbid'                       = $data.'tvdbid'
            'imdbid'                       = $data.'imdbid'
            'tmdbid'                       = $data.'tmdbid'
            'type'                         = $data.'type'
            'Season Number'                = $data.'Season Number'
            'SeasonName'                   = $data.'SeasonName'
            'Episodes'                     = $data.'Episodes'
            'Title'                        = $data.'Title'
            'OtherMediaServerTitleCardTag' = $data.'OtherMediaServerTitleCardTag'
            'OtherMediaServerSeasonTag'    = $data.'OtherMediaServerSeasonTag'
        }
    }

    # Export the formatted data to CSV
    $FormattedData | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherEpisodedata.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $OtherLibraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherLibraries.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\Episodedata.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\Libraries.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force

    # START HERE
    Write-Entry -Message "Starting artwork sync now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting movie artwork sync part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    if ($null -ne $entry.PlexPosterUrl) {
                        if ($entry.PlexPosterUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexPosterUrl
                            }
                        }

                        # Attempt to match by ID (preferred)
                        $matchingMovie = $OtherAllMovies | Where-Object {
                            $_."Library Name" -eq $entry."Library Name" -and (
                                ($null -ne $entry.TmdbId -and $_.TmdbId -eq $entry.TmdbId) -or
                                ($null -ne $entry.TvdbId -and $_.TvdbId -eq $entry.TvdbId) -or
                                ($null -ne $entry.ImdbId -and $_.ImdbId -eq $entry.ImdbId)
                            )
                        }

                        # If no ID match, fall back to Title
                        if ($null -eq $matchingMovie) {
                            $warningMsg = "No ID match for '$($entry.title)'."
                            $warningMsg += " Source IDs (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId), ImdbId: $($entry.ImdbId)). Falling back to Title match..."
                            Write-Entry -Subtext $warningMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

                            $matchingMovie = $OtherAllMovies | Where-Object {
                                $_."Library Name" -eq $entry."Library Name" -and
                                $_.Title -eq $entry.Title
                            }
                            if ($matchingMovie) {
                                Write-Entry -Subtext "Fallback to Title match SUCCESSFUL for '$($entry.title)'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }

                        if ($matchingMovie) {
                            $MovieTitle = $entry.Title
                            $imageType = "Primary"
                            Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Movie Title: $MovieTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($matchingMovie.id.Count -gt 1) {
                                foreach ($id in $matchingMovie.id) {
                                    $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'poster'
                                    Write-Entry -Subtext "Movie ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }
                            Else {
                                $DestUrl = "$OtherMediaServerUrl/items/$($matchingMovie.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                if ($matchingMovie.id) {
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'poster'
                                    Write-Entry -Subtext "Movie ID: $($matchingMovie.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                                Else {
                                    Write-Entry -Message "Could not find Movie ID for '$MovieTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                        Else {
                            $errorMsg = "Could not match movie '$($entry.title)' in '$($entry.'Library Name')' by ID or Title."
                            $errorMsg += " Source (Plex) IDs were (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId), ImdbId: $($entry.ImdbId)). Please check destination library metadata."
                            Write-Entry -Subtext $errorMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    Else {
                        Write-Entry -Message "Could not find Poster URL for '$($entry.title)' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Message "Please fix the metadata on the source media server to resolve this issue." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    }

                }
                # Now we can start the Background Poster Part
                if ($global:BackgroundPosters -eq 'true') {
                    $global:posterurl = $null
                    $global:PosterWithText = $null
                    # check if Background url id exists.
                    if ($null -ne $entry.PlexBackgroundUrl) {
                        if ($entry.PlexBackgroundUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl
                            }
                        }

                        # Attempt to match by ID (preferred)
                        $matchingMovie = $OtherAllMovies | Where-Object {
                            $_."Library Name" -eq $entry."Library Name" -and (
                                ($null -ne $entry.TmdbId -and $_.TmdbId -eq $entry.TmdbId) -or
                                ($null -ne $entry.TvdbId -and $_.TvdbId -eq $entry.TvdbId) -or
                                ($null -ne $entry.ImdbId -and $_.ImdbId -eq $entry.ImdbId)
                            )
                        }

                        # If no ID match, fall back to Title
                        if ($null -eq $matchingMovie) {
                            $warningMsg = "No ID match for '$($entry.title) (Background)'."
                            $warningMsg += " Source IDs (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId), ImdbId: $($entry.ImdbId)). Falling back to Title match..."
                            Write-Entry -Subtext $warningMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

                            $matchingMovie = $OtherAllMovies | Where-Object {
                                $_."Library Name" -eq $entry."Library Name" -and
                                $_.Title -eq $entry.Title
                            }

                            if ($matchingMovie) {
                                Write-Entry -Subtext "Fallback to Title match SUCCESSFUL for '$($entry.title) (Background)'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }

                        if ($matchingMovie) {
                            $MovieTitle = $entry.Title + " | Background"
                            $imageType = "Backdrop"
                            Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Movie Title: $MovieTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($matchingMovie.id.Count -gt 1) {
                                foreach ($id in $matchingMovie.id) {
                                    $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'background'
                                    Write-Entry -Subtext "Movie ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }
                            Else {
                                $DestUrl = "$OtherMediaServerUrl/items/$($matchingMovie.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                if ($matchingMovie.id) {
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $MovieTitle -artworktype 'background'
                                    Write-Entry -Subtext "Movie ID: $($matchingMovie.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                                Else {
                                    Write-Entry -Message "Could not find Movie ID for '$MovieTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                        Else {
                            $errorMsg = "Could not match movie '$($entry.title) (Background)' in '$($entry.'Library Name')' by ID or Title."
                            $errorMsg += " Source (Plex) IDs were (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId), ImdbId: $($entry.ImdbId)). Please check destination library metadata."
                            Write-Entry -Subtext $errorMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    Else {
                        Write-Entry -Message "Could not find Background URL for '$($entry.title)' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Message "Please fix the metadata on the source media server to resolve this issue." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    }
                }
            }
        }
        catch {
            write-Entry -Subtext "For: $MovieTitle in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Could not sync movies to jelly/emby, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
    }

    Write-Entry -Message "Starting show artwork sync part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    foreach ($entry in $AllShows) {
        try {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    if ($null -ne $entry.PlexPosterUrl) {
                        if ($entry.PlexPosterUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexPosterUrl
                            }
                        }

                        # Attempt to match by ID (preferred)
                        $matchingShow = $OtherAllShows | Where-Object {
                            $_."Library Name" -eq $entry."Library Name" -and (
                                ($null -ne $entry.TmdbId -and $_.TmdbId -eq $entry.TmdbId) -or
                                ($null -ne $entry.TvdbId -and $_.TvdbId -eq $entry.TvdbId)
                            )
                        }

                        # If no ID match, fall back to Title
                        if ($null -eq $matchingShow) {
                            $warningMsg = "No ID match for show '$($entry.title)'."
                            $warningMsg += " Source IDs (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Falling back to Title match..."
                            Write-Entry -Subtext $warningMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

                            $matchingShow = $OtherAllShows | Where-Object {
                                $_."Library Name" -eq $entry."Library Name" -and
                                ($_.Title -eq $entry.Title -or $_.originalTitle -eq $entry.originalTitle)
                            }

                            if ($matchingShow) {
                                Write-Entry -Subtext "Fallback to Title match SUCCESSFUL for show '$($entry.title)'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }

                        if ($matchingShow) {
                            $ShowTitle = $entry.Title
                            $imageType = "Primary"
                            Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($matchingShow.id.Count -gt 1) {
                                foreach ($id in $matchingShow.id) {
                                    $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'poster'
                                    Write-Entry -Subtext "Show ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }
                            Else {
                                $DestUrl = "$OtherMediaServerUrl/items/$($matchingShow.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                if ($matchingShow.id) {
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'poster'
                                    Write-Entry -Subtext "Show ID: $($matchingShow.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                                Else {
                                    Write-Entry -Message "Could not find Show ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                        Else {
                            $errorMsg = "Could not match show '$($entry.title)' in '$($entry.'Library Name')' by ID or Title."
                            $errorMsg += " Source (Plex) IDs were (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Please check destination library metadata."
                            Write-Entry -Subtext $errorMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    Else {
                        Write-Entry -Message "Could not find Poster URL for '$($entry.title)' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Message "Please fix the metadata on the source media server to resolve this issue." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    }

                }
                # Now we can start the Background Poster Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($null -ne $entry.PlexBackgroundUrl) {
                        if ($entry.PlexBackgroundUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl
                            }
                        }

                        # Attempt to match by ID (preferred)
                        $matchingShow = $OtherAllShows | Where-Object {
                            $_."Library Name" -eq $entry."Library Name" -and (
                                ($null -ne $entry.TmdbId -and $_.TmdbId -eq $entry.TmdbId) -or
                                ($null -ne $entry.TvdbId -and $_.TvdbId -eq $entry.TvdbId)
                            )
                        }

                        # If no ID match, fall back to Title
                        if ($null -eq $matchingShow) {
                            $warningMsg = "No ID match for show '$($entry.title) (Background)'."
                            $warningMsg += " Source IDs (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Falling back to Title match..."
                            Write-Entry -Subtext $warningMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

                            $matchingShow = $OtherAllShows | Where-Object {
                                $_."Library Name" -eq $entry."Library Name" -and
                                ($_.Title -eq $entry.Title -or $_.originalTitle -eq $entry.originalTitle)
                            }

                            if ($matchingShow) {
                                Write-Entry -Subtext "Fallback to Title match SUCCESSFUL for show '$($entry.title) (Background)'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                        }

                        if ($matchingShow) {
                            $ShowTitle = $entry.Title + " | Background"
                            $imageType = "Backdrop"
                            Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if ($matchingShow.id.Count -gt 1) {
                                foreach ($id in $matchingShow.id) {
                                    $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'background'
                                    Write-Entry -Subtext "Show ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }
                            Else {
                                $DestUrl = "$OtherMediaServerUrl/items/$($matchingShow.id)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                if ($matchingShow.id) {
                                    SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'background'
                                    Write-Entry -Subtext "Show ID: $($matchingShow.id)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                                Else {
                                    Write-Entry -Message "Could not find Show ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                        Else {
                            $errorMsg = "Could not match show '$($entry.title) (Background)' in '$($entry.'Library Name')' by ID or Title."
                            $errorMsg += " Source (Plex) IDs were (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Please check destination library metadata."
                            Write-Entry -Subtext $errorMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        }
                    }
                    Else {
                        Write-Entry -Message "Could not find Background URL for '$($entry.title)' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                    }

                }
                # Now we can start the Season Poster Part
                if ($global:SeasonPosters -eq 'true') {
                    $global:seasonNumbers = $entry.seasonNumbers -split ','
                    $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                    for ($i = 0; $i -lt $global:seasonNumbers.Count; $i++) {
                        $global:SeasonNumber = $global:seasonNumbers[$i]
                        $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                        if ($null -ne $global:PlexSeasonUrl) {
                            if ($global:PlexSeasonUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $global:PlexSeasonUrl
                                }
                            }

                            # Attempt to match by ID (preferred)
                            $matchingSeason = $OtherEpisodedata | Where-Object {
                                $_."Library Name" -eq $entry."Library Name" -and
                                $_."Season Number" -eq $global:SeasonNumber -and (
                                    ($null -ne $entry.TmdbId -and $_.TmdbId -eq $entry.TmdbId) -or
                                    ($null -ne $entry.TvdbId -and $_.TvdbId -eq $entry.TvdbId)
                                )
                            }

                            # If no ID match, fall back to Title
                            if ($null -eq $matchingSeason) {
                                $warningMsg = "No ID match for '$($entry.Title) | Season $global:SeasonNumber'."
                                $warningMsg += " Source IDs (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Falling back to Title match..."
                                Write-Entry -Subtext $warningMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

                                $matchingSeason = $OtherEpisodedata | Where-Object {
                                    $_."Library Name" -eq $entry."Library Name" -and
                                    $_."Season Number" -eq $global:SeasonNumber -and
                                    ($_.'Show Name' -eq $entry.Title -or $_.'Show Name' -eq $entry.originalTitle -or $_."Show Original Name" -eq $entry.originalTitle -or $_."Show Original Name" -eq $entry.Title)
                                }

                                if ($matchingSeason) {
                                    Write-Entry -Subtext "Fallback to Title match SUCCESSFUL for '$($entry.Title) | Season $global:SeasonNumber'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                            }

                            if ($matchingSeason) {
                                $ShowTitle = $entry.Title + " | Season $global:SeasonNumber"
                                $imageType = "Primary"
                                Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                Write-Entry -Message "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                if ($matchingSeason.SeasonId.Count -gt 1) {
                                    foreach ($id in $matchingSeason.SeasonId) {
                                        $DestUrl = "$OtherMediaServerUrl/items/$id/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                        SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'season'
                                        Write-Entry -Subtext "Season ID: $id" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    }
                                }
                                Else {
                                    $DestUrl = "$OtherMediaServerUrl/items/$($matchingSeason.SeasonId)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                    if ($matchingSeason.SeasonId) {
                                        SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'season'
                                        Write-Entry -Subtext "Season ID: $($matchingSeason.SeasonId)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    }
                                    Else {
                                        Write-Entry -Message "Could not find Season ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                            }
                            Else {
                                $errorMsg = "Could not match season '$($entry.Title) | Season $global:SeasonNumber' in '$($entry.'Library Name')' by ID or Title."
                                $errorMsg += " Source (Plex) IDs were (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Please check destination library metadata."
                                Write-Entry -Subtext $errorMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                        }
                        Else {
                            Write-Entry -Message "Could not find Season URL for '$($entry.Title) - Season $global:SeasonNumber' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            Write-Entry -Message "Please fix the metadata on the source media server to resolve this issue." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }

                    }
                }
                # Now we can start the Title Card Part
                if ($global:TitleCards -eq 'true') {
                    foreach ($episode in $Episodedata) {
                        $global:show_name = $episode."Show Name"
                        $global:season_number = $episode."Season Number"
                        $global:episode_numbers = $episode."Episodes".Split(",")
                        $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")

                        # Match based on Show name, tmdbid, tvdbid, and Library Name
                        if ($episode.'Library Name' -eq $entry.'Library Name' -and (
                                ($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -or
                                ($episode.'Show Name' -eq $entry.title -or $episode.'Show Name' -eq $entry.originalTitle)
                            )) {

                            # Loop through episodes in $episode_numbers
                            for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                if ($null -ne $global:PlexTitleCardUrl) {
                                    if ($global:PlexTitleCardUrl -like "/library/*") {
                                        if ($PlexToken) {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                        }
                                        else {
                                            $Arturl = $plexurl + $global:PlexTitleCardUrl
                                        }
                                    }

                                    # Find matching episode in OtherEpisodedata
                                    $matchingEpisode = $OtherEpisodedata | Where-Object {
                                        $_."Library Name" -eq $entry."Library Name" -and
                                        $_."Season Number" -eq $global:season_number -and
                                        ($_.Episodes.Split(",") -contains $global:episodenumber) -and (
                                            ($null -ne $entry.TmdbId -and $_.TmdbId -eq $entry.TmdbId) -or
                                            ($null -ne $entry.TvdbId -and $_.TvdbId -eq $entry.TvdbId)
                                        )
                                    }

                                    # If no ID match, fall back to Title
                                    if ($null -eq $matchingEpisode) {
                                        $warningMsg = "No ID match for '$($entry.Title) S$($global:season_number)E$($global:episodenumber)'."
                                        $warningMsg += " Source IDs (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Falling back to Title match..."
                                        Write-Entry -Subtext $warningMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning

                                        $matchingEpisode = $OtherEpisodedata | Where-Object {
                                            ($_.'Show Name' -eq $entry.title -or $_.'Show Name' -eq $entry.originalTitle) -and
                                            $_."Library Name" -eq $entry."Library Name" -and
                                            $_."Season Number" -eq $global:season_number -and
                                            ($_.Episodes.Split(",") -contains $global:episodenumber)
                                        }

                                        if ($matchingEpisode) {
                                            Write-Entry -Subtext "Fallback to Title match SUCCESSFUL for '$($entry.Title) S$($global:season_number)E$($global:episodenumber)'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                    }

                                    if ($matchingEpisode) {
                                        # Select the matching episode ID based on the current index
                                        $global:episodeid = $matchingEpisode.EpisodeIds.Split(",")[$i]
                                        # Construct the show title with the current episode number
                                        $ShowTitle = "$($entry.Title) | Season $($global:season_number) - Episode $global:episodenumber"
                                        # Define the image type and destination URL
                                        $imageType = "Primary"
                                        $DestUrl = "$OtherMediaServerUrl/items/$($global:episodeid)/images/$imageType/?api_key=$OtherMediaServerApiKey"
                                        # Call the SyncPlexArtwork function to sync the artwork
                                        if ($matchingShow.id) {
                                            SyncPlexArtwork -ArtUrl $Arturl -DestUrl $DestUrl -imagetype $imageType -title $ShowTitle -artworktype 'tc'
                                        }
                                        Else {
                                            Write-Entry -Message "Could not find Episode ID for '$ShowTitle' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                        Write-Entry -Subtext "Show Title: $ShowTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "Type: $imageType" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "Episode ID: $global:episodeid" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    }
                                    Else {
                                        $errorMsg = "Could not match episode '$($entry.Title) S$($global:season_number)E$($global:episodenumber)' in '$($entry.'Library Name')' by ID or Title."
                                        $errorMsg += " Source (Plex) IDs were (TmdbId: $($entry.TmdbId), TvdbId: $($entry.TvdbId)). Please check destination library metadata."
                                        Write-Entry -Subtext $errorMsg -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                                Else {
                                    Write-Entry -Message "Could not find TitleCard URL for '$($entry.Title) - Season $global:season_number - Episode $global:episodenumber' in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    Write-Entry -Message "Please fix the metadata on the source media server to resolve this issue." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }

                            }
                        }
                    }
                }
            }
        }
        catch {
            write-Entry -Subtext "For: $ShowTitle in $($entry.'Library Name')" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Could not sync shows to jelly/emby, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images uploaded: $uploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-TextSizeCacheSummary
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    Send-SummaryNotification -ScriptMode $Mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -PosterCount $posterCount -BackgroundCount $BackgroundCount -SeasonCount $SeasonCount -EpisodeCount $EpisodeCount -UploadCount $UploadCount

    # Export json
    $jsonObject = [PSCustomObject]@{
        Posters              = if ($posterCount) { $posterCount } Else { 0 }
        Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
        Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
        Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
        Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
        Mode                 = $Mode
        Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
        Errors               = if ($errorCount) { $errorCount } Else { 0 }
        Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
        Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
        Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
        Text                 = if ($TextCount) { $TextCount } Else { 0 }
        "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
        "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
        "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
        "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
        "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
        "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
        "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
        "Script Version"     = $CurrentScriptVersion
        "IM Version"         = $global:CurrentImagemagickversion
        "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
        "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
    }

    $jsonOutput = $jsonObject | ConvertTo-Json
    $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8


    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
#region Emby/Jelly Mode
Elseif ($OtherMediaServerUrl -and $OtherMediaServerApiKey -and $UseOtherMediaServer -eq 'true') {
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $PosterUnknownCount = 0
    $SkipTBACount = 0
    $SkipJapTitleCount = 0

    if ($UISchedule -or $ContainerSchedule) {
        $Mode = "scheduled"
        Write-Entry -Message "Scheduled Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Else {
        $Mode = "normal"
        Write-Entry -Message "Normal Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }

    Write-Entry -Message "Query Jellyfin/Emby..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $PreferredMetadataLanguage = (Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/System/Configuration?api_key=$OtherMediaServerApiKey").PreferredMetadataLanguage
    $allLibsquery = "$OtherMediaServerUrl/Library/VirtualFolders?api_key=$OtherMediaServerApiKey"
    $AllLibs = Invoke-RestMethod -Method Get -Uri $allLibsquery

    write-Entry -Subtext "Found '$($AllLibs.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = ($AllLibs | Where-Object { $_.Name -notin $LibstoExclude }).Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info

    # Debug Output all Libs
    Write-Entry -Subtext "Media Server Lib overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    Foreach ($lib in $AllLibs) {
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib name: $($lib.name)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib Type: $($lib.CollectionType)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "  Lib locations: $($lib.Locations)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        Write-Entry -Subtext "--------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
    }
    $AllMovies = @()
    $AllShows = @()
    $AllEpisodes = @()
    foreach ($slib in $AllLibs) {
        if ($slib.Name -notin $LibstoExclude) {
            if ($slib.CollectionType -eq 'movies') {
                Write-Entry -Subtext "Getting all Itmes from [$($slib.Name)] with item id [$($slib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allMoviesquery = "$OtherMediaServerUrl/Items?ParentId=$($slib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,OriginalTitle,Settings,Path,Overview,ProductionYear,Tags,Width,Height&IncludeItemTypes=Movie"
                $Querytemp = Invoke-RestMethod -Method Get -Uri $allMoviesquery
                $AllMovies += $Querytemp
            }
            if ($slib.CollectionType -eq 'tvshows') {
                Write-Entry -Subtext "Getting all Itmes from [$($slib.Name)] with item id [$($slib.ItemId)]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $allShowsquery = "$OtherMediaServerUrl/Items?ParentId=$($slib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,ProductionYear,Tags,Width,Height&IncludeItemTypes=Series"
                $allEpisodesquery = "$OtherMediaServerUrl/Items?ParentId=$($slib.ItemId)&api_key=$OtherMediaServerApiKey&Recursive=true&Fields=ProviderIds,SeasonUserData,OriginalTitle,Path,Overview,Settings,Tags,Width,Height&IncludeItemTypes=Episode"
                $Querytempshow = Invoke-RestMethod -Method Get -Uri $allShowsquery
                $QuerytempEpisodes = Invoke-RestMethod -Method Get -Uri $allEpisodesquery
                $AllShows += $Querytempshow
                $AllEpisodes += $QuerytempEpisodes
            }
        }
    }

    $Libraries = @()
    foreach ($Movie in $AllMovies.Items) {
        $Resolution = $null
        if ($UseEmby -eq 'true') {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $librariestemp = $AllLibs  | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations, LibraryOptions -Unique

            foreach ($singlelibrary in $librariestemp) {
                foreach ($location in $singlelibrary.Locations) {
                    # Select correct NetworkPath
                    $LibraryOptions = $singlelibrary.LibraryOptions.PathInfos | Where-Object { $_.Path -eq $location }
                    if ($LibraryOptions.NetworkPath) {
                        $location = $LibraryOptions.NetworkPath
                    }

                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$($location)/*" -or $Movie.Path -like "$($location)\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path[1])" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $Matchedpath = AddTrailingSlash $($lib.Path[1])
                $libpath = $Matchedpath
                $relativePath = $Movie.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }

                if ($Movie.Tags) {
                    $Labels = $($Movie.Tags -join ',')
                }
                Else {
                    $Labels = ""
                }
                # Determine resolution category
                if ($movie.Width -and $movie.Height) {
                    $Resolution = Get-Resolution -Width $movie.Width
                }

                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
                if ($Resolution) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        Else {
            $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Movie.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
            $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, Path

            $librariestemp = $AllLibs  | Where-Object { $_.CollectionType -eq 'movies' } | Select-Object Name, Locations -Unique

            foreach ($singlelibrary in $librariestemp) {
                # Loop through each location in the library's Locations array
                foreach ($location in $singlelibrary.Locations) {
                    Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    # Compare lib.Path with each location
                    if ($Movie.Path -like "$location/*" -or $Movie.Path -like "$location\*") {
                        $SingleLibName = $singlelibrary.Name
                        Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        break # Exit loop after match
                    }
                }
            }
            if ($SingleLibName -notin $LibstoExclude) {
                Write-Entry -Subtext "Location: $($Movie.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                if ($lib.Path.count -gt '1') {
                    $Matchedpath = AddTrailingSlash $($lib.Path[0])
                }
                else {
                    $Matchedpath = AddTrailingSlash $($lib.Path)
                }
                $libpath = $Matchedpath
                $relativePath = $Movie.Path.Substring($libpath.Length)
                $pathSegments = $relativePath -split '[\\/]'

                # Determine the extracted folder and the root folder path
                if ($pathSegments.Count -gt 2) {
                    $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                    $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                }
                else {
                    $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                    $extraFolder = $null  # No parent structure
                }

                if ($Movie.Tags) {
                    $Labels = $($Movie.Tags -join ',')
                }
                Else {
                    $Labels = ""
                }
                # Determine resolution category
                if ($movie.Width -and $movie.Height) {
                    $Resolution = Get-Resolution -Width $movie.Width
                }
                Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Movie.Type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
                $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Movie.Id
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Movie.Name
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Movie.OriginalTitle
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Movie.ProductionYear
                if ($Resolution) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Movie.ProviderIds.Imdb
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Movie.ProviderIds.Tmdb
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Movie.ProviderIds.Tvdb
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Movie.ImageTags.Primary
                $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Movie.BackdropImageTags -join ",")
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    foreach ($Show in $AllShows.Items) {
        $Libtemp = Invoke-RestMethod -Method Get -Uri "$OtherMediaServerUrl/Items/$($Show.Id)/Ancestors?api_key=$OtherMediaServerApiKey"
        $lib = $Libtemp | Where-Object { $_.Type -eq 'Folder' } | Select-Object Name, path

        if ($UseEmby -eq 'true') {
            $librariestemp = $AllLibs | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations, LibraryOptions -Unique
        }
        Else {
            $librariestemp = $AllLibs  | Where-Object { $_.CollectionType -eq 'tvshows' } | Select-Object Name, Locations -Unique
        }
        foreach ($singlelibrary in $librariestemp) {
            # Loop through each location in the library's Locations array
            foreach ($location in $singlelibrary.Locations) {
                if ($UseEmby -eq 'true') {
                    # Select correct NetworkPath
                    $LibraryOptions = $singlelibrary.LibraryOptions.PathInfos | Where-Object { $_.Path -eq $location }
                    if ($LibraryOptions.NetworkPath) {
                        $location = $LibraryOptions.NetworkPath
                    }
                }
                Write-Entry -Subtext "  Found location - '$($location)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                # Compare lib.Path with each location
                if ($Show.Path -like "$location/*" -or $Show.Path -like "$location\*") {
                    $SingleLibName = $singlelibrary.Name
                    Write-Entry -Subtext "  Single lib name is: '$($SingleLibName)'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    break # Exit loop after match
                }
            }
        }
        if ($SingleLibName -notin $LibstoExclude) {
            Write-Entry -Subtext "Location: $($Show.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "Libpath: $($lib.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            $Matchedpath = AddTrailingSlash $($lib.Path)
            $libpath = $Matchedpath
            $relativePath = $Show.Path.Substring($libpath.Length)
            $pathSegments = $relativePath -split '[\\/]'

            # Determine the extracted folder and the root folder path
            if ($pathSegments.Count -gt 2) {
                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
            }
            else {
                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                $extraFolder = $null  # No parent structure
            }

            if ($Show.Tags) {
                $Labels = $($Show.Tags -join ',')
            }
            Else {
                $Labels = ""
            }

            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

            $temp = New-Object psobject
            $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $SingleLibName
            $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Show.Type
            $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $PreferredMetadataLanguage
            $temp | Add-Member -MemberType NoteProperty -Name "Id" -Value $Show.Id
            $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $Show.Name
            $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $Show.OriginalTitle
            $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $Show.ProductionYear
            $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $Show.ProviderIds.Imdb
            $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $Show.ProviderIds.Tmdb
            $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $Show.ProviderIds.Tvdb
            $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $libpath
            $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
            $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerPosterUrl" -Value $Show.ImageTags.Primary
            $temp | Add-Member -MemberType NoteProperty -Name "OtherMediaServerBackgroundUrl" -Value $($Show.BackdropImageTags -join ",")
            $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
            $Libraries += $temp
            Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherMediaServerLibExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    Write-Entry -Message "Export everything to a csv: $global:ScriptRoot\Logs\OtherMediaServerLibExport.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    Write-Entry -Message "Starting episode data query now - This can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -Log Info

    $Episodedata = @()
    $TempShowLibs = $Libraries | Where-Object { $_."Library Type" -eq 'Series' }
    foreach ($show in $TempShowLibs) {
        # Iterate through all shows
        $seasons = $AllEpisodes.Items | Where-Object { $_.SeriesId -eq $show.id } | Group-Object -Property SeasonName | Sort-Object -Property Name
        foreach ($Season in $Seasons) {
            # Sort episodes within the season by IndexNumber
            $SeasonEpisodes = $Season.Group | Sort-Object -Property indexnumber

            # Collect episode IDs, Titles, and PrimaryImageTags
            $EpisodeIds = ($SeasonEpisodes.Id -join ',')
            $EpisodeWidths = ($SeasonEpisodes.Width -join ',')
            $EpisodeHeights = ($SeasonEpisodes.Height -join ',')
            $EpisodeTitles = ($SeasonEpisodes.Name -join ';')
            $Episodes = ($SeasonEpisodes.IndexNumber -join ',')
            $Thumbs = ($SeasonEpisodes.ImageTags.Primary -join ',')

            # Calculate the ShowID and SeasonId
            if ($null -ne $SeasonEpisodes.SeriesId) {
                if ($SeasonEpisodes.SeriesId -is [System.Array]) {
                    $ShowID = $SeasonEpisodes.SeriesId[0]
                }
                else {
                    $ShowID = $SeasonEpisodes.SeriesId
                }
            }
            else {
                $ShowID = $null
            }

            if ($null -ne $SeasonEpisodes.SeasonId) {
                if ($SeasonEpisodes.SeasonId -is [System.Array]) {
                    $SeasonId = $SeasonEpisodes.SeasonId[0]
                }
                else {
                    $SeasonId = $SeasonEpisodes.SeasonId
                }
            }
            else {
                $SeasonId = $null
            }


            # Create an object for the current season
            $seasonObject = [PSCustomObject]@{
                "Library Name"                 = $show."Library Name"
                "Show Name"                    = $show.title
                "Show Original Name"           = $show.OriginalTitle
                "Library Language"             = $PreferredMetadataLanguage
                "ShowID"                       = $ShowID
                "SeasonId"                     = $SeasonId
                "EpisodeIds"                   = $EpisodeIds
                "EpisodeWidths"                = $EpisodeWidths
                "EpisodeHeights"               = $EpisodeHeights
                "tvdbid"                       = $show.tvdbid
                "imdbid"                       = $show.imdbid
                "tmdbid"                       = $show.tmdbid
                "type"                         = "Episode"
                "Season Number"                = $SeasonEpisodes[0].ParentIndexNumber
                "SeasonName"                   = $Season.Name
                "Episodes"                     = $Episodes
                "Title"                        = $EpisodeTitles
                "OtherMediaServerTitleCardTag" = $Thumbs
                "OtherMediaServerSeasonTag"    = $SeasonEpisodes[0].SeriesPrimaryImageTag
            }

            # Add the season object to the array
            $Episodedata += $seasonObject
        }
    }
    # Create an empty array to hold the custom objects
    $FormattedData = @()

    # Iterate over each item in $OtherEpisodedata
    foreach ($data in $Episodedata) {
        $EpisodeWidths = $data.EpisodeWidths -split ","
        $EpisodeHeights = $data.EpisodeHeights -split ","
        # Initialize an empty array for resolutions
        $Resolution = @()

        # Loop through each episode and determine resolution
        for ($i = 0; $i -lt $EpisodeWidths.Count; $i++) {
            $Width = [int]$EpisodeWidths[$i]
            $Resolution += Get-Resolution -Width $Width
        }
        # Create a custom object for each episode using the variables
        $FormattedData += [PSCustomObject]@{
            'Library Name'                 = $data.'Library Name'
            'Show Name'                    = $data.'Show Name'
            'Show Original Name'           = $data.'Show Original Name'
            'Library Language'             = $data.'Library Language'
            'ShowID'                       = $data.'ShowID'
            'SeasonId'                     = $data.'SeasonId'
            'EpisodeIds'                   = $data.'EpisodeIds'
            'Resolutions'                  = $Resolution -join ","
            'tvdbid'                       = $data.'tvdbid'
            'imdbid'                       = $data.'imdbid'
            'tmdbid'                       = $data.'tmdbid'
            'type'                         = $data.'type'
            'Season Number'                = $data.'Season Number'
            'SeasonName'                   = $data.'SeasonName'
            'Episodes'                     = $data.'Episodes'
            'Title'                        = $data.'Title'
            'OtherMediaServerTitleCardTag' = $data.'OtherMediaServerTitleCardTag'
            'OtherMediaServerSeasonTag'    = $data.'OtherMediaServerSeasonTag'
        }
    }

    # Export the formatted data to CSV
    $FormattedData | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\OtherMediaServerEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    $Episodedata = $FormattedData
    if ($AllEpisodes) {
        Write-Entry -Subtext "Found '$($AllEpisodes.Items.count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }

    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'Series' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'Movie' }

    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
        $totalSize = 0
        $excludePath = Join-Path -Path $AssetPath -ChildPath 'Collections'

        if ($FollowSymlink) {
            Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $AssetPath -Recurse | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }

        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }

    Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    $checkedItems = @()
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    $global:posterurl = $null
                    $global:ImageMagickError = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $global:IsFallback = $null
                    $global:langCode = $null
                    $global:direction = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern -and $entry.originalTitle) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }
                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:TextlessPoster = $null
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    Default { $global:posterurl = GetFanartMoviePoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                }
                                if ($global:PosterPreferTextless -eq 'True') {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if ($global:PosterOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Elseif ($global:FavProvider -eq 'FANART') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMoviePoster
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB' -and !$global:PosterOnlyTextless -and !$global:PosterPreferTextless) {
                                        $global:posterurl = GetTVDBMoviePoster
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl -and $global:imdbid -and !$global:PosterOnlyTextless) {
                                        Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:posterurl = GetIMDBPoster
                                        $global:IsFallback = $true
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    try {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if ($UsePosterResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                '4K'            { $Posteroverlay = $4kposter }
                                                '1080p'         { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                # Move file back to original naming with Brackets.
                                if (!$global:ImageMagickError -eq 'True') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImage
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $movietemp = New-Object psobject
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }

                                        # Export the array to a CSV file
                                        $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $movietemp = New-Object psobject
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImageoriginal
                            }
                            Else {
                                if ($show_skipped -eq 'True' ) {
                                    Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Background Poster Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:ImageMagickError = $null
                            $global:TextlessPoster = $null
                            $global:TMDBfallbackposterurl = $null
                            $global:fanartfallbackposterurl = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    Default { $global:posterurl = GetFanartMovieBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq 'True') {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMovieBackground
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBMovieBackground
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl) {
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($BackgroundfontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    try {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $backgroundImage -ErrorAction Stop
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if ($UseBackgroundResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                '4K'            { $backgroundoverlay = $4kBackground }
                                                '1080p'         { $backgroundoverlay = $1080pBackground }
                                                Default { $backgroundoverlay = $backgroundoverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'True') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImage
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                            $BackgroundCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $moviebackgroundtemp = New-Object psobject
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $moviebackgroundtemp = New-Object psobject
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImageoriginal
                            }
                            Else {
                                if ($show_skipped -eq 'True' ) {
                                    Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            if ($global:PosterOnlyTextless) {
                $moviebackgroundtemp = New-Object psobject
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                switch -Wildcard ($global:FavProvider) {
                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                    Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                }
                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                }
                # Export the array to a CSV file
                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            }

        }
    }

    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Define Global Variables
                $SkippingText = 'false'
                $global:tmdbsearched = $null
                $global:tmdbid = $entry.tmdbid
                $global:tvdbid = $entry.tvdbid
                $global:imdbid = $entry.imdbid
                $Seasonpostersearchtext = $null
                $global:ImageMagickError = $null
                $Episodepostersearchtext = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $FanartSearched = $null
                $global:posterurl = $null
                $global:PosterWithText = $null
                $global:AssetTextLang = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:Fallback = $null
                $global:TextlessPoster = $null
                $global:tvdbalreadysearched = $null
                $TakeLocal = $null
                $LocalAssetMissing = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    if ($entry.extraFolder) {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                    }
                    Else {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                    }
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $ManualTestPath = $ManualEntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    if ($entry.extraFolder) {
                        $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                    }
                    Else {
                        $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                    }
                    $TestPath = $AssetPath
                    $ManualTestPath = $ManualPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $checkedItems += $hashtestpath
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }

                        if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                            Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                            $LocalAssetMissing = 'true'
                        }
                        Else {
                            Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                Default { $global:posterurl = GetFanartShowPoster }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                            }
                            if ($global:PosterPreferTextless -eq 'True') {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TVDBfallbackposterurl) {
                                    $global:posterurl = $global:TVDBfallbackposterurl
                                    Write-Entry -Subtext "Took TVDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                # try to find textless on TVDB
                                if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    $global:tvdbalreadysearched = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                    $global:posterurl = GetFanartMoviePoster
                                    $global:IsFallback = $true
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                $global:PosterWithText = $true
                            }

                            if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                $global:posterurl = GetTVDBShowPoster
                                $global:IsFallback = $true
                            }
                            if (!$global:posterurl) {
                                $global:IsFallback = $true
                                if (!$global:posterurl) {
                                    Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                        }
                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if (!$TakeLocal) {
                            if (!$global:TextlessPoster -eq 'True' -and $global:TMDBfallbackposterurl) {
                                $global:posterurl = $global:TMDBfallbackposterurl
                            }
                            if (!$global:TextlessPoster -eq 'True' -and $global:fanartfallbackposterurl) {
                                $global:posterurl = $global:fanartfallbackposterurl
                            }
                        }
                        if ($global:posterurl -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TMDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'FANART') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                try {
                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                }
                                catch {
                                    if ($_.Exception.Response) {
                                        $statusCode = $_.Exception.Response.StatusCode.value__
                                    }
                                    else {
                                        $statusCode = $_.Exception.Message
                                    }
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'True') {
                                    if ($UsePosterResolutionOverlays -eq 'true') {
                                        switch ($entry.Resolution) {
                                            '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                            '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                            '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                            '4K'            { $Posteroverlay = $4kposter }
                                            '1080p'         { $Posteroverlay = $1080pPoster }
                                            Default { $Posteroverlay = $Posteroverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                        $SkippingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $fontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                # Default: Replace the symbol with a newline
                                                $replacementString = "`n"

                                                # Check if the symbol should be kept
                                                $keepThisSymbol = $false
                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                        if ($symbol -like "*$k*") {
                                                            $keepThisSymbol = $true
                                                            break # Match found, no need to keep checking
                                                        }
                                                    }
                                                }

                                                # If it's a "keep" symbol, change the replacement string
                                                if ($keepThisSymbol) {
                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                    $replacementString = $symbol + "`n"
                                                }
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            # Add Stroke
                                            if ($AddTextStroke -eq 'true') {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }

                                            Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'True') {
                                if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                    # Move file back to original naming with Brackets.
                                    if (!$global:IsTruncated) {
                                        UploadOtherMediaServerArtwork -itemId $entry.Id -imageType "Primary" -imagePath $PosterImage
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    $showtemp = New-Object psobject
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    # Export the array to a CSV file
                                    $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                            }
                        }
                        Elseif ($LocalAssetMissing -eq 'true') {
                            Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            $showtemp = New-Object psobject
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                            $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                            $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                            }
                            if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                            }
                            # Export the array to a CSV file
                            $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $PosterImageoriginal
                        }
                        Else {
                            if ($show_skipped -eq 'True' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Background Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                        }
                        Else {
                            $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkippingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:TextlessPoster = $null
                        $global:ImageMagickError = $null
                        $global:TMDBfallbackposterurl = $null
                        $global:fanartfallbackposterurl = $null
                        $TakeLocal = $null
                        $LocalAssetMissing = $null
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }

                        if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                            Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                            $LocalAssetMissing = 'true'
                        }
                        Else {
                            Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                Default { $global:posterurl = GetFanartShowBackground }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                            }
                            if ($global:BackgroundPreferTextless -eq 'True') {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                            }
                            if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                if ($global:FavProvider -eq 'TVDB') {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                                Else {
                                    $global:posterurl = GetFanartShowBackground
                                }
                            }
                            if (!$global:posterurl) {
                                if ($global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowBackground
                                    $global:IsFallback = $true
                                }
                                $global:FallbackText = 'True-Background'
                                if (!$global:posterurl) {
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                            }
                        }
                        if ($BackgroundfontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $backgroundImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TMDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'FANRT') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                try {
                                    $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $backgroundImage -ErrorAction Stop
                                }
                                catch {
                                    if ($_.Exception.Response) {
                                        $statusCode = $_.Exception.Response.StatusCode.value__
                                    }
                                    else {
                                        $statusCode = $_.Exception.Message
                                    }
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'True') {
                                    if ($UseBackgroundResolutionOverlays -eq 'true') {
                                        switch ($entry.Resolution) {
                                            '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                            '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                            '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                            '4K'            { $backgroundoverlay = $4kBackground }
                                            '1080p'         { $backgroundoverlay = $1080pBackground }
                                            Default { $backgroundoverlay = $backgroundoverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                        $SkippingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $backgroundfontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                # Default: Replace the symbol with a newline
                                                $replacementString = "`n"

                                                # Check if the symbol should be kept
                                                $keepThisSymbol = $false
                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                        if ($symbol -like "*$k*") {
                                                            $keepThisSymbol = $true
                                                            break # Match found, no need to keep checking
                                                        }
                                                    }
                                                }

                                                # If it's a "keep" symbol, change the replacement string
                                                if ($keepThisSymbol) {
                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                    $replacementString = $symbol + "`n"
                                                }
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            # Add Stroke
                                            if ($AddBackgroundTextStroke -eq 'true') {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'True') {
                                # Move file back to original naming with Brackets.
                                if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                    if (!$global:IsTruncated) {
                                        UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImage
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        $BackgroundCount++
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    $showbackgroundtemp = New-Object psobject
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    # Export the array to a CSV file
                                    $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                            }
                        }
                        Elseif ($LocalAssetMissing -eq 'true') {
                            Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            $showbackgroundtemp = New-Object psobject
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                            }
                            if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                            }
                            # Export the array to a CSV file
                            $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Backdrop" -imagePath $backgroundImageoriginal
                        }
                        Else {
                            if ($show_skipped -eq 'True' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Season Part
                if ($global:SeasonPosters -eq 'true') {
                    # Loop through each Season
                    foreach ($season in $Episodedata) {
                        $SkippingText = 'false'
                        $global:tmdbsearched = $null
                        $global:seasontmp = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TextlessPoster = $null
                        $global:seasonNames = $null
                        $global:posterurl = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TMDBSeasonFallback = $null
                        $global:TVDBSeasonFallback = $null
                        $global:FANARTSeasonFallback = $null
                        $global:seasonId = $null
                        $global:SeasonNumber = $null
                        $TakeLocal = $null
                        $LocalAssetMissing = $null

                        if ($season.tmdbid -eq $entry.tmdbid -or $season.tvdbid -eq $entry.tvdbid) {
                            $global:seasonId = $season.SeasonId
                            $global:seasonNames = $season.SeasonName
                            $global:SeasonNumber = $season."Season Number"
                            Write-Entry -Message "Processing season: Id=$($global:seasonId), Name=$($global:seasonNames), Number=$($global:SeasonNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                            if ($SeasonfontAllCaps -eq 'true') {
                                $global:seasonTitle = $global:seasonNames.ToUpper()
                                Write-Entry -Message "Season font all caps enabled. SeasonTitle set to: $($global:seasonTitle)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                if (!$global:seasonTitle) {
                                    $global:seasonTitle = ("Season " + $global:SeasonNumber).ToUpper()
                                    Write-Entry -Message "SeasonTitle was empty, fallback to: $($global:seasonTitle)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Debug
                                }
                            }
                            Else {
                                $global:seasonTitle = $global:seasonNames
                                Write-Entry -Message "Season font all caps disabled. SeasonTitle set to: $($global:seasonTitle)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                if (!$global:seasonTitle) {
                                    $global:seasonTitle = "Season " + $global:SeasonNumber
                                    Write-Entry -Message "SeasonTitle was empty, fallback to: $($global:seasonTitle)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Debug
                                }
                            }
                            if ($null -ne $global:SeasonNumber) {
                                $global:seasontmp = "Season" + $global:SeasonNumber.ToString().PadLeft(2, '0')
                                Write-Entry -Message "seasontmp set to: $($global:seasontmp)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            if ($LibraryFolders -eq 'true') {
                                $SeasonImageoriginal = "$EntryDir\$global:seasontmp.jpg"
                                $TestPath = $EntryDir
                                $ManualTestPath = $ManualEntryDir
                                $Testfile = "$global:seasontmp"
                                Write-Entry -Message "LibraryFolders enabled. SeasonImageoriginal: $SeasonImageoriginal, TestPath: $TestPath, ManualTestPath: $ManualTestPath, Testfile: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            Else {
                                if ($entry.extraFolder) {
                                    $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                }
                                Else {
                                    $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:seasontmp.jpg"
                                }
                                $TestPath = $AssetPath
                                $ManualTestPath = $ManualPath
                                $Testfile = "$($entry.RootFoldername)_$global:seasontmp"
                                Write-Entry -Message "LibraryFolders disabled. SeasonImageoriginal: $SeasonImageoriginal, TestPath: $TestPath, ManualTestPath: $ManualTestPath, Testfile: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }

                            if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                $SeasonImageoriginal = ($SeasonImageoriginal).Replace('\', '/').Replace('./', '/')
                                $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                Write-Entry -Message "Platform is Docker/Linux. hashtestpath: $hashtestpath, SeasonImageoriginal: $SeasonImageoriginal, manualtestpath: $manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            }
                            else {
                                $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                if ($fullTestPath) {
                                    $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                    Write-Entry -Message "Windows path resolved. fullTestPath: $($fullTestPath.ProviderPath), fullManualTestPath: $($fullManualTestPath.ProviderPath)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                }
                                Else {
                                    $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                    $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                    Write-Entry -Message "Windows path fallback. TestPath: $TestPath, ManualTestPath: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Debug
                                }
                            }

                            Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                            $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:seasontmp.jpg"
                            $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                            Write-Entry -Message "SeasonImage temp path: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $checkedItems += $hashtestpath
                            Write-Entry -Message "Added $hashtestpath to checkedItems" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                foreach ($ext in $allowedExtensions) {
                                    $filePath = "$ManualTestPath$ext"
                                    if (Test-Path -LiteralPath $filePath) {
                                        Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        $posterext = $ext
                                        break
                                    }
                                }

                                if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                    Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $TakeLocal = $true
                                }
                                Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                    $LocalAssetMissing = 'true'
                                }
                                Else {
                                    if (!$Seasonpostersearchtext) {
                                        Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $Seasonpostersearchtext = $true
                                    }
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                        'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                        Default { $global:posterurl = GetFanartSeasonPoster }
                                    }
                                    # do a specific order
                                    if ($global:SeasonPreferTextless -eq 'True') {
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                $global:posterurl = GetTMDBSeasonPoster
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                            if (!$global:posterurl -or !$global:TextlessPoster) {
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:posterurl = GetFanartSeasonPoster
                                                    Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                    $global:posterurl = GetTVDBSeasonPoster
                                                    Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                        if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                            # Lets just try to grab a show poster.
                                            Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                                Default { $global:posterurl = GetFanartShowPoster }
                                            }
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                            Else {
                                                if ($global:FavProvider -ne 'TMDB') {
                                                    $global:posterurl = GetTMDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                    $global:posterurl = GetTVDBShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                                if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                    $global:posterurl = GetFanartShowPoster
                                                    if ($global:posterurl) {
                                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:IsFallback = $true
                                                        $global:FallbackText = 'True-Show'
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                                $global:posterurl = GetTMDBSeasonPoster
                                                $global:IsFallback = $true
                                                Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                            if (!$global:posterurl) {
                                                if ($global:FavProvider -ne 'FANART') {
                                                    $global:posterurl = GetFanartSeasonPoster
                                                    Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $global:IsFallback = $true
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                            if (!$global:posterurl -and $entry.tvdbid) {
                                                if ($global:FavProvider -ne 'TVDB') {
                                                    $global:IsFallback = $true
                                                    $global:posterurl = GetTVDBSeasonPoster
                                                    Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                }
                                            }
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                    if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                    if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                        $global:posterurl = $global:TMDBSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                        $global:posterurl = $global:FANARTSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                        $global:posterurl = $global:TVDBSeasonFallback
                                        Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }

                                }
                                if ($global:posterurl -or $TakeLocal) {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage | Out-Null
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            $global:IsFallback = $true
                                        }
                                        try {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                    }
                                    if ($global:ImageProcessing -eq 'true') {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                            if (!$global:ImageMagickError -eq 'True') {
                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                elseif ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                elseif ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                                else {
                                                    $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }

                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                    $SkippingText = 'true'
                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                }
                                                if ($AddSeasonText -eq 'true' -and $SkippingText -eq 'false') {
                                                    $global:seasonTitle = $global:seasonTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                    if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                        $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                    }
                                                    Else {
                                                        $global:ShowTitleOnSeason = $titletext -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                    }
                                                    # Loop through each symbol and replace it with a newline
                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                        foreach ($symbol in $NewLineSymbols) {
                                                            # Default: Replace the symbol with a newline
                                                            $replacementString = "`n"

                                                            # Check if the symbol should be kept
                                                            $keepThisSymbol = $false
                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                    if ($symbol -like "*$k*") {
                                                                        $keepThisSymbol = $true
                                                                        break # Match found, no need to keep checking
                                                                    }
                                                                }
                                                            }

                                                            # If it's a "keep" symbol, change the replacement string
                                                            if ($keepThisSymbol) {
                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                $replacementString = $symbol + "`n"
                                                            }
                                                            $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), $replacementString
                                                            if ($AddShowTitletoSeason -eq 'true') {
                                                                $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), $replacementString
                                                            }
                                                        }
                                                    }
                                                    $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                    $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                    if ($AddShowTitletoSeason -eq 'true') {
                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                        $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                        if (!$global:IsTruncated) {
                                                            Write-Entry -Subtext ("Optimal Season font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            Write-Entry -Subtext ("Optimal Show font size set to: '{0}' [{1}]" -f $showoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            # Season Part
                                                            # Add Stroke
                                                            if ($AddSeasonTextStroke -eq 'true') {
                                                                $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $SeasonArguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                            # Show Part
                                                            # Add Stroke
                                                            if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                                $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                        }
                                                    }
                                                    Else {
                                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                        if (!$global:IsTruncated) {
                                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            # Add Stroke
                                                            if ($AddSeasonTextStroke -eq 'true') {
                                                                $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }
                                                            Else {
                                                                $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                            }

                                                            Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    Else {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            # Resize Image to 2000x3000
                                            $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                            Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Resizeargument"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                        }
                                    }
                                    if (!$global:ImageMagickError -eq 'True') {
                                        if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                            # Move file back to original naming with Brackets.
                                            if (!$global:IsTruncated) {
                                                UploadOtherMediaServerArtwork -itemId $global:seasonId -imageType "Primary" -imagePath $SeasonImage
                                                try {
                                                    # Attempt to move the item
                                                    Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                    # Log success if move was successful
                                                    Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                }
                                                catch {
                                                    # Log the error if the move operation fails
                                                    Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                }
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $SeasonCount++
                                                $posterCount++
                                            }
                                            Else {
                                                Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            $seasontemp = New-Object psobject
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'True' } else { 'False' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$SeasonImage} Else {$global:posterurl})
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                            $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                            switch -Wildcard ($global:FavProvider) {
                                                'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                            }
                                            # Export the array to a CSV file
                                            $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                        }
                                    }
                                }
                                Elseif ($LocalAssetMissing -eq 'true') {
                                    Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                Else {
                                    Write-Entry -Subtext "Missing poster URL for: $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                    Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $seasontemp = New-Object psobject
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                    }
                                    # Export the array to a CSV file
                                    $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                                }
                            }
                            else {
                                if ($global:UploadExistingAssets -eq 'true') {
                                    Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    UploadOtherMediaServerArtwork -itemId $entry.id -imageType "Primary" -imagePath $SeasonImageoriginal
                                }
                                Else {
                                    if ($show_skipped -eq 'True' ) {
                                        Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    }
                                }
                            }
                        }
                    }
                }
                # Now we can start the Episode Part
                if ($global:TitleCards -eq 'true') {
                    # Loop through each episode
                    foreach ($episode in $Episodedata) {
                        $SkippingText = 'false'
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:TempImagecopied = $false
                        $EpisodeTempImage = $null
                        $global:ImageMagickError = $null
                        $global:season_number = $null
                        $Episodepostersearchtext = $null
                        $global:show_name = $null
                        $global:episodenumber = $null
                        $global:episode_numbers = $null
                        $global:titles = $null
                        $global:posterurl = $null
                        $global:FileNaming = $null
                        $EpisodeImageoriginal = $null
                        $EpisodeImage = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TextlessPoster = $null
                        $global:EPResolutions = $null

                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title) {
                            $global:show_name = $episode."Show Name"
                            $global:season_number = $episode."Season Number"
                            $global:EPResolutions = $episode."Resolutions".Split(",")
                            $global:episode_numbers = $episode."Episodes".Split(",")
                            $global:episodeids = $episode."EpisodeIDs".Split(",")
                            $global:titles = $episode."Title".Split(";")
                            if ($UseBackgroundAsTitleCard -eq 'True') {
                                $global:ImageMagickError = $null
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkippingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $LocalAssetMissing = $null
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:EPResolution = $($global:EPResolutions[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:episodeid = $($global:episodeids[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.ToString().PadLeft(2, '0') + "E" + $global:episodenumber.ToString().PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                    $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'True' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'True' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }

                                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                Write-Entry -Message "Found Manual Title Card for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                $LocalAssetMissing = 'true'
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:TempImagecopied -ne 'True') {
                                                    if ($global:FavProvider -eq 'TMDB') {
                                                        if ($episode.tmdbid) {
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($global:tmdbfallbackposterurl) {
                                                                    $global:posterurl = $global:tmdbfallbackposterurl
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($episode.tvdbid) {
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $TakeLocal -or $global:TempImagecopied -eq 'True') {
                                                if ($TakeLocal) {
                                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                        Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                    }
                                                    if ($global:TempImagecopied -ne 'true') {
                                                        Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                    }
                                                    Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                                Else {
                                                    if ($global:TempImagecopied -ne 'True') {
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        Write-Entry -Subtext "Taking temp image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                    }
                                                    if ($global:TempImagecopied -ne 'True') {
                                                        try {
                                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                    }
                                                }
                                                if ($global:ImageProcessing -eq 'true') {
                                                    $global:TempImagecopied = $true
                                                    # Check temp image
                                                    if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                        Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'True') {
                                                                if ($UseTCResolutionOverlays -eq 'true') {
                                                                    switch ($global:EPResolution) {
                                                                        '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                        '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                        '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                        '4K'            { $TitleCardoverlay = $4kTC }
                                                                        '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                        Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                    }
                                                                }
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                else {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                    $SkippingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            # Default: Replace the symbol with a newline
                                                                            $replacementString = "`n"

                                                                            # Check if the symbol should be kept
                                                                            $keepThisSymbol = $false
                                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                    if ($symbol -like "*$k*") {
                                                                                        $keepThisSymbol = $true
                                                                                        break # Match found, no need to keep checking
                                                                                    }
                                                                                }
                                                                            }

                                                                            # If it's a "keep" symbol, change the replacement string
                                                                            if ($keepThisSymbol) {
                                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                $replacementString = $symbol + "`n"
                                                                            }
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'True') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImage
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'True' } Else { 'False' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }
                                                }
                                            }
                                            Elseif ($LocalAssetMissing -eq 'true') {
                                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:BackgroundOnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                    }
                                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                    }
                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }

                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImageoriginal
                                            }
                                            Else {
                                                if ($show_skipped -eq 'True' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                                if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                    Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkippingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:FallbackText = $null
                                    $global:ImageMagickError = $null
                                    $global:TextlessPoster = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $LocalAssetMissing = $null
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:episodeid = $($global:episodeids[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.ToString().PadLeft(2, '0') + "E" + $global:episodenumber.ToString().PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'True' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'True' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath
                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }

                                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                $LocalAssetMissing = 'true'
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl -or $global:Fallback -eq "TVDB") {
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if ($global:posterurl){
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl -or $global:Fallback -eq "TMDB") {
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if ($global:posterurl){
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'True') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $TakeLocal) {
                                                if ($TakeLocal) {
                                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                        Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                    }
                                                    Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                                Else {
                                                    Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                        Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                                        if ($global:FavProvider -ne 'TMDB') {
                                                            $global:IsFallback = $true
                                                        }
                                                    }
                                                    if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                        Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                                        if ($global:FavProvider -ne 'TVDB') {
                                                            $global:IsFallback = $true
                                                        }
                                                    }
                                                    try {
                                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                    }
                                                    catch {
                                                        if ($_.Exception.Response) {
                                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                                        }
                                                        else {
                                                            $statusCode = $_.Exception.Message
                                                        }
                                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    }
                                                }
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                        if (!$global:ImageMagickError -eq 'True') {
                                                            if ($UseTCResolutionOverlays -eq 'true') {
                                                                Write-Entry -Subtext "Queried Overlay Resolution: $global:EPResolution" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                switch ($global:EPResolution) {
                                                                    '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                    '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                    '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                    '4K'            { $TitleCardoverlay = $4kTC }
                                                                    '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                    Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                }
                                                            }
                                                            # Resize Image to 2000x3000 and apply Border and overlay
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            else {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                $SkippingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                    $global:EPTitle = $global:EPTitle.ToUpper()
                                                                }
                                                                $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                if ($global:direction -eq "RTL") {
                                                                    $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                }
                                                                # Loop through each symbol and replace it with a newline
                                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                    foreach ($symbol in $NewLineSymbols) {
                                                                        # Default: Replace the symbol with a newline
                                                                        $replacementString = "`n"

                                                                        # Check if the symbol should be kept
                                                                        $keepThisSymbol = $false
                                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                if ($symbol -like "*$k*") {
                                                                                    $keepThisSymbol = $true
                                                                                    break # Match found, no need to keep checking
                                                                                }
                                                                            }
                                                                        }

                                                                        # If it's a "keep" symbol, change the replacement string
                                                                        if ($keepThisSymbol) {
                                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                            $replacementString = $symbol + "`n"
                                                                        }
                                                                        $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                    }
                                                                }
                                                                $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                    # Add Stroke
                                                                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                            if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                }
                                                                $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                                    # Add Stroke
                                                                    if ($AddTitleCardTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'True') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImage
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'True' } Else { 'False' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }
                                                }
                                            }
                                            Elseif ($LocalAssetMissing -eq 'true') {
                                                Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:BackgroundOnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'True' } else { 'False' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                    }
                                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                    }
                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }

                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                Write-Entry -Subtext "Searching for $Titletext Artwork on Media Server." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                UploadOtherMediaServerArtwork -itemId $global:episodeid -imageType "Primary" -imagePath $EpisodeImageoriginal
                                            }
                                            Else {
                                                if ($show_skipped -eq 'True' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
    }
    # Asset Cleanup
    if ($AssetCleanup -eq 'true') {
        $ImagesCleared = 0
        $PathsCleared = 0
        $savedsizestring = 0
        Write-Entry -Subtext "Starting Asset Cleanup, this can take some time..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        Write-Entry -Subtext "Only removing Artwork with posterizarr exif data" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $processedDirectories = @()
        $uncheckedItems = $directoryHashtable.Keys | Where-Object { $_ -notin $checkedItems }

        # Perform deletion of unchecked items
        foreach ($uncheckedItem in $uncheckedItems) {
            if ($uncheckedItem -notlike '*.jpg') {
                # Full path to the item
                $uncheckedItemPath = $uncheckedItem + ".jpg"

                # Check if its a asset from Posterizarr
                $exifmagickcommand = "& `"$magick`" identify -verbose `"$uncheckedItemPath`""
                $exifmagickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

                $ExifData = (Invoke-Expression $exifmagickcommand | Select-String -Pattern 'created with ppm|created with posterizarr')

                if ($ExifData) {
                    # Remove unchecked item from filesystem
                    Remove-Item -LiteralPath $uncheckedItemPath -Force | Out-Null
                    $ImagesCleared++
                    Write-Entry -Subtext "Artwork Removed: $uncheckedItemPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    if ($LibraryFolders -eq 'true') {
                        # Determine the parent directory of the item
                        $parentDir = Split-Path -Path $uncheckedItemPath -Parent

                        # Add the directory to the list if it's not already included
                        if ($parentDir -notin $processedDirectories) {
                            $processedDirectories += $parentDir
                        }
                    }
                }
            }
        }

        # Cleanup empty Asset dirs
        if ($LibraryFolders -eq 'true') {
            # After all files are removed get all empty directories at once
            $dirs2delete = Get-ChildItem -LiteralPath $AssetPath -Recurse -Directory -Force | Where-Object { -not $_.GetFileSystemInfos() }

            # Loop through the pre-filtered list
            foreach ($dir in $dirs2delete) {
                # Increment counter
                $PathsCleared++
                # Remove the empty directory
                Remove-Item -LiteralPath $dir.FullName -Force -Confirm:$false | Out-Null

                # Log the action
                Write-Entry -Subtext "Removed empty directory: $($dir.FullName)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
        }
        if ($ImagesCleared -ge '1' -or $PathsCleared -ge '1') {
            Write-Entry -Message "Asset Cleanup overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        # Check new dir Size
        if ($ImagesCleared -ge '1') {
            $newtotalSize = Get-ChildItem $AssetPath -Recurse | Measure-Object -Property Length -Sum
            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($newtotalSize.Sum -gt 1GB) {
                $newtotalSizeString = "{0:N2} GB" -f ($newtotalSize.Sum / 1GB)
            }
            elseif ($newtotalSize.Sum -gt 1MB) {
                $newtotalSizeString = "{0:N2} MB" -f ($newtotalSize.Sum / 1MB)
            }
            elseif ($newtotalSize.Sum -gt 1KB) {
                $newtotalSizeString = "{0:N2} KB" -f ($newtotalSize.Sum / 1KB)
            }
            else {
                $newtotalSizeString = "$($newtotalSize.Sum) bytes"
            }

            # Saved space
            $SavedSpace = $totalSize - $newtotalSize.Sum

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($SavedSpace -gt 1GB) {
                $savedsizestring = "{0:N2} GB" -f ($SavedSpace / 1GB)
            }
            elseif ($SavedSpace -gt 1MB) {
                $savedsizestring = "{0:N2} MB" -f ($SavedSpace / 1MB)
            }
            elseif ($SavedSpace -gt 1KB) {
                $savedsizestring = "{0:N2} KB" -f ($SavedSpace / 1KB)
            }
            else {
                $savedsizestring = "$SavedSpace bytes"
            }

            if ($ImagesCleared -ge '1') {
                Write-Entry -Subtext "Images Cleared: $ImagesCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Images Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($PathsCleared -ge '1') {
            if ($PathsCleared -ge '1') {
                Write-Entry -Subtext "Empty Folders Cleared: $PathsCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Empty Folders Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($ImagesCleared -ge '1') {
            Write-Entry -Subtext "Cleanup saved: $savedsizestring" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($UploadCount -ge '1') {
        Write-Entry -Message "Finished, Total images Uploaded: $UploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
        $ImageChoicesDummycsv = New-Object psobject

        # Add members to the object with empty values
        $ImageChoicesDummycsv = New-Object psobject
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Manual" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

        $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-TextSizeCacheSummary
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    Send-SummaryNotification -ScriptMode $Mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -FallbackCount $FallbackCount.count -TextlessCount $TextlessCount.count -TruncatedCount $TextTruncatedCount.count -PosterUnknownCount $PosterUnknownCount -SkipTBACount $SkipTBACount -SkipJapTitleCount $SkipJapTitleCount -PosterCount $posterCount -BackgroundCount $BackgroundCount -SeasonCount $SeasonCount -EpisodeCount $EpisodeCount -ImagesCleared $ImagesCleared -PathsCleared $PathsCleared -SavedSizeString $savedsizestring -UploadCount $UploadCount

    # Calculate Counts
    $CalculatedCount = $($posterCount - $SeasonCount - $BackgroundCount - $EpisodeCount)

    # Export json
    $jsonObject = [PSCustomObject]@{
        Posters              = if ($CalculatedCount) { $CalculatedCount } Else { 0 }
        Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
        Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
        Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
        Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
        Mode                 = $Mode
        Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
        Errors               = if ($errorCount) { $errorCount } Else { 0 }
        Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
        Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
        Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
        Text                 = if ($TextCount) { $TextCount } Else { 0 }
        "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
        "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
        "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
        "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
        "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
        "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
        "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
        "Script Version"     = $CurrentScriptVersion
        "IM Version"         = $global:CurrentImagemagickversion
        "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
        "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
    }

    $jsonOutput = $jsonObject | ConvertTo-Json
    $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}
#region Posterreset Mode
ElseIf ($PosterReset) {
    if ($UsePlex -eq 'true' -and $null -ne $LibraryToReset) {
        Write-Entry -Message "Poster reset requested for library: $LibraryToReset" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Yellow -log Warning
        Write-Entry -Subtext "This action will reset all posters and cannot be undone." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Warning
        Write-Entry -Subtext "Starting in 20 seconds... Press Ctrl+C to cancel." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Cyan -log Info

        Start-Sleep -Seconds 20

        Write-Entry -Subtext "Resetting posters for library: $LibraryToReset" -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Green -log Info
        Reset-PlexLibraryPictures -LibraryName $LibraryToReset
    }
    Else {
        Write-Entry -Message "This only works for plex servers..." -Path "$global:ScriptRoot\Logs\Scriptlog.log" -Color Red -log Error
    }
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
}
#region Normal Mode
else {
    if ($UISchedule -or $ContainerSchedule) {
        $Mode = "scheduled"
        Write-Entry -Message "Scheduled Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Else {
        $Mode = "normal"
        Write-Entry -Message "Normal Mode Started..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-Entry -Message "Query plex libs..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libsoverview = @()
    foreach ($lib in $Libs.MediaContainer.Directory) {
        if ($lib.title -notin $LibstoExclude) {
            $libtemp = New-Object psobject
            $libtemp | Add-Member -MemberType NoteProperty -Name "ID" -Value $lib.key
            $libtemp | Add-Member -MemberType NoteProperty -Name "Name" -Value $lib.title
            $libtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $lib.language

            # Check if $lib.location.path is an array
            if ($lib.location.path -is [array]) {
                $paths = $lib.location.path -join ',' # Convert array to string
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $paths
            }
            else {
                $libtemp | Add-Member -MemberType NoteProperty -Name "Path" -Value $lib.location.path
            }
            # Check if Libname has chars we cant use for Folders
            if ($lib.title -notmatch "^[^\/:*?`"<>\|\\}]+$") {
                Write-Entry -Message  "Lib: '$($lib.title)' contains invalid characters." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Please rename your lib and remove all chars that are listed here: '/, :, *, ?, `", <, >, |, \, or }'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                # Clear Running File
                if (Test-Path $CurrentlyRunning) {
                    try {
                        Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
                    }
                    catch {
                        Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                        Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                    }
                }
                if ($global:UptimeKumaUrl) {
                    Send-UptimeKumaWebhook -status "down" -msg "Invalid chars on lib"
                }
                Exit
            }
            $Libsoverview += $libtemp
        }
    }
    if ($($Libsoverview.count) -lt 1) {
        Write-Entry -Subtext "0 libraries were found. Are you on the correct Plex server?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "No libs found"
        }
        Exit
    }
    Write-Entry -Subtext "Found '$($Libsoverview.count)' libs and '$($LibstoExclude.count)' are excluded..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $IncludedLibraryNames = $Libsoverview.Name -join ', '
    Write-Entry -Subtext "Included Libraries: $IncludedLibraryNames" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    Write-Entry -Message "Query all items from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    $Libraries = @()
    Foreach ($Library in $Libsoverview) {
        if ($Library.Name -notin $LibstoExclude) {
            $PlexHeaders = @{}
            if ($PlexToken) {
                $PlexHeaders['X-Plex-Token'] = $PlexToken
            }

            # Create a parent XML document
            $Libcontent = New-Object -TypeName System.Xml.XmlDocument
            $mediaContainerNode = $Libcontent.CreateElement('MediaContainer')
            $Libcontent.AppendChild($mediaContainerNode) | Out-Null

            # Initialize variables for pagination
            $searchsize = 0
            $totalContentSize = 1

            # Loop until all content is retrieved
            do {
                # Set headers for the current request
                $PlexHeaders['X-Plex-Container-Start'] = $searchsize
                $PlexHeaders['X-Plex-Container-Size'] = '1000'

                # Fetch content from Plex server
                $response = Invoke-WebRequest -Uri "$PlexUrl/library/sections/$($Library.ID)/all" -Headers $PlexHeaders

                # Convert response content to XML
                [xml]$additionalContent = $response.Content

                # Get total content size if not retrieved yet
                if ($totalContentSize -eq 1) {
                    $totalContentSize = $additionalContent.MediaContainer.totalSize
                }

                # Import and append video nodes to the parent XML document
                $contentquery = if ($additionalContent.MediaContainer.video) {
                    'video'
                }
                else {
                    'Directory'
                }
                foreach ($videoNode in $additionalContent.MediaContainer.$contentquery) {
                    $importedNode = $Libcontent.ImportNode($videoNode, $true)
                    [void]$mediaContainerNode.AppendChild($importedNode)
                }

                # Update search size for next request
                $searchsize += [int]$additionalContent.MediaContainer.Size
            } until ($searchsize -ge $totalContentSize)
            if ($Libcontent.MediaContainer.video) {
                $contentquery = 'video'
            }
            Else {
                $contentquery = 'Directory'
            }
            foreach ($item in $Libcontent.MediaContainer.$contentquery) {
                $extractedFolder = $null
                $Seasondata = $null
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)?X-Plex-Token=$($PlexToken[0..7] -join '')****" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                            [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey)/children? -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Seasondata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)/children?" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                    Else {
                        try {
                            [xml]$Metadata = (Invoke-WebRequest $PlexUrl/library/metadata/$($item.ratingKey) -Headers $extraPlexHeaders).content
                        }
                        catch {
                            Write-Entry -Subtext "Current Metadata Plex Query: $($PlexUrl[0..10] -join '')****/library/metadata/$($item.ratingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "An error occurred during Plex query: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                        }
                    }
                }
                $metadatatemp = $Metadata.MediaContainer.$contentquery.guid.id
                $tmdbpattern = 'tmdb://(\d+)'
                $imdbpattern = 'imdb://tt(\d+)'
                $tvdbpattern = 'tvdb://(\d+)'
                if ($Metadata.MediaContainer.$contentquery.Location) {
                    $location = $Metadata.MediaContainer.$contentquery.Location.path
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                Else {
                    $location = $Metadata.MediaContainer.$contentquery.media.part.file
                    if ($location) {
                        $location = $location.replace('\\?\', '')
                    }
                    if ($location.count -gt '1') {
                        Write-Entry -Subtext "Multi File Locations: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        $location = $location[0]
                        $MultipleVersions = $true
                    }
                    Else {
                        $MultipleVersions = $false
                    }
                    Write-Entry -Subtext "File Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    if ($location.length -ge '256' -and $Platform -eq 'Windows') {
                        $CheckCharLimit = CheckCharLimit
                        if ($CheckCharLimit -eq $false) {
                            Write-Entry -Subtext "Skipping [$($item.title)] because path length is over '256'..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            Write-Entry -Subtext "You can adjust it by following this: https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry#enable-long-paths-in-windows-10-version-1607-and-later" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            continue
                        }
                    }

                    $libpaths = $($Library.path).split(',')
                    Write-Entry -Subtext "Plex Lib Paths before split: $($Library.path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Subtext "Plex Lib Paths after split: $libpaths" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    foreach ($libpath in $libpaths) {
                        if ($location -like "$libpath/*" -or $location -like "$libpath\*") {
                            Write-Entry -Subtext "Location: $location" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "Libpath: $libpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            $Matchedpath = AddTrailingSlash $libpath
                            $libpath = $Matchedpath
                            $relativePath = $location.Substring($libpath.Length)
                            $pathSegments = $relativePath -split '[\\/]'

                            # Determine the extracted folder and the root folder path
                            if ($pathSegments.Count -gt 2) {
                                $extractedFolder = $pathSegments[-2]  # Second-to-last segment is the folder containing the file
                                $extraFolder = $pathSegments[0]  # All segments up to the extracted folder
                            }
                            else {
                                $extractedFolder = $pathSegments[0]  # Only one segment, it's the folder
                                $extraFolder = $null  # No parent structure
                            }
                            Write-Entry -Subtext "Matchedpath: $Matchedpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            Write-Entry -Subtext "ExtractedFolder: $extractedFolder" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                            continue
                        }
                    }
                }
                if ($Seasondata) {
                    $SeasonsTemp = $Seasondata.MediaContainer.Directory | Where-Object { $_.Title -ne 'All episodes' }
                    $SeasonNames = $SeasonsTemp.Title -join ';'
                    $SeasonNumbers = $SeasonsTemp.index -join ','
                    $SeasonRatingkeys = $SeasonsTemp.ratingKey -join ','
                    $SeasonPosterUrl = ($SeasonsTemp | Where-Object { $_.type -eq "season" }).thumb -join ','
                }
                $matchesimdb = [regex]::Matches($metadatatemp, $imdbpattern)
                $matchestmdb = [regex]::Matches($metadatatemp, $tmdbpattern)
                $matchestvdb = [regex]::Matches($metadatatemp, $tvdbpattern)
                if ($matchesimdb.value) { $imdbid = $matchesimdb.value.Replace('imdb://', '') }Else { $imdbid = $null }
                if ($matchestmdb.value) { $tmdbid = $matchestmdb.value.Replace('tmdb://', '') }Else { $tmdbid = $null }
                if ($matchestvdb.value) { $tvdbid = $matchestvdb.value.Replace('tvdb://', '') }Else { $tvdbid = $null }

                # check if there are more then 1 entry in id´s
                if ($tvdbid.count -gt '1') { $tvdbid = $tvdbid[0] }
                if ($tmdbid.count -gt '1') { $tmdbid = $tmdbid[0] }
                if ($imdbid.count -gt '1') { $imdbid = $imdbid[0] }

                if ($Metadata.MediaContainer.$contentquery.Label.tag) {
                    $Labels = $($Metadata.MediaContainer.$contentquery.Label.tag -join ',')
                }
                Else {
                    $Labels = ""
                }
                $FileMetadata = $Metadata.MediaContainer.$contentquery.media.part.stream
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $FileMetadata | ForEach-Object {
                        if ($_.streamType -eq '1') {
                            $Resolution = $_.displayTitle
                        }
                    }
                }
                $temp = New-Object psobject
                $temp | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $Library.Name
                $temp | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $Metadata.MediaContainer.$contentquery.type
                $temp | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $($Library.language.split("-")[0])
                $temp | Add-Member -MemberType NoteProperty -Name "title" -Value $($item.title)
                if ($FileMetadata) {
                    $temp | Add-Member -MemberType NoteProperty -Name "Resolution" -Value $Resolution
                }
                $temp | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $($item.originalTitle)
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $SeasonNames
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $SeasonNumbers
                $temp | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $SeasonRatingkeys
                $temp | Add-Member -MemberType NoteProperty -Name "year" -Value $item.year
                $temp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $tvdbid
                $temp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $imdbid
                $temp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $tmdbid
                $temp | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $item.ratingKey
                $temp | Add-Member -MemberType NoteProperty -Name "Path" -Value $Matchedpath
                $temp | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $extractedFolder
                $temp | Add-Member -MemberType NoteProperty -Name "extraFolder" -Value $extraFolder
                $temp | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $MultipleVersions
                $temp | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $Metadata.MediaContainer.$contentquery.thumb
                $temp | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $Metadata.MediaContainer.$contentquery.art
                $temp | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $SeasonPosterUrl
                $temp | Add-Member -MemberType NoteProperty -Name "Labels" -Value $Labels
                $Libraries += $temp
                Write-Entry -Subtext "Found [$($temp.title)] of type $($temp.{Library Type}) in [$($temp.{Library Name})]" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
    }
    Write-Entry -Subtext "Found '$($Libraries.count)' Items..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    $Libraries | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
    Write-Entry -Message "Export everything to a csv: $global:ScriptRoot\Logs\PlexLibexport.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Initialize counter variable
    $posterCount = 0
    $SeasonCount = 0
    $EpisodeCount = 0
    $BackgroundCount = 0
    $PosterUnknownCount = 0
    $SkipTBACount = 0
    $SkipJapTitleCount = 0
    $AllShows = $Libraries | Where-Object { $_.'Library Type' -eq 'show' }
    $AllMovies = $Libraries | Where-Object { $_.'Library Type' -eq 'movie' }

    # Getting information of all Episodes
    if ($global:TitleCards -eq 'true') {
        Write-Entry -Message "Query episodes data from all Libs, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Query episode info
        $Episodedata = @()
        foreach ($showentry in $AllShows) {
            # Getting child entries for each season
            $splittedkeys = $showentry.SeasonRatingKeys.split(',')
            foreach ($key in $splittedkeys) {
                if ($PlexToken) {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children?X-Plex-Token=$PlexToken -Headers $extraPlexHeaders).content
                    }
                }
                Else {
                    if ($contentquery -eq 'Directory') {
                        [xml]$Seasondata = (Invoke-WebRequest $PlexUrl/library/metadata/$key/children? -Headers $extraPlexHeaders).content
                    }
                }
                $FileMetadata = $Seasondata.MediaContainer.video.media
                $Resolution = $null
                # Get Resolution
                if ($FileMetadata) {
                    $ResolutionList = @()
                    $FileMetadata | ForEach-Object {
                        $Resolution = $_.videoResolution
                        $ResolutionList += $Resolution
                    }
                    $Resolution = $ResolutionList -join ","
                }
                $tempseasondata = New-Object psobject
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $Seasondata.MediaContainer.grandparentTitle
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Type" -Value $Seasondata.MediaContainer.viewGroup
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $showentry.tvdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $showentry.tmdbid
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $showentry.'Library Name'
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $Seasondata.MediaContainer.parentIndex
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $($Seasondata.MediaContainer.video.index -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Seasondata.MediaContainer.video.title -join ';')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "RatingKeys" -Value $($Seasondata.MediaContainer.video.ratingKey -join ',')
                $tempseasondata | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $($Seasondata.MediaContainer.video.thumb -join ',')
                if ($FileMetadata) {
                    $tempseasondata | Add-Member -MemberType NoteProperty -Name "Resolutions" -Value $Resolution
                }
                $Episodedata += $tempseasondata
                Write-Entry -Subtext "Found [$($tempseasondata.{Show Name})] of type $($tempseasondata.Type) for season $($tempseasondata.{Season Number})" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            }
        }
        $Episodedata | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        if ($Episodedata) {
            Write-Entry -Subtext "Found '$($Episodedata.Episodes.split(',').count)' Episodes..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        }
    }

    # Test if csv´s are missing and create dummy file.
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -ErrorAction SilentlyContinue)) {
        $EpisodeDummycsv = New-Object psobject

        # Add members to the object with empty values
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Show Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Season Number" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Episodes" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $EpisodeDummycsv | Add-Member -MemberType NoteProperty -Name "PlexTitleCardUrls" -Value $null

        $EpisodeDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexEpisodeExport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexEpisodeExport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\PlexLibexport.csv" -ErrorAction SilentlyContinue)) {
        # Add members to the object with empty values
        $PlexLibDummycsv = New-Object psobject
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Name" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Type" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Library Language" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "title" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "originalTitle" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNames" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonNumbers" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "SeasonRatingKeys" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "year" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "ratingKey" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "Path" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "RootFoldername" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "MultipleVersions" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexPosterUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexBackgroundUrl" -Value $null
        $PlexLibDummycsv | Add-Member -MemberType NoteProperty -Name "PlexSeasonUrls" -Value $null

        $PlexLibDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\PlexLibexport.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No PlexLibexport.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    # Store all Files from asset dir in a hashtable
    Write-Entry -Message "Creating Hashtable of all posters in asset dir..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    try {
        $directoryHashtable = @{}
        $allowedExtensions = @(".jpg", ".jpeg", ".png", ".bmp")
        $totalSize = 0
        $excludePath = Join-Path -Path $AssetPath -ChildPath 'Collections'

        if ($FollowSymlink) {
            Get-ChildItem -Path $AssetPath -Recurse -FollowSymlink | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        Else {
            Get-ChildItem -Path $AssetPath -Recurse | Where-Object {
                $_.FullName -ne $excludePath -and $_.FullName -notlike "$excludePath/*"
            } | ForEach-Object {
                if ($allowedExtensions -contains $_.Extension.ToLower()) {
                    $directory = $_.Directory
                    $basename = $_.BaseName
                    if ($Platform -eq "Docker" -or $Platform -eq "Linux" -or $Platform -eq 'macOS') {
                        $directoryHashtable["$directory/$basename"] = $true
                    }
                    Else {
                        $directoryHashtable["$directory\$basename"] = $true
                    }
                }
                $totalSize += $_.Length
            }
        }
        # Convert bytes to kilobytes, megabytes, or gigabytes as needed
        if ($totalSize -gt 1GB) {
            $totalSizeString = "{0:N2} GB" -f ($totalSize / 1GB)
        }
        elseif ($totalSize -gt 1MB) {
            $totalSizeString = "{0:N2} MB" -f ($totalSize / 1MB)
        }
        elseif ($totalSize -gt 1KB) {
            $totalSizeString = "{0:N2} KB" -f ($totalSize / 1KB)
        }
        else {
            $totalSizeString = "$totalSize bytes"
        }

        Write-Entry -Subtext "Hashtable created..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        Write-Entry -Subtext "Found: '$($directoryHashtable.count)' images in asset directory." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        Write-Entry -Subtext "Total size of asset directory: $totalSizeString" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
    }
    catch {
        Write-Entry -Subtext "Error during Hashtable creation, please check Asset dir is available..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        # Clear Running File
        if (Test-Path $CurrentlyRunning) {
            try {
                Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
            }
            catch {
                Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            }
        }
        if ($global:UptimeKumaUrl) {
            Send-UptimeKumaWebhook -status "down" -msg "Hashtable creation failed"
        }
        Exit
    }
    if ($global:logLevel -eq '3') {
        Write-Entry -Message "Output hashtable..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        $directoryHashtable.keys | Out-File "$global:ScriptRoot\Logs\hashtable.log" -Force
    }

    # Download poster foreach movie
    Write-Entry -Message "Starting asset creation now, this can take a while..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    Write-Entry -Message "Starting Movie Poster Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info

    $checkedItems = @()
    # Movie Part
    foreach ($entry in $AllMovies) {
        try {
            if ($($entry.RootFoldername)) {
                # check if item has skip label
                if ($entry.labels -match 'skip_posterizarr') {
                    Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                }
                Else {
                    $SkippingText = 'false'
                    $global:posterurl = $null
                    $global:ImageMagickError = $null
                    $global:TMDBfallbackposterurl = $null
                    $global:fanartfallbackposterurl = $null
                    $global:IsFallback = $null
                    $global:PlexartworkDownloaded = $null
                    $global:langCode = $null
                    $global:direction = $null

                    # Determine the language direction
                    $global:langCode = $entry.'Library Language'
                    $global:direction = $global:languageDirections[$global:langCode]

                    $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                    if ($entry.title -match $cjkPattern) {
                        $Titletext = $entry.originalTitle
                    }
                    else {
                        $Titletext = $entry.title
                    }

                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $PosterImageoriginal = "$EntryDir\poster.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "poster"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                        }
                        Else {
                            $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = $($entry.RootFoldername)
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }
                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                    $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                    # Now we can start the Poster Part
                    if ($global:Posters -eq 'true') {
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:TextlessPoster = $null
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:ImageMagickError = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            $Arturl = $null

                            if ($entry.PlexPosterUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl
                                }
                            }

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMoviePoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMoviePoster } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                    Default { $global:posterurl = GetFanartMoviePoster }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMoviePoster } }
                                    'FANART' { $global:posterurl = GetFanartMoviePoster }
                                }
                                if ($global:PosterPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if ($global:PosterOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Elseif ($global:FavProvider -eq 'FANART') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMoviePoster
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetTVDBMoviePoster
                                            $global:IsFallback = $true
                                        }
                                    }
                                }

                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB' -and !$global:PosterOnlyTextless -and !$global:PosterPreferTextless) {
                                        $global:posterurl = GetTVDBMoviePoster
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:posterurl -and !$global:PosterOnlyTextless) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                            $global:IsFallback = $true
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl -and $global:imdbid -and !$global:PosterOnlyTextless) {
                                        Write-Entry -Subtext "Searching on IMDB for a movie poster" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:posterurl = GetIMDBPoster
                                        $global:IsFallback = $true
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }
                            }
                            if ($fontAllCaps -eq 'true') {
                                $joinedTitle = $Titletext.ToUpper()
                            }
                            Else {
                                $joinedTitle = $Titletext
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        if ($global:FavProvider -ne 'PLEX') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UsePosterResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                                '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                                '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                                '4K'            { $Posteroverlay = $4kposter }
                                                '1080p'         { $Posteroverlay = $1080pPoster }
                                                Default { $Posteroverlay = $Posteroverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $fontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddTextStroke -eq 'true') {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                                }

                                                Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                # Move file back to original naming with Brackets.
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            if ($Upload2Plex -eq 'true') {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "PosterImage: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $movietemp = New-Object psobject
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }

                                        # Export the array to a CSV file
                                        $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $movietemp = New-Object psobject
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $movietemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $movietemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $movietemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $movietemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $movietemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $movietemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                if ($entry.PlexPosterUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $entry.PlexPosterUrl
                                    }
                                }
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                try {
                                    GetPlexArtwork -Type "$Titletext Artwork." -ArtUrl $Arturl -TempImage $PosterImage
                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $fileContent = [System.IO.File]::ReadAllBytes($PosterImageoriginal)
                                        # Verify variables before uploading
                                        Write-Entry -Subtext "PosterImage: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                        $uri = if ($PlexToken) {
                                            "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                        }
                                        Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        # Try uploading, capturing the response in detail
                                        $Upload = Invoke-WebRequest -Uri $uri `
                                                                    -Method Post `
                                                                    -Headers $extraPlexHeaders `
                                                                    -Body $fileContent `
                                                                    -ContentType 'application/octet-stream' `
                                                                    -SkipHttpErrorCheck `
                                                                    -ErrorAction Stop

                                        if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                            Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                        }
                                        else {
                                            Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                            Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        }
                                        $UploadCount++
                                    }
                                }
                                catch {
                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $global:errorCount++
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                                if (Test-Path $PosterImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $PosterImage | Out-Null
                                    Write-Entry -Message "Deleting Temp Image: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                    # Now we can start the Background Poster Part
                    if ($global:BackgroundPosters -eq 'true') {
                        if ($LibraryFolders -eq 'true') {
                            $LibraryName = $entry.'Library Name'
                            if ($entry.extraFolder) {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            }
                            Else {
                                $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                                $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                            }
                            $backgroundImageoriginal = "$EntryDir\background.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "background"

                            if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                                New-Item -ItemType Directory -path $EntryDir -Force | out-null
                            }
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                            }
                            Else {
                                $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_background"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                        $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        $checkedItems += $hashtestpath
                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            # Define Global Variables
                            $SkippingText = 'false'
                            $global:tmdbid = $entry.tmdbid
                            $global:tvdbid = $entry.tvdbid
                            $global:imdbid = $entry.imdbid
                            $global:posterurl = $null
                            $global:PosterWithText = $null
                            $global:AssetTextLang = $null
                            $global:Fallback = $null
                            $global:IsFallback = $null
                            $global:TMDBAssetTextLang = $null
                            $global:FANARTAssetTextLang = $null
                            $global:TVDBAssetTextLang = $null
                            $global:TMDBAssetChangeUrl = $null
                            $global:FANARTAssetChangeUrl = $null
                            $global:TVDBAssetChangeUrl = $null
                            $global:ImageMagickError = $null
                            $global:TextlessPoster = $null
                            $global:TMDBfallbackposterurl = $null
                            $global:fanartfallbackposterurl = $null
                            $TakeLocal = $null
                            $LocalAssetMissing = $null
                            $Arturl = $null

                            if ($entry.PlexBackgroundUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl
                                }
                            }

                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }

                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBMovieBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartMovieBackground } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                    Default { $global:posterurl = GetFanartMovieBackground }
                                }
                                switch -Wildcard ($global:Fallback) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBMovieBackground } }
                                    'FANART' { $global:posterurl = GetFanartMovieBackground }
                                }
                                if ($global:BackgroundPreferTextless -eq $true) {
                                    if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                        $global:posterurl = $global:fanartfallbackposterurl
                                        Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                        $global:posterurl = $global:TMDBfallbackposterurl
                                        Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                        $global:IsFallback = $true
                                    }
                                    if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                    if ($global:FavProvider -eq 'TVDB') {
                                        if ($entry.tmdbid) {
                                            $global:posterurl = GetTMDBMovieBackground
                                            $global:IsFallback = $true
                                        }
                                        if (!$global:posterurl) {
                                            $global:posterurl = GetFanartMovieBackground
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        $global:posterurl = GetFanartMovieBackground
                                        if (!$global:FavProvider -eq 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                }
                                if (!$global:posterurl) {
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:posterurl = GetTVDBMovieBackground
                                        if ($global:posterurl) {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        if ($ArtUrl) {
                                            GetPlexArtwork -Type ' a Movie Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                            if ($global:posterurl) {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$global:posterurl) {
                                            Write-Entry -Subtext "Could not find a Background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        }
                                    }
                                }

                                if ($BackgroundfontAllCaps -eq 'true') {
                                    $joinedTitle = $Titletext.ToUpper()
                                }
                                Else {
                                    $joinedTitle = $Titletext
                                }
                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($TakeLocal) {
                                    Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                        Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                    }
                                    Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                }
                                Else {
                                    try {
                                        if (!$global:PlexartworkDownloaded) {
                                            $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                        }
                                    }
                                    catch {
                                        if ($_.Exception.Response) {
                                            $statusCode = $_.Exception.Response.StatusCode.value__
                                        }
                                        else {
                                            $statusCode = $_.Exception.Message
                                        }
                                        Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    }
                                    Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                    if ($global:posterurl -like 'https://image.tmdb.org*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'FANART') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                        if ($global:PosterWithText) {
                                            Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                        }
                                        if ($global:FavProvider -ne 'TVDB') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    elseif ($global:posterurl -like "$PlexUrl*") {
                                        Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        if ($global:FavProvider -ne 'PLEX') {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:IsFallback = $true
                                    }
                                }
                                if ($global:ImageProcessing -eq 'true') {
                                    Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                    $CommentlogEntry = "`"$magick`" $CommentArguments"
                                    $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                    if (!$global:ImageMagickError -eq 'true') {
                                        if ($UseBackgroundResolutionOverlays -eq 'true') {
                                            switch ($entry.Resolution) {
                                                '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                                '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                                '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                                '4K'            { $backgroundoverlay = $4kBackground }
                                                '1080p'         { $backgroundoverlay = $1080pBackground }
                                                Default { $backgroundoverlay = $backgroundoverlay }
                                            }
                                        }
                                        # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                        if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        else {
                                            $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                            Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        }
                                        $logEntry = "`"$magick`" $Arguments"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                            $SkippingText = 'true'
                                            Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                        }
                                        if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                            if ($global:direction -eq "RTL") {
                                                $backgroundfontImagemagick = $RTLfontImagemagick
                                            }
                                            $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                            # Loop through each symbol and replace it with a newline
                                            if ($NewLineOnSpecificSymbols -eq 'true') {
                                                foreach ($symbol in $NewLineSymbols) {
                                                    # Default: Replace the symbol with a newline
                                                    $replacementString = "`n"

                                                    # Check if the symbol should be kept
                                                    $keepThisSymbol = $false
                                                    if ($null -ne $SymbolsToKeepOnNewLine) {
                                                        # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                        foreach ($k in $SymbolsToKeepOnNewLine) {
                                                            # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                            if ($symbol -like "*$k*") {
                                                                $keepThisSymbol = $true
                                                                break # Match found, no need to keep checking
                                                            }
                                                        }
                                                    }

                                                    # If it's a "keep" symbol, change the replacement string
                                                    if ($keepThisSymbol) {
                                                        # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                        $replacementString = $symbol + "`n"
                                                    }
                                                    $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                                }
                                            }
                                            $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                            $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                            if (!$global:IsTruncated) {
                                                Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                                # Add Stroke
                                                if ($AddBackgroundTextStroke -eq 'true') {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }
                                                Else {
                                                    $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                                }

                                                Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $logEntry = "`"$magick`" $Arguments"
                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            }
                                        }
                                    }
                                }
                                Else {
                                    $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                    Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $logEntry = "`"$magick`" $Resizeargument"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    # Move file back to original naming with Brackets.
                                    if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                        if (!$global:IsTruncated) {
                                            if ($Upload2Plex -eq 'true') {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "BackgroundImage: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $posterCount++
                                            $BackgroundCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $moviebackgroundtemp = New-Object psobject
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $moviebackgroundtemp = New-Object psobject
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                if ($entry.PlexBackgroundUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $entry.PlexBackgroundUrl
                                    }
                                }
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                try {
                                    GetPlexArtwork -Type " $Titletext | Backgound Artwork." -ArtUrl $Arturl -TempImage $backgroundImage
                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $fileContent = [System.IO.File]::ReadAllBytes($backgroundImageoriginal)
                                        # Verify variables before uploading
                                        Write-Entry -Subtext "BackgroundImage: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                        $uri = if ($PlexToken) {
                                            "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                        }
                                        Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        # Try uploading, capturing the response in detail
                                        $Upload = Invoke-WebRequest -Uri $uri `
                                                                    -Method Post `
                                                                    -Headers $extraPlexHeaders `
                                                                    -Body $fileContent `
                                                                    -ContentType 'application/octet-stream' `
                                                                    -SkipHttpErrorCheck `
                                                                    -ErrorAction Stop

                                        if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                            Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                        }
                                        else {
                                            Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                            Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        }
                                        $UploadCount++
                                    }
                                }
                                catch {
                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $global:errorCount++
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                                if (Test-Path $backgroundImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $backgroundImage | Out-Null
                                    Write-Entry -Message "Deleting Temp Image: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
            }
            Else {
                Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

            }
        }
        catch {
            Write-Entry -Subtext "Could not query entries from movies array, error message: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            write-Entry -Subtext "At line $($_.InvocationInfo.ScriptLineNumber)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            if ($global:PosterOnlyTextless) {
                $moviebackgroundtemp = New-Object psobject
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Movie Background'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                switch -Wildcard ($global:FavProvider) {
                    'TMDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                    'FANART' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                    'TVDB' { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                    Default { $moviebackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                }
                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                }
                # Export the array to a CSV file
                $moviebackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
            }

        }
    }

    Write-Entry -Message "Starting Show/Season Poster/Background/TitleCard Creation part..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    # Show Part
    foreach ($entry in $AllShows) {
        if ($($entry.RootFoldername)) {
            # check if item has skip label
            if ($entry.labels -match 'skip_posterizarr') {
                Write-Entry -Message "Skipping '$($entry.title)' because it has a skip label..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
            }
            Else {
                # Define Global Variables
                $SkippingText = 'false'
                $global:tmdbsearched = $null
                $global:tmdbid = $entry.tmdbid
                $global:tvdbid = $entry.tvdbid
                $global:imdbid = $entry.imdbid
                $Seasonpostersearchtext = $null
                $global:ImageMagickError = $null
                $Episodepostersearchtext = $null
                $global:TMDBfallbackposterurl = $null
                $global:fanartfallbackposterurl = $null
                $FanartSearched = $null
                $global:plexalreadysearched = $null
                $global:posterurl = $null
                $global:PosterWithText = $null
                $global:AssetTextLang = $null
                $global:TMDBAssetTextLang = $null
                $global:FANARTAssetTextLang = $null
                $global:TVDBAssetTextLang = $null
                $global:TMDBAssetChangeUrl = $null
                $global:FANARTAssetChangeUrl = $null
                $global:TVDBAssetChangeUrl = $null
                $global:IsFallback = $null
                $global:FallbackText = $null
                $global:Fallback = $null
                $global:TextlessPoster = $null
                $global:tvdbalreadysearched = $null
                $global:PlexartworkDownloaded = $null
                $global:langCode = $null
                $global:direction = $null
                $TakeLocal = $null
                $LocalAssetMissing = $null

                # Determine the language direction
                $global:langCode = $entry.'Library Language'
                $global:direction = $global:languageDirections[$global:langCode]

                $cjkPattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsCyrillic}\p{IsDevanagari}\p{IsThai}\p{IsEthiopic}\p{IsGeorgian}\p{IsArmenian}\p{IsBengali}]'

                if ($entry.title -match $cjkPattern) {
                    $Titletext = $entry.originalTitle
                }
                else {
                    $Titletext = $entry.title
                }

                if ($LibraryFolders -eq 'true') {
                    $LibraryName = $entry.'Library Name'
                    if ($entry.extraFolder) {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                    }
                    Else {
                        $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                        $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                    }
                    $PosterImageoriginal = "$EntryDir\poster.jpg"
                    $TestPath = $EntryDir
                    $ManualTestPath = $ManualEntryDir
                    $Testfile = "poster"

                    if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                        New-Item -ItemType Directory -path $EntryDir -Force | out-null
                    }
                }
                Else {
                    if ($entry.extraFolder) {
                        $PosterImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername).jpg"
                    }
                    Else {
                        $PosterImageoriginal = "$AssetPath\$($entry.RootFoldername).jpg"
                    }
                    $TestPath = $AssetPath
                    $ManualTestPath = $ManualPath
                    $Testfile = $($entry.RootFoldername)
                }

                if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                    $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    $PosterImageoriginal = ($PosterImageoriginal).Replace('\', '/').Replace('./', '/')
                    $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                }
                else {
                    $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                    $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                    if ($fullTestPath) {
                        $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                    }
                    Else {
                        $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                        $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                    }
                }

                Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                $PosterImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername).jpg"
                $PosterImage = $PosterImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                # Now we can start the Poster Part
                if ($global:Posters -eq 'true') {
                    $checkedItems += $hashtestpath
                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        $Arturl = $null
                        if ($entry.PlexPosterUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexPosterUrl
                            }
                        }
                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                            Write-Entry -Message "Found Manual Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                            $LocalAssetMissing = 'true'
                        }
                        Else {
                            Write-Entry -Message "Start Poster Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                Default { $global:posterurl = GetFanartShowPoster }
                            }
                            if (!$global:posterurl) {
                                Write-Entry -Subtext "Could not find a poster on: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster } Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                'FANART' { $global:posterurl = GetFanartShowPoster }
                            }
                            if ($global:PosterPreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TVDBfallbackposterurl) {
                                    $global:posterurl = $global:TVDBfallbackposterurl
                                    Write-Entry -Subtext "Took TVDB Fallback poster because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                # try to find textless on TVDB
                                if ($global:TextlessPoster -ne 'true' -and $entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowPoster
                                    $global:IsFallback = $true
                                    $global:tvdbalreadysearched = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and $global:TextlessPoster -ne 'true') {
                                    $global:posterurl = GetFanartMoviePoster
                                    $global:IsFallback = $true
                                }
                            }

                            if (!$global:TextlessPoster -eq 'true' -and $global:posterurl) {
                                $global:PosterWithText = $true
                            }

                            if (!$global:posterurl -and $global:tvdbalreadysearched -ne "True") {
                                $global:posterurl = GetTVDBShowPoster
                                $global:IsFallback = $true
                                if (!$global:posterurl -and !$global:TMDBfallbackposterurl -and !$global:fanartfallbackposterurl) {
                                    if ($ArtUrl -and !$global:PosterOnlyTextless) {
                                        GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                        $global:plexalreadysearched = $True
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                            }
                            if (!$global:posterurl -and !$global:plexalreadysearched -eq 'true') {
                                $global:IsFallback = $true
                                if ($ArtUrl -and !$global:PosterOnlyTextless) {
                                    GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage
                                    $global:plexalreadysearched = $True
                                }
                                Else {
                                    Write-Entry -Subtext "Plex Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                }
                                if (!$global:posterurl) {
                                    Write-Entry -Subtext "Could not find a poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                            }
                            if (!$global:TextlessPoster -eq 'true' -and $global:TMDBfallbackposterurl) {
                                $global:posterurl = $global:TMDBfallbackposterurl
                            }
                            if (!$global:TextlessPoster -eq 'true' -and $global:fanartfallbackposterurl) {
                                $global:posterurl = $global:fanartfallbackposterurl
                            }
                        }
                        if ($fontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $PosterImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $PosterImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    if ($_.Exception.Response) {
                                        $statusCode = $_.Exception.Response.StatusCode.value__
                                    }
                                    else {
                                        $statusCode = $_.Exception.Message
                                    }
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TMDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'Fanart') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading Poster with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    if ($global:FavProvider -ne 'PLEX') {
                                        $global:IsFallback = $true
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing Poster for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$PosterImage`" -set `"comment`" `"created with posterizarr`" `"$PosterImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    if ($UsePosterResolutionOverlays -eq 'true') {
                                        switch ($entry.Resolution) {
                                            '4K DoVi/HDR10' { $Posteroverlay = $4KDoViHDR10 }
                                            '4K DoVi'       { $Posteroverlay = $4KDoVi }
                                            '4K HDR10'      { $Posteroverlay = $4KHDR10 }
                                            '4K'            { $Posteroverlay = $4kposter }
                                            '1080p'         { $Posteroverlay = $1080pPoster }
                                            Default { $Posteroverlay = $Posteroverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBorder -eq 'true' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBorder -eq 'true' -and $AddOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$borderwidthsecond`"  -bordercolor `"$bordercolor`" -border `"$borderwidth`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBorder -eq 'false' -and $AddOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Posteroverlay`" -gravity south -quality $global:outputQuality -composite `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        $Arguments = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                        $SkippingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddText -eq 'true' -and $SkippingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $fontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                # Default: Replace the symbol with a newline
                                                $replacementString = "`n"

                                                # Check if the symbol should be kept
                                                $keepThisSymbol = $false
                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                        if ($symbol -like "*$k*") {
                                                            $keepThisSymbol = $true
                                                            break # Match found, no need to keep checking
                                                        }
                                                    }
                                                }

                                                # If it's a "keep" symbol, change the replacement string
                                                if ($keepThisSymbol) {
                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                    $replacementString = $symbol + "`n"
                                                }
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $MaxWidth  -box_height $MaxHeight -min_pointsize $minPointSize -max_pointsize $maxPointSize -lineSpacing $lineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddTextStroke -eq 'true') {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -stroke `"$strokecolor`" -strokewidth `"$strokewidth`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$PosterImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$fontcolor`" -size `"$boxsize`" -background none -interline-spacing `"$lineSpacing`" -gravity `"$textgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$boxsize`" `) -gravity south -geometry +0`"$text_offset`" -quality $global:outputQuality -composite `"$PosterImage`""
                                            }

                                            Write-Entry -Subtext "Applying Poster text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$PosterImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$PosterImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                if (Get-ChildItem -LiteralPath $PosterImage -ErrorAction SilentlyContinue) {
                                    # Move file back to original naming with Brackets.
                                    if (!$global:IsTruncated) {
                                        if ($Upload2Plex -eq 'true') {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($PosterImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "PosterImage: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $PosterImage -Destination $PosterImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $PosterImage to $PosterImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    $showtemp = New-Object psobject
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$PosterImage} Else {$global:posterurl})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    # Export the array to a CSV file
                                    $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                            }
                        }
                        Elseif ($LocalAssetMissing -eq 'true') {
                            Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            $showtemp = New-Object psobject
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                            $showtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                            $showtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                            $showtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                            $showtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                'FANART' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                'TVDB' { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                Default { $showtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                            }
                            if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                            }
                            # Export the array to a CSV file
                            $showtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append


                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            if ($entry.PlexPosterUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexPosterUrl
                                }
                            }
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            try {
                                GetPlexArtwork -Type "$Titletext Artwork." -ArtUrl $Arturl -TempImage $PosterImage
                                if ($global:PlexartworkDownloaded -eq 'true') {
                                    Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $fileContent = [System.IO.File]::ReadAllBytes($PosterImageoriginal)
                                    # Verify variables before uploading
                                    Write-Entry -Subtext "PosterImage: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $uri = if ($PlexToken) {
                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/posters?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/posters"
                                    }
                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    # Try uploading, capturing the response in detail
                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                -Method Post `
                                                                -Headers $extraPlexHeaders `
                                                                -Body $fileContent `
                                                                -ContentType 'application/octet-stream' `
                                                                -SkipHttpErrorCheck `
                                                                -ErrorAction Stop

                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                    }
                                    else {
                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    $UploadCount++
                                }
                            }
                            catch {
                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $global:errorCount++
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                            if (Test-Path $PosterImage -ErrorAction SilentlyContinue) {
                                Remove-Item -LiteralPath $PosterImage | Out-Null
                                Write-Entry -Message "Deleting Temp Image: $PosterImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                        }
                        Else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $PosterImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Background Part
                if ($global:BackgroundPosters -eq 'true') {
                    if ($LibraryFolders -eq 'true') {
                        $LibraryName = $entry.'Library Name'
                        if ($entry.extraFolder) {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.extraFolder)\$($entry.RootFoldername)"
                        }
                        Else {
                            $EntryDir = "$AssetPath\$LibraryName\$($entry.RootFoldername)"
                            $ManualEntryDir = "$ManualAssetPath\$LibraryName\$($entry.RootFoldername)"
                        }
                        $backgroundImageoriginal = "$EntryDir\background.jpg"
                        $TestPath = $EntryDir
                        $ManualTestPath = $ManualEntryDir
                        $Testfile = "background"

                        if (!(Get-ChildItem -LiteralPath $EntryDir -ErrorAction SilentlyContinue)) {
                            New-Item -ItemType Directory -path $EntryDir -Force | out-null
                        }
                    }
                    Else {
                        if ($entry.extraFolder) {
                            $backgroundImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_background.jpg"
                        }
                        Else {
                            $backgroundImageoriginal = "$AssetPath\$($entry.RootFoldername)_background.jpg"
                        }
                        $TestPath = $AssetPath
                        $ManualTestPath = $ManualPath
                        $Testfile = "$($entry.RootFoldername)_background"
                    }

                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        $backgroundImageoriginal = ($backgroundImageoriginal).Replace('\', '/').Replace('./', '/')
                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                    }
                    else {
                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                        if ($fullTestPath) {
                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                        }
                        Else {
                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                        }
                    }

                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                    $backgroundImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_background.jpg"
                    $backgroundImage = $backgroundImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                    $checkedItems += $hashtestpath

                    if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                        # Define Global Variables
                        $SkippingText = 'false'
                        $global:tmdbid = $entry.tmdbid
                        $global:tvdbid = $entry.tvdbid
                        $global:imdbid = $entry.imdbid
                        $global:posterurl = $null
                        $global:PosterWithText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:TextlessPoster = $null
                        $global:ImageMagickError = $null
                        $global:TMDBfallbackposterurl = $null
                        $global:fanartfallbackposterurl = $null
                        $TakeLocal = $null
                        $LocalAssetMissing = $null
                        $Arturl = $null

                        if ($entry.PlexBackgroundUrl -like "/library/*") {
                            if ($PlexToken) {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                            }
                            Else {
                                $Arturl = $plexurl + $entry.PlexBackgroundUrl
                            }
                        }

                        foreach ($ext in $allowedExtensions) {
                            $filePath = "$ManualTestPath$ext"
                            if (Test-Path -LiteralPath $filePath) {
                                Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                $posterext = $ext
                                break
                            }
                        }
                        if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                            Write-Entry -Message "Found Manual Background for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            $TakeLocal = $true
                        }
                        Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                            $LocalAssetMissing = 'true'
                        }
                        Else {
                            Write-Entry -Message "Start Background Search for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                                'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowBackground }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowBackground } }
                                'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage } }
                                Default { $global:posterurl = GetFanartShowBackground }
                            }
                            switch -Wildcard ($global:Fallback) {
                                'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowBackground } }
                                'FANART' { $global:posterurl = GetFanartShowBackground }
                            }
                            if ($global:BackgroundPreferTextless -eq $true) {
                                if (!$global:TextlessPoster -and $global:fanartfallbackposterurl) {
                                    $global:posterurl = $global:fanartfallbackposterurl
                                    Write-Entry -Subtext "Took Fanart.tv Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if (!$global:TextlessPoster -and $global:TMDBfallbackposterurl) {
                                    $global:posterurl = $global:TMDBfallbackposterurl
                                    Write-Entry -Subtext "Took TMDB Fallback background because it is your Fav Provider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FavProvider -eq 'TVDB' -and !$global:posterurl) {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        if ($global:posterurl) {
                                            $global:IsFallback = $true
                                        }
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        if ($global:posterurl) {
                                            $global:IsFallback = $true
                                        }
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                            }
                            if ($global:BackgroundOnlyTextless -and !$global:posterurl) {
                                if ($global:FavProvider -eq 'TVDB') {
                                    if ($entry.tmdbid) {
                                        $global:posterurl = GetTMDBShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                    if (!$global:posterurl) {
                                        $global:posterurl = GetFanartShowBackground
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Background'
                                    }
                                }
                                Else {
                                    $global:posterurl = GetFanartShowBackground
                                }
                            }
                            if (!$global:posterurl) {
                                if ($global:FavProvider -ne 'TVDB') {
                                    $global:posterurl = GetTVDBShowBackground
                                    if ($global:posterurl) {
                                        $global:IsFallback = $true
                                    }
                                }
                                $global:FallbackText = 'True-Background'
                                if (!$global:posterurl) {
                                    if ($ArtUrl) {
                                        GetPlexArtwork -Type ' a Show Background' -ArtUrl $Arturl -TempImage $backgroundImage
                                        if ($global:posterurl) {
                                            $global:IsFallback = $true
                                        }
                                    }
                                    Else {
                                        Write-Entry -Subtext "Plex Background Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a background on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }

                            }
                        }
                        if ($BackgroundfontAllCaps -eq 'true') {
                            $joinedTitle = $Titletext.ToUpper()
                        }
                        Else {
                            $joinedTitle = $Titletext
                        }
                        if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                            if ($TakeLocal) {
                                Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                    Copy-Item -LiteralPath $_.FullName -Destination $BackgroundImage | Out-Null
                                }
                                Write-Entry -Subtext "Copy local asset to: $BackgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            }
                            Else {
                                try {
                                    if (!$global:PlexartworkDownloaded) {
                                        $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $BackgroundImage -ErrorAction Stop
                                    }
                                }
                                catch {
                                    if ($_.Exception.Response) {
                                        $statusCode = $_.Exception.Response.StatusCode.value__
                                    }
                                    else {
                                        $statusCode = $_.Exception.Message
                                    }
                                    Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                }
                                Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                if ($global:posterurl -like 'https://image.tmdb.org*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TMDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TMDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:FANARTAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'FANART') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                    if ($global:PosterWithText) {
                                        Write-Entry -Subtext "Downloading background with Text from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    Else {
                                        Write-Entry -Subtext "Downloading Textless background from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        $global:AssetTextLang = $global:TVDBAssetTextLang
                                    }
                                    if ($global:FavProvider -ne 'TVDB') {
                                        $global:IsFallback = $true
                                    }
                                }
                                elseif ($global:posterurl -like "$PlexUrl*") {
                                    Write-Entry -Subtext "Downloading Background from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    if ($global:FavProvider -ne 'PLEX') {
                                        $global:IsFallback = $true
                                    }
                                }
                                Else {
                                    Write-Entry -Subtext "Downloading background from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                            }
                            if ($global:ImageProcessing -eq 'true') {
                                Write-Entry -Subtext "Processing background for: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $CommentArguments = "`"$backgroundImage`" -set `"comment`" `"created with posterizarr`" `"$backgroundImage`""
                                $CommentlogEntry = "`"$magick`" $CommentArguments"
                                $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                if (!$global:ImageMagickError -eq 'true') {
                                    if ($UseBackgroundResolutionOverlays -eq 'true') {
                                        switch ($entry.Resolution) {
                                            '4K DoVi/HDR10' { $backgroundoverlay = $4KDoViHDR10Background }
                                            '4K DoVi'       { $backgroundoverlay = $4KDoViBackground }
                                            '4K HDR10'      { $backgroundoverlay = $4KHDR10Background }
                                            '4K'            { $backgroundoverlay = $4kBackground }
                                            '1080p'         { $backgroundoverlay = $1080pBackground }
                                            Default { $backgroundoverlay = $backgroundoverlay }
                                        }
                                    }
                                    # Calculate the height to maintain the aspect ratio with a width of 1000 pixels
                                    if ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBackgroundBorder -eq 'true' -and $AddBackgroundOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$Backgroundborderwidthsecond`"  -bordercolor `"$Backgroundbordercolor`" -border `"$Backgroundborderwidth`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    elseif ($AddBackgroundBorder -eq 'false' -and $AddBackgroundOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$Backgroundoverlay`" -gravity south -quality $global:outputQuality -composite `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    else {
                                        $Arguments = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                        Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    }
                                    $logEntry = "`"$magick`" $Arguments"
                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                    if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                        $SkippingText = 'true'
                                        Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                    }
                                    if ($AddBackgroundText -eq 'true' -and $SkippingText -eq 'false') {
                                        if ($global:direction -eq "RTL") {
                                            $backgroundfontImagemagick = $RTLfontImagemagick
                                        }
                                        $joinedTitle = $joinedTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                        # Loop through each symbol and replace it with a newline
                                        if ($NewLineOnSpecificSymbols -eq 'true') {
                                            foreach ($symbol in $NewLineSymbols) {
                                                # Default: Replace the symbol with a newline
                                                $replacementString = "`n"

                                                # Check if the symbol should be kept
                                                $keepThisSymbol = $false
                                                if ($null -ne $SymbolsToKeepOnNewLine) {
                                                    # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                    foreach ($k in $SymbolsToKeepOnNewLine) {
                                                        # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                        if ($symbol -like "*$k*") {
                                                            $keepThisSymbol = $true
                                                            break # Match found, no need to keep checking
                                                        }
                                                    }
                                                }

                                                # If it's a "keep" symbol, change the replacement string
                                                if ($keepThisSymbol) {
                                                    # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                    $replacementString = $symbol + "`n"
                                                }
                                                $joinedTitle = $joinedTitle -replace [regex]::Escape($symbol), $replacementString
                                            }
                                        }
                                        $joinedTitlePointSize = $joinedTitle -replace '""', '""""'
                                        $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $backgroundfontImagemagick -box_width $BackgroundMaxWidth  -box_height $BackgroundMaxHeight -min_pointsize $BackgroundminPointSize -max_pointsize $BackgroundmaxPointSize -lineSpacing $BackgroundlineSpacing
                                        if (!$global:IsTruncated) {
                                            Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

                                            # Add Stroke
                                            if ($AddBackgroundTextStroke -eq 'true') {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -stroke `"$Backgroundstrokecolor`" -strokewidth `"$Backgroundstrokewidth`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }
                                            Else {
                                                $Arguments = "`"$backgroundImage`" -gravity center -background None -layers Flatten `( -font `"$backgroundfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Backgroundfontcolor`" -size `"$Backgroundboxsize`" -background none -interline-spacing `"$BackgroundlineSpacing`" -gravity `"$Backgroundtextgravity`" caption:`"$joinedTitle`" -trim +repage -extent `"$Backgroundboxsize`" `) -gravity south -geometry +0`"$Backgroundtext_offset`" -quality $global:outputQuality -composite `"$backgroundImage`""
                                            }

                                            Write-Entry -Subtext "Applying Background text: `"$joinedTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                        }
                                    }
                                }
                            }
                            Else {
                                $Resizeargument = "`"$backgroundImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$backgroundImage`""
                                Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $logEntry = "`"$magick`" $Resizeargument"
                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                            }
                            if (!$global:ImageMagickError -eq 'true') {
                                # Move file back to original naming with Brackets.
                                if (Get-ChildItem -LiteralPath $backgroundImage -ErrorAction SilentlyContinue) {
                                    if (!$global:IsTruncated) {
                                        if ($Upload2Plex -eq 'true') {
                                            try {
                                                Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                $fileContent = [System.IO.File]::ReadAllBytes($backgroundImage)
                                                # Verify variables before uploading
                                                Write-Entry -Subtext "BackgroundImage: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                $uri = if ($PlexToken) {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                                }
                                                Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                # Try uploading, capturing the response in detail
                                                $Upload = Invoke-WebRequest -Uri $uri `
                                                                            -Method Post `
                                                                            -Headers $extraPlexHeaders `
                                                                            -Body $fileContent `
                                                                            -ContentType 'application/octet-stream' `
                                                                            -SkipHttpErrorCheck `
                                                                            -ErrorAction Stop

                                                if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                    Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                    Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                }
                                                else {
                                                    Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                    Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                        }
                                        try {
                                            # Attempt to move the item
                                            Move-Item -LiteralPath $backgroundImage -Destination $backgroundImageoriginal -Force -ErrorAction Stop

                                            # Log success if move was successful
                                            Write-Entry -Subtext "Added: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                        }
                                        catch {
                                            # Log the error if the move operation fails
                                            Write-Entry -Subtext "Failed to move $backgroundImage to $backgroundImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        $BackgroundCount++
                                        Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                        $posterCount++
                                    }
                                    Else {
                                        Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                    }
                                    $showbackgroundtemp = New-Object psobject
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$backgroundImage} Else {$global:posterurl})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                    $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                        'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                        'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                        Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                    }
                                    # Export the array to a CSV file
                                    $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                }
                            }
                        }
                        Elseif ($LocalAssetMissing -eq 'true') {
                            Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                        }
                        Else {
                            Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                            $showbackgroundtemp = New-Object psobject
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $Titletext
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Show Background'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                            $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                            switch -Wildcard ($global:FavProvider) {
                                'TMDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                'FANART' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                'TVDB' { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                Default { $showbackgroundtemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                            }
                            if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                            }
                            # Export the array to a CSV file
                            $showbackgroundtemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                        }
                    }
                    else {
                        if ($global:UploadExistingAssets -eq 'true') {
                            if ($entry.PlexBackgroundUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $entry.PlexBackgroundUrl
                                }
                            }
                            Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                            try {
                                GetPlexArtwork -Type " $Titletext | Backgound Artwork." -ArtUrl $Arturl -TempImage $backgroundImage
                                if ($global:PlexartworkDownloaded -eq 'true') {
                                    Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $fileContent = [System.IO.File]::ReadAllBytes($backgroundImageoriginal)
                                    # Verify variables before uploading
                                    Write-Entry -Subtext "BackgroundImage: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "RatingKey: $($entry.ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $uri = if ($PlexToken) {
                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/arts?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        "$PlexUrl/library/metadata/$($entry.ratingkey)/arts"
                                    }
                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    # Try uploading, capturing the response in detail
                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                -Method Post `
                                                                -Headers $extraPlexHeaders `
                                                                -Body $fileContent `
                                                                -ContentType 'application/octet-stream' `
                                                                -SkipHttpErrorCheck `
                                                                -ErrorAction Stop

                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                    }
                                    else {
                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    $UploadCount++
                                }
                            }
                            catch {
                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $global:errorCount++
                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                            }
                            if (Test-Path $backgroundImage -ErrorAction SilentlyContinue) {
                                Remove-Item -LiteralPath $backgroundImage | Out-Null
                                Write-Entry -Message "Deleting Temp Image: $backgroundImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                            }
                        }
                        Else {
                            if ($show_skipped -eq 'true' ) {
                                Write-Entry -Subtext "Already exists: $backgroundImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                            }
                        }
                    }
                }
                # Now we can start the Season Part
                if ($global:SeasonPosters -eq 'true') {
                    $global:IsFallback = $null
                    $global:FallbackText = $null
                    $global:AssetTextLang = $null
                    $global:Fallback = $null
                    $global:TMDBAssetTextLang = $null
                    $global:FANARTAssetTextLang = $null
                    $global:TVDBAssetTextLang = $null
                    $global:TMDBAssetChangeUrl = $null
                    $global:FANARTAssetChangeUrl = $null
                    $global:TVDBAssetChangeUrl = $null
                    $global:PosterWithText = $null
                    $global:ImageMagickError = $null
                    $global:TextlessPoster = $null
                    $global:seasonNames = $entry.SeasonNames -split ';'
                    $global:SeasonRatingKeys = $entry.SeasonRatingKeys -split ','
                    $global:seasonNumbers = $entry.seasonNumbers -split ','
                    $global:PlexSeasonUrls = $entry.PlexSeasonUrls -split ','
                    for ($i = 0; $i -lt $global:seasonNames.Count; $i++) {
                        $SkippingText = 'false'
                        $Seasonpostersearchtext = $null
                        $global:seasontmp = $null
                        $global:TextlessPoster = $null
                        $global:tmdbsearched = $null
                        $global:posterurl = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:AssetTextLang = $null
                        $global:Fallback = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:ImageMagickError = $null
                        $global:TMDBSeasonFallback = $null
                        $global:TVDBSeasonFallback = $null
                        $global:FANARTSeasonFallback = $null
                        $TakeLocal = $null
                        $LocalAssetMissing = $null
                        if ($SeasonfontAllCaps -eq 'true') {
                            $global:seasonTitle = $global:seasonNames[$i].ToUpper()
                        }
                        Else {
                            $global:seasonTitle = $global:seasonNames[$i]
                        }
                        $global:SeasonNumber = $global:seasonNumbers[$i]
                        $global:SeasonRatingKey = $global:SeasonRatingKeys[$i]
                        $global:PlexSeasonUrl = $global:PlexSeasonUrls[$i]
                        if ($null -ne $global:SeasonNumber) {
                            $global:seasontmp = "Season" + $global:SeasonNumber.PadLeft(2, '0')
                        }
                        if ($LibraryFolders -eq 'true') {
                            $SeasonImageoriginal = "$EntryDir\$global:seasontmp.jpg"
                            $TestPath = $EntryDir
                            $ManualTestPath = $ManualEntryDir
                            $Testfile = "$global:seasontmp"
                        }
                        Else {
                            if ($entry.extraFolder) {
                                $SeasonImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:seasontmp.jpg"
                            }
                            Else {
                                $SeasonImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:seasontmp.jpg"
                            }
                            $TestPath = $AssetPath
                            $ManualTestPath = $ManualPath
                            $Testfile = "$($entry.RootFoldername)_$global:seasontmp"
                        }

                        if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                            $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                            $SeasonImageoriginal = ($SeasonImageoriginal).Replace('\', '/').Replace('./', '/')
                            $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                        }
                        else {
                            $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                            $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                            if ($fullTestPath) {
                                $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                            }
                            Else {
                                $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                            }
                        }

                        Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                        Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                        $SeasonImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:seasontmp.jpg"
                        $SeasonImage = $SeasonImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                        $checkedItems += $hashtestpath

                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                            $Arturl = $null
                            if ($global:PlexSeasonUrl -like "/library/*") {
                                if ($PlexToken) {
                                    $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                                }
                                Else {
                                    $Arturl = $plexurl + $global:PlexSeasonUrl
                                }
                            }
                            foreach ($ext in $allowedExtensions) {
                                $filePath = "$ManualTestPath$ext"
                                if (Test-Path -LiteralPath $filePath) {
                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    $posterext = $ext
                                    break
                                }
                            }
                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                Write-Entry -Message "Found Manual Season Poster for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                $TakeLocal = $true
                            }
                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                $LocalAssetMissing = 'true'
                            }
                            Else {
                                if (!$Seasonpostersearchtext) {
                                    Write-Entry -Message "Start Season Poster Search for: $Titletext | $global:seasonTitle" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                    $Seasonpostersearchtext = $true
                                }
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'FANART' { $global:posterurl = GetFanartSeasonPoster }
                                    'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBSeasonPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning } }
                                    'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage } }
                                    Default { $global:posterurl = GetFanartSeasonPoster }
                                }
                                # do a specific order
                                if ($global:SeasonPreferTextless -eq $true) {
                                    if (!$global:posterurl -or !$global:TextlessPoster) {
                                        if (!$entry.tmdbid -and $global:FavProvider -ne 'TMDB') {
                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if (!$entry.tvdbid -and $global:FavProvider -ne 'TVDB') {
                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            $global:IsFallback = $true
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl -or !$global:TextlessPoster) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                if ($global:posterurl) {
                                                    $global:IsFallback = $true
                                                }
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ((!$global:posterurl -or !$global:TextlessPoster) -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:posterurl = GetTVDBSeasonPoster
                                                if ($global:posterurl) {
                                                    $global:IsFallback = $true
                                                }
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                    if (!$global:TextlessPoster -and $ShowFallback -eq 'true') {
                                        # Lets just try to grab a show poster.
                                        Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'FANART' { $global:posterurl = GetFanartShowPoster }
                                            'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                            'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                            Default { $global:posterurl = GetFanartShowPoster }
                                        }
                                        if ($global:posterurl) {
                                            Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            $global:IsFallback = $true
                                            $global:FallbackText = 'True-Show'
                                        }
                                        Else {
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:posterurl = GetTMDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                                $global:posterurl = GetTVDBShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                            if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                                $global:posterurl = GetFanartShowPoster
                                                if ($global:posterurl) {
                                                    Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                    $global:IsFallback = $true
                                                    $global:FallbackText = 'True-Show'
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if (!$global:posterurl) {
                                        if ($global:FavProvider -ne 'TMDB' -and $entry.tmdbid) {
                                            $global:posterurl = GetTMDBSeasonPoster
                                            if ($global:posterurl) {
                                                $global:IsFallback = $true
                                            }
                                            Write-Entry -Subtext "Function GetTMDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        }
                                        if (!$global:posterurl) {
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:posterurl = GetFanartSeasonPoster
                                                Write-Entry -Subtext "Function GetFanartSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                if ($global:posterurl) {
                                                    $global:IsFallback = $true
                                                }
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if (!$global:posterurl -and $entry.tvdbid) {
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:posterurl = GetTVDBSeasonPoster
                                                if ($global:posterurl) {
                                                    $global:IsFallback = $true
                                                }
                                                Write-Entry -Subtext "Function GetTVDBSeasonPoster called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        if ($ArtUrl) {
                                            if ($global:FavProvider -ne 'PLEX') {
                                                GetPlexArtwork -Type ' a Season Poster' -ArtUrl $Arturl -TempImage $SeasonImage
                                                if ($global:posterurl) {
                                                    $global:IsFallback = $true
                                                }
                                                Write-Entry -Subtext "Function GetPlexArtwork called..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                Write-Entry -Subtext "IsFallback: $global:IsFallback" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Plex Season Poster Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                    }
                                    if (!$global:posterurl) {
                                        Write-Entry -Subtext "Could not find a season poster on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                    }
                                }
                                if (!$global:posterurl -and $ShowFallback -eq 'true') {
                                    # Lets just try to grab a show poster.
                                    Write-Entry -Subtext "Fallback to Show Poster..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    switch -Wildcard ($global:FavProvider) {
                                        'TMDB' { if ($entry.tmdbid) { $global:posterurl = GetTMDBShowPoster }Else { Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'FANART' { $global:posterurl = GetFanartShowPoster }
                                        'TVDB' { if ($entry.tvdbid) { $global:posterurl = GetTVDBShowPoster }Else { Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning; $global:posterurl = GetFanartShowPoster } }
                                        'PLEX' { if ($ArtUrl) { GetPlexArtwork -Type ' a Show Poster' -ArtUrl $Arturl -TempImage $PosterImage } }
                                        Default { $global:posterurl = GetFanartShowPoster }
                                    }
                                    if ($global:posterurl) {
                                        Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $global:IsFallback = $true
                                        $global:FallbackText = 'True-Show'
                                    }
                                    Else {
                                        if ($global:FavProvider -ne 'TMDB') {
                                            $global:posterurl = GetTMDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'TVDB' -and !$global:posterurl) {
                                            $global:posterurl = GetTVDBShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                        if ($global:FavProvider -ne 'FANART' -and !$global:posterurl) {
                                            $global:posterurl = GetFanartShowPoster
                                            if ($global:posterurl) {
                                                Write-Entry -Subtext "Using the Show Poster as Season Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                $global:IsFallback = $true
                                                $global:FallbackText = 'True-Show'
                                            }
                                        }
                                    }
                                }
                                if ($global:TMDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TMDB') {
                                    $global:posterurl = $global:TMDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:FANARTSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'FANART') {
                                    $global:posterurl = $global:FANARTSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'FANART'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }
                                if ($global:TVDBSeasonFallback -and $global:PosterWithText -and $global:FavProvider -eq 'TVDB') {
                                    $global:posterurl = $global:TVDBSeasonFallback
                                    Write-Entry -Subtext "Taking Season Poster with text as fallback from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                    $global:IsFallback = $true
                                }

                            }
                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                if ($global:ImageProcessing -eq 'true') {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        $CommentArguments = "`"$SeasonImage`" -set `"comment`" `"created with posterizarr`" `"$SeasonImage`""
                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                        if (!$global:ImageMagickError -eq 'true') {
                                            # Resize Image to 2000x3000 and apply Border and overlay
                                            if ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddSeasonBorder -eq 'true' -and $AddSeasonOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" -shave `"$Seasonborderwidthsecond`"  -bordercolor `"$Seasonbordercolor`" -border `"$Seasonborderwidth`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            elseif ($AddSeasonBorder -eq 'false' -and $AddSeasonOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$Seasonoverlay`" -gravity south -quality $global:outputQuality -composite `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }
                                            else {
                                                $Arguments = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                            }

                                            $logEntry = "`"$magick`" $Arguments"
                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                $SkippingText = 'true'
                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                            }
                                            if ($AddSeasonText -eq 'true' -and $SkippingText -eq 'false') {
                                                $global:seasonTitle = $global:seasonTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                if ($ShowOnSeasonfontAllCaps -eq 'true') {
                                                    $global:ShowTitleOnSeason = $titletext.ToUpper() -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                Else {
                                                    $global:ShowTitleOnSeason = $titletext -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                }
                                                # Loop through each symbol and replace it with a newline
                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                    foreach ($symbol in $NewLineSymbols) {
                                                        # Default: Replace the symbol with a newline
                                                        $replacementString = "`n"

                                                        # Check if the symbol should be kept
                                                        $keepThisSymbol = $false
                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                if ($symbol -like "*$k*") {
                                                                    $keepThisSymbol = $true
                                                                    break # Match found, no need to keep checking
                                                                }
                                                            }
                                                        }

                                                        # If it's a "keep" symbol, change the replacement string
                                                        if ($keepThisSymbol) {
                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                            $replacementString = $symbol + "`n"
                                                        }
                                                        $global:seasonTitle = $global:seasonTitle -replace [regex]::Escape($symbol), $replacementString
                                                        if ($AddShowTitletoSeason -eq 'true') {
                                                            $global:ShowTitleOnSeason = $global:ShowTitleOnSeason -replace [regex]::Escape($symbol), $replacementString
                                                        }
                                                    }
                                                }
                                                $joinedTitlePointSize = $global:seasonTitle -replace '""', '""""'
                                                $joinedShowTitlePointSize = $global:ShowTitleOnSeason -replace '""', '""""'
                                                if ($AddShowTitletoSeason -eq 'true') {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    $ShowoptimalFontSize = Get-OptimalPointSize -text $joinedShowTitlePointSize -font $fontImagemagick -box_width $ShowOnSeasonMaxWidth  -box_height $ShowOnSeasonMaxHeight -min_pointsize $ShowOnSeasonminPointSize -max_pointsize $ShowOnSeasonmaxPointSize -lineSpacing $ShowOnSeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext ("Optimal Season font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        Write-Entry -Subtext ("Optimal Show font size set to: '{0}' [{1}]" -f $showoptimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Season Part
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $SeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $SeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $SeasonArguments

                                                        # Show Part
                                                        # Add Stroke
                                                        if ($AddShowOnSeasonTextStroke -eq 'true') {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -stroke `"$ShowOnSeasonstrokecolor`" -strokewidth `"$ShowOnSeasonstrokewidth`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $ShowOnSeasonArguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$ShowoptimalFontSize`" -fill `"$ShowOnSeasonfontcolor`" -size `"$ShowOnSeasonboxsize`" -background none -interline-spacing `"$ShowOnSeasonlineSpacing`" -gravity `"$ShowOnSeasontextgravity`" caption:`"$global:ShowTitleOnSeason`" -trim +repage -extent `"$ShowOnSeasonboxsize`" `) -gravity south -geometry +0`"$ShowOnSeasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying showTitle text: `"$global:ShowTitleOnSeason`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $ShowOnSeasonArguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $ShowOnSeasonArguments
                                                    }
                                                }
                                                Else {
                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $fontImagemagick -box_width $SeasonMaxWidth  -box_height $SeasonMaxHeight -min_pointsize $SeasonminPointSize -max_pointsize $SeasonmaxPointSize -lineSpacing $SeasonlineSpacing
                                                    if (!$global:IsTruncated) {
                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        # Add Stroke
                                                        if ($AddSeasonTextStroke -eq 'true') {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -stroke `"$Seasonstrokecolor`" -strokewidth `"$Seasonstrokewidth`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }
                                                        Else {
                                                            $Arguments = "`"$SeasonImage`" -gravity center -background None -layers Flatten `( -font `"$fontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$Seasonfontcolor`" -size `"$Seasonboxsize`" -background none -interline-spacing `"$SeasonlineSpacing`" -gravity `"$Seasontextgravity`" caption:`"$global:seasonTitle`" -trim +repage -extent `"$Seasonboxsize`" `) -gravity south -geometry +0`"$Seasontext_offset`" -quality $global:outputQuality -composite `"$SeasonImage`""
                                                        }

                                                        Write-Entry -Subtext "Applying seasonTitle text: `"$global:seasonTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Arguments"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                Else {
                                    if ($TakeLocal) {
                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                            Copy-Item -LiteralPath $_.FullName -Destination $SeasonImage
                                        }
                                        Write-Entry -Subtext "Copy local asset to: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                    }
                                    Else {
                                        try {
                                            if (!$global:PlexartworkDownloaded) {
                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $SeasonImage -ErrorAction Stop
                                            }
                                        }
                                        catch {
                                            if ($_.Exception.Response) {
                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                            }
                                            else {
                                                $statusCode = $_.Exception.Message
                                            }
                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                        }
                                        Write-Entry -Subtext "Poster url: $(RedactMediaServerUrl -url $global:posterurl)" -Path "$($global:ScriptRoot)\Logs\Scriptlog.log" -Color White -log Info
                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                            if ($global:FavProvider -ne 'TMDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://assets.fanart.tv*') {
                                            Write-Entry -Subtext "Downloading Poster from 'Fanart.tv'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:FANARTAssetTextLang
                                            $PosterUnknownCount++
                                            if ($global:FavProvider -ne 'FANART') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                            Write-Entry -Subtext "Downloading Poster from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                            if ($global:FavProvider -ne 'TVDB') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        elseif ($global:posterurl -like "$PlexUrl*") {
                                            Write-Entry -Subtext "Downloading Poster from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            if ($global:FavProvider -ne 'PLEX') {
                                                $global:IsFallback = $true
                                            }
                                        }
                                        Else {
                                            Write-Entry -Subtext "Downloading Poster from 'IMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                            $PosterUnknownCount++
                                            $global:IsFallback = $true
                                        }
                                    }
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Resize Image to 2000x3000
                                        $Resizeargument = "`"$SeasonImage`" -resize `"$PosterSize^`" -gravity center -extent `"$PosterSize`" `"$SeasonImage`""
                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $logEntry = "`"$magick`" $Resizeargument"
                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                    }
                                }
                                if (!$global:ImageMagickError -eq 'true') {
                                    if (Get-ChildItem -LiteralPath $SeasonImage -ErrorAction SilentlyContinue) {
                                        # Move file back to original naming with Brackets.
                                        if (!$global:IsTruncated) {
                                            if ($Upload2Plex -eq 'true') {
                                                try {
                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($SeasonImage)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "SeasonImage: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($global:SeasonRatingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                            }
                                            try {
                                                # Attempt to move the item
                                                Move-Item -LiteralPath $SeasonImage -Destination $SeasonImageoriginal -Force -ErrorAction Stop

                                                # Log success if move was successful
                                                Write-Entry -Subtext "Added: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                            }
                                            catch {
                                                # Log the error if the move operation fails
                                                Write-Entry -Subtext "Failed to move $SeasonImage to $SeasonImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                            }
                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                            $SeasonCount++
                                            $posterCount++
                                        }
                                        Else {
                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        }
                                        $seasontemp = New-Object psobject
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback) { 'true' } else { 'false' })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$SeasonImage} Else {$global:posterurl})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                        $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                        switch -Wildcard ($global:FavProvider) {
                                            'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                            'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                            'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                            Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                        }
                                        # Export the array to a CSV file
                                        $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                    }
                                }
                            }
                            Elseif ($LocalAssetMissing -eq 'true') {
                                Write-Entry -Subtext "Skipping [$Titletext] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                            }
                            Else {
                                Write-Entry -Subtext "Missing poster URL for: $($entry.title)" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color Red -log Error
                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                $seasontemp = New-Object psobject
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($Titletext + " | Season " + $global:SeasonNumber)
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Season'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                $seasontemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                switch -Wildcard ($global:FavProvider) {
                                    'TMDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                    'FANART' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                    'TVDB' { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                    Default { $seasontemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                }
                                if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                    Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                }
                                # Export the array to a CSV file
                                $seasontemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                            }
                        }
                        else {
                            if ($global:UploadExistingAssets -eq 'true') {
                                if ($global:PlexSeasonUrl -like "/library/*") {
                                    if ($PlexToken) {
                                        $Arturl = $plexurl + $global:PlexSeasonUrl + "?X-Plex-Token=$PlexToken"
                                    }
                                    Else {
                                        $Arturl = $plexurl + $global:PlexSeasonUrl
                                    }
                                }
                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                try {
                                    GetPlexArtwork -Type " $Titletext | $global:seasontmp Artwork."  -ArtUrl $Arturl -TempImage $SeasonImage
                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                        $fileContent = [System.IO.File]::ReadAllBytes($SeasonImageoriginal)
                                        # Verify variables before uploading
                                        Write-Entry -Subtext "SeasonImage: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "RatingKey: $($global:SeasonRatingKey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                        $uri = if ($PlexToken) {
                                            "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters?X-Plex-Token=$PlexToken"
                                        }
                                        Else {
                                            "$PlexUrl/library/metadata/$($global:SeasonRatingKey)/posters"
                                        }
                                        Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                        # Try uploading, capturing the response in detail
                                        $Upload = Invoke-WebRequest -Uri $uri `
                                                                    -Method Post `
                                                                    -Headers $extraPlexHeaders `
                                                                    -Body $fileContent `
                                                                    -ContentType 'application/octet-stream' `
                                                                    -SkipHttpErrorCheck `
                                                                    -ErrorAction Stop

                                        if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                            Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                        }
                                        else {
                                            Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                            Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                        }
                                        $UploadCount++
                                    }
                                }
                                catch {
                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                    $global:errorCount++
                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                }
                                if (Test-Path $SeasonImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $SeasonImage | Out-Null
                                    Write-Entry -Message "Deleting Temp Image: $SeasonImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                if ($show_skipped -eq 'true' ) {
                                    Write-Entry -Subtext "Already exists: $SeasonImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                }
                            }
                        }
                    }
                }
                # Now we can start the Episode Part
                if ($global:TitleCards -eq 'true') {
                    # Loop through each episode
                    foreach ($episode in $Episodedata) {
                        $SkippingText = 'false'
                        $global:AssetTextLang = $null
                        $global:TMDBAssetTextLang = $null
                        $global:FANARTAssetTextLang = $null
                        $global:TVDBAssetTextLang = $null
                        $global:TMDBAssetChangeUrl = $null
                        $global:FANARTAssetChangeUrl = $null
                        $global:TVDBAssetChangeUrl = $null
                        $global:PosterWithText = $null
                        $global:TempImagecopied = $false
                        $EpisodeTempImage = $null
                        $global:ImageMagickError = $null
                        $global:season_number = $null
                        $Episodepostersearchtext = $null
                        $global:show_name = $null
                        $global:episodenumber = $null
                        $global:episode_numbers = $null
                        $global:titles = $null
                        $global:posterurl = $null
                        $global:FileNaming = $null
                        $EpisodeImageoriginal = $null
                        $EpisodeImage = $null
                        $global:Fallback = $null
                        $global:IsFallback = $null
                        $global:FallbackText = $null
                        $global:TextlessPoster = $null
                        $global:EPResolutions = $null

                        if (($episode.tmdbid -eq $entry.tmdbid -or $episode.tvdbid -eq $entry.tvdbid) -and $episode.'Show Name' -eq $entry.title -and $episode.'Library Name' -eq $entry.'Library Name') {
                            $global:show_name = $episode."Show Name"
                            $global:season_number = $episode."Season Number"
                            $global:EPResolutions = $episode."Resolutions".Split(",")
                            $global:episode_numbers = $episode."Episodes".Split(",")
                            $global:episode_ratingkeys = $episode."ratingKeys".Split(",")
                            $global:titles = $episode."Title".Split(";")
                            $global:PlexTitleCardUrls = $episode."PlexTitleCardUrls".Split(",")
                            if ($UseBackgroundAsTitleCard -eq 'true') {
                                $global:ImageMagickError = $null
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkippingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $LocalAssetMissing = $null
                                    $global:PlexTitleCardUrl = $entry.PlexBackgroundUrl
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:EPResolution = $($global:EPResolutions[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    Write-Entry -Message "Test Path is: $TestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Test File is: $Testfile" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Full Test Path is: $fullTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved hash Test Path is: $hashtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Manual Test Path is: $ManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Test Path is: $Manualtestpath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                    Write-Entry -Message "Resolved Manual Full Test Path is: $fullManualTestPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')

                                    $EpisodeTempImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\temp.jpg"
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath

                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            $Arturl = $
                                            if ($global:PlexTitleCardUrl -like "/library/*") {
                                                if ($PlexToken) {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                }
                                            }
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }
                                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                                $Episodepostersearchtext = $true
                                            }
                                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                $LocalAssetMissing = 'true'
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                if ($global:TempImagecopied -ne 'true') {
                                                    # now search for TitleCards
                                                    if ($global:FavProvider -eq 'TMDB') {
                                                        if ($episode.tmdbid) {
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if ($global:tmdbfallbackposterurl) {
                                                                    $global:posterurl = $global:tmdbfallbackposterurl
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    $global:IsFallback = $false
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    $global:IsFallback = $false
                                                                }
                                                            }
                                                        }
                                                    }
                                                    Else {
                                                        if ($episode.tvdbid) {
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if (!$global:posterurl) {
                                                                    $global:posterurl = GetFanartShowBackground
                                                                }
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    $global:IsFallback = $false
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if (!$global:posterurl) {
                                                                $global:posterurl = GetFanartShowBackground
                                                            }
                                                            if (!$global:posterurl) {
                                                                $global:IsFallback = $true
                                                                if ($ArtUrl) {
                                                                    GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                                }
                                                                Else {
                                                                    Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                }
                                                                if (!$global:posterurl) {
                                                                    Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                    $global:IsFallback = $false
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal -or $global:TempImagecopied -eq 'true') {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded -and $global:TempImagecopied -ne 'true') {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                                Copy-Item -LiteralPath $EpisodeImage -destination $EpisodeTempImage | Out-Null
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        if ($global:TempImagecopied -ne 'true') {
                                                            Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TMDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TMDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                                Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                $global:AssetTextLang = $global:TVDBAssetTextLang
                                                                if ($global:FavProvider -ne 'TVDB') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                            if ($global:posterurl -like "$PlexUrl*") {
                                                                Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                if ($global:FavProvider -ne 'PLEX') {
                                                                    $global:IsFallback = $true
                                                                }
                                                            }
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Taking temp image..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                            Copy-Item -LiteralPath $EpisodeTempImage -destination $EpisodeImage | Out-Null
                                                        }
                                                    }
                                                    $global:TempImagecopied = $true
                                                    # Check temp image
                                                    if ((Get-ChildItem -LiteralPath $EpisodeTempImage -ErrorAction SilentlyContinue).length -eq '0') {
                                                        Write-Entry -Subtext "Temp image is corrupt, cannot proceed" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    }
                                                    Else {
                                                        if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                            $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                            $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                            $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                            if (!$global:ImageMagickError -eq 'true') {
                                                                if ($UseTCResolutionOverlays -eq 'true') {
                                                                    switch ($global:EPResolution) {
                                                                        '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                        '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                        '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                        '4K'            { $TitleCardoverlay = $4kTC }
                                                                        '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                        Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                    }
                                                                }
                                                                # Resize Image to 2000x3000 and apply Border and overlay
                                                                if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                else {
                                                                    $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                    Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                }
                                                                $logEntry = "`"$magick`" $Arguments"
                                                                $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                    $SkippingText = 'true'
                                                                    Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                                }
                                                                if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                        $global:EPTitle = $global:EPTitle.ToUpper()
                                                                    }
                                                                    $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''

                                                                    if ($global:direction -eq "RTL") {
                                                                        $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                    }
                                                                    # Loop through each symbol and replace it with a newline
                                                                    if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                        foreach ($symbol in $NewLineSymbols) {
                                                                            # Default: Replace the symbol with a newline
                                                                            $replacementString = "`n"

                                                                            # Check if the symbol should be kept
                                                                            $keepThisSymbol = $false
                                                                            if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                                # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                                foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                    # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                    if ($symbol -like "*$k*") {
                                                                                        $keepThisSymbol = $true
                                                                                        break # Match found, no need to keep checking
                                                                                    }
                                                                                }
                                                                            }

                                                                            # If it's a "keep" symbol, change the replacement string
                                                                            if ($keepThisSymbol) {
                                                                                # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                                $replacementString = $symbol + "`n"
                                                                            }
                                                                            $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                        }
                                                                    }
                                                                    $joinedTitlePointSize = $global:EPTitle -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                                if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                    if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                        $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                    }
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                    $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                    $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                    if (!$global:IsTruncated) {
                                                                        Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        # Add Stroke
                                                                        if ($AddTitleCardTextStroke -eq 'true') {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }
                                                                        Else {
                                                                            $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                        }

                                                                        Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                        $logEntry = "`"$magick`" $Arguments"
                                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                        InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            if ($Upload2Plex -eq 'true') {
                                                                try {
                                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                    # Verify variables before uploading
                                                                    Write-Entry -Subtext "EpisodeImage: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                                    $uri = if ($PlexToken) {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                                    }
                                                                    Else {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                                    }
                                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    # Try uploading, capturing the response in detail
                                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                                -Method Post `
                                                                                                -Headers $extraPlexHeaders `
                                                                                                -Body $fileContent `
                                                                                                -ContentType 'application/octet-stream' `
                                                                                                -SkipHttpErrorCheck `
                                                                                                -ErrorAction Stop

                                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                                    }
                                                                    else {
                                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                    }
                                                                }
                                                                catch {
                                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                    $global:errorCount++
                                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }
                                                }
                                            }
                                            Elseif ($LocalAssetMissing -eq 'true') {
                                                Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:BackgroundOnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                    }
                                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                    }
                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }

                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                if ($global:PlexTitleCardUrl -like "/library/*") {
                                                    if ($PlexToken) {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                    }
                                                }
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                try {
                                                GetPlexArtwork -Type " $Titletext | $global:FileNaming Artwork." -ArtUrl $Arturl -TempImage $EpisodeImage
                                                if ($global:PlexartworkDownloaded -eq 'true') {
                                                    Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImageoriginal)
                                                    # Verify variables before uploading
                                                    Write-Entry -Subtext "EpisodeImage: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                    $uri = if ($PlexToken) {
                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                    }
                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    # Try uploading, capturing the response in detail
                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                -Method Post `
                                                                                -Headers $extraPlexHeaders `
                                                                                -Body $fileContent `
                                                                                -ContentType 'application/octet-stream' `
                                                                                -SkipHttpErrorCheck `
                                                                                -ErrorAction Stop

                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    $UploadCount++
                                                }
                                            }
                                            catch {
                                                Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                $global:errorCount++
                                                Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                            }
                                                if (Test-Path $EpisodeImage -ErrorAction SilentlyContinue) {
                                                    Remove-Item -LiteralPath $EpisodeImage | Out-Null
                                                    Write-Entry -Message "Deleting Temp Image: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                            }
                                            Else {
                                                if ($show_skipped -eq 'true' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                                if (Test-Path $EpisodeTempImage -ErrorAction SilentlyContinue) {
                                    Remove-Item -LiteralPath $EpisodeTempImage | Out-Null
                                    Write-Entry -Message "Deleting EpisodeTempImage: $EpisodeTempImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                }
                            }
                            Else {
                                for ($i = 0; $i -lt $global:episode_numbers.Count; $i++) {
                                    $SkippingText = 'false'
                                    $global:AssetTextLang = $null
                                    $global:TMDBAssetTextLang = $null
                                    $global:FANARTAssetTextLang = $null
                                    $global:TVDBAssetTextLang = $null
                                    $global:TMDBAssetChangeUrl = $null
                                    $global:FANARTAssetChangeUrl = $null
                                    $global:TVDBAssetChangeUrl = $null
                                    $global:PosterWithText = $null
                                    $global:Fallback = $null
                                    $global:IsFallback = $null
                                    $global:FallbackText = $null
                                    $global:ImageMagickError = $null
                                    $global:TextlessPoster = $null
                                    $global:posterurl = $null
                                    $Episodepostersearchtext = $null
                                    $ExifFound = $null
                                    $global:PlexartworkDownloaded = $null
                                    $value = $null
                                    $magickcommand = $null
                                    $Arturl = $null
                                    $TakeLocal = $null
                                    $LocalAssetMissing = $null
                                    $global:PlexTitleCardUrl = $($global:PlexTitleCardUrls[$i].Trim())
                                    $global:episode_ratingkey = $($global:episode_ratingkeys[$i].Trim())
                                    $global:EPTitle = $($global:titles[$i].Trim())
                                    $global:episodenumber = $($global:episode_numbers[$i].Trim())
                                    $global:FileNaming = "S" + $global:season_number.PadLeft(2, '0') + "E" + $global:episodenumber.PadLeft(2, '0')
                                    $bullet = [char]0x2022
                                    $global:SeasonEPNumber = "$SeasonTCText $global:season_number $bullet $EpisodeTCText $global:episodenumber"

                                    if ($LibraryFolders -eq 'true') {
                                        $EpisodeImageoriginal = "$EntryDir\$global:FileNaming.jpg"
                                        $TestPath = $EntryDir
                                        $ManualTestPath = $ManualEntryDir
                                        $Testfile = "$global:FileNaming"
                                    }
                                    Else {
                                        if ($entry.extraFolder) {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.extraFolder)\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        Else {
                                            $EpisodeImageoriginal = "$AssetPath\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                        }
                                        $TestPath = $AssetPath
                                        $ManualTestPath = $ManualPath
                                        $Testfile = "$($entry.RootFoldername)_$global:FileNaming"
                                    }

                                    if ($Platform -eq 'Docker' -or $Platform -eq 'Linux' -or $Platform -eq 'macOS') {
                                        $hashtestpath = ($TestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                        $EpisodeImageoriginal = ($EpisodeImageoriginal).Replace('\', '/').Replace('./', '/')
                                        $manualtestpath = ($ManualTestPath + "/" + $Testfile).Replace('\', '/').Replace('./', '/')
                                    }
                                    else {
                                        $fullTestPath = Resolve-Path -Path $TestPath -ErrorAction SilentlyContinue
                                        $fullManualTestPath = Resolve-Path -Path $ManualTestPath -ErrorAction SilentlyContinue
                                        if ($fullTestPath) {
                                            $hashtestpath = ($fullTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($fullManualTestPath.ProviderPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                        Else {
                                            $hashtestpath = ($TestPath + "\" + $Testfile).Replace('/', '\')
                                            $Manualtestpath = ($ManualTestPath + "\" + $Testfile).Replace('/', '\')
                                        }
                                    }

                                    $EpisodeImage = Join-Path -Path $global:ScriptRoot -ChildPath "temp\$($entry.RootFoldername)_$global:FileNaming.jpg"
                                    $EpisodeImage = $EpisodeImage.Replace('[', '_').Replace(']', '_').Replace('{', '_').Replace('}', '_')
                                    $cjkTitlePattern = '[\p{IsHiragana}\p{IsKatakana}\p{IsCJKUnifiedIdeographs}\p{IsThai}]'
                                    if ($SkipTBA -eq 'true' -and $global:EPTitle -eq 'TBA') {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title is 'TBA'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipTBACount++
                                    }
                                    Elseif ($SkipJapTitle -eq 'true' -and $global:EPTitle -match $cjkTitlePattern) {
                                        Write-Entry -Subtext "Skipping $global:FileNaming of $global:show_name because Title contains Jap/Chinese Chars" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                        $SkipJapTitleCount++
                                    }
                                    Else {
                                        $checkedItems += $hashtestpath

                                        if (-not $directoryHashtable.ContainsKey("$hashtestpath")) {
                                            $Arturl = $null
                                            if ($global:PlexTitleCardUrl -like "/library/*") {
                                                if ($PlexToken) {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                }
                                                Else {
                                                    $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                }
                                            }
                                            foreach ($ext in $allowedExtensions) {
                                                $filePath = "$ManualTestPath$ext"
                                                if (Test-Path -LiteralPath $filePath) {
                                                    Write-Entry -Message "Local file exists: $filePath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                    $posterext = $ext
                                                    break
                                                }
                                            }
                                            if ((Test-Path -LiteralPath "$($Manualtestpath)$posterext") -and $Manualtestpath -ne '\') {
                                                Write-Entry -Message "Found Manual Title Card for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                $TakeLocal = $true
                                            }
                                            Elseif ($global:DisableOnlineAssetFetch -eq 'true') {
                                                $LocalAssetMissing = 'true'
                                            }
                                            Else {
                                                if (!$Episodepostersearchtext) {
                                                    Write-Entry -Message "Start Title Card Search for: $global:show_name - $global:SeasonEPNumber" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                    $Episodepostersearchtext = $true
                                                }
                                                # now search for TitleCards
                                                if ($global:FavProvider -eq 'TMDB') {
                                                    if ($episode.tmdbid) {
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            $global:posterurl = GetTVDBTitleCard
                                                            if ($global:posterurl){
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTVDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TMDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            Write-Entry -Subtext "No Title Cards for this Episode on TVDB or TMDB..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($episode.tvdbid) {
                                                        $global:posterurl = GetTVDBTitleCard
                                                        if (!$global:posterurl -or $global:Fallback -eq "TMDB") {
                                                            $global:posterurl = GetTMDBTitleCard
                                                            if ($global:FavProvider -ne 'TMDB' -and $global:posterurl) {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTVDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                            Else {
                                                                # Lets just try to grab a background poster.
                                                                $global:posterurl = GetTMDBShowBackground
                                                                if ($global:posterurl) {
                                                                    Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                    $global:IsFallback = $true
                                                                    $global:FallbackText = 'True-Background'
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        Write-Entry -Subtext "Can't search on TVDB, missing ID..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        $global:posterurl = GetTMDBTitleCard
                                                        if ($global:FavProvider -ne 'TMDB' -and $global:posterurl) {
                                                            $global:IsFallback = $true
                                                        }
                                                        if (!$global:posterurl) {
                                                            $global:IsFallback = $true
                                                            if ($ArtUrl) {
                                                                GetPlexArtwork -Type ": $global:show_name 'Season $global:season_number - Episode $global:episodenumber' Title Card" -ArtUrl $ArtUrl -TempImage $EpisodeImage
                                                            }
                                                            Else {
                                                                Write-Entry -Subtext "Plex TitleCard Url empty, cannot search on plex, likely there is no artwork on plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                            }
                                                            if (!$global:posterurl) {
                                                                Write-Entry -Subtext "Could not find a TitleCard on any site" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            }
                                                        }
                                                        if (!$global:posterurl -and $BackgroundFallback -eq 'true') {
                                                            # Lets just try to grab a background poster.
                                                            Write-Entry -Subtext "Fallback to Show Background..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:posterurl = GetTMDBShowBackground
                                                            if ($global:posterurl) {
                                                                Write-Entry -Subtext "Using the Show Background Poster as TitleCard Fallback..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                                $global:IsFallback = $true
                                                                $global:FallbackText = 'True-Background'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if ($global:posterurl -or $global:PlexartworkDownloaded -or $TakeLocal) {
                                                if ($global:ImageProcessing -eq 'true') {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        $CommentArguments = "`"$EpisodeImage`" -set `"comment`" `"created with posterizarr`" `"$EpisodeImage`""
                                                        $CommentlogEntry = "`"$magick`" $CommentArguments"
                                                        $CommentlogEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $CommentArguments
                                                        if (!$global:ImageMagickError -eq 'true') {
                                                            if ($UseTCResolutionOverlays -eq 'true') {
                                                                switch ($global:EPResolution) {
                                                                    '4K DoVi/HDR10' { $TitleCardoverlay = $4KDoViHDR10TC }
                                                                    '4K DoVi'       { $TitleCardoverlay = $4KDoViTC }
                                                                    '4K HDR10'      { $TitleCardoverlay = $4KHDR10TC }
                                                                    '4K'            { $TitleCardoverlay = $4kTC }
                                                                    '1080p'         { $TitleCardoverlay = $1080pTC }
                                                                    Default { $TitleCardoverlay = $TitleCardoverlay }
                                                                }
                                                            }
                                                            # Resize Image to 2000x3000 and apply Border and overlay
                                                            if ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            elseif ($AddTitleCardBorder -eq 'true' -and $AddTitleCardOverlay -eq 'false' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" -shave `"$TitleCardborderwidthsecond`"  -bordercolor `"$TitleCardbordercolor`" -border `"$TitleCardborderwidth`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Borders" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            elseif ($AddTitleCardBorder -eq 'false' -and $AddTitleCardOverlay -eq 'true' -and $SkipAddTextAndOverlay -eq 'false') {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$TitleCardoverlay`" -gravity south -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it | Adding Overlay" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            else {
                                                                $Arguments = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                                Write-Entry -Subtext "Resizing it" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                            }
                                                            $logEntry = "`"$magick`" $Arguments"
                                                            $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                            InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                            if (($SkipAddText -eq 'true' -or $SkipAddTextAndOverlay -eq 'true') -and $global:PosterWithText) {
                                                                $SkippingText = 'true'
                                                                Write-Entry -Subtext "Skipping 'AddText' because poster alreaedy has text." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                                                            }
                                                            if ($AddTitleCardEPTitleText -eq 'true' -and $SkippingText -eq 'false') {
                                                                if ($TitleCardEPTitlefontAllCaps -eq 'true') {
                                                                    $global:EPTitle = $global:EPTitle.ToUpper()
                                                                }
                                                                $global:EPTitle = $global:EPTitle -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                if ($global:direction -eq "RTL") {
                                                                    $TitleCardfontImagemagick = $RTLfontImagemagick
                                                                }
                                                                # Loop through each symbol and replace it with a newline
                                                                if ($NewLineOnSpecificSymbols -eq 'true') {
                                                                    foreach ($symbol in $NewLineSymbols) {
                                                                        # Default: Replace the symbol with a newline
                                                                        $replacementString = "`n"

                                                                        # Check if the symbol should be kept
                                                                        $keepThisSymbol = $false
                                                                        if ($null -ne $SymbolsToKeepOnNewLine) {
                                                                            # Loop through all items in $SymbolsToKeepOnNewLine (in case it's an array like [':', '!'])
                                                                            foreach ($k in $SymbolsToKeepOnNewLine) {
                                                                                # Check if the $symbol (e.g., ": ") contains the $k character (e.g., ":")
                                                                                if ($symbol -like "*$k*") {
                                                                                    $keepThisSymbol = $true
                                                                                    break # Match found, no need to keep checking
                                                                                }
                                                                            }
                                                                        }

                                                                        # If it's a "keep" symbol, change the replacement string
                                                                        if ($keepThisSymbol) {
                                                                            # Replace ": " with ": \n" (keeps the symbol, adds newline after)
                                                                            $replacementString = $symbol + "`n"
                                                                        }
                                                                        $global:EPTitle = $global:EPTitle -replace [regex]::Escape($symbol), $replacementString
                                                                    }
                                                                }
                                                                $joinedTitlePointSize = $global:EPTitle -replace '""', '""""' -replace '`', ''
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPTitleMaxWidth  -box_height $TitleCardEPTitleMaxHeight -min_pointsize $TitleCardEPTitleminPointSize -max_pointsize $TitleCardEPTitlemaxPointSize -lineSpacing $TitleCardEPTitlelineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardEPTitleTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -stroke `"$TitleCardEPTitlestrokecolor`" -strokewidth `"$TitleCardEPTitlestrokewidth`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPTitlefontcolor`" -size `"$TitleCardEPTitleboxsize`" -background none -interline-spacing `"$TitleCardEPTitlelineSpacing`" -gravity `"$TitleCardEPTitletextgravity`" caption:`"$global:EPTitle`" -trim +repage -extent `"$TitleCardEPTitleboxsize`" `) -gravity south -geometry +0`"$TitleCardEPTitletext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying EPTitle text: `"$global:EPTitle`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                            if ($AddTitleCardEPText -eq 'true' -and $SkippingText -eq 'false') {
                                                                if ($TitleCardEPfontAllCaps -eq 'true') {
                                                                    $global:SeasonEPNumber = $global:SeasonEPNumber.ToUpper()
                                                                }
                                                                $global:SeasonEPNumber = $global:SeasonEPNumber -replace '„', '"' -replace '”', '"' -replace '“', '"' -replace '"', '""' -replace '`', ''
                                                                $joinedTitlePointSize = $global:SeasonEPNumber -replace '""', '""""'
                                                                $optimalFontSize = Get-OptimalPointSize -text $joinedTitlePointSize -font $TitleCardfontImagemagick -box_width $TitleCardEPMaxWidth  -box_height $TitleCardEPMaxHeight -min_pointsize $TitleCardEPminPointSize -max_pointsize $TitleCardEPmaxPointSize -lineSpacing $TitleCardEPlineSpacing
                                                                if (!$global:IsTruncated) {
                                                                    Write-Entry -Subtext ("Optimal font size set to: '{0}' [{1}]" -f $optimalFontSize, $(if ($null -eq $script:CurrentTextSizeSource) { 'calculated' } else { $script:CurrentTextSizeSource })) -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    # Add Stroke
                                                                    if ($AddTitleCardTextStroke -eq 'true') {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -stroke `"$TitleCardstrokecolor`" -strokewidth `"$TitleCardstrokewidth`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }
                                                                    Else {
                                                                        $Arguments = "`"$EpisodeImage`" -gravity center -background None -layers Flatten `( -font `"$TitleCardfontImagemagick`" -pointsize `"$optimalFontSize`" -fill `"$TitleCardEPfontcolor`" -size `"$TitleCardEPboxsize`" -background none -interline-spacing `"$TitleCardEPlineSpacing`" -gravity `"$TitleCardEPtextgravity`" caption:`"$global:SeasonEPNumber`" -trim +repage -extent `"$TitleCardEPboxsize`" `) -gravity south -geometry +0`"$TitleCardEPtext_offset`" -quality $global:outputQuality -composite `"$EpisodeImage`""
                                                                    }

                                                                    Write-Entry -Subtext "Applying SeasonEPNumber text: `"$global:SeasonEPNumber`"" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                                    $logEntry = "`"$magick`" $Arguments"
                                                                    $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                                    InvokeMagickCommand -Command $magick -Arguments $Arguments
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                Else {
                                                    if ($TakeLocal) {
                                                        Get-ChildItem -LiteralPath "$($ManualTestPath)$posterext" | ForEach-Object {
                                                            Copy-Item -LiteralPath $_.FullName -Destination $EpisodeImage | Out-Null
                                                        }
                                                        Write-Entry -Subtext "Copy local asset to: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                    }
                                                    Else {
                                                        try {
                                                            if (!$global:PlexartworkDownloaded) {
                                                                $response = Invoke-WebRequest -Uri $global:posterurl -OutFile $EpisodeImage -ErrorAction Stop
                                                            }
                                                        }
                                                        catch {
                                                            if ($_.Exception.Response) {
                                                                $statusCode = $_.Exception.Response.StatusCode.value__
                                                            }
                                                            else {
                                                                $statusCode = $_.Exception.Message
                                                            }
                                                            Write-Entry -Subtext "An error occurred while downloading the artwork: $statusCode" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                        }
                                                        Write-Entry -Subtext "Title Card url: $(RedactMediaServerUrl -url $global:posterurl)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        if ($global:posterurl -like 'https://image.tmdb.org*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TMDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TMDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TMDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like 'https://artworks.thetvdb.com*') {
                                                            Write-Entry -Subtext "Downloading Title Card from 'TVDB'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            $global:AssetTextLang = $global:TVDBAssetTextLang
                                                            if ($global:FavProvider -ne 'TVDB') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                        if ($global:posterurl -like "$PlexUrl*") {
                                                            Write-Entry -Subtext "Downloading Title Card from 'Plex'" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                            if ($global:FavProvider -ne 'PLEX') {
                                                                $global:IsFallback = $true
                                                            }
                                                        }
                                                    }
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Resize Image to 2000x3000
                                                        $Resizeargument = "`"$EpisodeImage`" -resize `"$BackgroundSize^`" -gravity center -extent `"$BackgroundSize`" `"$EpisodeImage`""
                                                        Write-Entry -Subtext "Resizing it... " -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $logEntry = "`"$magick`" $Resizeargument"
                                                        $logEntry | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append
                                                        InvokeMagickCommand -Command $magick -Arguments $Resizeargument
                                                    }
                                                }
                                                if (!$global:ImageMagickError -eq 'true') {
                                                    if (Get-ChildItem -LiteralPath $EpisodeImage -ErrorAction SilentlyContinue) {
                                                        # Move file back to original naming with Brackets.
                                                        if (!$global:IsTruncated) {
                                                            if ($Upload2Plex -eq 'true') {
                                                                try {
                                                                    Write-Entry -Subtext "Uploading Artwork to Plex..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color DarkMagenta -log Info
                                                                    $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImage)
                                                                    # Verify variables before uploading
                                                                    Write-Entry -Subtext "EpisodeImage: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                                    $uri = if ($PlexToken) {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                                    }
                                                                    Else {
                                                                        "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                                    }
                                                                    Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                                    # Try uploading, capturing the response in detail
                                                                    $Upload = Invoke-WebRequest -Uri $uri `
                                                                                                -Method Post `
                                                                                                -Headers $extraPlexHeaders `
                                                                                                -Body $fileContent `
                                                                                                -ContentType 'application/octet-stream' `
                                                                                                -SkipHttpErrorCheck `
                                                                                                -ErrorAction Stop

                                                                    if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                                        Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                        Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                                    }
                                                                    else {
                                                                        Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                                        Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                                    }
                                                                }
                                                                catch {
                                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                                    $global:errorCount++
                                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                                }
                                                            }
                                                            try {
                                                                # Attempt to move the item
                                                                Move-Item -LiteralPath $EpisodeImage -Destination $EpisodeImageoriginal -Force -ErrorAction Stop

                                                                # Log success if move was successful
                                                                Write-Entry -Subtext "Added: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -Log Info
                                                            }
                                                            catch {
                                                                # Log the error if the move operation fails
                                                                Write-Entry -Subtext "Failed to move $EpisodeImage to $EpisodeImageoriginal." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                Write-Entry -Subtext "Error: $_" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -Log Error
                                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                            }
                                                            Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                            $EpisodeCount++
                                                            $posterCount++
                                                        }
                                                        Else {
                                                            Write-Entry -Subtext "Skipping asset move because text is truncated..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                                        }
                                                        $episodetemp = New-Object psobject
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value $(if ($TakeLocal) {"false"} Else {if (!$global:AssetTextLang) { "Textless" }Else { $global:AssetTextLang }})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $(if ($global:IsFallback -and $global:FallbackText) { $global:FallbackText } elseif ($global:IsFallback -and !$global:FallbackText) { 'true' } Else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $(if ($TakeLocal) {$EpisodeImage} Else {$global:posterurl})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                        $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                        switch -Wildcard ($global:FavProvider) {
                                                            'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                            'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                            'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                            Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                        }
                                                        # Export the array to a CSV file
                                                        $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                    }
                                                }
                                            }
                                            Elseif ($LocalAssetMissing -eq 'true') {
                                                Write-Entry -Subtext "Skipping [$global:show_name - $global:SeasonEPNumber] - local asset missing and online fetch is disabled." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Warning
                                            }
                                            Else {
                                                Write-Entry -Subtext "--------------------------------------------------------------------------------" -Path $global:ScriptRoot\Logs\Scriptlog.log  -Color White -log Info
                                                $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                if ($global:BackgroundOnlyTextless) {
                                                    $episodetemp = New-Object psobject
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Title" -Value $($global:FileNaming + " | " + $global:EPTitle)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Type" -Value 'Episode'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $($entry.RootFoldername)
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $($entry.'Library Name')
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Language" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Fallback" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $(if ($global:IsTruncated) { 'true' } else { 'false' })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Download Source" -Value 'false'
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "Manual" -Value $(if ($TakeLocal) {"true"} Else {"false"})
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $(if ($entry.tmdbid) { $entry.tmdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $(if ($entry.tvdbid) { $entry.tvdbid } Else { "false" })
                                                    $episodetemp | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $(if ($entry.imdbid) { $entry.imdbid } Else { "false" })
                                                    switch -Wildcard ($global:FavProvider) {
                                                        'TMDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TMDBAssetChangeUrl) { $global:TMDBAssetChangeUrl }Else { "false" }) }
                                                        'FANART' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:FANARTAssetChangeUrl) { $global:FANARTAssetChangeUrl }Else { "false" }) }
                                                        'TVDB' { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $(if ($global:TVDBAssetChangeUrl) { $global:TVDBAssetChangeUrl }Else { "false" }) }
                                                        Default { $episodetemp | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value 'false' }
                                                    }
                                                    if ($EntryDir -and (Test-Path -LiteralPath $EntryDir) -and !(Get-ChildItem -LiteralPath $EntryDir)) {
                                                        Remove-Item -LiteralPath $EntryDir -Force -ErrorAction SilentlyContinue | out-null
                                                    }
                                                    # Export the array to a CSV file
                                                    $episodetemp | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force -Append
                                                }

                                            }

                                        }
                                        else {
                                            if ($global:UploadExistingAssets -eq 'true') {
                                                if ($global:PlexTitleCardUrl -like "/library/*") {
                                                    if ($PlexToken) {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl + "?X-Plex-Token=$PlexToken"
                                                    }
                                                    Else {
                                                        $Arturl = $plexurl + $global:PlexTitleCardUrl
                                                    }
                                                }
                                                Write-Entry -Message "Starting Existing Asset Upload..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                try {
                                                    GetPlexArtwork -Type " $Titletext | $global:FileNaming Artwork." -ArtUrl $Arturl -TempImage $EpisodeImage
                                                    if ($global:PlexartworkDownloaded -eq 'true') {
                                                        Write-Entry -Subtext "Uploading Existing Artwork for: $Titletext" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                        $fileContent = [System.IO.File]::ReadAllBytes($EpisodeImageoriginal)
                                                        # Verify variables before uploading
                                                        Write-Entry -Subtext "EpisodeImage: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        Write-Entry -Subtext "RatingKey: $($global:episode_ratingkey)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        Write-Entry -Subtext "File size: $($fileContent.Length) bytes" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug

                                                        $uri = if ($PlexToken) {
                                                            "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters?X-Plex-Token=$PlexToken"
                                                        }
                                                        Else {
                                                            "$PlexUrl/library/metadata/$($global:episode_ratingkey)/posters"
                                                        }
                                                        Write-Entry -Subtext "Upload URI: $(RedactMediaServerUrl -url $uri)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
                                                        # Try uploading, capturing the response in detail
                                                        $Upload = Invoke-WebRequest -Uri $uri `
                                                                                    -Method Post `
                                                                                    -Headers $extraPlexHeaders `
                                                                                    -Body $fileContent `
                                                                                    -ContentType 'application/octet-stream' `
                                                                                    -SkipHttpErrorCheck `
                                                                                    -ErrorAction Stop

                                                        if ($Upload.StatusCode -ne 200 -and $Upload.StatusCode -ne 201) {
                                                            Write-Entry -Subtext "Upload failed: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                            Write-Entry -Subtext "Response body:`n$($Upload.Content)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan-log Debug
                                                        }
                                                        else {
                                                            Write-Entry -Subtext "Upload OK: HTTP $($Upload.StatusCode)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Debug
                                                            Write-Entry -Subtext "Artwork uploaded successfully..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
                                                        }
                                                        $UploadCount++
                                                    }
                                                }
                                                catch {
                                                    Write-Entry -Subtext "Invoke-WebRequest failed at transport level: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

                                                    $global:errorCount++
                                                    Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
                                                }
                                                if (Test-Path $EpisodeImage -ErrorAction SilentlyContinue) {
                                                    Remove-Item -LiteralPath $EpisodeImage | Out-Null
                                                    Write-Entry -Message "Deleting Temp Image: $EpisodeImage" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
                                                }
                                            }
                                            Else {
                                                if ($show_skipped -eq 'true' ) {
                                                    Write-Entry -Subtext "Already exists: $EpisodeImageoriginal" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
            }
        }
        Else {
            Write-Entry -Message "Rootfolder value: $($entry.RootFoldername)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Path value: $($entry.Path)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Debug
            Write-Entry -Message "Missing RootFolder for: $($entry.title) - you have to manually create the poster for it..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error

        }
    }

    # Asset Cleanup
    if ($AssetCleanup -eq 'true') {
        $ImagesCleared = 0
        $PathsCleared = 0
        $savedsizestring = 0
        Write-Entry -Subtext "Starting Asset Cleanup, this can take some time..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        Write-Entry -Subtext "Only removing Artwork with posterizarr exif data" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Cyan -log Info
        $processedDirectories = @()
        $uncheckedItems = $directoryHashtable.Keys | Where-Object { $_ -notin $checkedItems }

        # Perform deletion of unchecked items
        foreach ($uncheckedItem in $uncheckedItems) {
            if ($uncheckedItem -notlike '*.jpg') {
                # Full path to the item
                $uncheckedItemPath = $uncheckedItem + ".jpg"

                # Check if its a asset from Posterizarr
                $exifmagickcommand = "& `"$magick`" identify -verbose `"$uncheckedItemPath`""
                $exifmagickcommand | Out-File $global:ScriptRoot\Logs\ImageMagickCommands.log -Append

                $ExifData = (Invoke-Expression $exifmagickcommand | Select-String -Pattern 'created with ppm|created with posterizarr')

                if ($ExifData) {
                    # Remove unchecked item from filesystem
                    Remove-Item -LiteralPath $uncheckedItemPath -Force | Out-Null
                    $ImagesCleared++
                    Write-Entry -Subtext "Artwork Removed: $uncheckedItemPath" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
                    if ($LibraryFolders -eq 'true') {
                        # Determine the parent directory of the item
                        $parentDir = Split-Path -Path $uncheckedItemPath -Parent

                        # Add the directory to the list if it's not already included
                        if ($parentDir -notin $processedDirectories) {
                            $processedDirectories += $parentDir
                        }
                    }
                }
            }
        }

        # Cleanup empty Asset dirs
        if ($LibraryFolders -eq 'true') {
            # After all files are removed get all empty directories at once
            $dirs2delete = Get-ChildItem -LiteralPath $AssetPath -Recurse -Directory -Force | Where-Object { -not $_.GetFileSystemInfos() }

            # Loop through the pre-filtered list
            foreach ($dir in $dirs2delete) {
                # Increment counter
                $PathsCleared++
                # Remove the empty directory
                Remove-Item -LiteralPath $dir.FullName -Force -Confirm:$false | Out-Null

                # Log the action
                Write-Entry -Subtext "Removed empty directory: $($dir.FullName)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            }
        }
        if ($ImagesCleared -ge '1' -or $PathsCleared -ge '1') {
            Write-Entry -Message "Asset Cleanup overview..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
        # Check new dir Size
        if ($ImagesCleared -ge '1') {
            $newtotalSize = Get-ChildItem $AssetPath -Recurse | Measure-Object -Property Length -Sum
            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($newtotalSize.Sum -gt 1GB) {
                $newtotalSizeString = "{0:N2} GB" -f ($newtotalSize.Sum / 1GB)
            }
            elseif ($newtotalSize.Sum -gt 1MB) {
                $newtotalSizeString = "{0:N2} MB" -f ($newtotalSize.Sum / 1MB)
            }
            elseif ($newtotalSize.Sum -gt 1KB) {
                $newtotalSizeString = "{0:N2} KB" -f ($newtotalSize.Sum / 1KB)
            }
            else {
                $newtotalSizeString = "$($newtotalSize.Sum) bytes"
            }

            # Saved space
            $SavedSpace = $totalSize - $newtotalSize.Sum

            # Convert bytes to kilobytes, megabytes, or gigabytes as needed
            if ($SavedSpace -gt 1GB) {
                $savedsizestring = "{0:N2} GB" -f ($SavedSpace / 1GB)
            }
            elseif ($SavedSpace -gt 1MB) {
                $savedsizestring = "{0:N2} MB" -f ($SavedSpace / 1MB)
            }
            elseif ($SavedSpace -gt 1KB) {
                $savedsizestring = "{0:N2} KB" -f ($SavedSpace / 1KB)
            }
            else {
                $savedsizestring = "$SavedSpace bytes"
            }

            if ($ImagesCleared -ge '1') {
                Write-Entry -Subtext "Images Cleared: $ImagesCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Images Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($PathsCleared -ge '1') {
            if ($PathsCleared -ge '1') {
                Write-Entry -Subtext "Empty Folders Cleared: $PathsCleared" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
            Else {
                Write-Entry -Subtext "Empty Folders Cleared: 0" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
            }
        }
        if ($ImagesCleared -ge '1') {
            Write-Entry -Subtext "Cleanup saved: $savedsizestring" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
        }
    }

    $endTime = Get-Date
    $executionTime = New-TimeSpan -Start $startTime -End $endTime
    # Format the execution time
    $hours = [math]::Floor($executionTime.TotalHours)
    $minutes = $executionTime.Minutes
    $seconds = $executionTime.Seconds
    $FormattedTimespawn = $hours.ToString() + "h " + $minutes.ToString() + "m " + $seconds.ToString() + "s "
    Write-Entry -Message "Finished, Total images created: $posterCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    if ($UploadCount -ge '1') {
        Write-Entry -Message "Finished, Total images Uploaded: $UploadCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ($posterCount -ge '1') {
        Write-Entry -Message "Show/Movie Posters created: $($posterCount-$SeasonCount-$BackgroundCount-$EpisodeCount)| Season images created: $SeasonCount | Background images created: $BackgroundCount | TitleCards created: $EpisodeCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Green -log Info
    }
    if ((Test-Path $global:ScriptRoot\Logs\ImageChoices.csv)) {
        Write-Entry -Message "You can find a detailed Summary of image Choices here: $global:ScriptRoot\Logs\ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
        # Calculate Summary
        $SummaryCount = Import-Csv -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -Delimiter ';'
        $FallbackCount = @($SummaryCount | Where-Object Fallback -eq 'true')
        $TextlessCount = @($SummaryCount | Where-Object Language -eq 'Textless')
        $TextTruncatedCount = @($SummaryCount | Where-Object TextTruncated -eq 'true')
        $TextCount = @($SummaryCount | Where-Object Textless -eq 'false')
        if ($TextlessCount -or $FallbackCount -or $TextCount -or $PosterUnknownCount -or $TextTruncatedCount) {
            Write-Entry -Message "This is a subset summary of all image choices from the ImageChoices.csv" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextlessCount) {
            Write-Entry -Subtext "'$($TextlessCount.count)' times the script took a Textless image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($FallbackCount) {
            Write-Entry -Subtext "'$($FallbackCount.count)' times the script took a fallback image" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
            Write-Entry -Subtext "'$($posterCount-$($FallbackCount.count))' times the script took the image from fav provider: $global:FavProvider" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextCount) {
            Write-Entry -Subtext "'$($TextCount.count)' times the script took an image with Text" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($PosterUnknownCount -ge '1') {
            Write-Entry -Subtext "'$PosterUnknownCount' times the script took a season poster where we cannot tell if it has text or not" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
        if ($TextTruncatedCount) {
            Write-Entry -Subtext "'$($TextTruncatedCount.count)' times the script truncated the text in images" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Info
        }
    }
    if ($errorCount -ge '1') {
        Write-Entry -Message "During execution '$errorCount' Errors occurred, please check the log for a detailed description where you see [ERROR-HERE]." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    if (!(Get-ChildItem -LiteralPath "$global:ScriptRoot\Logs\ImageChoices.csv" -ErrorAction SilentlyContinue)) {
        $ImageChoicesDummycsv = New-Object psobject

        # Add members to the object with empty values
        $ImageChoicesDummycsv = New-Object psobject
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Title" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Type" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Rootfolder" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "LibraryName" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Language" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fallback" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "TextTruncated" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Download Source" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Manual" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tmdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "tvdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "imdbid" -Value $null
        $ImageChoicesDummycsv | Add-Member -MemberType NoteProperty -Name "Fav Provider Link" -Value $null

        $ImageChoicesDummycsv | Select-Object * | Export-Csv -Path "$global:ScriptRoot\Logs\ImageChoices.csv" -NoTypeInformation -Delimiter ';' -Encoding UTF8 -Force
        Write-Entry -Message "No ImageChoices.csv found, creating dummy file for you..." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info
    }
    Write-TextSizeCacheSummary
    Write-Entry -Message "Script execution time: $FormattedTimespawn" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color White -log Info

    # Send Notification
    Send-SummaryNotification -ScriptMode $Mode -FormattedTimespawn $FormattedTimespawn -ErrorCount $errorCount -FallbackCount $FallbackCount.count -TextlessCount $TextlessCount.count -TruncatedCount $TextTruncatedCount.count -PosterUnknownCount $PosterUnknownCount -SkipTBACount $SkipTBACount -SkipJapTitleCount $SkipJapTitleCount -PosterCount $posterCount -BackgroundCount $BackgroundCount -SeasonCount $SeasonCount -EpisodeCount $EpisodeCount -ImagesCleared $ImagesCleared -PathsCleared $PathsCleared -SavedSizeString $savedsizestring

    # Calculate Counts
    $CalculatedCount = $($posterCount - $SeasonCount - $BackgroundCount - $EpisodeCount)
    # Export json
    $jsonObject = [PSCustomObject]@{
        Posters              = if ($CalculatedCount) { $CalculatedCount } Else { 0 }
        Backgrounds          = if ($BackgroundCount) { $BackgroundCount } Else { 0 }
        Titlecards           = if ($EpisodeCount) { $EpisodeCount } Else { 0 }
        Seasons              = if ($SeasonCount) { $SeasonCount } Else { 0 }
        Collections          = if ($collectionCount) { $collectionCount } Else { 0 }
        Mode                 = $Mode
        Runtime              = $($hours.ToString() + ":" + $minutes.ToString() + ":" + $seconds.ToString())
        Errors               = if ($errorCount) { $errorCount } Else { 0 }
        Fallbacks            = if ($FallbackCount) { $FallbackCount } Else { 0 }
        Textless             = if ($TextlessCount) { $TextlessCount } Else { 0 }
        Truncated            = if ($TextTruncatedCount) { $TextTruncatedCount } Else { 0 }
        Text                 = if ($TextCount) { $TextCount } Else { 0 }
        "TBA Skipped"        = if ($SkipTBACount) { $SkipTBACount } Else { 0 }
        "Jap/Chines Skipped" = if ($SkipJapTitleCount) { $SkipJapTitleCount } Else { 0 }
        "Notification Sent"  = if ($global:SendNotification -eq 'true') { $global:SendNotification } Else { "false" }
        "Uptime Kuma"        = if ($global:UptimeKumaUrl) { "true" } Else { "false" }
        "Images cleared"     = if ($ImagesCleared) { $ImagesCleared } Else { 0 }
        "Folders Cleared"    = if ($PathsCleared) { $PathsCleared } Else { 0 }
        "Space saved"        = if ($savedsizestring) { $savedsizestring } Else { 0 }
        "Script Version"     = $CurrentScriptVersion
        "IM Version"         = $global:CurrentImagemagickversion
        "Start time"         = $startTime.ToString('dd.MM.yyyy HH:mm:ss')
        "End Time"           = $endTime.ToString('dd.MM.yyyy HH:mm:ss')
    }

    $jsonOutput = $jsonObject | ConvertTo-Json
    $jsonOutput | Out-File -FilePath "$global:ScriptRoot\Logs\$Mode.json" -Encoding utf8

    # Clear Running File
    if (Test-Path $CurrentlyRunning) {
        try {
            Remove-Item -LiteralPath $CurrentlyRunning -ErrorAction Stop | Out-Null
        }
        catch {
            Write-Entry -Message "Failed to delete '$CurrentlyRunning'." -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
            Write-Entry -Subtext "Reason: $($_.Exception.Message)" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Yellow -log Error
            $global:errorCount++; Write-Entry -Subtext "[ERROR-HERE] See above. ^^^ errorCount: $errorCount" -Path $global:ScriptRoot\Logs\Scriptlog.log -Color Red -log Error
        }
    }
    if ($global:UptimeKumaUrl) {
        Send-UptimeKumaWebhook -status "up" -ping $executionTime.TotalMilliseconds
    }
}